<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */

function showAppModal(state, message, redirectPage = null) {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
}

function loadPage(event, pageName, params = {}) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;
                if (typeof pageInitializers !== 'undefined' && typeof pageInitializers[pageName] === 'function') {
                    pageInitializers[pageName](params);
                }
                updateActiveMenu(pageName);
                addRequiredStars(); // <-- DITAMBAHKAN: Panggil fungsi untuk menambahkan bintang
            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p><p><strong>Stack:</strong> ${e.stack}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
}

function updateActiveMenu(pageName) {
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar-menu .has-submenu').forEach(el => el.classList.remove('open'));

    let activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);
    let startElement = null;

    if (activeLink) {
        activeLink.classList.add('active');
        startElement = activeLink;
    } else {
        const parentPageName = pageName.replace('_menu', '');
        const parentLink = document.querySelector(`.sidebar-menu a[data-page-parent="${parentPageName}"]`);
        
        if (parentLink) {
            parentLink.classList.add('active');
            parentLink.parentElement.classList.add('open');
            startElement = parentLink;
        }
    }

    if (!startElement) return;

    let parent = startElement.closest('.has-submenu');
    while (parent) {
        parent.classList.add('open');
        const parentAnchor = parent.querySelector('a[data-page-parent]');
        if (parentAnchor) {
            parentAnchor.classList.add('active');
        }
        parent = parent.parentElement.closest('.has-submenu');
    }
}

/**
 * [BARU] Fungsi untuk menambahkan tanda bintang (*) pada label input yang wajib diisi.
 */
function addRequiredStars() {
    const form = document.querySelector('#main-content form');
    if (form) {
        form.querySelectorAll('input[required], select[required], textarea[required]').forEach(input => {
            const label = form.querySelector(`label[for="${input.id}"]`);
            if (label && !label.querySelector('.required-star')) {
                label.innerHTML += ' <span class="required-star">*</span>';
            }
        });
    }
}

const debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

/**
 * [BARU & DIPERBAIKI] Fungsi reusable untuk dropdown informasi.
 * @param {string} buttonId - ID dari tombol dropdown.
 * @param {string} contentId - ID dari kontainer konten dropdown.
 * @param {string} serverFunctionName - Nama fungsi di code.gs yang akan dipanggil.
 */
function setupInfoDropdown(buttonId, contentId, serverFunctionName) {
    const infoBtn = document.getElementById(buttonId);
    const contentDiv = document.getElementById(contentId);

    if (!infoBtn || !contentDiv) return;

    let isDataLoaded = false;

    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? (contentDiv.scrollHeight + "px") : "0px";

        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `<ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">${infoItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                [serverFunctionName]();
        }
    };
}


/**
 * ===================================================================
 * =================== 2. FUNGSI INISIALISASI HALAMAN ================
 * ===================================================================
 */

function initHomePage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSubMenuPage() {
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

// --- Modul SK Pembagian Tugas (Semua fungsi lengkap) ---

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
        })
        .withFailureHandler(error => console.error('Gagal memuat opsi form SK:', error))
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            showAppModal('error', 'File PDF maksimal 1 MB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    initializeGenericTablePage({
        tableId: 'riwayatTable', // ID dari elemen <table> di page_sk_riwayat.html
        serverFunction: 'getSKRiwayatData', // Nama fungsi BARU di code.gs
        filterConfig: [ // Konfigurasi untuk setiap filter
            { id: 'filterTahun', dataColumn: 'Tahun Ajaran', sortReverse: true },
            { id: 'filterSemester', dataColumn: 'Semester' },
            { id: 'filterNamaSekolah', dataColumn: 'Nama SD' }
        ]
    });
}

function initSkStatusPage() {
    // Cukup panggil fungsi generik dengan konfigurasi yang tepat
    initializeGenericTablePage({
        tableId: 'statusTable', // ID dari <table> di page_sk_status.html
        serverFunction: 'getSKStatusData', // Nama fungsi BARU di code.gs
        filterConfig: [] // Halaman ini tidak memiliki filter, jadi array-nya kosong
    });
}

function initSkKelolaPage() {
    initializeGenericTablePage({
        tableId: 'kelolaTable',
        serverFunction: 'getSKKelolaData',
        editPage: 'sk_edit',
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun Ajaran', sortReverse: true },
            { id: 'filterSemester', dataColumn: 'Semester' },
            { id: 'filterNamaSekolah', dataColumn: 'Nama SD' }
        ]
    });

    // **AWAL BLOK KODE PERBAIKAN UNTUK FUNGSI HAPUS**

    // Fungsi untuk menampilkan konfirmasi hapus (langkah 1)
    window.showDeleteConfirmation = (button) => {
        const rowInfo = JSON.parse(button.dataset.rowInfo);
        const modal = document.getElementById('deleteModal');
        if (!modal) return;

        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');

        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p>
                             <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                               Sekolah: ${rowInfo['Nama SD']}<br>
                               Tahun Ajaran: ${rowInfo['Tahun Ajaran']}
                             </div>`;
        
        // Gandakan tombol untuk menghapus event listener lama
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => showDeletePrompt(rowInfo);

        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    };

    // Fungsi untuk meminta kode hapus (langkah 2)
    function showDeletePrompt(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');

        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p>
                             <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => processDeletion(rowInfo);

        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }

    // Fungsi untuk memproses penghapusan ke server (langkah 3)
    function processDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) {
            showAppModal('error', 'Kode hapus tidak boleh kosong.');
            return;
        }

        showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'sk_kelola'); // Muat ulang halaman kelola setelah sukses
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deleteSKData(rowInfo._rowIndex, deleteCode); // Memanggil fungsi di code.gs
    }
    
    // **AKHIR BLOK KODE PERBAIKAN**
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => alert(`Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => alert(`Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    const MAIN_FOLDER_ID = "1GwIow8B4O1OWoq3nhpzDbMO53LXJJUKs";
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index;
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else if (item.type === 'tahun') {
                        renderSemesterView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: MAIN_FOLDER_ID }];
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderSemesterView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(MAIN_FOLDER_ID);
    }

    function renderSemesterView(tahunId, tahunName) {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail.push({ name: tahunName, type: 'tahun', id: tahunId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder semester ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFileView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(tahunId);
    }

    function renderFileView(semesterId, semesterName) {
        viewContainer.classList.add('view-container-scrollable');
        breadcrumbTrail.push({ name: semesterName, type: 'semester', id: semesterId });
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(semesterId);
    }
    
    renderTahunAjaranView();
}


// --- Modul Laporan Bulan (Semua fungsi lengkap dan diperbaiki) ---

function initLapbulUnggahPage() {
    initSubMenuPage(); 
    setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', 'getLapbulInfo');
}


function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    showAppModal('loading', 'Memuat daftar sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            const handleJenjangChange = () => {
                const selectedJenjang = jenjangSelect.value;
                const schoolList = schoolLists[selectedJenjang] || [];
                namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
                schoolList.forEach(school => {
                    namaSekolahSelect.add(new Option(school, school));
                });
                namaSekolahSelect.disabled = false;
            };
            jenjangSelect.addEventListener('change', handleJenjangChange);
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
        .getPaudSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) { // 300 KB Limit
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormPaud(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        let rombelInputsHTML = '';
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" value="0" min="0" required></div></div></div>`;
        }
        rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_rombel_tunggal_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_rombel_tunggal_P" value="0" min="0" required></div></div></div>`;
        let agamaInputsHTML = '';
        for (const ag of agama) {
            const agId = ag.toLowerCase();
            const isIslam = ag === 'Islam';
            agamaInputsHTML += `<div class="form-grid agama-row"><div class="form-group"><label>${ag}</label><select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}"><option value="Ada" ${isIslam ? 'selected' : ''}>Ada</option><option value="Tidak Ada" ${!isIslam ? 'selected' : ''}>Tidak Ada</option></select></div><div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isIslam ? 'grid' : 'none'};"><div class="form-group"><label>Laki-laki</label><input type="number" name="k${kelas}_agama_${agId}_L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="k${kelas}_agama_${agId}_P" value="0" min="0" required></div></div></div>`;
        }
        return `<div class="form-grid"><div class="form-group"><label>Jumlah Rombel Kelas ${kelas}</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="0">0</option><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option></select></div></div><h4 class="sub-section-title">Jumlah Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div><h4 class="sub-section-title">Jumlah Murid per Agama</h4><div class="agama-container">${agamaInputsHTML}</div>`;
    }
    function generatePtkNegeriHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Negeri)</legend>
      
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_ks_pns" value="0" min="0" max="1"></div>
            <div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_ks_pppk" value="0" min="0" max="1"></div>
        </div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kelas_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kelas_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kelas_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pai_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pai_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pai_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_pjok_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_pjok_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_pjok_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>PNS</label><input type="number" name="ptk_negeri_guru_kristen_pns" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_guru_kristen_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_guru_kristen_pppkpw" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTT</label><input type="number" name="ptk_negeri_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>

      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_operator_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_operator_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PPPK</label><input type="number" name="ptk_negeri_tendik_pengelola_pppk" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="ptk_negeri_tendik_pengelola_pppkpw" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTT</label><input type="number" name="ptk_negeri_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }

    function generatePtkSwastaHTML() {
    return `
    <fieldset class="ptk-fieldset">
      <legend>Data Jumlah PTK (Swasta)</legend>
      <fieldset class="ptk-sub-fieldset">
        <legend>Kepala Sekolah</legend>
        <div class="ptk-row ptk-grid-2">
            <div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_ks_gty" value="0" min="0" max="1"></div>
            <div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_ks_gtt" value="0" min="0" max="1"></div>
        </div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Guru</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Kelas</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kelas_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kelas_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PAI</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pai_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pai_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PJOK</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_pjok_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_pjok_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru PA Kristen</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_kristen_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_kristen_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_inggris_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_inggris_gtt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTY</label><input type="number" name="ptk_swasta_guru_lainnya_gty" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="ptk_swasta_guru_lainnya_gtt" value="0" min="0"></div></div>
      </fieldset>
      <fieldset class="ptk-sub-fieldset">
        <legend>Tenaga Kependidikan</legend>
        <div class="ptk-row has-label ptk-grid-4"><label>Operator</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_operator_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_operator_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pengelola Umum</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pengelola_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pengelola_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Penjaga Sekolah</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_penjaga_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_penjaga_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tenaga Administrasi</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_tas_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_tas_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Pustakawan</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_pustakawan_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_pustakawan_ptt" value="0" min="0"></div></div>
        <div class="ptk-row has-label ptk-grid-4"><label>Tendik Lainnya</label><div class="form-group"><label>PTY</label><input type="number" name="ptk_swasta_tendik_lainnya_pty" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="ptk_swasta_tendik_lainnya_ptt" value="0" min="0"></div></div>
      </fieldset>
    </fieldset>
    `;
    }
    
    (function setupInitialDropdowns() {
        const bulanSelect = form.querySelector('[name="laporanBulan"]');
        const tahunSelect = form.querySelector('[name="tahun"]');
        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
    })();

    function setupDataSekolah(schoolLists) {
        const statusSekolah = document.getElementById('statusSekolah');
        const namaSekolah = document.getElementById('namaSekolah');
        const ptkContainer = document.getElementById('ptk-section-container');
        ptkContainer.innerHTML = `<div id="ptk-negeri">${generatePtkNegeriHTML()}</div> <div id="ptk-swasta">${generatePtkSwastaHTML()}</div>`;
        const ptkNegeri = document.getElementById('ptk-negeri');
        const ptkSwasta = document.getElementById('ptk-swasta');
        ptkNegeri.style.display = 'none';
        ptkSwasta.style.display = 'none';
        statusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
            if (status === 'Negeri') {
                ptkNegeri.style.display = 'block';
                ptkSwasta.style.display = 'none';
            } else if (status === 'Swasta') {
                ptkNegeri.style.display = 'none';
                ptkSwasta.style.display = 'block';
            }
        });
    }

    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
            document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
        }
        tabsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('tab-link')) {
                document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                e.target.classList.add('active');
                document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block';
            }
        });
        contentContainer.addEventListener('change', function(e) {
            const target = e.target;
            if (target.classList.contains('rombel-toggle')) {
                const kelas = target.dataset.kelas;
                const count = parseInt(target.value, 10);
                document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                if (count === 1) {
                    document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block';
                } else if (count === 2) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                } else if (count === 3) {
                    document.getElementById(`rombel-${kelas}-A`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-B`).style.display = 'block';
                    document.getElementById(`rombel-${kelas}-C`).style.display = 'block';
                }
            }
            if (target.classList.contains('agama-toggle')) {
                const kelas = target.dataset.kelas;
                const agama = target.dataset.agama;
                const show = target.value === 'Ada';
                document.getElementById(`agama-input-${kelas}-${agama}`).style.display = show ? 'grid' : 'none';
            }
        });
    }

    showAppModal('loading', 'Memuat data sekolah...');
    google.script.run
        .withSuccessHandler(schoolLists => {
            setupDataSekolah(schoolLists);
            setupDataMurid();
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat data sekolah: ${err.message}`))
        .getSdSchoolLists();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Mengirim data dan mengunggah file...');
        const file = document.getElementById('fileLapbul').files[0];
        if (!file || file.size > 300 * 1024) {
            showAppModal('error', 'File PDF dengan ukuran maksimal 300 KB harus dipilih.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = Object.fromEntries(new FormData(form));
            formData.fileData = fileData;
            google.script.run
                .withSuccessHandler(response => showAppModal('success', response, 'lapbul_riwayat'))
                .withFailureHandler(error => {
                    showAppModal('error', `Gagal: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormSd(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initLapbulRiwayatPage() {
    initializeGenericTablePage({
        tableId: 'lapbulRiwayatTable', // ID tabel dari page_lapbul_riwayat.html
        serverFunction: 'getLapbulRiwayatData', // Nama fungsi BARU di code.gs
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun', sortReverse: true },
            { id: 'filterBulan', dataColumn: 'Bulan', specialSort: 'bulan' }, // Gunakan pengurutan bulan khusus
            { id: 'filterJenjang', dataColumn: 'Jenjang' },
            { id: 'filterNamaSekolah', dataColumn: 'Nama Sekolah' }
        ]
    });
}

function initLapbulStatusPage() {
    initializeGenericTablePage({
        tableId: 'lapbulStatusTable', // ID tabel dari page_lapbul_status.html
        serverFunction: 'getLapbulStatusData', // Nama fungsi BARU di code.gs
        filterConfig: [
            { id: 'filterTahun', dataColumn: '_filterTahun', sortReverse: true },
            { id: 'filterJenjang', dataColumn: '_filterJenjang' },
            { id: 'filterStatus', dataColumn: '_filterStatus' }
        ]
    });
}

function initLapbulArsipPage() {
    const FOLDER_IDS = {
        'KB': '18CxRT-eledBGRtHW1lFd2AZ8Bub6q5ra',
        'TK': '1WUNz_BSFmcwRVlrG67D2afm9oJ-bVI9H',
        'SD': '1I8DRQYpBbTt1mJwtD1WXVD6UK51TC8El'
    };

    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;

            if (index < breadcrumbTrail.length - 1) {
                // --- PERBAIKAN LOGIKA DI SINI ---
                span.onclick = () => {
                    breadcrumbTrail.length = index; // Potong breadcrumb ke posisi yang diklik
                    // Cek apakah yang diklik adalah level root "Jenjang"
                    if (item.type === 'root') {
                        renderJenjangView(); // Jika ya, panggil fungsi untuk menampilkan jenjang
                    } else {
                        renderFolderView(item.id, item.name); // Jika tidak, panggil fungsi untuk folder biasa
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderJenjangView() {
        viewContainer.classList.remove('view-container-scrollable');
        // Saat kembali ke jenjang, reset breadcrumb ke kondisi awal
        breadcrumbTrail = [{ name: 'Jenjang', type: 'root', id: null }];
        updateBreadcrumb();
        viewContainer.innerHTML = '<div class="card-grid"></div>';
        const cardGrid = viewContainer.querySelector('.card-grid');
        
        const jenjang = [
            { name: 'KB', icon: 'fa-cubes', color: '#3498db' },
            { name: 'TK', icon: 'fa-shapes', color: '#9b59b6' },
            { name: 'SD', icon: 'fa-school', color: '#e74c3c' }
        ];

        jenjang.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `<i class="fas ${item.icon}" style="color: ${item.color};"></i><span>${item.name}</span>`;
            card.onclick = () => renderFolderView(FOLDER_IDS[item.name], item.name);
            cardGrid.appendChild(card);
        });
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        // Hanya tambahkan ke breadcrumb jika belum ada
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    renderJenjangView();
}

function initLapbulKelolaPage() {
    initializeGenericTablePage({
        tableId: 'lapbulKelolaTable',
        serverFunction: 'getLapbulKelolaData',
        // 'editPage' di sini dinamis, kita akan tangani di dalam buildTable
        filterConfig: [
            { id: 'filterTahun', dataColumn: 'Tahun', sortReverse: true },
            { id: 'filterJenjang', dataColumn: 'Jenjang' },
            { id: 'filterNamaSekolah', dataColumn: 'Nama Sekolah' }
        ]
    });

    // Fungsi untuk menampilkan konfirmasi hapus (langkah 1)
    window.showDeleteConfirmation = (button) => {
        const rowInfo = JSON.parse(button.dataset.rowInfo);
        const modal = document.getElementById('deleteModal');
        if (!modal) return;

        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        const cancelBtn = modal.querySelector('#cancelDeleteBtn');

        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Yakin ingin menghapus Laporan Bulan ini?</p>
                             <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                               Sekolah: ${rowInfo['Nama Sekolah']}<br>
                               Bulan: ${rowInfo['Bulan']} ${rowInfo['Tahun']}
                             </div>`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => showDeletePrompt(rowInfo);

        cancelBtn.onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    };

    // Fungsi untuk meminta kode hapus (langkah 2)
    function showDeletePrompt(rowInfo) {
        const modal = document.getElementById('deleteModal');
        // ... (Kode ini sama seperti di initSkKelolaPage, jadi tidak perlu diubah jika sudah ada) ...
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');

        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p><input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => processDeletion(rowInfo);
        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }

    // Fungsi untuk memproses penghapusan ke server (langkah 3)
    function processDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { 
            showAppModal('error', 'Kode hapus tidak boleh kosong.');
            return; 
        }
        showAppModal('loading', 'Menghapus data dan file terkait...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'lapbul_kelola');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deleteLapbulData(rowInfo._rowIndex, rowInfo._source, deleteCode); // Menggunakan _rowIndex dan _source
    }
}

function initLapbulEditPaudPage(params) {
    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    const form = document.getElementById('lapbulEditFormPaud');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');
    
    const lockField = (fieldName) => {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) {
            field.disabled = true;
            field.style.backgroundColor = 'rgba(0,0,0,0.3)';
            field.style.cursor = 'not-allowed';
            if (field.tagName === 'INPUT') field.readOnly = true;
        }
    };

    google.script.run
        .withSuccessHandler(rowData => {
            if (!rowData || Object.keys(rowData).length === 0) {
                loadingDiv.innerHTML = `<p style="color:red;">Gagal: Data untuk baris ${params.rowIndex} tidak ditemukan.</p>`;
                return;
            }
            
            form.querySelector('[name="rowIndex"]').value = params.rowIndex;

            const bulanSelect = form.querySelector('[name="Bulan"]');
            const tahunSelect = form.querySelector('[name="Tahun"]');
            const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            bulanSelect.innerHTML = bulanOptions.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            tahunSelect.innerHTML = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}">${y}</option>`).join('');
            
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) field.value = rowData[key];
            }
            
            lockField('Bulan');
            lockField('Tahun');
            lockField('Status');
            lockField('Jenjang');
            lockField('Nama Sekolah');

            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData['Dokumen']) {
                 fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`;
            } else {
                 fileLinkContainer.innerHTML = 'Tidak ada file.';
            }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';
        })
        .withFailureHandler(err => {
            loadingDiv.innerHTML = `<p style="color:red;">Gagal memuat data baris: ${err.message}</p>`;
        })
        .getLapbulDataByRow(params.rowIndex, params.source);

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        
        // Ambil nilai dari field yang terkunci secara manual
        payload.laporanBulan = form.querySelector('[name="Bulan"]').value;
        payload.tahun = form.querySelector('[name="Tahun"]').value;
        payload.jenjang = form.querySelector('[name="Jenjang"]').value;
        payload.namaSekolah = form.querySelector('[name="Nama Sekolah"]').value;

        const file = form.querySelector('input[type="file"]').files[0];

        const sendData = (data) => {
            google.script.run
                // KUNCI PERBAIKAN: Logika ini disamakan dengan fungsi edit SD
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         showAppModal('error', res.error);
                         if (submitButton) submitButton.disabled = false;
                    } else {
                         showAppModal('success', res, 'lapbul_kelola');
                    }
                })
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    if (submitButton) submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
    });
}

function initLapbulEditSdPage(params) {
    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    const form = document.getElementById('lapbulEditFormSd');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');

    // --- SEMUA FUNGSI BANTU SEKARANG ADA DI DALAM SATU FUNGSI INI ---
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        let rombelInputsHTML = `<div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} P" value="0" min="0" required></div></div></div>`;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas}${rombel} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas}${rombel} P" value="0" min="0" required></div></div></div>`;
        }
        let agamaInputsHTML = '';
        for (const ag of agama) {
            const agId = ag;
            agamaInputsHTML += `<div class="form-grid agama-row"><div class="form-group"><label>${ag}</label><select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}"><option value="Ada">Ada</option><option value="Tidak Ada" selected>Tidak Ada</option></select></div><div class="agama-input-pair" id="agama-input-${kelas}-${agId}" style="display: none;"><div class="form-group"><label>Laki-laki</label><input type="number" name="K${kelas} ${agId} L" value="0" min="0" required></div><div class="form-group"><label>Perempuan</label><input type="number" name="K${kelas} ${agId} P" value="0" min="0" required></div></div></div>`;
        }
        return `<div class="form-grid"><div class="form-group"><label>Jumlah Rombel Kelas ${kelas}</label><select class="rombel-toggle" name="Rombel ${kelas}" data-kelas="${kelas}"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div></div><h4 class="sub-section-title">Jumlah Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}">${rombelInputsHTML}</div><h4 class="sub-section-title">Jumlah Murid per Agama</h4><div class="agama-container">${agamaInputsHTML}</div>`;
    }
    function generatePtkNegeriHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Negeri)</legend><fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2"><div class="form-group"><label>PNS</label><input type="number" name="KS PNS" value="0" min="0" max="1"></div><div class="form-group"><label>PPPK</label><input type="number" name="KS PPPK" value="0" min="0" max="1"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Guru</legend><div class="ptk-row has-label"><label>Guru Kelas</label><div class="form-group"><label>PNS</label><input type="number" name="GK PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GK PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GK PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PAI</label><div class="form-group"><label>PNS</label><input type="number" name="GPAI PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPAI PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPAI PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPAI GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PJOK</label><div class="form-group"><label>PNS</label><input type="number" name="GPJOK PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPJOK PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPJOK PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPJOK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PA Kristen</label><div class="form-group"><label>PNS</label><input type="number" name="GPAKris PNS" value="0" min="0"></div><div class="form-group"><label>PPPK</label><input type="number" name="GPAKris PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="GPAKris PPPK PW" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="GPAKris GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTT</label><input type="number" name="GTT Inggris" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTT</label><input type="number" name="GTT Lain" value="0" min="0"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend><div class="ptk-row has-label"><label>Operator</label><div class="form-group"><label>PPPK</label><input type="number" name="OLO PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="OLO PPPK PW" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="OLO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pengelola Umum</label><div class="form-group"><label>PPPK</label><input type="number" name="PUO PPPK" value="0" min="0"></div><div class="form-group"><label>PPPK PW</label><input type="number" name="PUO PPPK PW" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="PUO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Penjaga Sekolah</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Penjaga" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tenaga Administrasi</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Admin" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pustakawan</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Perpus" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tendik Lainnya</label><div class="form-group"><label>PTT</label><input type="number" name="PTT Lain" value="0" min="0"></div></div></fieldset></fieldset>`;
    }
    function generatePtkSwastaHTML() {
        return `<fieldset class="ptk-fieldset"><legend>Data Jumlah PTK (Swasta)</legend><fieldset class="ptk-sub-fieldset"><legend>Kepala Sekolah</legend><div class="ptk-row ptk-grid-2"><div class="form-group"><label>GTY</label><input type="number" name="SDS KS GTY" value="0" min="0" max="1"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS KS GTT" value="0" min="0" max="1"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Guru</legend><div class="ptk-row has-label"><label>Guru Kelas</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GK GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PAI</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GPAI GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GPAI GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PJOK</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GPJOK GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GPJOK GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru PA Kristen</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GKRIS GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GKRIS GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Bhs. Inggris</label><div class="form-group"><label>GTY</label><input type="number" name="SDS ING GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS ING GTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Guru Mapel Lainnya</label><div class="form-group"><label>GTY</label><input type="number" name="SDS GLAIN GTY" value="0" min="0"></div><div class="form-group"><label>GTT</label><input type="number" name="SDS GLAIN GTT" value="0" min="0"></div></div></fieldset><fieldset class="ptk-sub-fieldset"><legend>Tenaga Kependidikan</legend><div class="ptk-row has-label"><label>Operator</label><div class="form-group"><label>PTY</label><input type="number" name="SDS OLO PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS OLO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pengelola Umum</label><div class="form-group"><label>PTY</label><input type="number" name="SDS PUO PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS PUO PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Penjaga Sekolah</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Penjaga PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Penjaga PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tenaga Administrasi</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Admin PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Admin PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Pustakawan</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Perpus PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Perpus PTT" value="0" min="0"></div></div><div class="ptk-row has-label"><label>Tendik Lainnya</label><div class="form-group"><label>PTY</label><input type="number" name="SDS Tendik Lain PTY" value="0" min="0"></div><div class="form-group"><label>PTT</label><input type="number" name="SDS Tendik Lain PTT" value="0" min="0"></div></div></fieldset></fieldset>`;
    }
    function setupFormUI() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        tabsContainer.innerHTML = ''; contentContainer.innerHTML = '';
        for (let i = 1; i <= 6; i++) {
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            const content = document.createElement('div');
            content.id = `kelas-content-${i}`; content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i);
            contentContainer.appendChild(content);
        }
        tabsContainer.addEventListener('click', function(e) { if (e.target.classList.contains('tab-link')) { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none'); e.target.classList.add('active'); document.getElementById(`kelas-content-${e.target.dataset.kelas}`).style.display = 'block'; } });
        contentContainer.addEventListener('change', function(e) { 
            const t = e.target; 
            if (t.classList.contains('rombel-toggle')) { 
                const k = t.dataset.kelas, c = parseInt(t.value, 10); 
                document.querySelectorAll(`#rombel-container-${k} .rombel-input-group`).forEach(el => el.style.display = 'none'); 
                if (c === 1) { 
                    document.getElementById(`rombel-${k}-Tunggal`).style.display = 'block'; 
                } else if (c > 1) { 
                    ['A', 'B', 'C'].slice(0, c).forEach(r => {
                        const rombelEl = document.getElementById(`rombel-${k}-${r}`);
                        if (rombelEl) rombelEl.style.display = 'block';
                    });
                } 
            } 
            if (t.classList.contains('agama-toggle')) { 
                document.getElementById(`agama-input-${t.dataset.kelas}-${t.dataset.agama}`).style.display = t.value === 'Ada' ? 'grid' : 'none'; 
            } 
        });
        document.getElementById('ptk-section-container').innerHTML = `<div id="ptk-negeri" style="display:none;">${generatePtkNegeriHTML()}</div><div id="ptk-swasta" style="display:none;">${generatePtkSwastaHTML()}</div>`;
    }
    function lockField(fieldName) {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) { field.disabled = true; field.style.cssText = 'background-color: rgba(0,0,0,0.3); cursor: not-allowed;'; if (field.tagName === 'INPUT') field.readOnly = true; }
    }

    // --- PROSES UTAMA ---
    setupFormUI();

    google.script.run
        .withSuccessHandler(rowData => {
            if (!rowData || Object.keys(rowData).length === 0) {
                loadingDiv.innerHTML = `<p style="color:red;">Gagal: Data untuk baris ${params.rowIndex} tidak ditemukan.</p>`;
                return;
            }

            form.querySelector('[name="rowIndex"]').value = params.rowIndex;
            
            for (const header in rowData) {
                const fieldName = header.trim();
                const field = form.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    let value = rowData[header];
                    if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                        value = '0';
                    }
                    field.value = value;
                }
            }
            
            const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
            for (let i = 1; i <= 6; i++) {
                agama.forEach(ag => {
                    const L = parseInt(rowData[`K${i} ${ag} L`] || 0, 10);
                    const P = parseInt(rowData[`K${i} ${ag} P`] || 0, 10);
                    const selectAgama = form.querySelector(`.agama-toggle[data-kelas="${i}"][data-agama="${ag}"]`);
                    if (selectAgama) {
                        selectAgama.value = (L + P > 0) ? 'Ada' : 'Tidak Ada';
                    }
                });
            }

            form.querySelectorAll('select').forEach(select => {
                select.dispatchEvent(new Event('change', { bubbles: true }));
            });

            const bulanSelect = form.querySelector('[name="Bulan"]');
            const tahunSelect = form.querySelector('[name="Tahun"]');
            const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            bulanSelect.innerHTML = bulanOptions.map(m => `<option value="${m}">${m}</option>`).join('');
            const currentYear = new Date().getFullYear();
            tahunSelect.innerHTML = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2].map(y => `<option value="${y}">${y}</option>`).join('');
            bulanSelect.value = rowData['Bulan'];
            tahunSelect.value = rowData['Tahun'];

            if (rowData['Status'] === 'Negeri') {
                document.getElementById('ptk-negeri').style.display = 'block';
            } else if (rowData['Status'] === 'Swasta') {
                document.getElementById('ptk-swasta').style.display = 'block';
            }

            lockField('Bulan'); lockField('Tahun'); lockField('Status'); lockField('Nama Sekolah');
            
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData['Dokumen']) { fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`; } else { fileLinkContainer.innerHTML = 'Tidak ada file.'; }

            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';
        })
        .withFailureHandler(err => { loadingDiv.innerHTML = `<p style="color:red;">Gagal memuat data baris: ${err.message}</p>`; })
        .getLapbulDataByRow(params.rowIndex, params.source);

    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');
        
        const payload = {};
        const allFields = form.querySelectorAll('input, select, textarea');
        allFields.forEach(field => {
            if (field.name) {
                payload[field.name] = field.value;
            }
        });
        
        payload.laporanBulan = form.querySelector('[name="Bulan"]').value;
        payload.tahun = form.querySelector('[name="Tahun"]').value;
        payload.namaSekolah = form.querySelector('[name="Nama Sekolah"]').value;

        const file = form.querySelector('input[type="file"]').files[0];

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         showAppModal('error', res.error);
                         if (submitButton) submitButton.disabled = false;
                    } else {
                         showAppModal('success', res, 'lapbul_kelola');
                    }
                })
                .withFailureHandler(err => {
                    showAppModal('error', err.message);
                    if (submitButton) submitButton.disabled = false;
                })
                .updateLapbulData(data);
        };

        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(payload);
        }
      });
  }

function initLapbulUnduhFormatPage() {
    // Jalankan animasi untuk tombol Unduh
    initSubMenuPage();

    const infoBtn = document.getElementById('infoDropdownBtn');
    const contentDiv = document.getElementById('infoDropdownContent');

    if (!infoBtn || !contentDiv) return;

    let isDataLoaded = false;

    infoBtn.onclick = function() {
        // Toggle (buka/tutup) dropdown
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";

        // Jika dropdown dibuka dan data belum dimuat, panggil server
        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    // Sesuaikan kembali tinggi dropdown setelah konten dimuat
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                .getUnduhFormatInfo();
        }
    };
}

// --- Modul Data PTK ---

function initPtkKeadaanPaudPage() {
    initializeGenericTablePage({
        tableId: 'keadaanPtkPaudTable',
        serverFunction: 'getKeadaanPtkPaudData',
        filterConfig: [
            { id: 'filterJenjang', dataColumn: '_filterJenjang' }
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga', // Kolom untuk teks "JUMLAH"
            sumStartColumn: 'Jumlah Rombel' // Kolom pertama untuk mulai menjumlahkan
        }
    });
}

function initPtkKeadaanSdPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], filterIndices = {}, currentFilteredRows = [];
    
    function buildTable() {
        const table = document.getElementById('keadaanPtkSdTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';

        for (let i = 0; i < headerRow1.length; i++) {
            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 1;
                while ((i + colspan) < headerRow1.length && (headerRow1[i + colspan] === '' || headerRow1[i + colspan] === null)) {
                    colspan++;
                }
                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    for (let j = 0; j < colspan; j++) {
                        secondRowHTML += `<th>${headerRow2[i + j]}</th>`;
                    }
                    i += colspan - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        if (currentFilteredRows.length === 0) {
            const colspan = headerRow2.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell) => {
                bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        const totals = new Array(headerRow2.length).fill(0);
        currentFilteredRows.forEach(row => {
            for (let i = 4; i < headerRow2.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });
        
        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td><td>-</td><td>-</td><td>-</td>';
        for (let i = 4; i < totals.length; i++) {
            totalRowHTML += `<td>${totals[i] || '-'}</td>`;
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatusSekolah').value;
        currentFilteredRows = allDataRows.filter(row => {
            const statusIndex = filterIndices.status;
            return (filterStatus === "") || (statusIndex === -1) || (String(row[statusIndex]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak lengkap atau tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);

        filterIndices = { status: headerRow1.indexOf('Status') };
        if (filterIndices.status === -1) {
           filterIndices.status = headerRow2.indexOf('Status');
        }
        
        const statusSelect = document.getElementById('filterStatusSekolah');
        if (statusSelect && filterIndices.status !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterIndices.status])))].filter(Boolean);
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => { 
                if(val && val.trim() !== '') statusSelect.add(new Option(val, val)); 
            });
            statusSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        document.querySelector('.filter-container').style.display = 'flex';
        // KUNCI PERBAIKAN 2: Mengubah 'block' menjadi 'flex' agar sesuai dengan CSS
        tableWrapper.style.display = 'flex'; 
        
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKeadaanPtkSdData();
}

function initPtkJumlahBulananPaudPage() {
    initializeGenericTablePage({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunction: 'getPtkJumlahBulananPaudData',
        filterConfig: [
            { id: 'filterTahun', dataColumn: '_filterTahun', sortReverse: true },
            { id: 'filterBulan', dataColumn: '_filterBulan', specialSort: 'bulan' },
            { id: 'filterJenjang', dataColumn: '_filterJenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              dependsOn: 'filterJenjang',
              dependencyColumn: '_filterJenjang'
            }
        ],
        // **TAMBAHKAN KONFIGURASI BARU INI**
        defaultFilters: [
            {
                id: 'filterTahun',
                value: () => new Date().getFullYear().toString()
            },
            {
                id: 'filterBulan',
                value: () => {
                    const d = new Date();
                    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
                    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                    return monthNames[prevMonthIndex];
                }
            }
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkDaftarPaudPage() {
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
    let filterIndices = {};
    let hiddenColumnIndices = [];

    // [PERBAIKAN FINAL] Menggunakan metode perhitungan dari halaman 'Kelola PTK PAUD'
    function calculateRowsPerPage() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 37; // Ketinggian baris tetap sebagai dasar pembagian
        
        // Menghitung sisa ruang dengan mengurangi posisi atas tabel dari total tinggi jendela
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 160; 
        
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tableBody = document.getElementById('daftarPtkPaudTable').querySelector('tbody');
        if (!tableBody) return;

        const visibleColsCount = headerCols.length - hiddenColumnIndices.length;
        
        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            paginatedRows.forEach((cols, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${start + index + 1}</td>`;
                cols.forEach((cellData, i) => {
                    if (hiddenColumnIndices.includes(i)) return;
                    tr.innerHTML += `<td>${cellData || '-'}</td>`;
                });
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«'; prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»'; nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }
    
    function applyFilters() {
        const filterJenjang = document.getElementById('filterJenjang').value;
        const filterNamaLembaga = document.getElementById('filterNamaLembaga').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        currentFilteredRows = allDataRows.filter(cols => {
            const jenjangMatch = (filterJenjang === "") || (String(cols[filterIndices.jenjang]) === filterJenjang);
            const namaLembagaMatch = (filterNamaLembaga === "") || (String(cols[filterIndices.namaLembaga]) === filterNamaLembaga);
            const statusMatch = (filterStatus === "") || (String(cols[filterIndices.status]) === filterStatus);
            return jenjangMatch && namaLembagaMatch && statusMatch;
        });
        currentPage = 1;
        buildTable();
    }
    
    function updateNamaLembagaFilter() {
        const jenjangFilter = document.getElementById('filterJenjang').value;
        const namaLembagaFilter = document.getElementById('filterNamaLembaga');
        
        const filteredData = (jenjangFilter === "") ? allDataRows : allDataRows.filter(row => row[filterIndices.jenjang] === jenjangFilter);
        const uniqueLembaga = [...new Set(filteredData.map(row => row[filterIndices.namaLembaga]))].filter(Boolean).sort();
        
        namaLembagaFilter.innerHTML = '<option value="">Semua</option>';
        uniqueLembaga.forEach(nama => namaLembagaFilter.add(new Option(nama, nama)));
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('daftarPtkPaudTable').querySelector('thead');
        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        
        filterIndices = { jenjang: 0, namaLembaga: 1, status: 3 };
        hiddenColumnIndices = [0, 1, 3];
        
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.filter((h, i) => !hiddenColumnIndices.includes(i)).map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = ''; tableHead.appendChild(headerRow);
        
        const jenjangSelect = document.getElementById('filterJenjang');
        const uniqueJenjang = [...new Set(allDataRows.map(row => row[filterIndices.jenjang]))].filter(Boolean).sort();
        jenjangSelect.innerHTML = `<option value="">Semua</option>`;
        uniqueJenjang.forEach(val => jenjangSelect.add(new Option(val, val)));

        const statusSelect = document.getElementById('filterStatus');
        const uniqueStatus = [...new Set(allDataRows.map(row => row[filterIndices.status]))].filter(Boolean).sort();
        statusSelect.innerHTML = `<option value="">Semua</option>`;
        uniqueStatus.forEach(val => statusSelect.add(new Option(val, val)));
        statusSelect.addEventListener('change', applyFilters);

        jenjangSelect.addEventListener('change', () => {
            updateNamaLembagaFilter();
            applyFilters();
        });
        document.getElementById('filterNamaLembaga').addEventListener('change', applyFilters);

        updateNamaLembagaFilter();
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        
        // Panggil kalkulasi setelah semua elemen filter dan tabel siap
        rowsPerPage = calculateRowsPerPage();
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => { document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`; })
        .getDaftarPtkPaudData();
}

function initPtkKelolaPaudPage() {
    let allDataRows = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    // KUNCI PERBAIKAN: Fungsi showDeleteConfirmationPtk dipindahkan ke dalam lingkup yang benar
    function showDeleteConfirmationPtk(rowInfo) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Apakah Anda yakin ingin menghapus data PTK ini?</p>
                             <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                               Nama: ${rowInfo.data['Nama']}<br>Lembaga: ${rowInfo.data['Nama Lembaga']}
                             </div>`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => showDeletePromptPtk(rowInfo);

        modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }

    // KUNCI PERBAIKAN: Fungsi showDeletePromptPtk dipindahkan ke dalam lingkup yang benar
    function showDeletePromptPtk(rowInfo) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');

        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Hubungi admin Korwil untuk mendapatkan kode.</p>
                             <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => processFinalPtkDeletion(rowInfo);

        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }

    // KUNCI PERBAIKAN: Fungsi processFinalPtkDeletion dipindahkan ke dalam lingkup yang benar
    function processFinalPtkDeletion(rowInfo) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) {
            alert('Kode hapus tidak boleh kosong.');
            return;
        }

        showAppModal('loading', 'Menghapus data...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deletePtkPaudData(rowInfo.rowIndex, deleteCode);
    }

    function calculateRowsPerPage() {
        const tableContainer = document.querySelector('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 37;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 160;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tbody = document.querySelector('#kelolaPtkPaudTable tbody');
        tbody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const paginated = currentFilteredRows.slice(start, start + rowsPerPage);

        if (paginated.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9">Tidak ada data yang cocok.</td></tr>`;
            return;
        }

        paginated.forEach((rowInfo, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${start + index + 1}</td>
                <td>${rowInfo.data['Nama'] || '-'}</td>
                <td>${rowInfo.data['Nama Lembaga'] || '-'}</td>
                <td>${rowInfo.data['Status'] || '-'}</td>
                <td>${rowInfo.data['NIP/NIY'] || '-'}</td>
                <td>${rowInfo.data['Jabatan'] || '-'}</td>
                <td class="action-buttons">
                    <button class="action-btn edit-btn"><i class="fas fa-pencil-alt"></i> Edit</button>
                    <button class="action-btn delete-btn"><i class="fas fa-trash"></i> Hapus</button>
                </td>
                <td>${rowInfo.data['Tanggal Input'] || '-'}</td>
                <td>${rowInfo.data['Update'] || '-'}</td>
            `;
            
            tr.querySelector('.edit-btn').onclick = (e) => loadPage(e, 'ptk_edit_paud', { rowIndex: rowInfo.rowIndex });
            tr.querySelector('.delete-btn').onclick = () => showDeleteConfirmationPtk(rowInfo);

            tbody.appendChild(tr);
        });

        setupPagination();
    }

    function setupPagination() {
        const container = document.getElementById('pagination-container');
        container.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { container.style.display = 'none'; return; }
        container.style.display = 'flex';

        const prev = document.createElement('button');
        prev.textContent = '«';
        prev.className = 'page-btn';
        prev.disabled = currentPage === 1;
        prev.onclick = () => { currentPage--; buildTable(); };

        const info = document.createElement('span');
        info.className = 'page-info';
        info.textContent = `Halaman ${currentPage} dari ${pageCount}`;

        const next = document.createElement('button');
        next.textContent = '»';
        next.className = 'page-btn';
        next.disabled = currentPage === pageCount;
        next.onclick = () => { currentPage++; buildTable(); };

        container.append(prev, info, next);
    }

    function updateNamaLembagaFilter() {
        const jenjang = document.getElementById('filterJenjang').value;
        const lembagaSelect = document.getElementById('filterNamaLembaga');
        const filtered = (jenjang === "") ? allDataRows : allDataRows.filter(r => r.data['Jenjang'] === jenjang);
        const lembaga = [...new Set(filtered.map(r => r.data['Nama Lembaga']))].filter(Boolean).sort();

        const currentSelection = lembagaSelect.value;
        lembagaSelect.innerHTML = '<option value="">Semua Lembaga</option>';
        lembaga.forEach(nama => lembagaSelect.add(new Option(nama, nama)));
        if ([...lembagaSelect.options].some(opt => opt.value === currentSelection)) {
            lembagaSelect.value = currentSelection;
        }
    }

    function applyFilters() {
        const jenjang = document.getElementById('filterJenjang').value;
        const lembaga = document.getElementById('filterNamaLembaga').value;

        currentFilteredRows = allDataRows.filter(r =>
            (jenjang === "" || r.data['Jenjang'] === jenjang) &&
            (lembaga === "" || r.data['Nama Lembaga'] === lembaga)
        );

        currentPage = 1;
        buildTable();
    }

    function initializePage(serverData) {
        const loading = document.getElementById('loadingStatus');
        const wrapper = document.getElementById('tableWrapper');
        const thead = document.querySelector('#kelolaPtkPaudTable thead');

        loading.style.display = 'none';
        wrapper.style.display = 'block';

        if (serverData.error || !serverData.rows) {
            wrapper.innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data: ${serverData.error || 'Data tidak ditemukan.'}</p>`;
            return;
        }

        allDataRows = serverData.rows;

        const finalHeaders = ['No.', 'Nama', 'Nama Lembaga', 'Status', 'NIP/NIY', 'Jabatan', 'Aksi', 'Tanggal Input', 'Update'];
        thead.innerHTML = `<tr>${finalHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
        rowsPerPage = calculateRowsPerPage();

        if (allDataRows.length > 0) {
            const jenjangSelect = document.getElementById('filterJenjang');
            const uniqueJenjang = [...new Set(allDataRows.map(r => r.data['Jenjang']))].filter(Boolean).sort();
            jenjangSelect.innerHTML = '<option value="">Semua Jenjang</option>';
            uniqueJenjang.forEach(j => jenjangSelect.add(new Option(j, j)));

            jenjangSelect.addEventListener('change', () => {
                updateNamaLembagaFilter();
                applyFilters();
            });
            document.getElementById('filterNamaLembaga').addEventListener('change', applyFilters);
            updateNamaLembagaFilter();
        }
        
        // KUNCI PERBAIKAN 3: Menambahkan event listener ke tombol Tambah
        document.getElementById('tambahPtkBtn').addEventListener('click', (e) => {
            loadPage(e, 'ptk_tambah_paud');
        });

        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(err => {
            const loading = document.getElementById('loadingStatus');
            loading.style.display = 'none';
            document.getElementById('tableWrapper').style.display = 'block';
            document.getElementById('tableWrapper').innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data dari server: ${err.message}</p>`;
        })
        .getKelolaPtkPaudData();
}

function initPtkTambahPaudPage() {
    const form = document.getElementById('addPtkPaudForm');
    if (!form) return;

    showAppModal('loading', 'Memuat opsi formulir...');

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }

            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            const statusSelect = form.querySelector('#status');
            const jabatanSelect = form.querySelector('#jabatan');

            // Isi dropdown Jenjang
            jenjangSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang --</option>';
            options['Jenjang'].forEach(j => jenjangSelect.add(new Option(j, j)));

            // Isi dropdown Status
            statusSelect.innerHTML = '<option value="" disabled selected>-- Pilih Status --</option>';
            options['Status'].forEach(s => statusSelect.add(new Option(s, s)));

            // Isi dropdown Jabatan
            jabatanSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jabatan --</option>';
            options['Jabatan'].forEach(j => jabatanSelect.add(new Option(j, j)));

            // Logika untuk mengubah Nama Lembaga berdasarkan Jenjang
            jenjangSelect.addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });
            
            document.getElementById('appModal').classList.remove('show'); // Sembunyikan modal loading
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkPaudOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkPaud(formData);
    });
}

function initPtkEditPaudPage(params) {
    const form = document.getElementById('editPtkPaudForm');
    const loadingDiv = document.getElementById('loading-data');
    if (!form || !params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;

    // 1. Ambil semua opsi dropdown
    google.script.run.withSuccessHandler(options => {
        // 2. Ambil data spesifik untuk baris ini
        google.script.run.withSuccessHandler(rowData => {
            if (options.error || rowData.error) {
                showAppModal('error', options.error || rowData.error);
                return;
            }

            // --- Isi semua dropdown dengan opsi dari server ---
            const jenjangSelect = form.querySelector('#jenjang');
            jenjangSelect.innerHTML = '<option value="" disabled>-- Pilih Jenjang --</option>';
            options['Jenjang'].forEach(j => jenjangSelect.add(new Option(j, j)));

            ['Status', 'Jabatan'].forEach(key => {
                const select = form.querySelector(`#${key.toLowerCase()}`);
                select.innerHTML = `<option value="" disabled>-- Pilih ${key} --</option>`;
                options[key].forEach(opt => select.add(new Option(opt, opt)));
            });
            
            // --- Isi form dengan data yang ada ---
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = rowData[key];
                }
            }
            
            // --- Atur dropdown Nama Lembaga ---
            const lembagaSelect = form.querySelector('#namaLembaga');
            const selectedJenjang = jenjangSelect.value;
            const lembagaOptions = options['Nama Lembaga'][selectedJenjang] || [];
            lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
            lembagaSelect.value = rowData['Nama Lembaga']; // Set nilai yang sudah tersimpan

            // Tambahkan event listener untuk mengubah lembaga jika jenjang diubah
            jenjangSelect.addEventListener('change', function() {
                const newJenjang = this.value;
                const newLembagaOptions = options['Nama Lembaga'][newJenjang] || [];
                lembagaSelect.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
                newLembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });

            // Sembunyikan loading dan tampilkan form
            loadingDiv.style.display = 'none';
            form.style.display = 'block';

        }).withFailureHandler(err => showAppModal('error', `Gagal mengambil data baris: ${err.message}`)).getPtkPaudDataByRow(params.rowIndex);
    }).withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`)).getNewPtkPaudOptions();

    // Logika saat form disubmit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkPaudData(formData);
    });
}

function initPtkJumlahBulananSdPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], filterIndices = {}, currentFilteredRows = [];
    
    function buildTable() {
        const table = document.getElementById('jumlahPtkSdBulananTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';

        for (let i = 0; i < headerRow1.length; i++) {
            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 1;
                while ((i + colspan) < headerRow1.length && (headerRow1[i + colspan] === '' || headerRow1[i + colspan] === null)) {
                    colspan++;
                }
                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    for (let j = 0; j < colspan; j++) {
                        secondRowHTML += `<th>${headerRow2[i + j]}</th>`;
                    }
                    i += colspan - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        if (currentFilteredRows.length === 0) {
            const colspan = headerRow2.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell) => {
                bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        const totals = new Array(headerRow2.length).fill(0);
        currentFilteredRows.forEach(row => {
            for (let i = 5; i < headerRow2.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });
        
        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td><td>-</td><td>-</td><td>-</td><td>-</td>';
        for (let i = 5; i < totals.length; i++) {
            totalRowHTML += `<td>${totals[i] || '-'}</td>`;
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterBulan = document.getElementById('filterBulan').value;
        const filterStatus = document.getElementById('filterStatusSekolah').value;

        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (String(row[filterIndices.tahun]) === filterTahun);
            const bulanMatch = (filterBulan === "") || (String(row[filterIndices.bulan]) === filterBulan);
            const statusMatch = (filterStatus === "") || (String(row[filterIndices.status]) === filterStatus);
            return tahunMatch && bulanMatch && statusMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak lengkap atau tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);

        filterIndices = { 
            status: headerRow1.indexOf('Status'),
            tahun: headerRow1.indexOf('Tahun'),
            bulan: headerRow1.indexOf('Bulan')
        };
        
        const populateFilter = (elementId, colIndex, specialSort = null) => {
            const select = document.getElementById(elementId);
            if (!select || colIndex === -1) return;
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[colIndex])))].filter(Boolean);
            select.innerHTML = `<option value="">Semua</option>`;
            
            let sortedValues;
            if (specialSort === 'bulan') {
                const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                sortedValues = uniqueValues.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            } else {
                sortedValues = uniqueValues.sort();
                if (specialSort === 'reverse') sortedValues.reverse();
            }

            sortedValues.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterTahun', filterIndices.tahun, 'reverse');
        populateFilter('filterBulan', filterIndices.bulan, 'bulan');
        populateFilter('filterStatusSekolah', filterIndices.status);

        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const lastMonthName = monthNames[prevMonthIndex];

        const tahunSelect = document.getElementById('filterTahun');
        if (tahunSelect && [...tahunSelect.options].some(opt => opt.value === currentYear)) {
            tahunSelect.value = currentYear;
        }
        const bulanSelect = document.getElementById('filterBulan');
        if (bulanSelect && [...bulanSelect.options].some(opt => opt.value === lastMonthName)) {
            bulanSelect.value = lastMonthName;
        }
        
        loadingStatus.style.display = 'none';
        document.querySelector('.filter-container').style.display = 'flex';
        
        // KUNCI PERBAIKAN 2: Mengubah 'block' menjadi 'flex' agar sesuai dengan CSS
        tableWrapper.style.display = 'flex'; 

        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getJumlahPtkSdBulananData();
}

function initPtkDaftarSdnPage() {
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    function calculateRowsPerPage(tableId) {
        const tableContainer = document.getElementById(tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 37;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 180;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tableBody = document.getElementById('daftarPtkSdnTable').querySelector('tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((rowData, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                rowData.displayData.forEach(cellData => {
                    rowHTML += `<td>${cellData || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';

        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        const filterUnitKerja = document.getElementById('filterUnitKerja').value;
        const filterStatus = document.getElementById('filterStatus').value;
        const filterPangkat = document.getElementById('filterPangkat').value;
        const filterJabatan = document.getElementById('filterJabatan').value;
        
        currentFilteredRows = allDataRows.filter(row => {
            const unitKerjaMatch = (filterUnitKerja === "") || (row.filterData.unitKerja === filterUnitKerja);
            const statusMatch = (filterStatus === "") || (row.filterData.status === filterStatus);
            const pangkatMatch = (filterPangkat === "") || (row.filterData.pangkat === filterPangkat);
            const jabatanMatch = (filterJabatan === "") || (row.filterData.jabatan === filterJabatan);
            return unitKerjaMatch && statusMatch && pangkatMatch && jabatanMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(serverData) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('daftarPtkSdnTable').querySelector('thead');

        if (!serverData || serverData.length < 2) {
            loadingStatus.innerHTML = `<p>Tidak ada data PTK untuk ditampilkan.</p>`;
            return;
        }

        const sourceHeaders = serverData[0];
        const sourceRows = serverData.slice(1);

        // KUNCI PERBAIKAN: Mengurutkan berdasarkan kolom B (indeks 1)
        const namaIndex = 1; 
        sourceRows.sort((a, b) => {
            if (a[namaIndex] && b[namaIndex]) {
                return a[namaIndex].localeCompare(b[namaIndex]);
            }
            return 0;
        });

        const filterIndices = {
            unitKerja: 0, // Kolom A
            status: 3,    // Kolom D
            pangkat: 5,   // Kolom F
            jabatan: 9    // Kolom J
        };
        
        const displayIndices = [1, 3, 4, 5, 9, 10, 6, 2, 7, 8, 11];

        headerCols = displayIndices.map(index => sourceHeaders[index]);

        allDataRows = sourceRows.map(row => {
            return {
                filterData: {
                    unitKerja: row[filterIndices.unitKerja],
                    status: row[filterIndices.status],
                    pangkat: row[filterIndices.pangkat],
                    jabatan: row[filterIndices.jabatan]
                },
                displayData: displayIndices.map(index => row[index])
            };
        });

        tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        const populateFilter = (elementId, colIndex) => {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '<option value="">Semua</option>';
            const uniqueValues = [...new Set(sourceRows.map(row => row[colIndex]))].filter(Boolean).sort();
            uniqueValues.forEach(opt => select.add(new Option(opt, opt)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterUnitKerja', filterIndices.unitKerja);
        populateFilter('filterStatus', filterIndices.status);
        populateFilter('filterPangkat', filterIndices.pangkat);
        populateFilter('filterJabatan', filterIndices.jabatan);
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        
        rowsPerPage = calculateRowsPerPage('daftarPtkSdnTable');
        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdnData();
        
    window.addEventListener('resize', debounce(() => {
        if(document.getElementById('daftarPtkSdnTable')) {
            rowsPerPage = calculateRowsPerPage('daftarPtkSdnTable');
            buildTable();
        }
    }));
}

function initPtkDaftarSdsPage() {
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    function calculateRowsPerPage(tableId) {
        const tableContainer = document.getElementById(tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 37;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 180;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tableBody = document.getElementById('daftarPtkSdsTable').querySelector('tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const pageCount = Math.max(1, Math.ceil(currentFilteredRows.length / rowsPerPage));
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((rowData, index) => {
                const tr = document.createElement('tr');
                let rowHTML = `<td>${start + index + 1}</td>`;
                rowData.displayData.forEach(cellData => {
                    rowHTML += `<td>${cellData || '-'}</td>`;
                });
                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';

        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        const filterUnitKerja = document.getElementById('filterUnitKerja').value;
        const filterStatus = document.getElementById('filterStatus').value;
        const filterJabatan = document.getElementById('filterJabatan').value;
        
        currentFilteredRows = allDataRows.filter(row => {
            const unitKerjaMatch = (filterUnitKerja === "") || (row.filterData.unitKerja === filterUnitKerja);
            const statusMatch = (filterStatus === "") || (row.filterData.status === filterStatus);
            const jabatanMatch = (filterJabatan === "") || (row.filterData.jabatan === filterJabatan);
            return unitKerjaMatch && statusMatch && jabatanMatch;
        });
        currentPage = 1;
        buildTable();
    }

    function initializePage(serverData) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('daftarPtkSdsTable').querySelector('thead');

        if (!serverData || serverData.length < 2) {
            loadingStatus.innerHTML = `<p>Tidak ada data PTK untuk ditampilkan.</p>`;
            return;
        }

        const sourceHeaders = serverData[0];
        const sourceRows = serverData.slice(1);
        
        const namaIndex = 1; // Kolom B adalah 'Nama'
        sourceRows.sort((a, b) => (a[namaIndex] && b[namaIndex]) ? a[namaIndex].localeCompare(b[namaIndex]) : 0);

        const filterIndices = {
            unitKerja: 0, // Kolom A
            status: 3,    // Kolom D
            jabatan: 9    // Kolom J
        };
        
        const displayIndices = [1, 3, 4, 5, 9, 10, 6, 2, 7, 8, 11];

        headerCols = displayIndices.map(index => sourceHeaders[index]);

        allDataRows = sourceRows.map(row => {
            return {
                filterData: {
                    unitKerja: row[filterIndices.unitKerja],
                    status: row[filterIndices.status],
                    jabatan: row[filterIndices.jabatan]
                },
                displayData: displayIndices.map(index => row[index])
            };
        });

        tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        const populateFilter = (elementId, colIndex) => {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '<option value="">Semua</option>';
            const uniqueValues = [...new Set(sourceRows.map(row => row[colIndex]))].filter(Boolean).sort();
            uniqueValues.forEach(opt => select.add(new Option(opt, opt)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterUnitKerja', filterIndices.unitKerja);
        populateFilter('filterStatus', filterIndices.status);
        populateFilter('filterJabatan', filterIndices.jabatan);
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        
        rowsPerPage = calculateRowsPerPage('daftarPtkSdsTable');
        applyFilters();
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdsData();
        
    window.addEventListener('resize', debounce(() => {
        if(document.getElementById('daftarPtkSdsTable')) {
            rowsPerPage = calculateRowsPerPage('daftarPtkSdsTable');
            buildTable();
        }
    }));
}

function initPtkKelolaSdPage() {
    let allDataRows = [], headerCols = ["Nama", "Unit Kerja", "Status", "NIP/NIY", "Jabatan", "Aksi", "Tanggal Input", "Update"], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    function calculateRowsPerPage(tableId) {
        const tableContainer = document.getElementById(tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 37;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 180;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const tableBody = document.getElementById('kelolaPtkSdTable').querySelector('tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (currentPage > pageCount) currentPage = pageCount;
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, end);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedRows.forEach((rowInfo, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${start + index + 1}</td>
                                <td>${rowInfo.data['Nama'] || '-'}</td>
                                <td>${rowInfo.data['Unit Kerja'] || '-'}</td>
                                <td>${rowInfo.data['Status'] || '-'}</td>
                                <td>${rowInfo.data['NIP/NIY'] || '-'}</td>
                                <td>${rowInfo.data['Jabatan'] || '-'}</td>
                                <td class="action-buttons">
                                    <button class="action-btn edit-btn" data-row-index="${rowInfo.rowIndex}" data-source="${rowInfo.source}"><i class="fas fa-pencil-alt"></i> Edit</button>
                                    <button class="action-btn delete-btn" data-row-index="${rowInfo.rowIndex}" data-source="${rowInfo.source}"><i class="fas fa-trash"></i> Hapus</button>
                                </td>
                                <td>${rowInfo.data['Tanggal Input'] || '-'}</td>
                                <td>${rowInfo.data['Update'] || '-'}</td>`;
                tableBody.appendChild(tr);
            });
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        const pageInfo = document.createElement('span');
        pageInfo.className = 'page-info';
        pageInfo.textContent = `Halaman ${currentPage} dari ${pageCount}`;
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '«';
        prevBtn.className = 'page-btn';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; buildTable(); } };
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '»';
        nextBtn.className = 'page-btn';
        nextBtn.disabled = currentPage === pageCount;
        nextBtn.onclick = () => { if (currentPage < pageCount) { currentPage++; buildTable(); } };
        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
    }

    function applyFilters() {
        const filterUnitKerja = document.getElementById('filterUnitKerja').value;
        currentFilteredRows = allDataRows.filter(row => {
            const unitKerjaMatch = (filterUnitKerja === "") || (String(row.data['Unit Kerja']).trim() === filterUnitKerja);
            return unitKerjaMatch;
        });
        currentPage = 1;
        buildTable();
    }
    
    function showDeleteConfirmationPtkSd(rowIndex, source, rowData) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        modalTitle.textContent = 'Konfirmasi Hapus';
        modalBody.innerHTML = `<p>Yakin ingin menghapus PTK ini?</p><div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">Nama: ${rowData['Nama']}<br>Unit Kerja: ${rowData['Unit Kerja']}</div>`;
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Ya, Hapus';
        newConfirmBtn.onclick = () => showDeletePromptPtkSd(rowIndex, source);
        modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');
        modal.classList.add('show');
    }
 
    function showDeletePromptPtkSd(rowIndex, source) {
        const modal = document.getElementById('deleteModal');
        const modalTitle = modal.querySelector('#deleteModalTitle');
        const modalBody = modal.querySelector('#deleteModalBody');
        const confirmBtn = modal.querySelector('#confirmDeleteBtn');
        modalTitle.textContent = 'Masukkan Kode Hapus';
        modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p><input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        newConfirmBtn.textContent = 'Konfirmasi & Hapus';
        newConfirmBtn.onclick = () => processDeletionPtkSd(rowIndex, source);
        setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
    }
 
    function processDeletionPtkSd(rowIndex, source) {
        const deleteCode = document.getElementById('kodeHapusInput').value;
        if (!deleteCode) { showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
        showAppModal('loading', 'Menghapus data...');
        google.script.run
            .withSuccessHandler(response => {
                document.getElementById('deleteModal').classList.remove('show');
                showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => showAppModal('error', error.message))
            .deletePtkSdData(rowIndex, source, deleteCode);
    }

    function initializePage(serverData) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('kelolaPtkSdTable').querySelector('thead');

        if (serverData.error || !serverData.rows || serverData.rows.length === 0) {
            loadingStatus.innerHTML = `<p>Tidak ada data PTK untuk dikelola.</p>`;
            return;
        }
        
        // KUNCI PERBAIKAN: Logika pengurutan dipindahkan ke sini
        const parseDate = (dateString) => {
            if (!dateString || typeof dateString !== 'string') return 0;
            const parts = dateString.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{2}):(\d{2})/);
            if (parts) return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
            return 0;
        };

        serverData.rows.sort((a, b) => {
            const dateB = parseDate(b.data['Update']) || parseDate(b.data['Tanggal Input']);
            const dateA = parseDate(a.data['Update']) || parseDate(a.data['Tanggal Input']);
            return dateB - dateA; // Mengurutkan dari yang terbaru ke terlama
        });

        allDataRows = serverData.rows;

        tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
        
        const populateFilter = (elementId, dataKey) => {
            const select = document.getElementById(elementId);
            if (!select) return;
            select.innerHTML = '<option value="">Semua</option>';
            const uniqueValues = [...new Set(allDataRows.map(row => row.data[dataKey]))].filter(Boolean).sort();
            uniqueValues.forEach(opt => select.add(new Option(opt, opt)));
            select.addEventListener('change', applyFilters);
        };
        
        populateFilter('filterUnitKerja', 'Unit Kerja');
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'block';
        
        setTimeout(() => {
            rowsPerPage = calculateRowsPerPage('kelolaPtkSdTable');
            applyFilters();
        }, 0);

        document.getElementById('tambahPtkSdBtn').addEventListener('click', (e) => {
            loadPage(e, 'ptk_tambah_sd');
        });

        tableWrapper.addEventListener('click', (e) => {
            const target = e.target.closest('button.action-btn');
            if (!target) return;
            
            const rowIndex = target.dataset.rowIndex;
            const source = target.dataset.source;
            const rowInfo = allDataRows.find(r => r.rowIndex == rowIndex && r.source == source);

            if (target.classList.contains('edit-btn')) {
                loadPage(null, 'ptk_edit_sd', { rowIndex: rowIndex, source: source });
            }
            if (target.classList.contains('delete-btn') && rowInfo) {
                showDeleteConfirmationPtkSd(rowIndex, source, rowInfo.data);
            }
        });
    }

    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKelolaPtkSdData();
        
    window.addEventListener('resize', debounce(() => {
        if(document.getElementById('kelolaPtkSdTable')) {
            rowsPerPage = calculateRowsPerPage('kelolaPtkSdTable');
            buildTable();
        }
    }));
}

function initPtkTambahSdPage() {
    const form = document.getElementById('addPtkSdForm');
    if (!form) return;

    showAppModal('loading', 'Memuat opsi formulir...');

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }

            const statusSekolahSelect = form.querySelector('#statusSekolah');
            const unitKerjaSelect = form.querySelector('#unitKerja');
            const statusKepegawaianSelect = form.querySelector('#statusKepegawaian');
            const pangkatSelect = form.querySelector('#pangkat');
            const jabatanSelect = form.querySelector('#jabatan');

            const populateSelect = (selectEl, optionsArr, placeholder) => {
                selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
                optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
            };

            populateSelect(statusKepegawaianSelect, options['Status Kepegawaian'], 'Pilih Status');
            populateSelect(pangkatSelect, options['Pangkat'], 'Pilih Pangkat');
            populateSelect(jabatanSelect, options['Jabatan'], 'Pilih Jabatan');
            
            statusSekolahSelect.addEventListener('change', function() {
                const selectedStatus = this.value;
                const schoolList = selectedStatus === 'Negeri' ? options['Nama SDN'] : options['Nama SDS'];
                populateSelect(unitKerjaSelect, schoolList, 'Pilih Unit Kerja');
                unitKerjaSelect.disabled = false;
            });
            
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkSdOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkSd(formData);
    });
}

function initPtkTambahSdPage() {
    const form = document.getElementById('addPtkSdForm');
    if (!form) return;

    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const dynamicFormContainer = form.querySelector('#dynamic-form-container');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {};

    showAppModal('loading', 'Memuat opsi formulir...');

    function populateSelect(selectEl, optionsArr, placeholder) {
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    function toggleFormSection(sectionToShow, sectionToHide) {
        sectionToShow.style.display = 'block';
        sectionToHide.style.display = 'none';
        sectionToShow.querySelectorAll('input, select').forEach(input => input.disabled = false);
        sectionToHide.querySelectorAll('input, select').forEach(input => input.disabled = true);
    }

    statusSekolahSelect.addEventListener('change', function() {
        const isNegeri = this.value === 'Negeri';
        dynamicFormContainer.style.display = 'block';
        
        if (isNegeri) {
            toggleFormSection(formNegeri, formSwasta);
            populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja');
            populateSelect(formNegeri.querySelector('#statusNegeri'), allOptions['Status Negeri'], 'Pilih Status');
        } else {
            toggleFormSection(formSwasta, formNegeri);
            populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja');
            populateSelect(formSwasta.querySelector('#statusSwasta'), allOptions['Status Swasta'], 'Pilih Status');
        }
        unitKerjaSelect.disabled = false;
    });

    formNegeri.querySelector('#statusNegeri').addEventListener('change', function() {
        const status = this.value;
        const isASN = ['PNS', 'PPPK', 'PPPK Paruh Waktu'].includes(status);
        const nipInput = formNegeri.querySelector('#nip');
        const pangkatNegeriSelect = formNegeri.querySelector('#pangkatNegeri');
        
        nipInput.required = isASN;
        nipInput.disabled = !isASN;
        nipInput.placeholder = isASN ? 'Wajib diisi 18 digit' : '-';
        if (!isASN) nipInput.value = '-';

        pangkatNegeriSelect.disabled = (status === 'Tenaga Non ASN');
        if (status === 'PNS') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
        } else if (status === 'PPPK') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
        } else if (status === 'PPPK Paruh Waktu') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan');
        } else {
            pangkatNegeriSelect.innerHTML = '<option value="-">--</option>';
            pangkatNegeriSelect.value = '-';
        }
    });

    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options;
            populateSelect(jabatanSelect, allOptions['Jabatan'], 'Pilih Jabatan');
            populateSelect(tugasTambahanSelect, allOptions['Tugas Tambahan'], 'Pilih Tugas Tambahan');
            toggleFormSection(document.createElement('div'), formNegeri);
            toggleFormSection(document.createElement('div'), formSwasta);
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`))
        .getNewPtkSdOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkSd(formData);
    });
}

function initPtkEditSdPage(params) {
    const form = document.getElementById('editPtkSdForm');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-form-container');
    if (!form || !params || !params.rowIndex || !params.source) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;

    const statusSekolahInput = form.querySelector('[name="statusSekolah"]');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {};

    function populateSelect(selectEl, optionsArr, placeholder) {
        selectEl.innerHTML = `<option value="">-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    // KUNCI PERBAIKAN 1: Fungsi untuk menonaktifkan/mengaktifkan form
    function toggleFormSection(sectionToShow, sectionToHide) {
        sectionToShow.style.display = 'block';
        sectionToHide.style.display = 'none';
        sectionToShow.querySelectorAll('input, select').forEach(input => input.disabled = false);
        sectionToHide.querySelectorAll('input, select').forEach(input => input.disabled = true);
    }

    // 1. Ambil semua opsi dropdown
    google.script.run.withSuccessHandler(options => {
        allOptions = options;
        populateSelect(jabatanSelect, allOptions['Jabatan'], 'Pilih Jabatan');
        populateSelect(tugasTambahanSelect, allOptions['Tugas Tambahan'], 'Pilih Tugas Tambahan');

        // 2. Ambil data spesifik untuk baris ini
        google.script.run.withSuccessHandler(rowData => {
            if (rowData.error) {
                showAppModal('error', `Gagal memuat data: ${rowData.error}`);
                return;
            }

            // Tampilkan form yang sesuai (Negeri/Swasta) terlebih dahulu
            const isNegeri = params.source === 'SDN';
            if (isNegeri) {
                toggleFormSection(formNegeri, formSwasta);
                populateSelect(formNegeri.querySelector('#statusNegeri'), allOptions['Status Negeri'], 'Pilih Status');
            } else {
                toggleFormSection(formSwasta, formNegeri);
                populateSelect(formSwasta.querySelector('#statusSwasta'), allOptions['Status Swasta'], 'Pilih Status');
            }

            // --- Isi form dengan data yang ada ---
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    field.value = rowData[key];
                }
            }
            statusSekolahInput.value = isNegeri ? 'Negeri' : 'Swasta';
            
            // Trigger event 'change' secara manual untuk mengatur field dinamis
            if (isNegeri) {
                formNegeri.querySelector('#statusNegeri').dispatchEvent(new Event('change'));
            }

            // Sembunyikan loading dan tampilkan form
            loadingDiv.style.display = 'none';
            formContainer.style.display = 'block';

        }).withFailureHandler(err => showAppModal('error', `Gagal mengambil data baris: ${err.message}`)).getPtkSdDataByRow(params.rowIndex, params.source);
    }).withFailureHandler(err => showAppModal('error', `Gagal memuat opsi form: ${err.message}`)).getNewPtkSdOptions();
    
    // KUNCI PERBAIKAN 2: Event listener untuk Status Kepegawaian (Negeri) ditambahkan
    formNegeri.querySelector('#statusNegeri').addEventListener('change', function() {
        const status = this.value;
        const isASN = ['PNS', 'PPPK', 'PPPK Paruh Waktu'].includes(status);
        const nipInput = formNegeri.querySelector('#nip');
        const pangkatNegeriSelect = formNegeri.querySelector('#pangkatNegeri');
        
        nipInput.required = isASN;
        nipInput.disabled = !isASN;
        nipInput.placeholder = isASN ? 'Wajib diisi 18 digit' : '-';
        if (!isASN) nipInput.value = '-';

        pangkatNegeriSelect.disabled = (status === 'Tenaga Non ASN');
        if (status === 'PNS') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
        } else if (status === 'PPPK') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
        } else if (status === 'PPPK Paruh Waktu') {
            populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan');
        } else {
            pangkatNegeriSelect.innerHTML = '<option value="-">--</option>';
            pangkatNegeriSelect.value = '-';
        }
    });

    // Logika saat form disubmit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                showAppModal('success', response, 'ptk_kelola_sd');
            })
            .withFailureHandler(error => {
                showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkSdData(formData);
    });
}

function initPtkKebutuhanSdnPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [];
    let kurangColumnIndices = []; // Variabel baru untuk menyimpan indeks kolom "Kurang"

    function buildTable() {
        try {
            const table = document.getElementById('kebutuhanPtkSdnTable');
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');
            const tableFoot = table.querySelector('tfoot');
            if (!tableBody || !tableFoot || !tableHead) return;

            let firstRowHTML = '<tr><th rowspan="2">No.</th>';
            let secondRowHTML = '<tr>';
            for (let i = 0; i < headerRow1.length; i++) {
                const topHeader = headerRow1[i];
                if (topHeader && topHeader.trim() !== '') {
                    let colspan = 1;
                    while ((i + colspan) < headerRow1.length && (headerRow1[i + colspan] === '' || headerRow1[i + colspan] === null)) {
                        colspan++;
                    }
                    if (colspan > 1) {
                        firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                        for (let j = 0; j < colspan; j++) {
                            secondRowHTML += `<th>${headerRow2[i + j] || ''}</th>`;
                        }
                        i += colspan - 1;
                    } else {
                        firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                    }
                }
            }
            firstRowHTML += '</tr>';
            secondRowHTML += '</tr>';
            tableHead.innerHTML = firstRowHTML + secondRowHTML;
            
            tableBody.innerHTML = '';
            if (allDataRows.length === 0) {
                const colspan = headerRow2.length + 1;
                tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data untuk ditampilkan.</td></tr>`;
                tableFoot.innerHTML = '';
                return;
            }
            
            allDataRows.forEach((row, index) => {
                let bodyRowHTML = `<td>${index + 1}</td>`;
                // --- AWAL PERUBAHAN ---
                row.forEach((cell, i) => {
                    let cellClass = '';
                    // Cek apakah kolom ini adalah salah satu kolom "Kurang"
                    if (kurangColumnIndices.includes(i)) {
                        const value = parseInt(cell, 10);
                        if (!isNaN(value)) {
                            if (value < 0) {
                                cellClass = ' class="cell-negative"';
                            } else if (value > 0) {
                                cellClass = ' class="cell-positive"';
                            }
                        }
                    }
                    bodyRowHTML += `<td${cellClass}>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                });
                // --- AKHIR PERUBAHAN ---
                tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
            });

            const totals = new Array(headerRow2.length).fill(0);
            allDataRows.forEach(row => {
                for (let i = 1; i < headerRow2.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            });
            
            let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>';
            for (let i = 1; i < totals.length; i++) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
            totalRowHTML += '</tr>';
            tableFoot.innerHTML = totalRowHTML;

        } catch (e) {
            console.error("Error saat membangun tabel:", e);
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red; text-align: left;"><b>Terjadi Error di Browser!</b><br>Ini biasanya terjadi jika struktur header di spreadsheet tidak terduga.<br><br><b>Pesan Error:</b> ${e.message}</p>`;
        }
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.error || dataArray.length < 3) {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data dari server. ${dataArray.error || 'Data tidak lengkap.'}</p>`; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        
        const rombelIndex = headerRow2.indexOf('Jumlah Rombel');
        if (rombelIndex > -1) {
            headerRow2[rombelIndex] = 'Jumlah<br>Rombel';
        }
        const siswaIndex = headerRow2.indexOf('Jumlah Siswa');
        if (siswaIndex > -1) {
            headerRow2[siswaIndex] = 'Jumlah<br>Siswa';
        }
        
        // --- AWAL PERUBAHAN ---
        // Cari semua kolom yang bernama "Kurang" dan simpan posisinya
        kurangColumnIndices = [];
        headerRow2.forEach((header, index) => {
            if (header === 'Kurang') {
                kurangColumnIndices.push(index);
            }
        });
        // --- AKHIR PERUBAHAN ---

        allDataRows = dataArray.slice(2);
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        buildTable();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;"><b>Gagal Total Memuat Data dari Server!</b><br>Pesan: ${error.message}</p>`;
        })
        .getKebutuhanPtkSdnData();
}

function initMuridPaudKelasUsiaPage() {
    let allDataRows = [], headerCols = [], filterIndices = {}, currentFilteredRows = [];
    let jenjangIndex = -1; // Variabel baru untuk menyimpan posisi kolom "Jenjang"

    function buildTable() {
        const tableBody = document.getElementById('muridPaudKelasUsiaTable').querySelector('tbody');
        const tableFoot = document.getElementById('muridPaudKelasUsiaTable').querySelector('tfoot');
        if (!tableBody || !tableFoot) return;

        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; 

        // Hitung jumlah kolom yang akan ditampilkan (tanpa kolom Jenjang)
        const visibleColsCount = headerCols.length - (jenjangIndex > -1 ? 1 : 0);

        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }
        
        currentFilteredRows.forEach((cols, index) => {
            const tr = document.createElement('tr');
            let rowHTML = `<td>${index + 1}</td>`;
            cols.forEach((cellData, i) => {
                // Lewati (jangan tampilkan) kolom "Jenjang"
                if (i === jenjangIndex) return; 
                rowHTML += `<td>${(String(cellData) === '0' || !cellData) ? '-' : cellData}</td>`;
            });
            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });

        const totals = new Array(headerCols.length).fill(0);
            // Sesuai permintaan, index untuk memulai penjumlahan adalah 5 
            // (karena kolom 1="Nama Sekolah", 2="Jenjang"(hidden), 3="Rombel", 4="Kel A L", 5="Kel A P", 6="Kel B L")
            const sumStartIndex = 5; 

            currentFilteredRows.forEach(row => {
                for (let i = sumStartIndex; i < headerCols.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            });

            // Buat baris jumlah, tambahkan placeholder untuk kolom yang tidak dijumlahkan
            let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td><td>-</td><td>-</td><td>-</td>';
            for (let i = sumStartIndex; i < totals.length; i++) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
            totalRowHTML += '</tr>';
            tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterJenjang = document.getElementById('filterJenjang').value;
        currentFilteredRows = allDataRows.filter(cols => {
            const jenjangMatch = (filterJenjang === "") || (jenjangIndex === -1) || (String(cols[jenjangIndex]) === filterJenjang);
            return jenjangMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('muridPaudKelasUsiaTable').querySelector('thead');

        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; 
            return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        
        // Cari posisi kolom "Jenjang"
        jenjangIndex = headerCols.indexOf('Jenjang');

        // Buat header dengan menyembunyikan kolom "Jenjang"
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.filter((h, i) => i !== jenjangIndex).map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        const jenjangSelect = document.getElementById('filterJenjang');
        if (jenjangSelect && jenjangIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[jenjangIndex])))];
            jenjangSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => { 
                if(val && val.trim() !== '') jenjangSelect.add(new Option(val, val)); 
            });
            jenjangSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex'; 
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudKelasUsiaData();
}

function initMuridPaudJenisKelaminPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let jenjangIndex = -1; // Variabel untuk menyimpan posisi kolom "Jenjang"

    function buildTable() {
        const table = document.getElementById('muridPaudJkTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        // --- Header Construction ---
        let firstRowHTML = '<th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';

        for (let i = 0; i < headerRow1.length; i++) {
            if (i === jenjangIndex) continue;

            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 1;
                while ((i + colspan) < headerRow1.length && (headerRow1[i + colspan] === '' || headerRow1[i + colspan] === null)) {
                    colspan++;
                }

                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    let subheaders = '';
                    for (let j = 0; j < colspan; j++) {
                        // Pastikan tidak melintasi kolom jenjang
                        if ((i + j) !== jenjangIndex) {
                            subheaders += `<th>${headerRow2[i + j] || ''}</th>`;
                        }
                    }
                    secondRowHTML += subheaders;
                    i += colspan - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            } else if (i !== jenjangIndex) {
                 firstRowHTML += `<th rowspan="2">${headerRow2[i]}</th>`;
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;

        // --- Body Construction ---
        tableBody.innerHTML = '';
        const visibleCols = headerRow2.filter((_, i) => i !== jenjangIndex).length;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleCols + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (i !== jenjangIndex) {
                    bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- Footer Construction (PERBAIKAN DI SINI) ---
        const totals = new Array(headerRow2.length).fill(0);
        // Indeks 5 sesuai dengan kolom ke-6 ("L" di bawah "Kelompok A")
        const sumStartIndex = 5; 
        currentFilteredRows.forEach(row => {
            for (let i = sumStartIndex; i < row.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });
        
        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>'; // Kolom 1 dan 2
        // Tambahkan placeholder untuk kolom 3, 4, dan 5
        totalRowHTML += '<td>-</td><td>-</td><td>-</td>'; 

        for (let i = sumStartIndex; i < totals.length; i++) {
            if (i !== jenjangIndex) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterJenjang = document.getElementById('filterJenjang').value;
        currentFilteredRows = allDataRows.filter(row => {
            return (filterJenjang === "") || (jenjangIndex === -1) || (String(row[jenjangIndex]) === filterJenjang);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak lengkap atau tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);

        // Cari indeks kolom "Jenjang" dari data asli
        jenjangIndex = headerRow1.indexOf('Jenjang');

        const jenjangSelect = document.getElementById('filterJenjang');
        if (jenjangSelect && jenjangIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[jenjangIndex])))].filter(Boolean);
            jenjangSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => jenjangSelect.add(new Option(val, val)));
            jenjangSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJenisKelaminData();
}

function initMuridPaudJumlahBulananPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let hiddenColumnIndices = [];

    function buildTable() {
        const table = document.getElementById('muridPaudBulananTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';
        for (let i = 0; i < headerRow1.length; i++) {
            if (hiddenColumnIndices.includes(i)) continue;
            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 0;
                let subheaders = [];
                let k = i;
                while (k < headerRow1.length && (headerRow1[k] === '' || headerRow1[k] === null || k === i)) {
                    if (!hiddenColumnIndices.includes(k)) {
                       colspan++;
                       subheaders.push(`<th>${headerRow2[k] || ''}</th>`);
                    }
                    k++;
                }
                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    secondRowHTML += subheaders.join('');
                    i = k - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        const visibleColsCount = headerRow1.length - hiddenColumnIndices.length;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (!hiddenColumnIndices.includes(i)) {
                    bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- AWAL PERBAIKAN FOOTER (FINAL) ---
        const totals = new Array(headerRow2.length).fill(0);
        const sumStartIndex = headerRow1.indexOf('Rombel');

        currentFilteredRows.forEach(row => {
            if (sumStartIndex > -1) {
                for (let i = sumStartIndex; i < row.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            }
        });
        
        let totalRowHTML = '<tr>';
        
        // Loop untuk membuat placeholder dan total dengan benar
        for (let i = 0; i < headerRow1.length; i++) {
            if (hiddenColumnIndices.includes(i)) continue; // Lewati kolom tersembunyi

            if (i === 0) { // Kolom pertama setelah "No." adalah "Nama Sekolah"
                totalRowHTML += '<td>JUMLAH</td>';
            } else if (i < sumStartIndex) { // Kolom sebelum penjumlahan
                totalRowHTML += '<td>-</td>';
            } else { // Kolom yang dijumlahkan
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        
        // Masukkan placeholder untuk kolom "No." di awal
        totalRowHTML = '<tr><td>-</td>' + totalRowHTML.substring(4);
        tableFoot.innerHTML = totalRowHTML;
        // --- AKHIR PERBAIKAN FOOTER (FINAL) ---
    }
    
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterBulan = document.getElementById('filterBulan').value;
        const filterJenjang = document.getElementById('filterJenjang').value;

        const tahunIndex = headerRow1.indexOf('Tahun');
        const bulanIndex = headerRow1.indexOf('Bulan');
        const jenjangIndex = headerRow1.indexOf('Jenjang');
        
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (String(row[tahunIndex]) === filterTahun);
            const bulanMatch = (filterBulan === "") || (String(row[bulanIndex]) === filterBulan);
            const jenjangMatch = (filterJenjang === "") || (String(row[jenjangIndex]) === filterJenjang);
            return tahunMatch && bulanMatch && jenjangMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);
        
        hiddenColumnIndices = [1, 2, 3, 4];

        const populateFilter = (elementId, colName, sortReverse = false, specialSort = null) => {
            const select = document.getElementById(elementId);
            const colIndex = headerRow1.indexOf(colName);
            if (!select || colIndex === -1) return;
            
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[colIndex])))].filter(Boolean);
            select.innerHTML = `<option value="">Semua</option>`;
            let sorted = uniqueValues;
            if (specialSort === 'bulan') {
                const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                sorted = uniqueValues.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            } else {
                sorted = uniqueValues.sort();
            }
            if (sortReverse) sorted.reverse();

            sorted.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };

        populateFilter('filterTahun', 'Tahun', true);
        populateFilter('filterBulan', 'Bulan', false, 'bulan');
        populateFilter('filterJenjang', 'Jenjang');
        
        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const lastMonthName = monthNames[prevMonthIndex];

        const tahunSelect = document.getElementById('filterTahun');
        if (tahunSelect && [...tahunSelect.options].some(opt => opt.value === currentYear)) {
            tahunSelect.value = currentYear;
        }
        const bulanSelect = document.getElementById('filterBulan');
        if (bulanSelect && [...bulanSelect.options].some(opt => opt.value === lastMonthName)) {
            bulanSelect.value = lastMonthName;
        }

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJumlahBulananData();
}

function initMuridSdKelasPage() {
    let allDataRows = [], headerCols = [], currentFilteredRows = [];
    let statusIndex = -1;

    function buildTable() {
        const tableBody = document.getElementById('muridSdKelasTable').querySelector('tbody');
        const tableFoot = document.getElementById('muridSdKelasTable').querySelector('tfoot');
        if (!tableBody || !tableFoot) return;

        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; 

        const visibleColsCount = headerCols.length - 1;

        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            return;
        }
        
        currentFilteredRows.forEach((cols, index) => {
            const tr = document.createElement('tr');
            let rowHTML = `<td>${index + 1}</td>`;
            cols.forEach((cellData, i) => {
                if (i !== statusIndex) {
                    rowHTML += `<td>${(String(cellData) === '0' || !cellData) ? '-' : cellData}</td>`;
                }
            });
            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });

        // --- AWAL PERBAIKAN FOOTER ---
        const totals = new Array(headerCols.length).fill(0);
        // Cari posisi kolom "Rombel" secara dinamis
        const sumStartIndex = headerCols.indexOf('Rombel');

        currentFilteredRows.forEach(row => {
            if (sumStartIndex > -1) {
                for (let i = sumStartIndex; i < headerCols.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            }
        });

        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>';
        // Tambahkan placeholder dinamis untuk kolom sebelum Rombel
        for (let i = 2; i < sumStartIndex; i++) {
            if (i !== statusIndex) {
                totalRowHTML += '<td>-</td>';
            }
        }
        
        // Tambahkan nilai total
        for (let i = sumStartIndex; i < totals.length; i++) {
            if (i !== statusIndex) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
        // --- AKHIR PERBAIKAN FOOTER ---
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatus').value;
        currentFilteredRows = allDataRows.filter(cols => {
            return (filterStatus === "") || (statusIndex === -1) || (String(cols[statusIndex]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.getElementById('muridSdKelasTable').querySelector('thead');

        if (!dataArray || dataArray.length < 2) {
            loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>"; 
            return;
        }

        headerCols = dataArray[0];
        allDataRows = dataArray.slice(1);
        
        statusIndex = headerCols.indexOf('Status');

        const headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>No.</th>' + headerCols.filter((h, i) => i !== statusIndex).map(header => `<th>${header}</th>`).join('');
        tableHead.innerHTML = '';
        tableHead.appendChild(headerRow);
        
        const statusSelect = document.getElementById('filterStatus');
        if (statusSelect && statusIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[statusIndex])))].filter(Boolean);
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => statusSelect.add(new Option(val, val)));
            statusSelect.addEventListener('change', applyFilters);
        }
        
        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex'; 
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdKelasData();
}

function initMuridSdRombelPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let statusIndex = -1; // Kolom B (Status)

    function buildTable() {
        const table = document.getElementById('muridSdRombelTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';
        for (let i = 0; i < headerRow1.length; i++) {
            if (i === statusIndex) continue; // Lewati kolom Status

            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 0;
                let subheaders = [];
                let k = i;
                while (k < headerRow1.length && (headerRow1[k] === '' || headerRow1[k] === null || k === i)) {
                    if (k !== statusIndex) {
                       colspan++;
                       subheaders.push(`<th>${headerRow2[k] || ''}</th>`);
                    }
                    k++;
                }

                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    secondRowHTML += subheaders.join('');
                    i = k - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        const visibleColsCount = headerRow1.length - 1;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (i !== statusIndex) {
                    bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- AWAL PERBAIKAN FOOTER ---
        const totals = new Array(headerRow2.length).fill(0);
        // Cari posisi kolom "Jumlah Rombel" secara dinamis (seharusnya di indeks 4)
        const sumStartIndex = headerRow1.indexOf('Jumlah Rombel');

        currentFilteredRows.forEach(row => {
            if (sumStartIndex > -1) {
                for (let i = sumStartIndex; i < row.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            }
        });

        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>'; // Placeholder No. & Nama Sekolah
        // Tambahkan placeholder dinamis untuk kolom sebelum "Jumlah Rombel"
        for (let i = 2; i < sumStartIndex; i++) {
            if (i !== statusIndex) {
                totalRowHTML += '<td>-</td>';
            }
        }
        
        // Tambahkan nilai total
        for (let i = sumStartIndex; i < totals.length; i++) {
             if (i !== statusIndex) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
        // --- AKHIR PERBAIKAN FOOTER ---
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatus').value;
        currentFilteredRows = allDataRows.filter(row => {
            return (filterStatus === "") || (statusIndex === -1) || (String(row[statusIndex]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);
        
        statusIndex = headerRow1.indexOf('Status');
        if (statusIndex === -1) statusIndex = 1;

        const statusSelect = document.getElementById('filterStatus');
        if (statusSelect && statusIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[statusIndex])))].filter(Boolean);
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => statusSelect.add(new Option(val, val)));
            statusSelect.addEventListener('change', applyFilters);
        }

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdRombelData();
}

function initMuridSdJenisKelaminPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let statusIndex = -1; // Kolom B (Status)

    function buildTable() {
        const table = document.getElementById('muridSdJkTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';
        for (let i = 0; i < headerRow1.length; i++) {
            if (i === statusIndex) continue; // Lewati kolom Status

            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 0;
                let subheaders = [];
                let k = i;
                while (k < headerRow1.length && (headerRow1[k] === '' || headerRow1[k] === null || k === i)) {
                    if (k !== statusIndex) {
                       colspan++;
                       subheaders.push(`<th>${headerRow2[k] || ''}</th>`);
                    }
                    k++;
                }

                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    secondRowHTML += subheaders.join('');
                    i = k - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        const visibleColsCount = headerRow1.length - 1;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (i !== statusIndex) {
                    bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- AWAL PERBAIKAN FOOTER ---
        const totals = new Array(headerRow2.length).fill(0);
        const sumStartIndex = headerRow1.indexOf('Rombel');

        currentFilteredRows.forEach(row => {
            if (sumStartIndex > -1) {
                for (let i = sumStartIndex; i < row.length; i++) {
                    const value = parseInt(row[i], 10);
                    if (!isNaN(value)) totals[i] += value;
                }
            }
        });

        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>'; // Placeholder No. & Nama Sekolah
        
        // Tambahkan placeholder dinamis untuk kolom sebelum Rombel
        for (let i = 2; i < sumStartIndex; i++) { // Dimulai dari setelah "Nama Sekolah"
            if (i !== statusIndex) {
                totalRowHTML += '<td>-</td>';
            }
        }
        
        // Tambahkan nilai total
        for (let i = sumStartIndex; i < totals.length; i++) {
             if (i !== statusIndex) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
        // --- AKHIR PERBAIKAN FOOTER ---
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatus').value;
        currentFilteredRows = allDataRows.filter(row => {
            return (filterStatus === "") || (statusIndex === -1) || (String(row[statusIndex]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);
        
        statusIndex = headerRow1.indexOf('Status');
        if (statusIndex === -1) statusIndex = 1;

        const statusSelect = document.getElementById('filterStatus');
        if (statusSelect && statusIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[statusIndex])))].filter(Boolean);
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => statusSelect.add(new Option(val, val)));
            statusSelect.addEventListener('change', applyFilters);
        }

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJenisKelaminData();
}

function initMuridSdAgamaPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let statusIndex = -1; // Kolom B (Status)

    function buildTable() {
        const table = document.getElementById('muridSdAgamaTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';
        for (let i = 0; i < headerRow1.length; i++) {
            if (i === statusIndex) continue; // Lewati kolom Status

            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 0;
                let subheaders = [];
                let k = i;
                while (k < headerRow1.length && (headerRow1[k] === '' || headerRow1[k] === null || k === i)) {
                    if (k !== statusIndex) {
                       colspan++;
                       subheaders.push(`<th>${headerRow2[k] || ''}</th>`);
                    }
                    k++;
                }

                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    secondRowHTML += subheaders.join('');
                    i = k - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        const visibleColsCount = headerRow1.length - 1;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (i !== statusIndex) {
                    bodyRowHTML += `<td>${(cell === '0' || cell === '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        // --- AWAL PERBAIKAN FOOTER ---
        const totals = new Array(headerRow2.length).fill(0);
        // Kolom ke-5 secara visual adalah indeks ke-4 dalam data asli.
        const sumStartIndex = 4; 

        currentFilteredRows.forEach(row => {
            for (let i = sumStartIndex; i < row.length; i++) {
                const value = parseInt(row[i], 10);
                if (!isNaN(value)) totals[i] += value;
            }
        });

        let totalRowHTML = '<tr><td>-</td><td>JUMLAH</td>'; // Placeholder No. & Nama Sekolah
        // Tambahkan placeholder untuk kolom-kolom sebelum penjumlahan
        for (let i = 2; i < sumStartIndex; i++) {
            if (i !== statusIndex) {
                totalRowHTML += '<td>-</td>';
            }
        }
        
        // Tambahkan nilai total
        for (let i = sumStartIndex; i < totals.length; i++) {
             if (i !== statusIndex) {
                totalRowHTML += `<td>${totals[i] || '-'}</td>`;
            }
        }
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
        // --- AKHIR PERBAIKAN FOOTER ---
    }
    
    function applyFilters() {
        const filterStatus = document.getElementById('filterStatus').value;
        currentFilteredRows = allDataRows.filter(row => {
            return (filterStatus === "") || (statusIndex === -1) || (String(row[statusIndex]) === filterStatus);
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);
        
        statusIndex = headerRow1.indexOf('Status');
        if (statusIndex === -1) statusIndex = 1;

        const statusSelect = document.getElementById('filterStatus');
        if (statusSelect && statusIndex !== -1) {
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[statusIndex])))].filter(Boolean);
            statusSelect.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.sort().forEach(val => statusSelect.add(new Option(val, val)));
            statusSelect.addEventListener('change', applyFilters);
        }

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdAgamaData();
}

function initMuridSdJumlahBulananPage() {
    let allDataRows = [], headerRow1 = [], headerRow2 = [], currentFilteredRows = [];
    let statusIndex = -1; // Kolom B (Status) yang akan disembunyikan

    function buildTable() {
        const table = document.getElementById('muridSdBulananTable');
        const tableHead = table.querySelector('thead');
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody || !tableFoot || !tableHead) return;

        let firstRowHTML = '<tr><th rowspan="2">No.</th>';
        let secondRowHTML = '<tr>';
        for (let i = 0; i < headerRow1.length; i++) {
            if (i === statusIndex) continue;
            const topHeader = headerRow1[i];
            if (topHeader && topHeader.trim() !== '') {
                let colspan = 0;
                let subheaders = [];
                let k = i;
                while (k < headerRow1.length && (headerRow1[k] === '' || headerRow1[k] === null || k === i)) {
                    if (k !== statusIndex) {
                       colspan++;
                       subheaders.push(`<th>${headerRow2[k] || ''}</th>`);
                    }
                    k++;
                }
                if (colspan > 1) {
                    firstRowHTML += `<th colspan="${colspan}">${topHeader}</th>`;
                    secondRowHTML += subheaders.join('');
                    i = k - 1;
                } else {
                    firstRowHTML += `<th rowspan="2">${topHeader}</th>`;
                }
            }
        }
        firstRowHTML += '</tr>';
        secondRowHTML += '</tr>';
        tableHead.innerHTML = firstRowHTML + secondRowHTML;
        
        tableBody.innerHTML = '';
        const visibleColsCount = headerRow1.length - 1;
        if (currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${visibleColsCount + 1}">Tidak ada data yang cocok.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        currentFilteredRows.forEach((row, index) => {
            let bodyRowHTML = `<td>${index + 1}</td>`;
            row.forEach((cell, i) => {
                if (i !== statusIndex) {
                    bodyRowHTML += `<td>${(cell == 0 && cell !== '') ? '-' : cell}</td>`;
                }
            });
            tableBody.innerHTML += `<tr>${bodyRowHTML}</tr>`;
        });

        const totals = new Array(headerRow2.length).fill(0);
        const sumStartIndex = headerRow1.indexOf('Rombel');

        currentFilteredRows.forEach(row => {
            if (sumStartIndex > -1) {
                for (let i = sumStartIndex; i < row.length; i++) {
                    const value = parseInt(String(row[i]).replace(/[^0-9]/g, ''), 10);
                    if (!isNaN(value)) {
                        totals[i] += value;
                    }
                }
            }
        });
        
        let totalRowHTML = '<tr><td>-</td>';
        
        for (let i = 0; i < headerRow1.length; i++) {
            if (i === statusIndex) continue;
            const namaSekolahIndex = 0;
            if (i === namaSekolahIndex) {
                totalRowHTML += '<td>JUMLAH</td>';
            } else if (i < sumStartIndex) {
                totalRowHTML += '<td>-</td>';
            } else {
                totalRowHTML += `<td>${totals[i] === 0 ? '-' : totals[i]}</td>`;
            }
        }
        
        totalRowHTML += '</tr>';
        tableFoot.innerHTML = totalRowHTML;
    }
    
    function applyFilters() {
        const filterTahun = document.getElementById('filterTahun').value;
        const filterBulan = document.getElementById('filterBulan').value;
        const filterStatus = document.getElementById('filterStatus').value;

        const tahunIndex = headerRow1.indexOf('Tahun');
        const bulanIndex = headerRow1.indexOf('Bulan');
        
        currentFilteredRows = allDataRows.filter(row => {
            const tahunMatch = (filterTahun === "") || (String(row[tahunIndex]) === filterTahun);
            const bulanMatch = (filterBulan === "") || (String(row[bulanIndex]) === filterBulan);
            const statusMatch = (filterStatus === "") || (statusIndex === -1) || (String(row[statusIndex]) === filterStatus);
            return tahunMatch && bulanMatch && statusMatch;
        });
        buildTable();
    }

    function initializePage(dataArray) {
        const loadingStatus = document.getElementById('loadingStatus');
        const tableWrapper = document.getElementById('tableWrapper');

        if (!dataArray || dataArray.length < 3) {
            loadingStatus.innerHTML = "<p>Data tidak ditemukan.</p>"; 
            return;
        }

        headerRow1 = dataArray[0];
        headerRow2 = dataArray[1];
        allDataRows = dataArray.slice(2);
        
        // PERBAIKAN UTAMA: Hanya sembunyikan kolom "Status"
        statusIndex = headerRow1.indexOf('Status');
        if (statusIndex === -1) statusIndex = 1; // Fallback jika tidak ditemukan, anggap di kolom B

        const populateFilter = (elementId, colName, sortReverse = false, specialSort = null) => {
            const select = document.getElementById(elementId);
            const colIndex = headerRow1.indexOf(colName);
            if (!select || colIndex === -1) return;
            
            const uniqueValues = [...new Set(allDataRows.map(row => String(row[colIndex])))].filter(Boolean);
            select.innerHTML = `<option value="">Semua</option>`;
            let sorted = uniqueValues;
            if (specialSort === 'bulan') {
                const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                sorted = uniqueValues.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            } else {
                sorted = uniqueValues.sort();
            }
            if (sortReverse) sorted.reverse();

            sorted.forEach(val => select.add(new Option(val, val)));
            select.addEventListener('change', applyFilters);
        };

        populateFilter('filterTahun', 'Tahun', true);
        populateFilter('filterBulan', 'Bulan', false, 'bulan');
        populateFilter('filterStatus', 'Status');
        
        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const lastMonthName = monthNames[prevMonthIndex];

        const tahunSelect = document.getElementById('filterTahun');
        if (tahunSelect && [...tahunSelect.options].some(opt => opt.value === currentYear)) {
            tahunSelect.value = currentYear;
        }
        const bulanSelect = document.getElementById('filterBulan');
        if (bulanSelect && [...bulanSelect.options].some(opt => opt.value === lastMonthName)) {
            bulanSelect.value = lastMonthName;
        }

        loadingStatus.style.display = 'none';
        tableWrapper.style.display = 'flex';
        applyFilters();
    }
    
    google.script.run
        .withSuccessHandler(initializePage)
        .withFailureHandler(error => {
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJumlahBulananData();
}

function initSiabaDaftarPresensiPage() {
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const tableHead = document.getElementById('presensiTable').querySelector('thead');
    const tableBody = document.getElementById('presensiTable').querySelector('tbody');

    let allMonthlyData = [];
    let displayHeaders = [];

    const backgroundMap = {
        'HA': 'cell-bg-cream', 'APL': 'cell-bg-cream', 'TAp': 'cell-bg-cream',
        'HU': 'cell-bg-cream', 'U': 'cell-bg-cream', 'TU': 'cell-bg-cream',
        'CT': 'cell-bg-green', 'CAP': 'cell-bg-green', 'CS': 'cell-bg-green', 'CM': 'cell-bg-green',
        'DD': 'cell-bg-blue', 'DL': 'cell-bg-blue',
        'TA': 'cell-bg-yellow', 'Waktu TA': 'cell-bg-yellow', 'PLA': 'cell-bg-yellow', 'Waktu PLA': 'cell-bg-yellow',
        'LA': 'cell-bg-purple'
    };

    const fontColorMap = {
        'CT': 'font-green', 'CAP': 'font-green', 'CS': 'font-green', 'CM': 'font-green',
        'DD': 'font-blue', 'DL': 'font-blue',
        'DP': 'font-brown'
    };
    
    // --- BARU: Daftar kolom yang font-nya akan diwarnai merah ---
    const redFontColumns = ['TAp', 'TU', 'TA', 'PLA', 'LA'];

    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option('Semua', 'Semua'));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        } else if (options.length > 0 && selectElement.id !== 'filterUnitKerja') {
             selectElement.selectedIndex = 0;
        }
    }

    function renderTable() {
        const selectedUnitKerja = filterUnitKerja.value;
        
        const filteredRows = (selectedUnitKerja === "Semua")
            ? allMonthlyData
            : allMonthlyData.filter(row => row[0] === selectedUnitKerja);
        
        tableBody.innerHTML = '';
        if (!filteredRows || filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}">Tidak ada data untuk unit kerja ini.</td></tr>`;
        } else {
            const tpIndex = displayHeaders.indexOf('TP');
            const dayStartIndex = displayHeaders.indexOf('1D');
            const dayEndIndex = displayHeaders.indexOf('31P');

            filteredRows.forEach((row, index) => {
                const rowData = row.slice(1); 
                const tr = document.createElement('tr');
                
                let rowHTML = `<td>${index + 1}</td>`;
                rowData.forEach((cell, cellIndex) => {
                    const header = displayHeaders[cellIndex];
                    let classes = [];
                    const isNumericValuePositive = parseInt(cell, 10) > 0;

                    if (backgroundMap[header]) {
                        classes.push(backgroundMap[header]);
                    }
                    
                    if (dayStartIndex !== -1 && cellIndex >= dayStartIndex && cellIndex <= dayEndIndex) {
                        if (cell === '' || cell === null || cell === undefined) {
                            classes.push('cell-bg-red');
                        } else if (cell === '-') {
                            classes.push('cell-bg-gray');
                        } else if (fontColorMap[cell]) {
                            classes.push(fontColorMap[cell]);
                        }
                    }

                    if (cellIndex === tpIndex && isNumericValuePositive) {
                        classes.push('cell-negative');
                    }
                    
                    // --- Logika BARU untuk font merah ---
                    if (redFontColumns.includes(header) && isNumericValuePositive) {
                        classes.push('font-red');
                    }
                    
                    const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                    const cellContent = (cell === '' || cell === null || cell === undefined || cell === '0') ? '-' : cell;
                    rowHTML += `<td${classString}>${cellContent}</td>`;
                });

                tr.innerHTML = rowHTML;
                tableBody.appendChild(tr);
            });
        }
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value
        };

        if (!filters.tahun || !filters.bulan) {
            showAppModal('info', 'Silakan pilih Tahun dan Bulan terlebih dahulu.');
            return;
        }

        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none';
                if (result.error) {
                     loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${result.error}</p>`;
                     loadingStatus.style.display = 'flex';
                     return;
                }

                allMonthlyData = result.rows; 
                displayHeaders = result.headers.slice(1);

                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);
                
                tableWrapper.style.display = 'flex';
                renderTable();
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none';
                loadingStatus.innerHTML = `<p style="color:red;">Gagal menghubungi server: ${err.message}</p>`;
                loadingStatus.style.display = 'flex';
            })
            .getSiabaPresensiData(filters);
    }

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], 'Semua');

            terapkanBtn.addEventListener('click', fetchData);
            filterUnitKerja.addEventListener('change', renderTable);
            fetchData();
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat filter. Error: ${err.message}</p>`;
        })
        .getSiabaFilterOptions();
}

function initSiabaTidakPresensiPage() {
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const tableHead = document.getElementById('tidakPresensiTable').querySelector('thead');
    const tableBody = document.getElementById('tidakPresensiTable').querySelector('tbody');

    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option('Semua', 'Semua'));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        } else if (options.length > 0 && selectElement.id !== 'filterUnitKerja') {
             selectElement.selectedIndex = 0;
        }
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnitKerja.value
        };
        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none';
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + result.headers.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);

                tableBody.innerHTML = '';
                if (!result.rows || result.rows.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${result.headers.length + 1}">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
                } else {
                    result.rows.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${index + 1}</td>` + row.map(cell => `<td>${cell || '-'}</td>`).join('');
                        tableBody.appendChild(tr);
                    });
                }
                tableWrapper.style.display = 'flex';
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none';
                tableWrapper.style.display = 'flex'; // Tampilkan wrapper agar pesan error terlihat
                tableBody.innerHTML = `<tr><td colspan="7" style="color:red;">Gagal memuat data: ${err.message}</td></tr>`;
            })
            .getSiabaTidakPresensiData(filters);
    }

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], 'Semua');

            terapkanBtn.addEventListener('click', fetchData);
            fetchData(); // Langsung muat data awal
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat opsi filter: ${err.message}</p>`;
        })
        .getSiabaTidakPresensiFilterOptions();
}

/**
 * [FUNGSI GENERIK FINAL - v5.0]
 * Versi stabil yang memperbaiki error crash dan menggabungkan semua fitur:
 * - Filter (termasuk pengurutan bulan & filter berantai)
 * - Filter Default
 * - Paginasi otomatis
 * - Tombol Aksi (Edit/Hapus) yang dinamis dan aman
 * - Penanganan format data Array & Objek
 * - Konversi nilai 0 menjadi strip (-)
 * - Footer dengan kalkulasi total
 */
function initializeGenericTablePage(config) {
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;

    function calculateRowsPerPage() {
        const tableContainer = document.getElementById(config.tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const rowHeight = 40;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - 180;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    }

    function buildTable() {
        const table = document.getElementById(config.tableId);
        if (!table) return;
        const tableBody = table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        
        if (!tableBody) return;
        tableBody.innerHTML = '';
        if (tableFoot) tableFoot.innerHTML = '';

        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, start + rowsPerPage);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headerCols.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            paginatedRows.forEach((rowObjectOrArray, index) => {
                const tr = document.createElement('tr');
                let rowCells = [`<td>${start + index + 1}</td>`];
                const isObject = typeof rowObjectOrArray === 'object' && !Array.isArray(rowObjectOrArray);

                headerCols.forEach((header, colIndex) => {
                    let cellData = isObject ? (rowObjectOrArray[header] ?? '') : (rowObjectOrArray[colIndex] ?? '');

                    if (header === 'Aksi') {
                        const rowIndex = rowObjectOrArray._rowIndex;
                        const source = rowObjectOrArray._source;
                        let editPage = config.editPage;

                        if (source === 'PAUD') editPage = 'lapbul_edit_paud';
                        else if (source === 'SD') editPage = 'lapbul_edit_sd';
                        
                        if (editPage && rowIndex !== undefined) {
                            rowCells.push(`
                                <td class="action-buttons">
                                    <button class="action-btn edit-btn" onclick="loadPage(event, '${editPage}', { rowIndex: ${rowIndex}, source: '${source}' })"><i class="fas fa-pencil-alt"></i> Edit</button>
                                    <button class="action-btn delete-btn" onclick="showDeleteConfirmation(this)" data-row-info='${JSON.stringify(rowObjectOrArray)}'><i class="fas fa-trash"></i> Hapus</button>
                                </td>`);
                        } else {
                            rowCells.push('<td>-</td>');
                        }
                    } else if (header === 'Dokumen' && String(cellData).startsWith('http')) {
                        rowCells.push(`<td class="view-btn-container"><a href="${cellData}" target="_blank" class="action-btn view-btn"><i class="fas fa-eye"></i> Lihat</a></td>`);
                    } else {
                        let displayCell = (cellData === '' || cellData === null) ? '-' : cellData;
                        if (displayCell === 'T') displayCell = '<span style="color: var(--color-green); font-weight: bold;">✓</span>';
                        else if (displayCell === 'F') displayCell = '<span style="color: var(--color-red); font-weight: bold;">✗</span>';
                        else if (displayCell === '0' || displayCell === 0) displayCell = '-';
                        rowCells.push(`<td>${displayCell}</td>`);
                    }
                });
                tr.innerHTML = rowCells.join('');
                tableBody.appendChild(tr);
            });
        }

        if (tableFoot && config.footerConfig && config.footerConfig.enabled && currentFilteredRows.length > 0) {
            const totals = {};
            headerCols.forEach(h => totals[h] = 0);
            const sumStartCol = config.footerConfig.sumStartColumn;
            const sumStartIndex = headerCols.indexOf(sumStartCol);

            if (sumStartIndex > -1) {
                currentFilteredRows.forEach(row => {
                    for (let i = sumStartIndex; i < headerCols.length; i++) {
                        const header = headerCols[i];
                        const value = parseInt(row[header], 10);
                        if (!isNaN(value)) totals[header] += value;
                    }
                });
                let totalRowCells = ['<td>-</td>'];
                headerCols.forEach(header => {
                    if (header === config.footerConfig.labelColumn) totalRowCells.push('<td>JUMLAH</td>');
                    else if (headerCols.indexOf(header) >= sumStartIndex) totalRowCells.push(`<td>${totals[header] || '-'}</td>`);
                    else totalRowCells.push('<td>-</td>');
                });
                tableFoot.innerHTML = `<tr>${totalRowCells.join('')}</tr>`;
                tableFoot.classList.add('has-content');
            }
        } else if (tableFoot) {
            tableFoot.classList.remove('has-content');
        }
        setupPagination();
    }
    
    function setupPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;
        paginationContainer.innerHTML = '';
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        if (pageCount <= 1) { paginationContainer.style.display = 'none'; return; }
        paginationContainer.style.display = 'flex';
        
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="changePage(1)">»</button>`;
        
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    }
    
    function applyFilters() {
        const filters = config.filterConfig.map(f => ({
            ...f,
            value: document.getElementById(f.id)?.value ?? ""
        }));
        
        currentFilteredRows = allDataRows.filter(row => {
            return filters.every(f => f.value === "" || String(row[f.dataColumn]) === f.value);
        });
        
        currentPage = 1;
        buildTable();
    }

    function updateDependentFilters(masterFilterId) {
        const masterSelect = document.getElementById(masterFilterId);
        if (!masterSelect) return;
        const masterValue = masterSelect.value;
        
        const dependentFilters = config.filterConfig.filter(f => f.dependsOn === masterFilterId);

        dependentFilters.forEach(depFilter => {
            const select = document.getElementById(depFilter.id);
            if (!select) return;

            const relevantRows = masterValue === "" ? allDataRows : allDataRows.filter(row => row[depFilter.dependencyColumn] === masterValue);
            const uniqueValues = [...new Set(relevantRows.map(row => String(row[depFilter.dataColumn])))].filter(Boolean).sort();
            
            const currentValue = select.value;
            select.innerHTML = `<option value="">Semua</option>`;
            uniqueValues.forEach(val => select.add(new Option(val, val)));

            if ([...select.options].some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }
        });
    }

    window.changePage = (direction) => {
        currentPage += direction;
        buildTable();
    };

    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    
    google.script.run
        .withSuccessHandler(data => {
            // Seluruh blok withSuccessHandler ini sudah benar, tidak perlu diubah
            if (data.error || !data.rows || data.rows.length === 0) {
                loadingStatus.innerHTML = "<p>Tidak ada data untuk ditampilkan.</p>";
                return;
            }
            allDataRows = data.rows;
            headerCols = data.headers;
            const tableHead = document.getElementById(config.tableId)?.querySelector('thead');
            if (tableHead) {
                tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }
            (config.filterConfig || []).forEach(filterConf => {
                const select = document.getElementById(filterConf.id);
                if (!select) return;
                if (!filterConf.dependsOn) {
                    const uniqueValues = [...new Set(allDataRows.map(row => String(row[filterConf.dataColumn])))].filter(Boolean);
                    select.innerHTML = `<option value="">Semua</option>`;
                    let sortedValues = uniqueValues.sort((a,b) => a.localeCompare(b, undefined, {numeric: true}));
                    if (filterConf.specialSort === 'bulan') {
                        const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                        sortedValues = uniqueValues.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                    }
                    if (filterConf.sortReverse) sortedValues.reverse();
                    sortedValues.forEach(val => select.add(new Option(val, val)));
                }
                select.addEventListener('change', () => {
                    if (config.filterConfig.some(f => f.dependsOn === filterConf.id)) {
                        updateDependentFilters(filterConf.id);
                    }
                    applyFilters();
                });
            });
            (config.filterConfig || []).forEach(filterConf => {
                if (filterConf.dependsOn) {
                    updateDependentFilters(filterConf.dependsOn);
                }
            });
            let filtersChanged = false;
            if (config.defaultFilters) {
                config.defaultFilters.forEach(df => {
                    const select = document.getElementById(df.id);
                    const defaultValue = df.value();
                    if (select && [...select.options].some(opt => opt.value === defaultValue)) {
                        select.value = defaultValue;
                        filtersChanged = true;
                    }
                });
            }
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            rowsPerPage = calculateRowsPerPage();
            if(filtersChanged) {
                applyFilters();
            } else {
                buildTable();
            }
            window.addEventListener('resize', () => {
                rowsPerPage = calculateRowsPerPage();
                buildTable();
            });
        })
        .withFailureHandler(error => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        [config.serverFunction]();
}

/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */

const pageInitializers = {
    'home': initHomePage,
    'sk_menu': initSubMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initSubMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage,
    'lapbul_status': initLapbulStatusPage,
    'lapbul_arsip': initLapbulArsipPage,
    'lapbul_kelola': initLapbulKelolaPage,
    'lapbul_edit_paud': initLapbulEditPaudPage,
    'lapbul_edit_sd': initLapbulEditSdPage,
    'lapbul_unduh_format': initLapbulUnduhFormatPage,
    'ptk_menu': initSubMenuPage,
    'ptk_paud_menu': initSubMenuPage,
    'ptk_sd_menu': initSubMenuPage,
    'ptk_keadaan_paud': initPtkKeadaanPaudPage,
    'ptk_keadaan_sd': initPtkKeadaanSdPage,
    'ptk_jumlah_bulanan_sd': initPtkJumlahBulananSdPage,
    'ptk_jumlah_bulanan_paud': initPtkJumlahBulananPaudPage,
    'ptk_daftar_paud': initPtkDaftarPaudPage,
    'ptk_kelola_paud': initPtkKelolaPaudPage,
    'ptk_tambah_paud': initPtkTambahPaudPage,
    'ptk_edit_paud': initPtkEditPaudPage,
    'ptk_daftar_sd_negeri': initPtkDaftarSdnPage,
    'ptk_daftar_sd_swasta': initPtkDaftarSdsPage,
    'ptk_kelola_sd': initPtkKelolaSdPage,
    'ptk_kebutuhan_sd_negeri': initPtkKebutuhanSdnPage,
    'ptk_tambah_sd': initPtkTambahSdPage,
    'ptk_edit_sd': initPtkEditSdPage,
    'ptk_bezetting_sd_negeri': initSubMenuPage,
    'murid_menu': initSubMenuPage,
    'murid_paud_kelas_usia': initMuridPaudKelasUsiaPage,
    'murid_paud_jenis_kelamin': initMuridPaudJenisKelaminPage,
    'murid_paud_jumlah_bulanan': initMuridPaudJumlahBulananPage,
    'murid_sd_kelas': initMuridSdKelasPage,
    'murid_sd_rombel': initMuridSdRombelPage,
    'murid_sd_jenis_kelamin': initMuridSdJenisKelaminPage,
    'murid_sd_agama': initMuridSdAgamaPage,
    'murid_sd_jumlah_bulanan': initMuridSdJumlahBulananPage,
    'siaba_menu': initSubMenuPage,
    'siaba_menu': initSubMenuPage,
    'siaba_panduan': initSubMenuPage,
    'siaba_daftar_presensi': initSiabaDaftarPresensiPage,
    'siaba_tidak_presensi': initSiabaTidakPresensiPage,
    'siaba_apel_upacara': initSubMenuPage,
    'siaba_lupa_presensi': initSubMenuPage,
    'siaba_salah_presensi': initSubMenuPage,
    'siaba_perjalanan_dinas': initSubMenuPage,
    'siaba_cuti': initSubMenuPage,
    'siaba_rekap_terlambat': initSubMenuPage,
    'siaba_rekap_pulang_awal': initSubMenuPage,
    'siaba_unduh_rekap': initSubMenuPage,
    'pns_menu': initSubMenuPage,
    'rapor_pendidikan_menu': initSubMenuPage,
    'tata_naskah_menu': initSubMenuPage,
    'mutasi_murid_menu': initSubMenuPage,
    'tapera_sitara_menu': initSubMenuPage,
    'administrasi_sekolah_menu': initSubMenuPage,
    'data_sekolah_menu': initSubMenuPage,
    'komunitas_belajar_menu': initSubMenuPage,
    'gelar_karya_menu': initSubMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    loadPage(null, 'home');
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link) return;
        const pageName = link.dataset.page;
        const isSubmenuToggle = link.hasAttribute('data-page-parent');
        if (isSubmenuToggle) {
            e.preventDefault();
            link.parentElement.classList.toggle('open');
        }
        if (pageName) {
            e.preventDefault();
            loadPage(null, pageName);
        }
    });
});
</script>
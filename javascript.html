<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>

<div id="previewModal" class="modal-overlay">
    <div class="modal-content" style="width: 90%; max-width: 1000px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: #2c3e50;">
        <div style="padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin: 0; color: white; font-size: 1.1em;"><i class="fas fa-file-pdf" style="margin-right:8px; color:#e74c3c;"></i>Pratinjau Dokumen</h3>
            <div style="display: flex; align-items: center; gap: 15px;">
                <a id="previewDownloadBtn" href="#" target="_blank" style="display: none; align-items: center; color: #3498db; text-decoration: none; font-weight: bold; font-size: 0.9em; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 4px;">
                    <i class="fas fa-download" style="margin-right: 5px;"></i> Unduh
                </a>
                <button onclick="App.closePreview()" style="background: none; border: none; color: #bdc3c7; font-size: 1.5em; cursor: pointer; transition: color 0.2s;">&times;</button>
            </div>
        </div>
        <div style="flex-grow: 1; position: relative; background: #fff;">
            <iframe id="previewFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
            <div id="previewLoading" style="position: absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.8); color:#333;">Memuat dokumen...</div>
        </div>
    </div>
</div>

<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */
 
// DEKLARASI NAMESPACE UTAMA
const App = {};

// Helper Validasi Tanggal Dinas
// Aturan: Mulai >= SPT, Selesai >= Mulai
function setupDateValidation(idSpt, idMulai, idSelesai) {
    const elSpt = document.getElementById(idSpt);
    const elMulai = document.getElementById(idMulai);
    const elSelesai = document.getElementById(idSelesai);

    if (!elSpt || !elMulai || !elSelesai) return;

    // 1. Saat Tanggal SPT berubah
    elSpt.addEventListener('change', () => {
        if (elSpt.value) {
            // Set batas minimal Tanggal Mulai = Tanggal SPT
            elMulai.min = elSpt.value;
            
            // Jika Tanggal Mulai yang sudah dipilih ternyata lebih kecil, reset
            if (elMulai.value && elMulai.value < elSpt.value) {
                elMulai.value = elSpt.value;
                // Picu event change di Mulai agar Selesai juga menyesuaikan
                elMulai.dispatchEvent(new Event('change')); 
            }
        }
    });

    // 2. Saat Tanggal Mulai berubah
    elMulai.addEventListener('change', () => {
        if (elMulai.value) {
            // Validasi Mundur: Mulai tidak boleh < SPT
            if (elSpt.value && elMulai.value < elSpt.value) {
                App.showAppModal('error', 'Tanggal Mulai tidak boleh sebelum Tanggal SPT.');
                elMulai.value = elSpt.value;
            }
            
            // Set batas minimal Tanggal Selesai = Tanggal Mulai
            elSelesai.min = elMulai.value;
            
            // Jika Tanggal Selesai yang sudah dipilih lebih kecil, reset
            if (elSelesai.value && elSelesai.value < elMulai.value) {
                elSelesai.value = elMulai.value;
            }
        }
    });

    // 3. Saat Tanggal Selesai berubah
    elSelesai.addEventListener('change', () => {
        if (elSelesai.value && elMulai.value) {
            // Validasi: Selesai tidak boleh < Mulai
            if (elSelesai.value < elMulai.value) {
                App.showAppModal('error', 'Tanggal Selesai tidak boleh sebelum Tanggal Mulai.');
                elSelesai.value = elMulai.value;
            }
        }
    });
}

App.showAppModal = (state, message, redirectPage = null) => {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) App.loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
};

App.loadPage = (event, pageName, params = {}) => {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;

                
                
                // KEMBALIKAN KE 0
                setTimeout(() => {
                    if (typeof App.pageInitializers !== 'undefined' && typeof App.pageInitializers[pageName] === 'function') {
                        App.pageInitializers[pageName](params);
                    }
                    App.updateActiveMenu(pageName);
                }, 0); 

            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p><p><strong>Stack:</strong> ${e.stack}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
};

App.updateActiveMenu = (pageName) => {
    // 1. Reset: Hapus semua kelas active dan open
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar-menu .has-submenu').forEach(el => el.classList.remove('open'));

    // 2. Cari link yang sesuai dengan pageName saat ini
    const activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);

    if (activeLink) {
        // Tandai link ini sebagai aktif
        activeLink.classList.add('active');

        // 3. Buka semua induk (Parent Menu) dari link ini
        let parentItem = activeLink.closest('.has-submenu');
        
        while (parentItem) {
            // Tambahkan kelas open ke <li> parent
            parentItem.classList.add('open');
            
            // Cari <a> milik parent tersebut (judul menu utama) dan aktifkan warnanya
            // Kita cari <a> pertama yang merupakan anak langsung dari parentItem
            const parentLink = parentItem.querySelector('a'); 
            if (parentLink) {
                parentLink.classList.add('active');
            }

            // Lanjut naik ke atas (jika ada level 3, dia akan naik ke level 2, lalu level 1)
            parentItem = parentItem.parentElement.closest('.has-submenu');
        }
    }
};

App.debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

const parseCustomDateTime = (dateStr) => {
    // Pastikan input adalah string, bersihkan spasi ekstra, dan periksa null/kosong
    const cleanedStr = String(dateStr).trim();
    if (!cleanedStr || cleanedStr === '-') return 0;
    
    // RegEx yang disederhanakan untuk menangkap format dd/MM/yyyy HH:mm:ss
    const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);

    if (parts && parts.length === 7) {
        // parts[1]: Tanggal (d)
        // parts[2]: Bulan (M) - Kritis: Harus dikurangi 1 (0 = Januari)
        // parts[3]: Tahun (yyyy)
        // parts[4]: Jam (HH)
        // parts[5]: Menit (mm)
        // parts[6]: Detik (ss)
        
        // Buat objek Date. (Bulan: parts[2] - 1)
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
    }
    
    // Fallback: Coba konversi sebagai string yang hanya berisi tanggal (dd/MM/yyyy)
    const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (dateOnly) {
        return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
    }
    
    return 0; // Jika tidak ada yang cocok, disortir ke posisi paling akhir
};

App.setupInfoDropdown = (buttonId, contentId, infoItems) => {
    const infoBtn = document.getElementById(buttonId);
    const contentDiv = document.getElementById(contentId);
    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    if (infoItems && infoItems.length > 0) {
        const infoContent = `<ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">${infoItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
        contentDiv.innerHTML = infoContent;
        isDataLoaded = true;
    } else {
        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
    }
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
    };
};

const applySorting = (sortConfig) => {
    if (!sortConfig || currentFilteredRows.length === 0) return;

    currentFilteredRows.sort((a, b) => {
        for (let i = 0; i < sortConfig.length; i++) {
            const conf = sortConfig[i];
            
            // Tentukan parser, default adalah fungsi identitas jika tidak ada
            const parser = conf.parser || ((val) => val); 

            // Ambil nilai dan pastikan nilai yang tidak ada (null/undefined) menjadi 0 (untuk disortir terakhir)
            const valA = parser(a[conf.column]) || 0; 
            const valB = parser(b[conf.column]) || 0; 

            const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;

            if (comparison !== 0) {
                return conf.order === 'DESC' ? -comparison : comparison;
            }
        }
        return 0;
    });

    // Setelah disortir, bangun ulang tabel
    buildTable(); 
};

// ===============================================================
// === FUNGSI GENERIK TABEL DITEMPATKAN DI SINI (SEBELUM INIT) ===
// ===============================================================

App.initializeGenericTablePage = (config) => {
    // VARIABEL LOKAL
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
    let filterData = null;
    
    config.filters = config.filters || [];
    
    // --- FUNGSI HELPER LOKAL ---
    const getRowValue = (row, key) => {
        const isDataNested = config.tableId === 'kelolaTable' || config.tableId === 'kelolaPtkSdTable';
        return isDataNested ? (row.data ? row.data[key] : row[key]) : row[key];
    };
    
    // FUNGSI PARSER UNTUK SORTING TANGGAL
    const parseCustomDateTime = (dateStr) => {
        const cleanedStr = String(dateStr).trim();
        if (!cleanedStr || cleanedStr === '-') return 0;
        const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);
        if (parts && parts.length === 7) {
            return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
        }
        const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (dateOnly) {
            return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
        }
        return 0;
    };
    
    // FUNGSI SORTING
    const applySorting = (dataArray, sortConfig) => {
        if (!sortConfig || dataArray.length === 0) return dataArray;
        dataArray.sort((a, b) => {
            for (let i = 0; i < sortConfig.length; i++) {
                const conf = sortConfig[i];
                const parser = conf.parser || ((val) => val); 
                const valA = parser(a[conf.column]) || 0; 
                const valB = parser(b[conf.column]) || 0; 
                const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;
                if (comparison !== 0) {
                    return conf.order === 'DESC' ? -comparison : comparison;
                }
            }
            return 0;
        });
        return dataArray; 
    };
    
    // FUNGSI PAGINATION
    const calculateRowsPerPage = () => {
        const tableContainer = document.getElementById(config.tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const paginationContainer = document.getElementById('pagination-container');
        const bottomOffset = paginationContainer ? 180 : 100;
        const rowHeight = 38;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = () => {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    App.changePage = (direction) => {
        currentPage += direction;
        buildTable();
    };

    // ========================================================
    // ===== FUNGSI buildTable DENGAN LOGIKA FOOTER BARU =====
    // ========================================================
    const buildTable = () => {
        const table = document.getElementById(config.tableId);
        if (!table) return;
        const tableBody = document.getElementById(config.tableId + 'Body') || table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        if (tableFoot) tableFoot.innerHTML = '';

        const usePagination = !!document.getElementById('pagination-container');
        let paginatedRows = currentFilteredRows;
        
        if (usePagination) {
            rowsPerPage = calculateRowsPerPage();
            const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage) || 1;
            currentPage = Math.min(currentPage, pageCount) || 1;
            const start = (currentPage - 1) * rowsPerPage;
            paginatedRows = currentFilteredRows.slice(start, start + rowsPerPage);
            setupPagination();
        }

        if (paginatedRows.length === 0) {
            const colspan = headerCols.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            const AppLoadPage = App.loadPage;
            const AppShowDelete = App.showDeleteConfirmation;
            
            paginatedRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                const rowNumber = usePagination ? (currentPage - 1) * rowsPerPage + index + 1 : index + 1;
                const tdNum = document.createElement('td');
                tdNum.textContent = rowNumber;
                tr.appendChild(tdNum);

                headerCols.forEach(header => {
                    const cellData = row[header] ?? '';
                    const td = document.createElement('td');
                    if (header === 'Dokumen' && String(cellData).startsWith('http')) {
                        td.className = 'view-btn-container';
                        const btn = document.createElement('button');
                        btn.className = 'action-btn view-btn';
                        btn.innerHTML = '<i class="fas fa-eye"></i> Lihat';
                        // Panggil fungsi preview yang sudah kita buat
                        btn.onclick = (e) => {
                            e.preventDefault();
                            App.showFilePreview(cellData);
                        };
                        td.appendChild(btn);
                    } else if (header === 'Aksi') {
                        const rowIndex = row._rowIndex;
                        const source = row._source;
                        if (rowIndex !== undefined && typeof AppLoadPage === 'function' && typeof AppShowDelete === 'function') {
                            td.className = 'action-buttons';
                            let dynamicEditPage = config.editPage || 'lapbul_edit_sd'; 
                            if (config.tableId === 'lapbulKelolaTable') {
                                dynamicEditPage = (source === 'PAUD') ? 'lapbul_edit_paud' : 'lapbul_edit_sd';
                            }
                            const editButton = document.createElement('button');
                            editButton.className = 'action-btn edit-btn';
                            editButton.innerHTML = '<i class="fas fa-pencil-alt"></i> Edit';
                            editButton.addEventListener('click', (e) => {
                                App.loadPage(e, dynamicEditPage, { rowIndex: rowIndex, source: source });
                            });
                            const deleteButton = document.createElement('button');
                            deleteButton.className = 'action-btn delete-btn';
                            deleteButton.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                            deleteButton.dataset.rowInfo = JSON.stringify(row);
                            deleteButton.addEventListener('click', function() {
                                App.showDeleteConfirmation(this);
                            });
                            td.appendChild(editButton);
                            td.appendChild(deleteButton);
                        } else {
                            td.textContent = '-';
                        }
                    } else {
                        td.textContent = (cellData === '' || cellData === null || cellData == 0) ? '-' : cellData;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        // ===========================================
        // ===== LOGIKA BARU UNTUK FOOTER (NO-COLSPAN) =====
        // ===========================================
        if (tableFoot && config.footerConfig && config.footerConfig.enabled && currentFilteredRows.length > 0) {
            const totals = {};
            headerCols.forEach(h => totals[h] = 0);
            
            const labelColName = config.footerConfig.labelColumn; // misal: "Nama Lembaga"
            const sumStartColName = config.footerConfig.sumStartColumn; // misal: "Jumlah Rombel"
            const labelColIndex = headerCols.indexOf(labelColName); // misal: 0
            const sumStartIndex = headerCols.indexOf(sumStartColName); // misal: 3

            if (labelColIndex !== -1 && sumStartIndex !== -1) {
                // Hitung total dari SEMUA baris yang difilter (bukan hanya yang dipaginasi)
                currentFilteredRows.forEach(row => {
                    for (let i = sumStartIndex; i < headerCols.length; i++) {
                        const header = headerCols[i];
                        const val = getRowValue(row, header);
                        totals[header] += (parseFloat(val) || 0);
                    }
                });

                const tfootTr = document.createElement('tr');
                let footerCells = [];
                
                // 1. Sel 'No.' (Kolom 0)
                footerCells.push('<td>-</td>');
                
                // 2. Loop melalui headerCols (untuk Kolom 1 s/d ...)
                for (let i = 0; i < headerCols.length; i++) {
                    const header = headerCols[i];
                    
                    if (i === labelColIndex) {
                        // Ini kolom Label (misal: "Nama Lembaga")
                        footerCells.push(`<td style="text-align: left; font-weight: bold;">JUMLAH</td>`);
                    } else if (i < sumStartIndex) {
                        // Ini kolom non-data sebelum data dijumlahkan (misal: "Jenjang", "Status")
                        footerCells.push('<td>-</td>');
                    } else {
                        // Ini kolom data yang dijumlahkan (misal: "Jumlah Rombel", dst.)
                        footerCells.push(`<td>${totals[header]}</td>`);
                    }
                }
                
                tfootTr.innerHTML = footerCells.join('');
                tableFoot.appendChild(tfootTr);
            }
        }
        // ===========================================
        // ===== AKHIR LOGIKA FOOTER =====
        // ===========================================

    }; // END buildTable (Baru)

    // --- FILTER & EVENT LISTENERS (Tetap sama) ---
    const handleFilterChange = () => {
        applyFilters();
    };

    const debouncedFilterChange = App.debounce(handleFilterChange, 300);

    const setupEventListeners = () => {
        const searchInput = document.getElementById('searchFilter');
        if (searchInput) {
            searchInput.removeEventListener('input', debouncedFilterChange);
            searchInput.addEventListener('input', debouncedFilterChange);
        }
        
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown) {
                dropdown.removeEventListener('change', handleFilterChange);
                dropdown.addEventListener('change', handleFilterChange);
            }
        });
    };
    
    const applyFilters = () => {
        let filtered = allDataRows;
        
        if (config.initialSort && filtered.length > 0) {
            filtered = applySorting(filtered, config.initialSort); 
        }
        
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown && dropdown.value) {
                const filterValue = dropdown.value;
                const filterKey = filterConf.dataColumn;
                
                filtered = filtered.filter(row => {
                    const rowValue = getRowValue(row, filterKey);
                    return String(rowValue).trim() === filterValue;
                });
            }
        });

        currentFilteredRows = filtered;
        currentPage = 1;
        buildTable();
    };

    const populateCascadingFilters = (data, defaultValues = {}) => {
        filterData = data;
        
        config.filters.forEach(filterConf => {
            if (filterConf.type !== 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const filterKey = filterConf.dataColumn || filterConf.key;
                
                if (dropdown && dropdown.tagName === 'SELECT' && filterKey) {
                    let uniqueValues;
                    if (filterConf.specialSort === 'bulan') {
                        const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                        uniqueValues = [...new Set(allDataRows.map(row => String(getRowValue(row, filterKey))))]
                            .filter(Boolean)
                            .sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                    } else {
                         uniqueValues = [...new Set(allDataRows.map(row => String(getRowValue(row, filterKey))))].filter(Boolean).sort();
                    }
                    
                    if (filterConf.sortReverse) {
                        uniqueValues.reverse();
                    }

                    const defaultText = filterConf.defaultText || 'Semua';
                    dropdown.innerHTML = `<option value="">${defaultText}</option>`;
                    uniqueValues.forEach(value => {
                        dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (defaultValues && defaultValues[filterConf.id]) {
                    const defaultValue = defaultValues[filterConf.id];
                    // Cek apakah default value itu ADA di dalam <option>
                    if (uniqueValues.includes(defaultValue)) {
                        dropdown.value = defaultValue;
                    }
                }
                }
            }
        });

        config.filters.forEach(filterConf => {
            if (filterConf.type === 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const parentDropdown = document.getElementById(filterConf.parent);
                
                if (dropdown && parentDropdown) {
                    const updateDropdown = () => {
                    const selectedParentValue = parentDropdown.value;
                    const keyChild = filterConf.dataColumn || filterConf.key;
                    const keyParent = filterConf.parentKey;

                    dropdown.innerHTML = `<option value="">${filterConf.defaultText || 'Semua'}</option>`;

                    let dataToProcess = allDataRows;

                    // 1. Tentukan sumber data: SEMUA data, atau data yang SUDAH DIFILTER?
                    if (selectedParentValue) {
                    dataToProcess = allDataRows.filter(row => String(getRowValue(row, keyParent)).trim() === selectedParentValue);
                    }
                    // (Jika selectedParentValue kosong, dataToProcess tetap allDataRows)

                    // 2. Ambil nilai unik dari sumber data yang sudah ditentukan
                    const uniqueChildValues = [...new Set(dataToProcess
                   .map(row => String(getRowValue(row, keyChild))))].filter(Boolean).sort();

                    // 3. Isi dropdown
                    uniqueChildValues.forEach(value => {
                    dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                    });

                    handleFilterChange();
                    };
                    parentDropdown.removeEventListener('change', updateDropdown);
                    parentDropdown.addEventListener('change', updateDropdown);
                    dropdown.removeEventListener('change', handleFilterChange);
                    dropdown.addEventListener('change', handleFilterChange);
                    updateDropdown();
                }
            }
        });
    };

    const finalizeSetup = (hasError = false) => {
        const loadingEl = document.getElementById('loadingStatus');
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
        if (!hasError) {
            const wrapperEl = document.getElementById('tableWrapper');
            if (wrapperEl) {
                wrapperEl.style.display = 'block';
            }
            setupEventListeners();
            applyFilters();
        }
    };

    const serverFunction = config.serverFunction;
    const filterFunction = config.filterFunction;
    
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) { 
                document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Error dari Server: ${data.error}</p>`;
                finalizeSetup(true);
                return;
            }

            allDataRows = data.rows || data; 
            headerCols = config.displayHeaders || data.headers;

            const tableHead = document.querySelector(`#${config.tableId} thead`);
            if (tableHead) {
                tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }
            
            if (filterFunction) {
                google.script.run
                    .withSuccessHandler(filterResult => {
                        if (filterResult.error) {
                            document.getElementById('loadingStatus').innerHTML = `<p style="color:orange;">Gagal memuat filter: ${filterResult.error}. Tabel ditampilkan tanpa filter.</p>`;
                            filterData = {};
                        } else {
                            populateCascadingFilters(filterResult, config.defaultValues); 
                        }
                        finalizeSetup();
                    })
                    .withFailureHandler(error => {
                        document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat filter data: ${error.message}</p>`;
                        finalizeSetup(true);
                    })
                    [filterFunction](); 
            } else {
                populateCascadingFilters(null, config.defaultValues); 
                finalizeSetup(); 
            }
        })
        .withFailureHandler(error => { 
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
            finalizeSetup(true);
        })
        [serverFunction]();
};

// ===============================================================
// === "MESIN" UTAMA UNTUK FORMULIR BERTINGKAT (VERSI FINAL) ===
// ===============================================================
App.setupTabForm = (formId) => {
    const form = document.getElementById(formId);
    if (!form) return;

    const navButtons = form.querySelectorAll('.tab-link');
    const contentDivs = form.querySelectorAll('.tab-content-form');
    let currentTabIndex = 0;
    let maxUnlockedTabIndex = 0;
    const customValidations = {};

    function updateTabStates() {
        navButtons.forEach((btn, index) => {
            btn.disabled = index > maxUnlockedTabIndex;
            btn.classList.toggle('active', index === currentTabIndex);
        });
        contentDivs.forEach((div, index) => div.classList.toggle('active', index === currentTabIndex));
        if (document.getElementById('tab-content-wrapper')) {
            document.getElementById('tab-content-wrapper').scrollTop = 0;
        }
    }

    function showTab(tabIndex) {
        if (tabIndex > maxUnlockedTabIndex && tabIndex > 0) return;
        currentTabIndex = tabIndex;
        updateTabStates();
    }

    // ========================================================
    // === PERBAIKAN TOTAL DIMULAI DI SINI ===
    // ========================================================
    function validateTab(tabIndex) {
    const tabContent = contentDivs[tabIndex];
    
    // PERBAIKAN: Hanya validasi field yang 'required' DAN 'enabled' (:not(:disabled))
    const fields = tabContent.querySelectorAll('[required]:not(:disabled)');

    let isValid = true;
    
    // Hapus glow merah HANYA dari field yang akan kita periksa
    fields.forEach(field => field.classList.remove('input-error'));

    fields.forEach(field => {
        let fieldIsValid = true;
        if (field.type === 'file') {
            if (field.files.length === 0) fieldIsValid = false;
        } 
        // ðŸ› ï¸ PERBAIKAN: Input number kosong diizinkan (dianggap 0)
        else if (!field.value && field.type !== 'number') { 
            fieldIsValid = false;
        } 
        else if (field.name === 'jumlahRombel' && field.value === '0') { // Cek Rombel 0
            fieldIsValid = false;
        }
        
        if (!fieldIsValid) {
            isValid = false;
            field.classList.add('input-error'); // Tambahkan glow merah
        }
    });
    return isValid;
    }
    // ========================================================
    // === AKHIR PERBAIKAN ===
    // ========================================================
    
    updateTabStates(); 

    form.addEventListener('click', (e) => {
        const target = e.target;
        if (target.matches('.tab-link:not(:disabled)')) { showTab(Array.from(navButtons).indexOf(target)); }
        if (target.matches('.prev-tab-btn')) { showTab(currentTabIndex - 1); }
        if (target.matches('.next-tab-btn')) {
            let validationFunction = customValidations[currentTabIndex] || (() => validateTab(currentTabIndex));
            if (validationFunction()) {
                maxUnlockedTabIndex = currentTabIndex + 1;
                showTab(currentTabIndex + 1);
            }
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        // Logika submit tetap sama
    });
    
    if (!document.getElementById('form-error-style')) {
        const style = document.createElement('style');
        style.id = 'form-error-style';
        style.textContent = '.input-error { border: 2px solid var(--color-red) !important; animation: shake 0.5s; } @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }';
        document.head.appendChild(style);
    }
    
    return {
        setTabValidation: function(tabIndex, validationFunction) {
            customValidations[tabIndex] = validationFunction;
        },
        unlockTab: function(tabIndex) {
        if (tabIndex > maxUnlockedTabIndex) {
            maxUnlockedTabIndex = tabIndex;
        }
        updateTabStates();
        },
        unlockAndShowTab: function(tabIndex) {
            if (tabIndex > maxUnlockedTabIndex) {
                maxUnlockedTabIndex = tabIndex;
            }
            showTab(tabIndex);
        },
        validateTab: validateTab,
        showTab: showTab
    };
};

// ========================================================
// ===== SEMUA FUNGSI HAPUS SEKARANG ADA DI SINI =====
// ========================================================
App.showDeleteConfirmation = (button) => {
    const rowInfo = JSON.parse(button.dataset.rowInfo);
    const modal = document.getElementById('deleteModal');
    if (!modal) return;

    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');
    const cancelBtn = modal.querySelector('#cancelDeleteBtn');
    
    // Tentukan jenis data untuk pesan
    const isSk = rowInfo._source === 'SK';
    const isPaud = rowInfo._source === 'PAUD';
    const isSd = rowInfo._source === 'SDN' || rowInfo._source === 'SDS';
    // Modifikasi: Cek header 'Nama Sekolah' atau 'Nama Lembaga' untuk Lapbul
    const isLapbul = rowInfo.hasOwnProperty('Nama Sekolah') && (rowInfo._source === 'PAUD' || rowInfo._source === 'SD');

    let infoHtml = '';
    let deleteFunction;
    let reloadPage;
    
    if (isSk) {
        infoHtml = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p>
                    <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                       Sekolah: ${rowInfo['Nama SD']}<br>
                       Tahun Ajaran: ${rowInfo['Tahun Ajaran']}
                    </div>`;
        deleteFunction = App.processDeletionSK;
        reloadPage = 'sk_kelola';
    } else if (isPaud && !isLapbul) { // PTK PAUD (MEMICU PROSES 2 LANGKAH)
        // JANGAN TAMPILKAN MODAL INI
        // Langsung panggil modal Alasan
        App.showDeleteReasonPrompt(rowInfo, App.processDeletionPtkPaud, 'ptk_kelola_paud');
        return;
    } else if (isSd) { // PTK SD
        App.showDeleteReasonPrompt(rowInfo, App.processDeletionPtkSd, 'ptk_kelola_sd');
        return;
    } else if (isLapbul) { // Laporan Bulan (PAUD/SD)
        infoHtml = `<p>Apakah Anda yakin ingin menghapus Laporan Bulan ini?</p>
                    <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                       Sekolah: ${rowInfo['Nama Sekolah']}<br>
                       Bulan/Tahun: ${rowInfo['Bulan']} ${rowInfo['Tahun']}
                    </div>`;
        deleteFunction = App.processDeletionLapbul;
        reloadPage = 'lapbul_kelola';
    } else if (rowInfo._source === 'DINAS') { 
        infoHtml = `<p>Apakah Anda yakin ingin menghapus Data Perjalanan Dinas ini?</p>
                    <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                       Nama ASN: ${rowInfo['Nama']}<br>
                       Nomor SPT: ${rowInfo['Nomor SPT'] || '-'}
                    </div>`;
        deleteFunction = App.processDeletionDinas; // Fungsi baru yang akan kita buat
        reloadPage = 'siaba_dinas_cek';
    } else if (rowInfo._source === 'CUTI') {
        infoHtml = `<p>Hapus pengajuan cuti atas nama <b>${rowInfo.Nama}</b>?</p>`;
        deleteFunction = App.processDeletionCuti;
        reloadPage = 'siaba_cuti_unduh';
    } else if (rowInfo._source === 'CEKCUTI') {
        infoHtml = `<p>Hapus data unggahan cuti atas nama <b>${rowInfo.Nama}</b>?</p>`;
        deleteFunction = App.processDeletionCutiCek; // Fungsi baru
        reloadPage = 'siaba_cuti_cek';
    } else if (rowInfo._source === 'SKP') {
        infoHtml = `<p>Hapus data SKP atas nama <b>${rowInfo.Nama}</b>?</p>`;
        deleteFunction = App.processDeletionSkp;
        reloadPage = 'asn_skp_kelola';
    } else if (rowInfo._source === 'PAK') {
        infoHtml = `<p>Hapus data PAK atas nama <b>${rowInfo.Nama}</b>?</p>`;
        deleteFunction = App.processDeletionPak;
        reloadPage = 'asn_pak_kelola';    
    } else {
        App.showAppModal('error', 'Gagal: Jenis data untuk dihapus tidak teridentifikasi.');
        return;
    }

    modalTitle.textContent = 'Konfirmasi Hapus';
    modalBody.innerHTML = infoHtml;

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Ya, Hapus';
    newConfirmBtn.onclick = () => App.showDeleteCodePrompt(rowInfo, deleteFunction, reloadPage);

    cancelBtn.onclick = () => modal.classList.remove('show');
    modal.classList.add('show');
};

App.showDeleteReasonPrompt = (rowInfo, deleteFunction, reloadPage) => {
    const modal = document.getElementById('deleteModal');
    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');
    const cancelBtn = modal.querySelector('#cancelDeleteBtn');

    const namaPtk = rowInfo['Nama'] || 'PTK Ini'; // Ambil nama dari data

    modalTitle.textContent = 'Konfirmasi Hapus';
    modalBody.innerHTML = `<p>Tuliskan alasan menghapus <strong>${namaPtk}</strong> dari database.</p>
                           <input type="text" id="alasanHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Contoh: Pensiun, Mutasi, Resign, Meninggal, dsb.">`;

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Proses';

    newConfirmBtn.onclick = () => {
        const alasan = document.getElementById('alasanHapusInput').value;
        if (!alasan || alasan.trim() === '') {
            App.showAppModal('error', 'Alasan tidak boleh kosong.');
            return;
        }
        // Panggil Modal 2 (Kode Hapus) dan teruskan alasannya
        App.showDeleteCodePrompt(rowInfo, deleteFunction, reloadPage, alasan);
    };

    cancelBtn.onclick = () => modal.classList.remove('show');
    modal.classList.add('show');

    setTimeout(() => document.getElementById('alasanHapusInput').focus(), 100);
};

App.showDeleteCodePrompt = (rowInfo, deleteFunction, reloadPage, alasan) => {
    const modal = document.getElementById('deleteModal');
    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');

    modalTitle.textContent = 'Masukkan Kode Hapus';
    modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p>
                             <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
    
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Konfirmasi & Hapus';
    newConfirmBtn.onclick = () => deleteFunction(rowInfo, reloadPage, alasan);

    modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');

    setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
};

App.processDeletionSK = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data dan file terkait...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            App.showAppModal('success', response, reloadPage);
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deleteSKData(rowInfo._rowIndex, deleteCode);
};

App.processDeletionPtkPaud = (rowInfo, reloadPage, alasan) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data...');
    google.script.run
        .withSuccessHandler(response => { // <--- TITIK EKSTRA SUDAH DIHAPUS
    document.getElementById('deleteModal').classList.remove('show');

    // --- TAKTIK DEKODER DIMULAI ---
    if (response && response.error) {
        // Jika server mengirim objek { error: "..." }
        App.showAppModal('error', response.error); 
    } else {
        // Jika server mengirim string sukses
        App.showAppModal('success', response, reloadPage); 
    }
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deletePtkPaudData(rowInfo._rowIndex, deleteCode, alasan);
};

App.processDeletionPtkSd = (rowInfo, reloadPage, alasan) => { // <-- TAMBAHKAN 'alasan'
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            // Tambahkan penanganan error jika server mengembalikan objek { error: "..." }
            if (response && response.error) {
                App.showAppModal('error', response.error); 
            } else {
                App.showAppModal('success', response, reloadPage); 
            }
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deletePtkSdData(rowInfo._rowIndex, rowInfo._source, deleteCode, alasan); // <-- KIRIM 'alasan'
};

App.processDeletionLapbul = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data dan file terkait...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            App.showAppModal('success', response, reloadPage);
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deleteLapbulData(rowInfo._rowIndex, rowInfo._source, deleteCode);
};

App.processDeletionDinas = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    
    App.showAppModal('loading', 'Menghapus data...');
    
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            // Cek error object
            if (response && response.error) {
                App.showAppModal('error', response.error);
            } else {
                App.showAppModal('success', response, reloadPage);
            }
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deleteSiabaDinasData(rowInfo._rowIndex, deleteCode);
};

App.processDeletionCuti = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus kosong.'); return; }
    App.showAppModal('loading', 'Menghapus...');
    google.script.run.withSuccessHandler(res => {
        document.getElementById('deleteModal').classList.remove('show');
        if(res && res.error) App.showAppModal('error', res.error);
        else App.showAppModal('success', res, reloadPage);
    }).deleteSiabaCutiData(rowInfo._rowIndex, deleteCode);
};

App.processDeletionCutiCek = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus kosong.'); return; }
    App.showAppModal('loading', 'Menghapus...');
    google.script.run.withSuccessHandler(res => {
        document.getElementById('deleteModal').classList.remove('show');
        if(res && res.error) App.showAppModal('error', res.error);
        else App.showAppModal('success', res, reloadPage);
    }).deleteSiabaCutiUnggahan(rowInfo._rowIndex, deleteCode);
};

App.processDeletionPak = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus kosong.'); return; }
    App.showAppModal('loading', 'Menghapus...');
    
    google.script.run.withSuccessHandler(res => {
        document.getElementById('deleteModal').classList.remove('show');
        if(res && res.error) App.showAppModal('error', res.error);
        else App.showAppModal('success', res, reloadPage);
    }).deleteSiabaPakData(rowInfo._sheetName, rowInfo._rowIndex, deleteCode);
};

// ========================================================
// ===== AKHIR DARI BLOK FUNGSI HAPUS =====
// ========================================================

/**
 * ===================================================================
 * ======================= 2. SEMUA FUNGSI INISIALISASI HALAMAN ======
 * ===================================================================
 */

function initMenuPage() {
    // Fungsi ini berlaku untuk semua halaman menu yang menggunakan .menu-button
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
            
            // --- TAMBAHKAN 2 BARIS INI ---
            document.getElementById('skeleton-loader').style.display = 'none';
            document.getElementById('form-content').style.display = 'block';
            // --- AKHIR TAMBAHAN ---
        })
        .withFailureHandler(error => {
            console.error('Gagal memuat opsi form SK:', error);
            // --- TAMBAHKAN 2 BARIS INI JUGA ---
            document.getElementById('skeleton-loader').style.display = 'none';
            document.getElementById('form-content').style.display = 'block';
            // --- AKHIR TAMBAHAN ---
        })
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            App.showAppModal('error', 'Unggah scan file format PDF ukuran maksimal 1 MB.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => App.showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'riwayatTable', 
        serverFunction: 'getSKRiwayatData', 
        // Menggunakan filter mandiri (Non-Cascading)
        filters: [ 
            // Tahun Ajaran
            { id: 'filterTahun', dataColumn: 'Tahun Ajaran', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Semester
            { id: 'filterSemester', dataColumn: 'Semester', type: 'dropdown', defaultText: 'Semua Semester' },
            
            // Nama Sekolah
            { id: 'filterNamaSekolah', dataColumn: 'Nama SD', type: 'dropdown', defaultText: 'Semua Sekolah' }
        ]
    });
}

function initSkStatusPage() {
    // Panggil fungsi generik dengan konfigurasi yang tepat
    App.initializeGenericTablePage({
        tableId: 'statusTable',
        serverFunction: 'getSKStatusData', // Memanggil fungsi baru yang sudah kita perbaiki
        filterConfig: [] // Halaman ini tidak memiliki filter, jadi array-nya kosong
    });
}

function initSkKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'kelolaTable', // ID tabel di page_sk_kelola.html
        serverFunction: 'getSKKelolaData', // Fungsi server untuk Kelola Data SK
        editPage: 'sk_edit', // KUNCI PERBAIKAN: Menambahkan halaman tujuan edit
        filters: [
            // Filter Tahun Ajaran
            { 
                id: 'filterTahun', 
                dataColumn: 'Tahun Ajaran', 
                type: 'dropdown', 
                sortReverse: true, 
                defaultText: 'Semua Tahun' 
            },
            
            // Filter Semester
            { 
                id: 'filterSemester', 
                dataColumn: 'Semester', 
                type: 'dropdown', 
                defaultText: 'Semua Semester' 
            },
            
            // Filter Nama Sekolah
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama SD', 
                type: 'dropdown', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => App.showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    App.showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                App.showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    let FOLDER_IDS = {}; 
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index; 
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: FOLDER_IDS.MAIN_SK }]; 
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(FOLDER_IDS.MAIN_SK);
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS.MAIN_SK = ids.MAIN_SK;
            renderTahunAjaranView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getSkArsipFolderIds();
}

function initLapbulUnggahPage() {
    initMenuPage(); 
    google.script.run
        .withSuccessHandler(infoItems => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', infoItems))
        .withFailureHandler(err => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', []))
        .getLapbulInfo();
}

App.calculateTotalMuridPaud = (form) => {
    let totalUsia = 0;
    let totalRombel = 0;
    
    // Hitung Total Usia
    form.querySelectorAll('#dataMurid [name^="murid_"]').forEach(input => {
        totalUsia += parseInt(input.value, 10) || 0;
    });

    // Hitung Total Rombel (Kelompok A dan B)
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_P"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_P"]').value, 10) || 0;

    // Ambil elemen validasi
    const totalUsiaEl = document.getElementById('totalUsia') || document.getElementById('edit-totalUsia');
    const totalRombelEl = document.getElementById('totalRombel') || document.getElementById('edit-totalRombel');
    const statusEl = document.getElementById('murid-validation-status') || document.getElementById('edit-murid-validation-status');

    // Perbarui tampilan angka
    if (totalUsiaEl) totalUsiaEl.textContent = totalUsia;
    if (totalRombelEl) totalRombelEl.textContent = totalRombel;
    
    // === LOGIKA VALIDASI BARU ===
    if (statusEl) {
        statusEl.classList.remove('status-ok', 'status-error');
        if (totalUsia !== totalRombel) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.classList.add('status-error');
        } else if (totalUsia === 0) {
            statusEl.textContent = "Isikan jumlah murid.";
            statusEl.classList.add('status-ok');
        } else {
            statusEl.textContent = "Jumlah SAMA!";
            statusEl.classList.add('status-ok');
        }
    }
    // === AKHIR LOGIKA VALIDASI BARU ===
    
    return { totalUsia, totalRombel };
};

function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const formLogic = App.setupTabForm('lapbulFormPaud');

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    
    // --- 1. VALIDASI KUSTOM TAB 1 (DATA LEMBAGA) ---
    formLogic.setTabValidation(0, () => {
    let isValid = true;
    const tabContent = document.getElementById('dataSekolah');
    // Hapus semua indikator error sebelumnya
    tabContent.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    
    // Hanya periksa elemen yang required
    const fields = tabContent.querySelectorAll('[required]');

    fields.forEach(field => {
        let fieldIsValid = true;
        const isRombel = field.name === 'jumlahRombel';

        // Check for emptiness or invalid select default value
        if (!field.value || field.value === "" || field.value === "-- Pilih Jenjang Dahulu --" || field.value === "-- Pilih Lembaga --") {
            
            // Khusus Rombel: Lolos jika nilainya adalah 0 (meskipun secara teknis dianggap "empty" oleh browser)
            if (isRombel && field.value === "0") {
                fieldIsValid = true;
            } else {
                fieldIsValid = false;
            }
        } 
        
        // Terapkan glow merah jika gagal, tetapi jangan tampilkan popup global
        if (!fieldIsValid) {
            isValid = false;
            field.classList.add('input-error');
        } else {
            field.classList.remove('input-error');
        }
    });

    if (!isValid) {
        // PERUBAHAN: Menghilangkan popup untuk Tab 1 (Hanya glow merah)
        return false;
    }

    return true;
    });

    // --- 2. VALIDASI KUSTOM TAB 2 (DATA MURID) ---
    formLogic.setTabValidation(1, () => {
        // Panggil fungsi global yang sudah kita perbaiki
        const { totalUsia, totalRombel } = App.calculateTotalMuridPaud(form);
        const statusEl = document.getElementById('murid-validation-status');

        // Skenario 2a: Total Murid 0 (Konfirmasi)
        if (totalUsia === 0) {
            const confirmModal = document.getElementById('deleteModal'); // Menggunakan modal yang ada
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data Siswa';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah siswa (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(2); // Lanjut ke Tab PTK
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false; // Kembali ke tab murid dulu
        }

        // Skenario 2b: Jumlah Murid Tidak Sama (Gagal)
        if (totalUsia !== totalRombel) {
            // Status sudah diatur oleh App.calculateTotalMuridPaud, kita tinggal tampilkan popup
            App.showAppModal('error', 'Kesalahan Validasi: Total Murid Menurut Usia harus SAMA dengan Total Murid Menurut Rombel.');
            return false;
        }

        // Skenario 2c: Valid dan Sama (Lolos)
        return true;
    });

    // --- 3. VALIDASI KUSTOM TAB 3 (DATA PTK) ---
    formLogic.setTabValidation(2, () => {
        const dataPtkContainer = document.getElementById('dataPtk');
        
        // KUNCI PERBAIKAN POIN 2: Validasi Kepala Sekolah PAUD
        const kepsekASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_ASN"]').value, 10) || 0;
        const kepsekNonASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_Non_ASN"]').value, 10) || 0;
        const totalKepsek = kepsekASN + kepsekNonASN;
        
        if (totalKepsek > 1) {
            App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal 1.');
            return false;
        }

        // Hitung Total Semua PTK (untuk Konfirmasi Lanjut)
        const ptkInputs = dataPtkContainer.querySelectorAll('input[type="number"]');
        const totalPtk = Array.from(ptkInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        
        // Skenario: Total PTK 0 (Konfirmasi Lanjut)
        if (totalPtk === 0) {
            const confirmModal = document.getElementById('deleteModal');
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(3);
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false;
        }
        
        return true;
    });

    form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Asumsikan semua tab sebelumnya sudah divalidasi dan dilewati.
    
    const submitButton = form.querySelector('#finalSubmitBtn'); // Menggunakan ID yang lebih spesifik
    submitButton.disabled = true;
    App.showAppModal('loading', 'Mengirim Laporan Bulanan...');

    const fileInput = document.getElementById('fileLapbul');
    const file = fileInput.files[0];
    const MAX_SIZE = 300 * 1024; // 300 KB

    if (!file) {
         // Harusnya tidak terjadi karena input file memiliki attribute required, tapi sebagai fallback
         App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
         submitButton.disabled = false;
         return;
    }

    if (file.size > MAX_SIZE) {
        // PERBAIKAN POIN 2: Popup jika file melebihi batas
        App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
        submitButton.disabled = false;
        return;
    }
    
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    
    // Ambil nilai dari field yang terkunci (atau yang namanya berbeda dari input)
    payload.laporanBulan = form.querySelector('[name="laporanBulan"]').value;
    payload.tahun = form.querySelector('[name="tahun"]').value;
    payload.jenjang = form.querySelector('[name="jenjang"]').value;
    payload.namaSekolah = form.querySelector('[name="namaSekolah"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     submitButton.disabled = false;
                } else {
                     // PERBAIKAN POIN 2: Redirect ke Riwayat Pengiriman
                     App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                submitButton.disabled = false;
            })
            .processLapbulFormPaud(data);
    };

    const reader = new FileReader();
    reader.onload = function(event) {
        payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
        sendData(payload);
    };
    reader.readAsDataURL(file);
    });
    
    // Tambahkan event listener untuk update validasi murid secara real-time
    form.querySelector('#dataMurid').addEventListener('input', () => {
        App.calculateTotalMuridPaud(form);
    });

    google.script.run
    .withSuccessHandler(schoolLists => {
        const availableJenjangs = Object.keys(schoolLists).filter(k => schoolLists[k] && schoolLists[k].length > 0);
        
        jenjangSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang --</option>';
        namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang Dahulu --</option>';

        availableJenjangs.forEach(j => {
            jenjangSelect.add(new Option(j, j));
        });

        const handleJenjangChange = () => {
            const selectedJenjang = jenjangSelect.value;
            const schoolList = schoolLists[selectedJenjang] || []; 
            
            namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
            
            schoolList.forEach(school => {
                namaSekolahSelect.add(new Option(school, school));
            });
            namaSekolahSelect.disabled = false;
        };
        
        jenjangSelect.addEventListener('change', handleJenjangChange);
        
        // --- TAMBAHKAN 2 BARIS INI ---
        if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
        if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
        // --- AKHIR TAMBAHAN ---
        
        // Inisialisasi awal validasi murid
        form.querySelector('#dataMurid').dispatchEvent(new Event('input'));
        
        document.getElementById('appModal').classList.remove('show');
    })
    .withFailureHandler(err => {
        App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`);
        // --- TAMBAHKAN 2 BARIS INI JUGA ---
        if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
        if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
        // --- AKHIR TAMBAHAN ---
    })
    .getPaudSchoolLists();
}

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    // 1. Panggil App.setupTabForm untuk tab utama (Tab 1-4)
    const formLogic = App.setupTabForm('lapbulFormSd'); 

    // ==========================================================
    // === FIX 2: Pindahkan submit listener ke sini ===
    // ==========================================================
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Mencegah halaman reload
        
        // Cek validasi tab terakhir sebelum kirim
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; } // Pesan error sudah diatur di validasi
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data PTK (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Mengirim Laporan Bulanan SD...');

        const fileInput = document.getElementById('fileLapbul');
        const file = fileInput.files[0];
        const MAX_SIZE = 300 * 1024; // 300 KB

        if (!file) {
             App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
             submitButton.disabled = false;
             return;
        }

        if (file.size > MAX_SIZE) {
            App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
            submitButton.disabled = false;
            return;
        }
        
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        
        // Ambil data dari field yang di-disable (jika perlu)
        payload.Bulan = form.querySelector('[name="Bulan"]').value;
        payload.Tahun = form.querySelector('[name="Tahun"]').value;
        payload.Status = form.querySelector('[name="Status"]').value;
        payload['Nama Sekolah'] = form.querySelector('[name="Nama Sekolah"]').value;

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         App.showAppModal('error', res.error);
                         submitButton.disabled = false;
                    } else {
                         App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                    }
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormSd(data); // <-- Memanggil fungsi SD yang benar
        };

        const reader = new FileReader();

// [BAGIAN SUKSES]
reader.onload = function(event) {
    payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
    sendData(payload); // Kirim data HANYA jika file sukses dibaca
};

// [INI TAMBAHAN PENTINGNYA]
reader.onerror = function(error) {
    // Tampilkan pesan error dan aktifkan tombol kembali
    App.showAppModal('error', 'Gagal membaca file. Pastikan file tidak rusak dan coba lagi.');
    submitButton.disabled = false; 
    console.error('FileReader Error:', error); // Untuk debugging
};

// Baru jalankan pembacaan file di akhir
reader.readAsDataURL(file);
    });
    // ==========================================================
    // =================== AKHIR BLOK SUBMIT ==================
    // ==========================================================

    // 2. Fungsi Bantuan untuk dropdown Bulan/Tahun
    function setupInitialDropdowns() {
        // ========================================================
        // INI ADALAH PERBAIKANNYA:
        // Mencari [name="Bulan"] (bukan "laporanBulan")
        // Mencari [name="Tahun"] (bukan "tahun")
        const bulanSelect = form.querySelector('[name="Bulan"]');
        const tahunSelect = form.querySelector('[name="Tahun"]');
        // ========================================================

        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        
        // Ditambahkan pengecekan (if) agar lebih aman
        if (bulanSelect) {
            bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        }
        if (tahunSelect) {
            tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        }
    }

    // 3. Fungsi Bantuan untuk Validasi Total Murid
    function checkKelasTotals(kelas) {
        const kelasContent = document.getElementById(`kelas-content-${kelas}`);
        if (!kelasContent) return true; // Jika konten kelas tidak ada, anggap valid

        // === LOGIKA BARU DIMULAI ===
        // 1. Ambil nilai dropdown 'Jumlah Rombel'
        const rombelDropdown = kelasContent.querySelector('.rombel-toggle');
        const jumlahRombelDipilih = parseInt(rombelDropdown.value, 10);
        // === LOGIKA BARU SELESAI ===

        const rombelInputs = kelasContent.querySelectorAll('.rombel-container input[type="number"]');
        const agamaInputs = kelasContent.querySelectorAll('.agama-container-grid input[type="number"]');

        const totalRombel = Array.from(rombelInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        const totalAgama = Array.from(agamaInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

        const statusEl = document.getElementById(`murid-validation-status-${kelas}`);
        document.getElementById(`totalRombel-${kelas}`).textContent = totalRombel;
        document.getElementById(`totalAgama-${kelas}`).textContent = totalAgama;

        // === VALIDASI BARU ===

        // Aturan 1: Jika dropdown rombel DIPILIH (bukan 0)
        if (jumlahRombelDipilih > 0) {
            // Aturan 1a: Total murid rombel tidak boleh 0
            if (totalRombel === 0) {
                statusEl.textContent = "Isikan jumlah murid per rombel.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
            // Aturan 1b: Total murid agama tidak boleh 0
            if (totalAgama === 0) {
                statusEl.textContent = "Isikan jumlah murid menurut agama.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
        }

        // Aturan 2: (Aturan Lama) Total Rombel HARUS SAMA DENGAN Total Agama
        if (totalRombel !== totalAgama) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.className = 'status-error';
            return false; // Gagal
        }

        // Aturan 3: (Aturan Baru) Jika rombel 0, total murid juga harus 0
        if (jumlahRombelDipilih === 0 && (totalRombel > 0 || totalAgama > 0)) {
            statusEl.textContent = "Rombel 0, tapi Jml Murid ada";
            statusEl.className = 'status-error';
            return false; // Gagal
        }
        
        // === AKHIR VALIDASI BARU ===

        // Jika lolos semua aturan
        statusEl.textContent = "Jumlah Sesuai";
        statusEl.className = 'status-ok';
        return true;
    }
    
    // 4. Fungsi Bantuan untuk Generate HTML (SAMA SEPERTI FUNGSI TAMBAH)
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        const agamaDefault = { 'Islam': 'Ada', 'Kristen': 'Tidak Ada', 'Katolik': 'Tidak Ada', 'Hindu': 'Tidak Ada', 'Buddha': 'Tidak Ada', 'Konghucu': 'Tidak Ada' };

        let rombelInputsHTML = `
            <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_tunggal_L" min="0" required></div>
                    <div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_tunggal_P" min="0" required></div>
                </div>
            </div>
        `;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" min="0" required></div><div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" min="0" required></div></div></div>`;
        }
        
        let agamaInputsHTML = '<div class="agama-container-grid">';
        
        for (const ag of agama) {
            const agId = ag.toLowerCase().replace(/\s/g, '_');
            const defaultValue = agamaDefault[ag] || 'Tidak Ada';
            const isVisible = defaultValue === 'Ada';

            agamaInputsHTML += `
                <div class="agama-input-group">
                    <label class="agama-group-label">${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${defaultValue === 'Ada' ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${defaultValue === 'Tidak Ada' ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                    <div class="murid-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isVisible ? 'flex' : 'none'}; margin-top: 10px;">
                        <div class="form-group"><label>L</label><input type="number" name="k${kelas}_agama_${agId}_L" min="0" required></div>
                        <div class="form-group"><label>P</label><input type="number" name="k${kelas}_agama_${agId}_P" min="0" required></div>
                    </div>
                </div>
            `;
        }
        agamaInputsHTML += '</div>';

        const validationHTML = `<div id="murid-validation-feedback-${kelas}" class="murid-validation-container" style="margin-top: 20px;"><p>Total per Rombel: <span id="totalRombel-${kelas}">0</span></p><p>Total per Agama: <span id="totalAgama-${kelas}">0</span></p><p id="murid-validation-status-${kelas}" class="status-ok">Jumlah Sesuai</p></div>`;
        
        let footerHTML = '';
        if (kelas === 1) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn prev-tab-btn" style="width: auto;">Sebelumnya</button></div>`;
        } else if (kelas === 6) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn next-tab-btn" style="width: auto; margin-left: auto;">Berikutnya</button></div>`;
        }
        
        // FIX: Hapus submit listener dari sini
        return `
            <fieldset class="ptk-fieldset"><legend>Menurut Rombel</legend><div class="form-group form-group-rombel-toggle" style="margin-bottom: 20px;"><label>Jumlah Rombel</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="0">0</option></select></div><h4 class="sub-section-title">Jml Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">${rombelInputsHTML}</div></fieldset>
            <fieldset class="ptk-fieldset" style="margin-top: 20px;"><legend>Menurut Agama</legend>${agamaInputsHTML}</fieldset>
            ${validationHTML}${footerHTML}
        `;
    }

    // 5. Fungsi Bantuan untuk Setup Logika Tab 2 (Murid)
    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        
        // KOSONGKAN SEBELUM MENGISI (PENTING)
        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        for (let i = 1; i <= 6; i++) {
            
            // --- INI ADALAH SENJATA YANG HILANG (G61) ---
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            // --- AKHIR SENJATA ---

            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i); // Memanggil fungsi generateKelasHTML
            content.dataset.kelas = i;
            contentContainer.appendChild(content);

            const defaultRombelSelect = content.querySelector('.rombel-toggle');
            const defaultRombelCount = parseInt(defaultRombelSelect.value, 10);
            if (defaultRombelCount === 1) document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
            
            checkKelasTotals(i);
        }

        // Pastikan event listener hanya dipasang sekali
        if (!tabsContainer.dataset.listener) {
            tabsContainer.addEventListener('click', function(e) { 
                const clickedTab = e.target.closest('.tab-link');
                if (clickedTab) {
                    e.stopPropagation();
                    tabsContainer.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                    contentContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    
                    clickedTab.classList.add('active');
                    document.getElementById(`kelas-content-${clickedTab.dataset.kelas}`).style.display = 'block';
                }
            });
            tabsContainer.dataset.listener = 'true';
        }
        
        if (!contentContainer.dataset.listener) {
            contentContainer.addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    const kelasContent = e.target.closest('.tab-content');
                    if (kelasContent) {
                        const kelas = kelasContent.dataset.kelas;
                        checkKelasTotals(kelas);
                    }
                }
            });

            contentContainer.addEventListener('change', function(e) {
                const target = e.target;
                const kelasContent = e.target.closest('.tab-content');
                const kelas = target.dataset.kelas || (kelasContent ? kelasContent.dataset.kelas : null);
                if (!kelas) return;

                if (target.classList.contains('rombel-toggle')) {
                    const count = parseInt(target.value, 10);
                    document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                    if (count === 1) { document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block'; }
                    else if (count > 1) { ['A', 'B', 'C'].slice(0, count).forEach(r => document.getElementById(`rombel-${kelas}-${r}`).style.display = 'block'); }
                    checkKelasTotals(kelas);
                }
                if (target.classList.contains('agama-toggle')) {
                    document.getElementById(`agama-input-${target.dataset.kelas}-${target.dataset.agama}`).style.display = target.value === 'Ada' ? 'flex' : 'none';
                }
            });
            contentContainer.dataset.listener = 'true';
        }
    }

    // 6. Fungsi Bantuan untuk Setup Logika Tab 1 (Sekolah)
    function setupDataSekolah(schoolLists) {
        // DIUBAH: Mencari [name="Status"]
        const statusSekolah = form.querySelector('[name="Status"]');
        const namaSekolah = document.getElementById('namaSekolah');
        
        // Hapus listener lama jika ada
        const newStatusSekolah = statusSekolah.cloneNode(true);
        statusSekolah.parentNode.replaceChild(newStatusSekolah, statusSekolah);

        newStatusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            if(schoolList) schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
        });
    }
    
    // ==========================================================
    // === FIX 1: Panggil fungsi statis SEBELUM server call ===
    // ==========================================================
    setupInitialDropdowns();
    setupDataMurid();
    // ==========================================================

    google.script.run
        .withSuccessHandler(schoolLists => {
            
            // setupInitialDropdowns(); // <-- Pindah ke atas
            setupDataSekolah(schoolLists); // <-- Tetap di sini
            // setupDataMurid(); // <-- Pindah ke atas
            
            // --- VALIDASI CUSTOM UNTUK TAB 2 (MURID) ---
            formLogic.setTabValidation(1, () => {
                let allValid = true;
                let firstInvalidKelas = -1;
                for (let i = 1; i <= 6; i++) {
                    if (!checkKelasTotals(i)) {
                        allValid = false;
                        if(firstInvalidKelas === -1) firstInvalidKelas = i;
                    }
                }
                if (!allValid) {
                     document.querySelector(`#kelas-tabs button[data-kelas="${firstInvalidKelas}"]`).click(); 
                     App.showAppModal('error', 'Terdapat isian murid yang belum lengkap atau jumlah tidak sesuai.');
                }
                return allValid;
            });
            
            // --- VALIDASI CUSTOM UNTUK TAB 3 (PTK) - INI ADALAH PERBAIKANNYA ---
            formLogic.setTabValidation(2, () => {
                const totalKepsek = (parseInt(form.querySelector('[name="ptk_kepsek_pns"]').value, 10) || 0) +
                                  (parseInt(form.querySelector('[name="ptk_kepsek_pppk"]').value, 10) || 0) +
                                  (parseInt(form.querySelector('[name="ptk_kepsek_nonasn"]').value, 10) || 0);

                if (totalKepsek > 1) {
                    App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal adalah 1.');
                    return false; // <--- INI AKAN MENCEGAH PINDAH TAB
                }
                return true; // Lolos
            });
            
            // --- TAMBAHKAN 2 BARIS INI ---
            if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
            if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
            // --- AKHIR TAMBAHAN ---
            
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => {
            App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`);
            // --- TAMBAHKAN 2 BARIS INI JUGA ---
            if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
            if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
            // --- AKHIR TAMBAHAN ---
        })
        .getSdSchoolLists();
        
    // (Fungsi submit listener sudah dipindah ke atas)
}

function initLapbulRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulRiwayatTable',
        serverFunction: 'getLapbulRiwayatData', 
        filters: [
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { id: 'filterBulan', dataColumn: 'Bulan', type: 'dropdown', specialSort: 'bulan', defaultText: 'Semua Bulan' },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaSekolah',      
              dataColumn: 'Nama Sekolah',   
              type: 'cascading-local', 
              parent: 'filterJenjang',      
              parentKey: 'Jenjang',      
              defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulStatusPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulStatusTable',
        serverFunction: 'getLapbulStatusData', 
        filterFunction: 'getLapbulStatusFilterData', 
        filters: [
            // Filter 1: Tahun
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Filter 2: Jenjang (Parent)
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            
            // Filter 3: Nama Sekolah (Cascading Child)
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang', 
                parentKey: 'Jenjang', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulArsipPage() {
    let FOLDER_IDS = {}; 

    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;

            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index;
                    if (item.type === 'root') {
                        renderJenjangView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderJenjangView() {
        viewContainer.classList.remove('view-container-scrollable');
        // Saat kembali ke jenjang, reset breadcrumb ke kondisi awal
        breadcrumbTrail = [{ name: 'Jenjang', type: 'root', id: null }];
        updateBreadcrumb();
        viewContainer.innerHTML = '<div class="card-grid"></div>';
        const cardGrid = viewContainer.querySelector('.card-grid');
        
        const jenjang = [
            { name: 'KB', icon: 'fa-cubes', color: '#3498db' },
            { name: 'TK', icon: 'fa-shapes', color: '#9b59b6' },
            { name: 'SD', icon: 'fa-school', color: '#e74c3c' }
        ];

        jenjang.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `<i class="fas ${item.icon}" style="color: ${item.color};"></i><span>${item.name}</span>`;
            card.onclick = () => renderFolderView(FOLDER_IDS[item.name], item.name);
            cardGrid.appendChild(card);
        });
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        // Hanya tambahkan ke breadcrumb jika belum ada
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS = ids;
            renderJenjangView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getLapbulArsipFolderIds();
}

function initLapbulKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulKelolaTable',
        serverFunction: 'getLapbulKelolaData',
        filters: [ 
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { 
                id: 'filterBulan', 
                dataColumn: 'Bulan', 
                type: 'dropdown', 
                specialSort: 'bulan', // <-- Ini penting agar urut Januari, Februari...
                defaultText: 'Semua Bulan' 
            },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang',
                parentKey: 'Jenjang',
                defaultText: 'Semua Sekolah'
            }
        ],
    });
}

function initLapbulEditPaudPage(params) {
    const form = document.getElementById('lapbulEditFormPaud'); 
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-lapbul-form-container'); 
    
    // Menggunakan ID baru untuk elemen navigasi dan konten
    const tabs = [
        document.getElementById('edit-dataSekolah'),
        document.getElementById('edit-dataMurid'),
        document.getElementById('edit-dataPtk'),
        document.getElementById('edit-dataDokumen')
    ].filter(el => el); 
    
    if (!form || !params || !params.rowIndex || !params.source) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak lengkap atau tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;

    let currentActiveTab = 'edit-dataSekolah';

    // --- FUNGSI UTILITY ---
    function showTab(tabId) {
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            currentActiveTab = tabId;
        }
        document.querySelectorAll('.tabs-container button').forEach(btn => {
            if (btn.getAttribute('data-tab') === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    // --- LOGIKA PERHITUNGAN DAN VALIDASI (Tab 2: Murid) ---
    const totalUsiaEl = document.getElementById('edit-totalUsia');
    const totalRombelEl = document.getElementById('edit-totalRombel');
    const statusEl = document.getElementById('edit-murid-validation-status');
    const muridInputs = form.querySelectorAll('#edit-dataMurid input[type="number"]');

    function showTab(tabId) {
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            currentActiveTab = tabId;
        }
        document.querySelectorAll('.tabs-container button').forEach(btn => {
            if (btn.getAttribute('data-tab') === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function updateMuridTotals() {
        let totalUsia = 0;
        form.querySelectorAll('#edit-dataMurid [name^="murid_"]').forEach(input => {
            totalUsia += parseInt(input.value, 10) || 0;
        });

        const rombelA = (parseInt(form.querySelector('[name="kelompok_A_L"]')?.value) || 0) + (parseInt(form.querySelector('[name="kelompok_A_P"]')?.value) || 0);
        const rombelB = (parseInt(form.querySelector('[name="kelompok_B_L"]')?.value) || 0) + (parseInt(form.querySelector('[name="kelompok_B_P"]')?.value) || 0);
        const totalRombel = rombelA + rombelB;
        
        if (totalUsiaEl) totalUsiaEl.textContent = totalUsia;
        if (totalRombelEl) totalRombelEl.textContent = totalRombel;
        
        if (statusEl) {
             statusEl.classList.remove('status-ok', 'status-error');
             if (totalUsia !== totalRombel) {
                 statusEl.textContent = "Jumlah TIDAK SAMA! Harap Koreksi.";
                 statusEl.classList.add('status-error');
             } else if (totalUsia > 0) {
                 statusEl.textContent = "Jumlah SAMA!";
                 statusEl.classList.add('status-ok');
             } else {
                 statusEl.textContent = "Isikan jumlah murid.";
                 statusEl.classList.add('status-ok');
             }
        }
        return { totalUsia, totalRombel };
    }
    
    function validateTab3Ptk(e) {
        e.preventDefault();
        
        const kepsekASN = parseInt(form.querySelector('#edit-dataPtk [name="kepsek_ASN"]')?.value) || 0;
        const kepsekNonASN = parseInt(form.querySelector('#edit-dataPtk [name="kepsek_Non_ASN"]')?.value) || 0;
        const totalKepsek = kepsekASN + kepsekNonASN;
        
        if (totalKepsek > 1) {
            App.showAppModal('error', 'Validasi PTK: Jumlah Kepala Sekolah maksimal 1.');
            return;
        }

        const ptkInputs = form.querySelectorAll('#edit-dataPtk input[type="number"]');
        const totalPtk = Array.from(ptkInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        
        if (totalPtk === 0) {
             const confirmModal = document.getElementById('deleteModal');
             confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
             confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut ke dokumen?</p>';
             
             const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
             const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

             confirmBtn.textContent = 'Lanjut';
             cancelBtn.textContent = 'Kembali';

             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.onclick = () => {
                  confirmModal.classList.remove('show');
                  showTab('edit-dataDokumen');
             };
             cancelBtn.onclick = () => confirmModal.classList.remove('show');

             confirmModal.classList.add('show');
             return;
        }
        
        showTab('edit-dataDokumen');
    }

    function validateTab2Murid(e) {
        e.preventDefault();
        const { totalUsia, totalRombel } = updateMuridTotals();
        
        if (totalUsia !== totalRombel) {
            App.showAppModal('error', 'Kesalahan Validasi: Total Murid Menurut Usia harus SAMA dengan Total Murid Menurut Rombel.');
            return; 
        } 
        
        if (totalUsia === 0) {
             const confirmModal = document.getElementById('deleteModal');
             confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data Siswa';
             confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah siswa (Total: 0). Tetap lanjut?</p>';
             
             const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
             const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

             confirmBtn.textContent = 'Lanjut';
             cancelBtn.textContent = 'Kembali';

             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.onclick = () => {
                  confirmModal.classList.remove('show');
                  showTab('edit-dataPtk'); 
             };
             cancelBtn.onclick = () => confirmModal.classList.remove('show');

             confirmModal.classList.add('show');
             return;
        }

        showTab('edit-dataPtk');
    }

    google.script.run
        .withSuccessHandler(rowData => {
            document.getElementById('appModal').classList.remove('show');
            
            if (rowData.error) {
                loadingDiv.innerHTML = `<p style="color:red; font-weight:bold;">Error Memuat Data: ${rowData.error}</p>`;
                loadingDiv.style.display = 'block';
                formContainer.style.display = 'none';
                return;
            }
            
            // 1. Isi semua field form
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    let value = rowData[key];
                    if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                        value = 0;
                    }
                    field.value = value;
                }
            }

            // 2. Update link dokumen
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData.Dokumen) { 
                fileLinkContainer.innerHTML = `<a href="${rowData.Dokumen}" target="_blank">Lihat File Saat Ini</a>`; 
            } else { 
                fileLinkContainer.innerHTML = 'Tidak ada file.'; 
            }

            // 3. Tampilkan form dan tab pertama
            loadingDiv.style.display = 'none';
            formContainer.style.display = 'flex';
            showTab(currentActiveTab); 
            
            // 4. Inisialisasi perhitungan setelah data dimuat
            updateMuridTotals(); 

        })
        .withFailureHandler(err => {
            loadingDiv.innerHTML = `<p style="color:red; font-weight:bold;">Gagal Menghubungi Server: ${err.message}</p>`;
            loadingDiv.style.display = 'flex';
        })
        .getLapbulDataByRow(params.rowIndex, params.source);

    // --- SETUP EVENT LISTENERS TAB & VALIDASI KHUSUS ---
    
    // Event listeners untuk tombol tab di atas
    form.querySelectorAll('.tabs-container button').forEach(button => {
        button.addEventListener('click', function() {
            showTab(this.getAttribute('data-tab'));
        });
    });

    // Event listener untuk tombol NEXT Tab 1 (Sekolah -> Murid)
    const nextSekolahBtn = document.querySelector('#edit-dataSekolah .next-tab-btn');
    if (nextSekolahBtn) {
        nextSekolahBtn.addEventListener('click', (e) => {
            if (form.reportValidity()) {
                showTab('edit-dataMurid');
            } else {
                 App.showAppModal('error', 'Harap lengkapi semua field yang wajib diisi di tab ini.');
            }
        });
    }

    // Event listener untuk tombol NEXT Tab 2 (Murid -> PTK)
    const nextMuridToPtkBtn = document.querySelector('#edit-dataMurid .next-tab-btn');
    if (nextMuridToPtkBtn) {
        nextMuridToPtkBtn.addEventListener('click', validateTab2Murid);
    }

    // Event listener untuk tombol NEXT Tab 3 (PTK -> Dokumen)
    const nextPtkToDokumenBtn = document.querySelector('#edit-dataPtk .next-tab-btn');
    if (nextPtkToDokumenBtn) {
        nextPtkToDokumenBtn.addEventListener('click', validateTab3Ptk);
    }
    
    // Event listeners untuk tombol PREVIOUS
    form.querySelectorAll('.tab-form-footer button[data-target]').forEach(button => {
        if (button.classList.contains('prev-tab-btn')) {
             button.addEventListener('click', function(e) {
                 e.preventDefault();
                 showTab(this.getAttribute('data-target'));
             });
        }
    });

    // Event listener untuk perhitungan input number
    form.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', updateMuridTotals);
    });
    
    // --- LOGIKA FORM SUBMISSION (KRITIS) ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('#edit-lapbul-submit-btn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        // 1. Ambil semua data sebagai payload
        const payload = Object.fromEntries(new FormData(form)); 
        
        const fileInput = form.querySelector('input[type="file"]');
        const file = fileInput.files[0];
        
        // 2. KRITIS: Hapus properti fileData dari payload jika tidak ada file yang dipilih
        // Ini mencegah pengiriman objek File yang tidak valid ke server.
        delete payload.fileData; 
        
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(response => {
                    App.showAppModal('success', response, 'lapbul_kelola');
                })
                .withFailureHandler(error => {
                    App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .updateLapbulData(data); 
        };
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                if (file.size > 300 * 1024) {
                    App.showAppModal('error', 'Ukuran file tidak boleh lebih dari 300 KB.');
                    submitButton.disabled = false;
                    return;
                }
                
                // 3. Jika ada file, tambahkan fileData yang sudah di-encode ke payload
                payload.fileData = { 
                    fileName: file.name, 
                    mimeType: file.type, 
                    data: event.target.result.split(',')[1] 
                };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            // 4. Jika tidak ada file, kirim payload tanpa properti fileData
            sendData(payload);
        }
    });
}


function initLapbulEditSdPage(params) {

    // --- AMBIL ELEMEN DARI HALAMAN EDIT ---
    const form = document.getElementById('lapbulEditFormSd');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-lapbul-sd-container');

    if (!form || !loadingDiv || !formContainer) {
         console.error("Elemen dasar form edit SD (form, loading, container) tidak ditemukan.");
         document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Elemen dasar (form, loading) tidak ditemukan. Halaman HTML mungkin rusak.</p></div>`;
         return;
    }

    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter (rowIndex) untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    // 1. Panggil App.setupTabForm untuk tab utama (Tab 1-4)
    const formLogic = App.setupTabForm('lapbulEditFormSd'); 

    // 2. Fungsi Bantuan untuk dropdown Bulan/Tahun
    function setupInitialDropdowns() {
        // DIUBAH: Mencari nama yang benar (sesuai HTML & code.gs)
        const bulanSelect = form.querySelector('[name="Bulan"]');
        const tahunSelect = form.querySelector('[name="Tahun"]');
        // --- AKHIR PERUBAHAN ---

        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        
        // Cek jika elemen ditemukan sebelum mengatur innerHTML
        if (bulanSelect) {
            bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        }
        if (tahunSelect) {
            tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        }
    }

    // 3. Fungsi Bantuan untuk Validasi Total Murid (disalin dari form Tambah)
    function checkKelasTotals(kelas) {
        const kelasContent = document.getElementById(`kelas-content-${kelas}`);
        if (!kelasContent) return true; // Jika konten kelas tidak ada, anggap valid

        // === LOGIKA BARU DIMULAI ===
        // 1. Ambil nilai dropdown 'Jumlah Rombel'
        const rombelDropdown = kelasContent.querySelector('.rombel-toggle');
        // Handle case where dropdown might not be found (shouldn't happen, but good safety)
        if (!rombelDropdown) {
             console.error("Gagal menemukan dropdown rombel for kelas " + kelas);
             return true; // Failsafe
        }
        const jumlahRombelDipilih = parseInt(rombelDropdown.value, 10);
        // === LOGIKA BARU SELESAI ===

        const rombelInputs = kelasContent.querySelectorAll('.rombel-container input[type="number"]');
        const agamaInputs = kelasContent.querySelectorAll('.agama-container-grid input[type="number"]');

        const totalRombel = Array.from(rombelInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        const totalAgama = Array.from(agamaInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

        const statusEl = document.getElementById(`murid-validation-status-${kelas}`);
        // Safety check for elements
        const rombelEl = document.getElementById(`totalRombel-${kelas}`);
        const agamaEl = document.getElementById(`totalAgama-${kelas}`);

        if (rombelEl) rombelEl.textContent = totalRombel;
        if (agamaEl) agamaEl.textContent = totalAgama;
        if (!statusEl) return true; // Failsafe if status element isn't found

        // === VALIDASI BARU ===

        // Aturan 1: Jika dropdown rombel DIPILIH (bukan 0)
        if (jumlahRombelDipilih > 0) {
            // Aturan 1a: Total murid rombel tidak boleh 0
            if (totalRombel === 0) {
                statusEl.textContent = "Isikan jumlah murid per rombel.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
            // Aturan 1b: Total murid agama tidak boleh 0
            if (totalAgama === 0) {
                statusEl.textContent = "Isikan jumlah murid menurut agama.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
        }

        // Aturan 2: (Aturan Lama) Total Rombel HARUS SAMA DENGAN Total Agama
        if (totalRombel !== totalAgama) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.className = 'status-error';
            return false; // Gagal
        }

        // Aturan 3: (Aturan Baru) Jika rombel 0, total murid juga harus 0
        if (jumlahRombelDipilih === 0 && (totalRombel > 0 || totalAgama > 0)) {
            statusEl.textContent = "Rombel 0, tapi Jml Murid ada";
            statusEl.className = 'status-error';
            return false; // Gagal
        }
        
        // === AKHIR VALIDASI BARU ===

        // Jika lolos semua aturan
        statusEl.textContent = "Jumlah Sesuai";
        statusEl.className = 'status-ok';
        return true;
    }

    // 4. Fungsi Bantuan untuk Generate HTML (SAMA SEPERTI FUNGSI TAMBAH)
    // Kita butuh ini agar bisa mengisi data yang di-load
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        const agamaDefault = { 'Islam': 'Ada', 'Kristen': 'Tidak Ada', 'Katolik': 'Tidak Ada', 'Hindu': 'Tidak Ada', 'Buddha': 'Tidak Ada', 'Konghucu': 'Tidak Ada' };

        let rombelInputsHTML = `
            <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_tunggal_L" min="0" required></div>
                    <div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_tunggal_P" min="0" required></div>
                </div>
            </div>
        `;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" min="0" required></div><div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" min="0" required></div></div></div>`;
        }

        let agamaInputsHTML = '<div class="agama-container-grid">';

        for (const ag of agama) {
            const agId = ag.toLowerCase().replace(/\s/g, '_');
            const defaultValue = agamaDefault[ag] || 'Tidak Ada';
            const isVisible = defaultValue === 'Ada';

            agamaInputsHTML += `
                <div class="agama-input-group">
                    <label class="agama-group-label">${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${defaultValue === 'Ada' ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${defaultValue === 'Tidak Ada' ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                    <div class="murid-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isVisible ? 'flex' : 'none'}; margin-top: 10px;">
                        <div class="form-group"><label>L</label><input type="number" name="k${kelas}_agama_${agId}_L" min="0" required></div>
                        <div class="form-group"><label>P</label><input type="number" name="k${kelas}_agama_${agId}_P" min="0" required></div>
                    </div>
                </div>
            `;
        }
        agamaInputsHTML += '</div>';

        const validationHTML = `<div id="murid-validation-feedback-${kelas}" class="murid-validation-container" style="margin-top: 20px;"><p>Total per Rombel: <span id="totalRombel-${kelas}">0</span></p><p>Total per Agama: <span id="totalAgama-${kelas}">0</span></p><p id="murid-validation-status-${kelas}" class="status-ok">Jumlah Sesuai</p></div>`;

        let footerHTML = '';
        if (kelas === 1) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn prev-tab-btn" style="width: auto;">Sebelumnya</button></div>`;
        } else if (kelas === 6) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn next-tab-btn" style="width: auto; margin-left: auto;">Berikutnya</button></div>`;
        }

        return `
            <fieldset class="ptk-fieldset"><legend>Menurut Rombel</legend><div class="form-group form-group-rombel-toggle" style="margin-bottom: 20px;"><label>Jumlah Rombel</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="0">0</option></select></div><h4 class="sub-section-title">Jml Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">${rombelInputsHTML}</div></fieldset>
            <fieldset class="ptk-fieldset" style="margin-top: 20px;"><legend>Menurut Agama</legend>${agamaInputsHTML}</fieldset>
            ${validationHTML}${footerHTML}
        `;
    }

// 5. Fungsi Bantuan untuk Setup Logika Tab 2 (Murid)
function setupDataMurid() {
        const tabsContainer = document.getElementById('edit-kelas-tabs');
        const contentContainer = document.getElementById('edit-kelas-content-container');

        if (!tabsContainer || !contentContainer) {
            console.error("Elemen sub-tab (edit-kelas-tabs) tidak ditemukan!");
            return;
        }

        // KOSONGKAN KONTEN (TAPI JANGAN TOMBOL TAB)
        contentContainer.innerHTML = ''; 
        
        for (let i = 1; i <= 6; i++) {
            
            // --- TIDAK ADA 'tabsContainer.innerHTML' DI SINI (INI SUDAH BENAR) ---

            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i); // Memanggil generateKelasHTML
            content.dataset.kelas = i;
            contentContainer.appendChild(content);

            // (Kode 'checkKelasTotals(i);' tidak diperlukan di sini, akan dipanggil saat load data)
        }

        // Pastikan event listener hanya dipasang sekali
        if (!tabsContainer.dataset.listener) {
            tabsContainer.addEventListener('click', function(e) { 
                const clickedTab = e.target.closest('.sub-tab-link'); 
                if (clickedTab) {
                    e.stopPropagation(); 
                    tabsContainer.querySelectorAll('.sub-tab-link').forEach(tab => tab.classList.remove('active')); 
                    contentContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

                    clickedTab.classList.add('active');
                    document.getElementById(`kelas-content-${clickedTab.dataset.kelas}`).style.display = 'block';
                }
            });
            tabsContainer.dataset.listener = 'true';
        }

        if (!contentContainer.dataset.listener) {
            contentContainer.addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    const kelasContent = e.target.closest('.tab-content');
                    if (kelasContent) {
                         const kelas = kelasContent.id.split('-')[2];
                         checkKelasTotals(kelas);
                    }
                }
            });

            contentContainer.addEventListener('change', function(e) {
                const target = e.target; 
                if (!target) return;

                const kelasContent = target.closest('.tab-content');
                const kelas = target.dataset.kelas || (kelasContent ? kelasContent.id.split('-')[2] : null);
                if (!kelas) return;

                if (target.classList.contains('rombel-toggle')) { 
                    const k = target.dataset.kelas;
                    const c = parseInt(target.value, 10);
                    const groupTunggal = document.getElementById(`rombel-${k}-Tunggal`);
                    const groupA = document.getElementById(`rombel-${k}-A`);
                    const groupB = document.getElementById(`rombel-${k}-B`);
                    const groupC = document.getElementById(`rombel-${k}-C`);

                    if (c === 1) {
                        if (groupTunggal) groupTunggal.style.display = 'block';
                    } else {
                        if (groupTunggal) {
                            groupTunggal.style.display = 'none';
                            groupTunggal.querySelectorAll('input[type="number"]').forEach(input => input.value = 0); 
                        }
                    }
                    if (c === 2 || c === 3) {
                        if (groupA) groupA.style.display = 'block';
                    } else {
                        if (groupA) {
                            groupA.style.display = 'none';
                            groupA.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    if (c === 2 || c === 3) {
                        if (groupB) groupB.style.display = 'block';
                    } else {
                        if (groupB) {
                            groupB.style.display = 'none';
                            groupB.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    if (c === 3) {
                        if (groupC) groupC.style.display = 'block';
                    } else {
                        if (groupC) {
                            groupC.style.display = 'none';
                            groupC.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    checkKelasTotals(k); 
                } 

                if (target.classList.contains('agama-toggle')) { 
                    const agId = target.dataset.agama.toLowerCase().replace(/\s/g, '_');
                    const inputPairContainer = document.getElementById(`agama-input-${kelas}-${agId}`);
                    if (inputPairContainer) {
                        if (target.value === 'Ada') { 
                            inputPairContainer.style.display = 'flex';
                        } else {
                            inputPairContainer.style.display = 'none';
                            inputPairContainer.querySelectorAll('input[type="number"]').forEach(input => { input.value = 0; });
                        }
                    }
                    checkKelasTotals(kelas);
                }
            });
            contentContainer.dataset.listener = 'true';
        }

        // Navigasi Kustom
        const prevBtnKelas1 = document.querySelector('#kelas-content-1 .prev-tab-btn');
        if(prevBtnKelas1) {
            prevBtnKelas1.addEventListener('click', function() {
                formLogic.showTab(0); // Pindah ke Tab 1 (Data Sekolah)
            });
        }

        const nextBtnKelas6 = document.querySelector('#kelas-content-6 .next-tab-btn');
        if (nextBtnKelas6) {
            nextBtnKelas6.addEventListener('click', function() {
                if (formLogic.validateTab(1)) {
                    formLogic.showTab(2); // Pindah ke Tab 3 (Data PTK)
                }
            });
        }
    }

// 6. Fungsi Bantuan untuk Setup Logika Tab 1 (Sekolah)
function setupDataSekolah(schoolLists) {
    // Hapus logika lama (ptkContainer, ptkNegeri, ptkSwasta)
    const statusSekolah = form.querySelector('#statusSekolah');
    const namaSekolah = form.querySelector('[name="Nama Sekolah"]');

    // Buat agar Nama Sekolah BISA DIKETIK (input type text)
    namaSekolah.disabled = false;

    // Hapus event listener lama yang mengubah form PTK
    statusSekolah.removeEventListener('change', null); 
}

// 7. Fungsi Bantuan untuk Mengunci Field
function lockField(fieldName) {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) { field.disabled = true; field.style.cssText = 'background-color: rgba(0,0,0,0.3); cursor: not-allowed;'; if (field.tagName === 'INPUT') field.readOnly = true; }
}

// --- PROSES UTAMA (MODIFIKASI UNTUK EDIT) ---
setupInitialDropdowns();
setupDataMurid(); // Panggil ini dulu untuk membangun HTML kelas 1-6

// Validasi Tab 2 (Murid)
formLogic.setTabValidation(1, () => { 
    let allValid = true;
    let firstInvalidKelas = -1;
    for (let i = 1; i <= 6; i++) {
        if (!checkKelasTotals(i)) {
            allValid = false;
            if(firstInvalidKelas === -1) firstInvalidKelas = i;
        }
    }
    if (!allValid) {
         document.querySelector(`#edit-kelas-tabs .sub-tab-link[data-kelas="${firstInvalidKelas}"]`).click(); 
         App.showAppModal('error', `Data Murid di Kelas ${firstInvalidKelas} tidak valid. Jumlah murid per rombel tidak sama dengan jumlah murid menurut agama.`);
    }
    return allValid;
});

// Validasi Tab 3 (PTK) - Validasi Kepala Sekolah
formLogic.setTabValidation(2, () => { 
    const totalKepsek = (parseInt(form.querySelector('[name="ptk_kepsek_pns"]').value, 10) || 0) +
                              (parseInt(form.querySelector('[name="ptk_kepsek_pppk"]').value, 10) || 0) +
                              (parseInt(form.querySelector('[name="ptk_kepsek_nonasn"]').value, 10) || 0);

    if (totalKepsek > 1) {
        App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal adalah 1.');
        return false;
    }
    return true; 
});

// Panggil data dari server
google.script.run
    .withSuccessHandler(schoolLists => {
        // Panggil setupDataSekolah setelah schoolLists (data sekolah) didapat
        setupDataSekolah(schoolLists);

        // Panggil data baris yang spesifik
        google.script.run
            .withSuccessHandler(rowData => {
                if (rowData.error || !rowData || Object.keys(rowData).length === 0) {
                    loadingDiv.innerHTML = `<p style="color:red;">Gagal: ${rowData.error || `Data untuk baris ${params.rowIndex} tidak ditemukan.`}</p>`;
                    return;
                }

                form.querySelector('[name="rowIndex"]').value = params.rowIndex;

                // Isi semua field (Termasuk 83+ PTK fields baru)
                for (const header in rowData) {
                    const fieldName = header.trim();
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        let value = rowData[header];
                        if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                            value = '0';
                        }
                        field.value = value;
                    }
                }

                // (Data Tab 1 diisi oleh loop di atas)

                // Picu 'change' untuk semua dropdown rombel dan agama
                const agama = ['islam', 'kristen', 'katolik', 'hindu', 'buddha', 'konghucu'];
                for (let i = 1; i <= 6; i++) {
                    const rombelSelect = form.querySelector(`[name="k${i}_jumlah_rombel"]`);
                    rombelSelect.dispatchEvent(new Event('change', { bubbles: true }));

                    agama.forEach(ag => {
                        const L = parseInt(rowData[`k${i}_agama_${ag}_L`] || 0, 10);
                        const P = parseInt(rowData[`k${i}_agama_${ag}_P`] || 0, 10);
                        const selectAgama = form.querySelector(`.agama-toggle[data-kelas="${i}"][data-agama="${ag}"]`);
                        if (selectAgama) {
                            selectAgama.value = (L + P > 0) ? 'Ada' : 'Tidak Ada';
                            selectAgama.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    checkKelasTotals(i); // Hitung ulang total setelah diisi
                }

                // Isi data file
                const fileLinkContainer = document.getElementById('existingFileLink');
                if (rowData['Dokumen']) { fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`; } else { fileLinkContainer.innerHTML = 'Tidak ada file.'; }

                // Kunci field
                lockField('Bulan'); lockField('Tahun'); lockField('Status'); lockField('Nama Sekolah');

                // Buka semua tab
                formLogic.unlockTab(1);
                formLogic.unlockTab(2);
                formLogic.unlockTab(3);
                formLogic.showTab(0); // Mulai di Tab 1

                loadingDiv.style.display = 'none';
                formContainer.style.display = 'flex';
            })
            .withFailureHandler(err => { 
                loadingDiv.style.display = 'none'; 
                formContainer.style.display = 'none'; 
                document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Gagal Memuat Data</h3><p>Gagal memuat data baris: ${err.message}. Coba muat ulang halaman.</p></div>`;
            })
            .getLapbulDataByRow(params.rowIndex, params.source);
    })
    .withFailureHandler(err => App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
    .getSdSchoolLists();

// Logika SUBMIT
form.addEventListener('submit', function (e) {
    e.preventDefault();

    if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
    if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
    if (!formLogic.validateTab(2)) { formLogic.showTab(2); return; }

    const fileInput = form.querySelector('input[type="file"]');
    const file = fileInput.files[0];
    if (file && file.size > 300 * 1024) { 
        App.showAppModal('error', 'Ukuran file tidak boleh lebih dari 300 KB.');
        formLogic.showTab(3); 
        return;
    }

    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    App.showAppModal('loading', 'Menyimpan perubahan...');

    const payload = {};
    const allFields = form.querySelectorAll('input:not(:disabled), select:not(:disabled), textarea:not(:disabled)');
    allFields.forEach(field => {
        if (field.name) {
            if (field.type === 'number' && field.value === '') {
                payload[field.name] = 0;
            } else {
                payload[field.name] = field.value;
            }
        }
    });

    // Tambahkan field yang 'disabled' (kunci) secara manual
    payload.rowIndex = form.querySelector('[name="rowIndex"]').value;
    payload.source = form.querySelector('[name="source"]').value;
    payload.Bulan = form.querySelector('[name="Bulan"]').value;
    payload.Tahun = form.querySelector('[name="Tahun"]').value;
    payload['Nama Sekolah'] = form.querySelector('[name="Nama Sekolah"]').value;
    payload['Status'] = form.querySelector('[name="Status"]').value;
    payload['NPSN'] = form.querySelector('[name="NPSN"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     if (submitButton) submitButton.disabled = false;
                } else {
                     App.showAppModal('success', res, 'lapbul_kelola');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', err.message);
                if (submitButton) submitButton.disabled = false;
            })
            .updateLapbulData(data); // Panggil fungsi UPDATE
    };

    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            sendData(payload);
        };
        reader.readAsDataURL(file);
    } else {
        sendData(payload);
    }
  });
}

function initLapbulUnduhFormatPage() {
    initMenuPage();
    const infoBtn = document.getElementById('infoDropdownBtn');
    const contentDiv = document.getElementById('infoDropdownContent');

    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                .getUnduhFormatInfo();
        }
    };
}

// --- Modul Data PTK ---

function initPtkKeadaanPaudPage() {
    App.initializeGenericTablePage({
        tableId: 'keadaanPtkPaudTable',
        serverFunction: 'getPtkKeadaanPaudData',
        filters: [ 
            { id: 'filterJenjang', dataColumn: '_filterJenjang', defaultText: 'Semua Jenjang' } 
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkKeadaanSdPage() {
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('keadaanPtkSdTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatusSekolah');

    let allDataRows = []; // Menyimpan baris data asli (tengah)
    let headerRow1_Data = []; // Data mentah header 1
    let headerRow2_Data = []; // Data mentah header 2
    let statusColumnIndex = -1; // Indeks kolom "Status"
    let dataHeaderCount = 0; // Untuk colspan

    // 1. Fungsi untuk membangun <tbody> DAN <tfoot> (DINAMIS)
    function buildTableBody() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; // Kosongkan footer setiap kali filter
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusColumnIndex === -1) {
                return true; // Tampilkan semua jika filter "Semua"
            }
            // Filter berdasarkan nilai kolom Status
            return String(row[statusColumnIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${dataHeaderCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.classList.remove('has-content');
            return; // Stop jika tidak ada data
        }

        // --- MULAI PERBAIKAN ---
        
        // Indeks kolom Rombel (kolom ke-6) adalah 4
        // (0:Nama, 1:NPSN, 2:Jenjang, 3:Status, 4:Rombel)
        const sumStartIndex = 4; 
        const totals = new Array(dataHeaderCount).fill(0); // Buat array [0, 0, 0, ...]

        // 1. Bangun <tbody>
        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Tambah "No."
            
            let rowCells = row.map((cell, cellIndex) => {
                // Ambil nilai mentah. Jika kosong/null, set ke 0 (angka). Jika tidak, biarkan (bisa "0" string).
                const rawValue = (cell === "" || cell === null || cell === undefined) ? 0 : cell;
                
                // ===============================================
                // INI PERBAIKANNYA: Gunakan '==' (loose equality)
                // Ini akan menangkap (0 == 0) -> true DAN ("0" == 0) -> true
                const displayValue = (rawValue == 0) ? '-' : rawValue;
                // ===============================================
                
                // Kalkulasi total (hanya jika kolom data)
                if (cellIndex >= sumStartIndex) {
                    // Konversi rawValue (yang bisa "0" string) ke angka untuk penjumlahan
                    const numericValue = parseFloat(String(rawValue).replace(/,/g, '')) || 0;
                    totals[cellIndex] += numericValue; 
                }
                return `<td>${displayValue}</td>`;
            });

            cellsHTML += rowCells.join('');
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
        // --- Selesai <tbody> ---

        // --- 2. Bangun <tfoot> DINAMIS ---
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td>JUMLAH</td>'; // Kolom Nama Sekolah (Index 0)
        footerHTML += '<td>-</td>';       // Kolom NPSN (Index 1)
        footerHTML += '<td>-</td>';       // Kolom Jenjang (Index 2)
        footerHTML += '<td>-</td>';       // Kolom Status (Index 3)
        
        // Loop untuk kolom total (mulai dari index 4 / "Rombel")
        for (let i = sumStartIndex; i < totals.length; i++) {
            // Logika untuk footer (total[i] adalah angka) sudah benar
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }

        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
        tableFoot.classList.add('has-content');
        
        // --- AKHIR PERBAIKAN ---
    }

    // 2. Fungsi buildTableHeader (v2 - sudah benar, JANGAN DIUBAH)
    function buildTableHeader() {
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = ''; 
        dataHeaderCount = headerRow1_Data.length; 

        for (let i = 0; i < headerRow1_Data.length; i++) {
            const header1 = headerRow1_Data[i];
            const header2 = headerRow2_Data[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } 
            else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < headerRow1_Data.length; j++) {
                    if (headerRow1_Data[j] === "" && headerRow2_Data[j] !== "") {
                        colspan++;
                    } else {
                        break; 
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } 
            else if (header1 === "" && header2 !== "") {
                 row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 3. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 3) {
                loadingStatus.innerHTML = '<p>Data tidak memadai untuk ditampilkan (kurang dari 3 baris).</p>';
                return;
            }

            // --- Logika Pemisahan Data (BARU) ---
            headerRow1_Data = data[0];
            headerRow2_Data = data[1];
            // Kita abaikan baris terakhir (footer statis)
            allDataRows = data.slice(2, data.length - 1); 
            // --- Selesai Logika Pemisahan ---

            statusColumnIndex = headerRow1_Data.indexOf('Status'); 
            buildTableHeader();

            // 4. Buat dropdown filter
            if (statusColumnIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusColumnIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(status => {
                    filterSelect.add(new Option(status, status));
                });
            } else {
                if(filterSelect) filterSelect.parentElement.style.display = 'none';
            }

            // 5. Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            filterSelect.addEventListener('change', buildTableBody);
            buildTableBody(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getPtkKeadaanSdData(); // <-- Memanggil fungsi code.gs
}

function initPtkJumlahBulananPaudPage() {
    // --- KODE BARU: Hitung default dinamis ---
    const d = new Date();
    const currentYear = d.getFullYear().toString();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    let lastMonthIndex = d.getMonth() - 1; // getMonth() itu 0-11
    let yearOfLastMonth = currentYear;

    // Jika sekarang Januari (0), bulan lalu adalah Desember (11) dari TAHUN LALU
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Desember
        yearOfLastMonth = (d.getFullYear() - 1).toString();
    }
    const lastMonthName = monthNames[lastMonthIndex];
    
    // Tentukan Tahun default. Jika bulan lalu adalah Desember, Tahun defaultnya adalah tahun lalu.
    const defaultTahun = (lastMonthIndex === 11) ? yearOfLastMonth : currentYear;
    // --- AKHIR KODE BARU ---

    App.initializeGenericTablePage({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunction: 'getPtkJumlahBulananPaudData',
        
        // --- PERUBAHAN DI SINI: Tambahkan properti defaultValues ---
        defaultValues: {
            'filterTahun': defaultTahun,
            'filterBulan': lastMonthName
        },
        // --- AKHIR PERUBAHAN ---

        filters: [
            { id: 'filterTahun', dataColumn: '_filterTahun', type: 'dropdown', sortReverse: true },
            { id: 'filterBulan', dataColumn: '_filterBulan', type: 'dropdown', specialSort: 'bulan' },
            { id: 'filterJenjang', dataColumn: '_filterJenjang', type: 'dropdown' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              type: 'cascading-local', 
              parent: 'filterJenjang',
              parentKey: '_filterJenjang'
            }
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkDaftarPaudPage() {
    
    // (Ini adalah daftar urutan kolom kustom Anda dari misi sebelumnya)
    const kustomHeaders = [
        "Nama", "Nama Lembaga", "Jenjang", "Status", "NIP/NIY", 
        "Pangkat, Gol./Ruang", "NUPTK", "Jabatan", "TMT", "L/P", 
        "Tempat, Tanggal Lahir", "Pendidikan", "Jurusan", "Tahun Lulus", 
        "Serdik", "Dapodik"
    ];

    App.initializeGenericTablePage({
        tableId: 'daftarPtkPaudTable',
        serverFunction: 'getDaftarPtkPaudData',
        displayHeaders: kustomHeaders, 
        
        // â–¼â–¼â–¼ PERBAIKAN DI SINI â–¼â–¼â–¼
        // 1. "filterConfig:" diubah menjadi "filters:"
        // 2. Menambahkan 3 filter baru
        filters: [
            { id: 'filterJenjang', dataColumn: '_filterJenjang', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: '_filterNamaLembaga', 
              type: 'cascading-local',
              parent: 'filterJenjang',
              parentKey: '_filterJenjang',
              defaultText: 'Semua Lembaga'
            },
            { id: 'filterStatus', dataColumn: '_filterStatus', defaultText: 'Semua Status' },
            { id: 'filterPendidikan', dataColumn: '_filterPendidikan', defaultText: 'Semua Pendidikan' },
            { id: 'filterSerdik', dataColumn: '_filterSerdik', defaultText: 'Semua Serdik' },
            { id: 'filterDapodik', dataColumn: '_filterDapodik', defaultText: 'Semua Dapodik' }
        ]
        // â–²â–²â–² AKHIR PERBAIKAN â–²â–²â–²
    });
}

function initPtkKelolaPaudPage() {

    // --- PERINTAH URUTAN KUSTOM (A, B, C, D, H, Aksi, Q, R) ---
    const kustomHeaders = [
        "Nama",        // A
        "Nama Lembaga",   // B
        "Status",         // D
        "Jabatan",        // H
        "Aksi",           // (Tombol)
        "Tanggal Input",  // Q (sesuai asumsi)
        "Update"          // R (sesuai asumsi)
    ];
    // --- AKHIR PERINTAH ---

    App.initializeGenericTablePage({
        tableId: 'kelolaPtkPaudTable',
        serverFunction: 'getKelolaPtkPaudData',
        displayHeaders: kustomHeaders, // <-- SENJATA BARU DI AKTIFKAN
        editPage: 'ptk_edit_paud',

        // â–¼â–¼â–¼ PERBAIKAN: 'filterConfig' menjadi 'filters' & dibuat cascading â–¼â–¼â–¼
        filters: [
            { id: 'filterJenjang', dataColumn: 'Jenjang', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              type: 'cascading-local', // <-- Taktik baru
              parent: 'filterJenjang',      // <-- Taktik baru
              parentKey: 'Jenjang',      // <-- Taktik baru
              defaultText: 'Semua Lembaga' // <-- Taktik baru
            }
        ]
        // â–²â–²â–² AKHIR PERBAIKAN â–²â–²â–²
    });

    document.getElementById('tambahPtkBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_paud');
    });
}

function initPtkTambahPaudPage() {
    const form = document.getElementById('addPtkPaudForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    if (!form) return;

    // Tampilkan skeleton segera (karena form disembunyikan di HTML)
    if (skeleton) skeleton.style.display = 'block';

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('addPtkPaudForm');
    
    // 2. Variabel untuk menyimpan data dropdown dari server
    let serverOptions = {};

    // 3. Fungsi untuk mengisi dropdown
    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    // 4. Panggil data dari server (Tanpa App.showAppModal di sini)
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                // Jika error, sembunyikan skeleton, tampilkan modal error, dan HENTIKAN proses pengisian
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex'; // Tampilkan form agar tombol OK di modal bisa di-klik
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            serverOptions = options; // Simpan data server

            // Isi dropdown Status dan Jabatan
            populateSingleDropdown("status", serverOptions['Status'], "-- Pilih Status --");
            populateSingleDropdown("jabatan", serverOptions['Jabatan'], "-- Pilih Jabatan --");
            
            // Atur listener untuk dropdown "Jenjang"
            form.querySelector('#jenjang').addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = serverOptions['Nama Lembaga'][selectedJenjang] || [];
                const lembagaSelect = form.querySelector('#namaLembaga');
                
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });
            
            // --- AKTIFKAN FORM DAN TUTUP SKELETON (PERBAIKAN) ---
            if (skeleton) skeleton.style.display = 'none'; // Sembunyikan skeleton
            form.style.display = 'flex'; // Tampilkan form utama sebagai flex
            // --- AKHIR PERBAIKAN ---

            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => {
             // Tangani kegagalan server
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkPaudOptions(); 

    // 5. Tentukan Aturan Validasi Kustom
    
    // Validasi Tab 1 (Data Lembaga)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));

    // Validasi Tab 2 (Data Pribadi)
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        
        // Validasi Kustom "Jurusan"
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsJurusan = ['S2', 'S1', 'D4', 'D3', 'D2', 'SMA', 'SMK', 'MA', 'Paket C'].includes(pendidikan);

        if (needsJurusan && !jurusan) {
            App.showAppModal('error', 'Jurusan wajib diisi untuk jenjang pendidikan yang Anda pilih.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        
        return true; // Lolos semua
    });
    
    // Validasi Tab 3 (Data Kepegawaian)
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));


    // 6. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cek semua tab sebelum mengirim
        if (!formLogic.validateTab(0)) {
            App.showAppModal('error', 'Data Lembaga (Tab 1) belum lengkap.');
            formLogic.showTab(0); // Pindahkan ke tab yang error
            return;
        }
        if (!formLogic.validateTab(1)) {
            formLogic.showTab(1); // Pindahkan ke tab yang error
            return;
        }
        if (!formLogic.validateTab(2)) {
            App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.');
            formLogic.showTab(2); // Pindahkan ke tab yang error
            return;
        }

        // --- Jika Semua Lolos ---
        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkPaud(formData); // Memanggil fungsi code.gs yang sudah ada
    });
}

function initPtkEditPaudPage(params) {
    const form = document.getElementById('editPtkPaudForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.rowIndex) {
        if(skeleton) skeleton.style.display = 'none';
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    if (skeleton) skeleton.style.display = 'block';

    // 2. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('editPtkPaudForm');
    let serverOptions = {};

    // 3. Fungsi untuk mengisi dropdown
    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = form.querySelector('#' + elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    // --- PANGGIL DATA OPSI DROPDOWN ---
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            serverOptions = options; 

            // Isi dropdown Statis (Status dan Jabatan)
            populateSingleDropdown("status", serverOptions['Status'], "-- Pilih Status --");
            populateSingleDropdown("jabatan", serverOptions['Jabatan'], "-- Pilih Jabatan --");
            
            // Atur listener untuk dropdown "Jenjang"
            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            
            jenjangSelect.addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = serverOptions['Nama Lembaga'][selectedJenjang] || [];
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });

            // --- PANGGIL DATA BARIS YANG AKAN DIEDIT (CHAINING) ---
            google.script.run
                .withSuccessHandler(rowData => {
                    if (rowData.error) {
                        App.showAppModal('error', `Gagal memuat data baris: ${rowData.error}`);
                        return;
                    }

                    // 1. Isi Semua Field Form
                    for (const key in rowData) {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (key === 'TMT' && rowData[key]) {
                                field.value = rowData[key]; // yyyy-MM-dd
                            } else {
                                field.value = rowData[key];
                            }
                        }
                    }

                    // 2. Taktik Kunci: Isi Dropdown Bertingkat
                    jenjangSelect.value = rowData['Jenjang'];
                    jenjangSelect.dispatchEvent(new Event('change')); // Picu event 'change'
                    lembagaSelect.value = rowData['Nama Lembaga']; // Set nilai anak

                    // 3. Tampilkan Form, Sembunyikan Skeleton
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    document.getElementById('appModal').classList.remove('show');

                })
                .withFailureHandler(err => { 
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`);
                })
                .getPtkPaudDataByRow(params.rowIndex); 

        })
        .withFailureHandler(err => { 
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkPaudOptions(); 

    // 5. Tentukan Aturan Validasi Kustom
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        // Validasi Kustom "Jurusan"
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsJurusan = ['S2', 'S1', 'D4', 'D3', 'D2', 'SMA', 'SMK', 'MA', 'Paket C'].includes(pendidikan);
        if (needsJurusan && !jurusan) {
            App.showAppModal('error', 'Jurusan wajib diisi untuk jenjang pendidikan yang Anda pilih.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        return true; 
    });
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 6. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cek semua tab
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Lembaga (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#editSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkPaudData(formData); 
    });
}

function initPtkJumlahBulananSdPage() {
    // 1. Tentukan target elemen (menggunakan ID dari page_ptk_jumlah_bulanan_sd.html)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('jumlahPtkSdBulananTable'); // <-- Target tabel yang benar
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua filter dari halaman
    const filterContainer = document.querySelector('.filter-container');
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterStatus = document.getElementById('filterStatusSekolah'); // <-- PERBAIKI: ID di HTML Anda adalah 'filterStatusSekolah'

    let allDataRows = []; // Menyimpan baris data asli (tengah)
    let headerRow1_Data = []; // Data mentah header 1
    let headerRow2_Data = []; // Data mentah header 2
    
    // Indeks kolom untuk filter
    let tahunColumnIndex = -1;
    let bulanColumnIndex = -1;
    let statusColumnIndex = -1;
    let dataHeaderCount = 0; // Untuk colspan

    // 2. Fungsi untuk membangun <tbody> DAN <tfoot> (DINAMIS)
    function buildTableBody() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; // Kosongkan footer setiap kali filter
        
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valStatus = filterStatus.value; // <-- PERBAIKI: Menggunakan filterStatus
        
        const filteredRows = allDataRows.filter(row => {
            const matchTahun = !valTahun || (tahunColumnIndex !== -1 && String(row[tahunColumnIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanColumnIndex !== -1 && String(row[bulanColumnIndex]).trim() === valBulan);
            const matchStatus = !valStatus || (statusColumnIndex !== -1 && String(row[statusColumnIndex]).trim() === valStatus); // <-- PERBAIKI: Logika filter Status
            return matchTahun && matchBulan && matchStatus;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${dataHeaderCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.classList.remove('has-content');
            return; // Stop jika tidak ada data
        }

        // --- MULAI Kalkulasi Total Dinamis ---
        
        // Asumsi: Kolom 5 ("Jml. Rombel") adalah awal penjumlahan (indeks ke-4)
        const sumStartIndex = 4; 
        const totals = new Array(dataHeaderCount).fill(0); // Buat array [0, 0, 0, ...]

        // 1. Bangun <tbody>
        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Tambah "No."
            
            let rowCells = row.map((cell, cellIndex) => {
                const rawValue = (cell === "" || cell === null || cell === undefined) ? 0 : cell;
                const displayValue = (rawValue == 0) ? '-' : rawValue; // Tampilkan 0 sebagai '-'
                
                if (cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(rawValue).replace(/,/g, '')) || 0;
                    totals[cellIndex] += numericValue; 
                }
                return `<td>${displayValue}</td>`;
            });

            cellsHTML += rowCells.join('');
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
        // --- Selesai <tbody> ---

        // --- 2. Bangun <tfoot> DINAMIS ---
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td>JUMLAH</td>'; // Kolom Nama Sekolah (Index 0)
        footerHTML += '<td>-</td>';       // Kolom NPSN (Index 1)
        footerHTML += '<td>-</td>';       // Kolom Jenjang (Index 2)
        footerHTML += '<td>-</td>';       // Kolom Status (Index 3)
        
        // Loop untuk kolom total (mulai dari index 4 / "Rombel")
        for (let i = sumStartIndex; i < totals.length; i++) {
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }

        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
        tableFoot.classList.add('has-content');
    }

    // 3. Fungsi buildTableHeader (v2 - Logika header gabungan yang benar)
    function buildTableHeader() {
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = ''; 
        dataHeaderCount = headerRow1_Data.length; 

        for (let i = 0; i < headerRow1_Data.length; i++) {
            const header1 = headerRow1_Data[i];
            const header2 = headerRow2_Data[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } 
            else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < headerRow1_Data.length; j++) {
                    if (headerRow1_Data[j] === "" && headerRow2_Data[j] !== "") {
                        colspan++;
                    } else {
                        break; 
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } 
            else if (header1 === "" && header2 !== "") {
                 row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk mengisi dropdown filter
    function setupFilters() {
        // Cari indeks berdasarkan header baris PERTAMA
        tahunColumnIndex = headerRow1_Data.indexOf('Tahun');
        bulanColumnIndex = headerRow1_Data.indexOf('Bulan');
        statusColumnIndex = headerRow1_Data.indexOf('Status');
        
        const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // ===============================================
        // === LOGIKA BARU UNTUK DEFAULT TANGGAL ===
        // ===============================================
        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        let lastMonthIndex = d.getMonth() - 1; // getMonth() itu 0-11
        let yearOfLastMonth = currentYear;

        // Penanganan jika sekarang Januari (0), bulan lalu adalah Desember (11) TAHUN LALU
        if (lastMonthIndex < 0) { 
            lastMonthIndex = 11; // Desember
            yearOfLastMonth = (d.getFullYear() - 1).toString();
        }
        const lastMonthName = monthNames[lastMonthIndex];
        // ===============================================
        
        if (tahunColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[tahunColumnIndex]))].filter(Boolean).sort().reverse();
            filterTahun.innerHTML = '<option value="">Semua Tahun</option>';
            unique.forEach(val => filterTahun.add(new Option(val, val)));
            
            // Set default Tahun (Gunakan tahun dari bulan lalu)
            if (unique.includes(yearOfLastMonth)) {
                filterTahun.value = yearOfLastMonth;
            }
        }
        if (bulanColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[bulanColumnIndex]))].filter(Boolean)
                             .sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            filterBulan.innerHTML = '<option value="">Semua Bulan</option>';
            unique.forEach(val => filterBulan.add(new Option(val, val)));

            // Set default Bulan (Bulan lalu)
            if (unique.includes(lastMonthName)) {
                filterBulan.value = lastMonthName;
            }
        }
        if (statusColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[statusColumnIndex]))].filter(Boolean).sort();
            filterStatus.innerHTML = '<option value="">Semua Status</option>'; // <-- PERBAIKI: Menggunakan filterStatus
            unique.forEach(val => filterStatus.add(new Option(val, val))); // <-- PERBAIKI: Menggunakan filterStatus
        }
        
        // Tampilkan filter & tambahkan listener
        filterContainer.style.display = 'flex';
        filterTahun.addEventListener('change', buildTableBody);
        filterBulan.addEventListener('change', buildTableBody);
        filterStatus.addEventListener('change', buildTableBody); // <-- PERBAIKI: Menggunakan filterStatus
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 3) {
                loadingStatus.innerHTML = '<p>Data tidak memadai untuk ditampilkan (kurang dari 3 baris).</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            headerRow1_Data = data[0]; // Baris 1 (Header Grup)
            headerRow2_Data = data[1]; // Baris 2 (Subheader)
            allDataRows = data.slice(2, data.length - 1); // Abaikan footer statis
            // --- Selesai Logika Pemisahan ---
            
            buildTableHeader();
            setupFilters(); // Buat filter

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getPtkJumlahBulananSdData(); // <-- Memanggil fungsi code.gs
}

function initPtkDaftarSdnPage() {
    // 1. Tentukan target elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('daftarPtkSdnTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const paginationContainer = document.getElementById('pagination-container');
    
    // Ambil semua filter (TERMASUK 3 YANG BARU)
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const filterStatus = document.getElementById('filterStatus');
    const filterPangkat = document.getElementById('filterPangkat');
    const filterJabatan = document.getElementById('filterJabatan');
    const filterPendidikan = document.getElementById('filterPendidikan'); // <-- BARU
    const filterDapodik = document.getElementById('filterDapodik');       // <-- BARU
    const filterSerdik = document.getElementById('filterSerdik');         // <-- BARU

    let allDataRows = []; // Menyimpan baris data asli (setelah header)
    let allHeaders = [];  // Menyimpan header
    
    // Indeks kolom untuk filter (DITAMBAH 3)
    let filterIndices = {
        'Unit Kerja': -1,
        'Status': -1,
        'Pangkat': -1,
        'Jabatan': -1,
        'Pendidikan': -1, // <-- BARU
        'Dapodik': -1,    // <-- BARU
        'Serdik': -1      // <-- BARU
    };
    
    let currentPage = 1;
    let rowsPerPage = 15; // Default

    // 2. Fungsi Paginasi (disalin dari logika generik)
    const calculateRowsPerPage = () => {
        const tableContainer = table.closest('.table-container');
        if (!tableContainer) return 15;
        const bottomOffset = 180; // Ruang untuk pagination + footer
        const rowHeight = 38; 
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = (totalRows) => {
        if (!paginationContainer) return;
        const pageCount = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDN(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDN(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    // Buat fungsi ganti halaman khusus untuk tabel ini
    App.changePage_DaftarPTKSDN = (direction) => {
        currentPage += direction;
        buildTableBody();
    };

    // 3. Fungsi untuk membangun <tbody> (DITAMBAH 3 LOGIKA FILTER)
    function buildTableBody() {
        tableBody.innerHTML = '';
        
        const valUnitKerja = filterUnitKerja.value;
        const valStatus = filterStatus.value;
        const valPangkat = filterPangkat.value;
        const valJabatan = filterJabatan.value;
        const valPendidikan = filterPendidikan.value; // <-- BARU
        const valDapodik = filterDapodik.value;     // <-- BARU
        const valSerdik = filterSerdik.value;         // <-- BARU
        
        const filteredRows = allDataRows.filter(row => {
            const matchUK = !valUnitKerja || (filterIndices['Unit Kerja'] !== -1 && String(row[filterIndices['Unit Kerja']]).trim() === valUnitKerja);
            const matchStatus = !valStatus || (filterIndices['Status'] !== -1 && String(row[filterIndices['Status']]).trim() === valStatus);
            const matchPangkat = !valPangkat || (filterIndices['Pangkat'] !== -1 && String(row[filterIndices['Pangkat']]).trim() === valPangkat);
            const matchJabatan = !valJabatan || (filterIndices['Jabatan'] !== -1 && String(row[filterIndices['Jabatan']]).trim() === valJabatan);
            
            // LOGIKA FILTER BARU
            const matchPendidikan = !valPendidikan || (filterIndices['Pendidikan'] !== -1 && String(row[filterIndices['Pendidikan']]).trim() === valPendidikan);
            const matchDapodik = !valDapodik || (filterIndices['Dapodik'] !== -1 && String(row[filterIndices['Dapodik']]).trim() === valDapodik);
            const matchSerdik = !valSerdik || (filterIndices['Serdik'] !== -1 && String(row[filterIndices['Serdik']]).trim() === valSerdik);
            
            // Kembalikan semua kondisi
            return matchUK && matchStatus && matchPangkat && matchJabatan && matchPendidikan && matchDapodik && matchSerdik;
        });

        // Hitung ulang paginasi
        rowsPerPage = calculateRowsPerPage();
        const pageCount = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = filteredRows.slice(start, start + rowsPerPage);
        
        setupPagination(filteredRows.length);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Bangun baris <tbody>
        paginatedRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
            
            let cellsHTML = `<td>${rowNumber}</td>`; // Tambah "No."
            
            // Tambahkan sisa sel dari data
            cellsHTML += row.map(cell => {
                const displayValue = (cell === "" || cell === null || cell === undefined || cell == 0) ? '-' : cell;
                return `<td>${displayValue}</td>`;
            }).join('');
            
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
    }

    // 4. Fungsi untuk mengisi dropdown filter (DITAMBAH 3 FILTER BARU)
    function setupFilters() {
        // Cari indeks kolom berdasarkan nama header
        filterIndices['Unit Kerja'] = allHeaders.indexOf('Unit Kerja');
        filterIndices['Status'] = allHeaders.indexOf('Status');
        filterIndices['Pangkat'] = allHeaders.indexOf('Pangkat, Gol./Ruang'); // Sesuaikan nama lengkap
        filterIndices['Jabatan'] = allHeaders.indexOf('Jabatan');
        filterIndices['Pendidikan'] = allHeaders.indexOf('Pendidikan'); // <-- BARU
        filterIndices['Dapodik'] = allHeaders.indexOf('Dapodik');       // <-- BARU
        filterIndices['Serdik'] = allHeaders.indexOf('Serdik');         // <-- BARU

        // Fungsi helper untuk mengisi satu dropdown
        function populateFilter(selectEl, columnIndex) {
            if (!selectEl || columnIndex === -1) {
                // Sembunyikan filter jika kolom tidak ditemukan di spreadsheet
                if(selectEl) selectEl.parentElement.style.display = 'none';
                return;
            }
            
            const unique = [...new Set(allDataRows.map(row => String(row[columnIndex]).trim()))].filter(Boolean).sort();
            selectEl.innerHTML = `<option value="">Semua</option>`; // Teks default "Semua"
            unique.forEach(val => selectEl.add(new Option(val, val)));
            
            // Tambahkan event listener
            selectEl.addEventListener('change', () => {
                currentPage = 1; // Reset ke halaman 1 saat filter
                buildTableBody();
            });
        }
        
        // Isi semua filter
        populateFilter(filterUnitKerja, filterIndices['Unit Kerja']);
        populateFilter(filterStatus, filterIndices['Status']);
        populateFilter(filterPangkat, filterIndices['Pangkat']);
        populateFilter(filterJabatan, filterIndices['Jabatan']);
        populateFilter(filterPendidikan, filterIndices['Pendidikan']); // <-- BARU
        populateFilter(filterDapodik, filterIndices['Dapodik']);       // <-- BARU
        populateFilter(filterSerdik, filterIndices['Serdik']);         // <-- BARU
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Data tidak ditemukan di spreadsheet.</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            allHeaders = data[0]; // Baris 1 adalah Header
            allDataRows = data.slice(1); // Sisanya adalah Data
            // --- Selesai Logika Pemisahan ---
            
            // Buat <thead> (SESUAI PERMINTAAN: Sesuai urutan spreadsheet)
            tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Buat filter
            setupFilters(); 

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdnData(); // <-- Memanggil fungsi code.gs
}

function initPtkDaftarSdsPage() {
    // 1. Tentukan target elemen (dari page_ptk_daftar_sd_swasta.html)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('daftarPtkSdsTable'); // <-- Target tabel SWASTA
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const paginationContainer = document.getElementById('pagination-container');
    
    // Ambil semua filter (TERMASUK 3 YANG BARU)
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const filterStatus = document.getElementById('filterStatus');
    const filterJabatan = document.getElementById('filterJabatan');
    const filterPendidikan = document.getElementById('filterPendidikan'); // <-- BARU
    const filterDapodik = document.getElementById('filterDapodik');       // <-- BARU
    const filterSerdik = document.getElementById('filterSerdik');         // <-- BARU

    let allDataRows = []; // Menyimpan baris data asli (setelah header)
    let allHeaders = [];  // Menyimpan header
    
    // Indeks kolom untuk filter (DITAMBAH 3)
    let filterIndices = {
        'Unit Kerja': -1,
        'Status': -1,
        'Jabatan': -1,
        'Pendidikan': -1, // <-- BARU
        'Dapodik': -1,    // <-- BARU
        'Serdik': -1      // <-- BARU
        // (Filter 'Pangkat' tidak ada di sini, sesuai file HTML Anda)
    };
    
    let currentPage = 1;
    let rowsPerPage = 15; // Default

    // 2. Fungsi Paginasi
    const calculateRowsPerPage = () => {
        const tableContainer = table.closest('.table-container');
        if (!tableContainer) return 15;
        const bottomOffset = 180;
        const rowHeight = 38; 
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = (totalRows) => {
        if (!paginationContainer) return;
        const pageCount = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        // Buat fungsi ganti halaman unik
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDS(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDS(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    // Fungsi ganti halaman unik untuk tabel SWASTA
    App.changePage_DaftarPTKSDS = (direction) => {
        currentPage += direction;
        buildTableBody();
    };

    // 3. Fungsi untuk membangun <tbody> (DITAMBAH 3 LOGIKA FILTER)
    function buildTableBody() {
        tableBody.innerHTML = '';
        
        const valUnitKerja = filterUnitKerja.value;
        const valStatus = filterStatus.value;
        const valJabatan = filterJabatan.value;
        const valPendidikan = filterPendidikan.value; // <-- BARU
        const valDapodik = filterDapodik.value;     // <-- BARU
        const valSerdik = filterSerdik.value;         // <-- BARU
        
        const filteredRows = allDataRows.filter(row => {
            const matchUK = !valUnitKerja || (filterIndices['Unit Kerja'] !== -1 && String(row[filterIndices['Unit Kerja']]).trim() === valUnitKerja);
            const matchStatus = !valStatus || (filterIndices['Status'] !== -1 && String(row[filterIndices['Status']]).trim() === valStatus);
            const matchJabatan = !valJabatan || (filterIndices['Jabatan'] !== -1 && String(row[filterIndices['Jabatan']]).trim() === valJabatan);
            
            // LOGIKA FILTER BARU
            const matchPendidikan = !valPendidikan || (filterIndices['Pendidikan'] !== -1 && String(row[filterIndices['Pendidikan']]).trim() === valPendidikan);
            const matchDapodik = !valDapodik || (filterIndices['Dapodik'] !== -1 && String(row[filterIndices['Dapodik']]).trim() === valDapodik);
            const matchSerdik = !valSerdik || (filterIndices['Serdik'] !== -1 && String(row[filterIndices['Serdik']]).trim() === valSerdik);
            
            // Kembalikan semua kondisi
            return matchUK && matchStatus && matchJabatan && matchPendidikan && matchDapodik && matchSerdik;
        });

        // Hitung ulang paginasi
        rowsPerPage = calculateRowsPerPage();
        const pageCount = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = filteredRows.slice(start, start + rowsPerPage);
        
        setupPagination(filteredRows.length);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Bangun baris <tbody>
        paginatedRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
            
            let cellsHTML = `<td>${rowNumber}</td>`; // Tambah "No."
            
            // Tambahkan sisa sel dari data
            cellsHTML += row.map(cell => {
                const displayValue = (cell === "" || cell === null || cell === undefined || cell == 0) ? '-' : cell;
                return `<td>${displayValue}</td>`;
            }).join('');
            
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
    }

    // 4. Fungsi untuk mengisi dropdown filter (DITAMBAH 3 FILTER BARU)
    function setupFilters() {
        // Cari indeks kolom berdasarkan nama header
        filterIndices['Unit Kerja'] = allHeaders.indexOf('Unit Kerja');
        filterIndices['Status'] = allHeaders.indexOf('Status');
        filterIndices['Jabatan'] = allHeaders.indexOf('Jabatan');
        filterIndices['Pendidikan'] = allHeaders.indexOf('Pendidikan'); // <-- BARU
        filterIndices['Dapodik'] = allHeaders.indexOf('Dapodik');       // <-- BARU
        filterIndices['Serdik'] = allHeaders.indexOf('Serdik');         // <-- BARU

        // Fungsi helper untuk mengisi satu dropdown
        function populateFilter(selectEl, columnIndex) {
            if (!selectEl || columnIndex === -1) {
                // Sembunyikan filter jika kolom tidak ditemukan di spreadsheet
                if(selectEl) selectEl.parentElement.style.display = 'none';
                return;
            }
            
            const unique = [...new Set(allDataRows.map(row => String(row[columnIndex]).trim()))].filter(Boolean).sort();
            selectEl.innerHTML = `<option value="">Semua</option>`; // Teks default "Semua"
            unique.forEach(val => selectEl.add(new Option(val, val)));
            
            // Tambahkan event listener
            selectEl.addEventListener('change', () => {
                currentPage = 1; // Reset ke halaman 1 saat filter
                buildTableBody();
            });
        }
        
        // Isi semua filter
        populateFilter(filterUnitKerja, filterIndices['Unit Kerja']);
        populateFilter(filterStatus, filterIndices['Status']);
        populateFilter(filterJabatan, filterIndices['Jabatan']);
        populateFilter(filterPendidikan, filterIndices['Pendidikan']); // <-- BARU
        populateFilter(filterDapodik, filterIndices['Dapodik']);       // <-- BARU
        populateFilter(filterSerdik, filterIndices['Serdik']);         // <-- BARU
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Data tidak ditemukan di spreadsheet.</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            allHeaders = data[0]; // Baris 1 adalah Header
            allDataRows = data.slice(1); // Sisanya adalah Data
            // --- Selesai Logika Pemisahan ---
            
            // Buat <thead> (SESUAI PERMINTAAN: Sesuai urutan spreadsheet)
            tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Buat filter
            setupFilters(); 

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdsData(); // <-- Memanggil fungsi code.gs SWASTA
}

function initPtkKelolaSdPage() {
    // Definisi header yang diinginkan di tabel
    const desiredHeaders = [
        "Nama", "Unit Kerja", "Status", "NIP/NIY", "Jabatan", "Aksi", "Input", "Update"
    ];

    App.initializeGenericTablePage({
        tableId: 'kelolaPtkSdTable',
        serverFunction: 'getKelolaPtkSdData',
        displayHeaders: desiredHeaders, // Gunakan header yang sudah didefinisikan
        editPage: 'ptk_edit_sd',
        
        // KONFIGURASI FILTER BARU (Cascading Filter + Search)
        filters: [
            // Filter 1: Status Sekolah (Parent)
            { 
              id: 'filterStatusSekolah', 
              dataColumn: 'Status', // Sekarang Status Sekolah (Negeri/Swasta)
              defaultText: 'Semua Status' 
            },
            // Filter 2: Unit Kerja (Child)
            { 
              id: 'filterUnitKerja', 
              dataColumn: 'Unit Kerja', 
              type: 'cascading-local',
              parent: 'filterStatusSekolah',      
              parentKey: 'Status',      
              defaultText: 'Semua Unit Kerja' 
            }
        ]
    });

    document.getElementById('tambahPtkSdBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_sd');
    });
}

function initPtkTambahSdPage() {
    const form = document.getElementById('addPtkSdForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    // Pastikan form disembunyikan sejak awal
    if (form) form.style.display = 'none';

    // Tampilkan skeleton segera
    if (skeleton) skeleton.style.display = 'block';
    
    if (!form) return;

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('addPtkSdForm');
    
    // 2. Variabel untuk elemen form
    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    
    // Variabel untuk dropdown di Tab 2 & 3
    const agamaSelect = form.querySelector('#agama');
    const pendidikanSelect = form.querySelector('#pendidikan');
    const statusNegeriSelect = form.querySelector('#statusNegeri');
    const pangkatNegeriSelect = form.querySelector('#pangkatNegeri');
    const statusSwastaSelect = form.querySelector('#statusSwasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {}; // Untuk menyimpan data DARI SERVER

    // 3. Fungsi helper untuk mengisi dropdown
    function populateSelect(selectEl, optionsArr, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    // 4. Isi dropdown STATIS
    if (typeof DROPDOWN_STATIS !== 'undefined') {
        populateSelect(agamaSelect, DROPDOWN_STATIS['Agama'], 'Pilih Agama');
        populateSelect(pendidikanSelect, DROPDOWN_STATIS['Pendidikan'], 'Pilih Pendidikan');
        populateSelect(statusNegeriSelect, DROPDOWN_STATIS['StatusKepegawaian'], 'Pilih Status');
        populateSelect(statusSwastaSelect, DROPDOWN_STATIS['StatusKepegawaianSwasta'], 'Pilih Status');
        populateSelect(jabatanSelect, DROPDOWN_STATIS['TugasJabatan'], 'Pilih Tugas/Jabatan');
        populateSelect(tugasTambahanSelect, DROPDOWN_STATIS['TugasTambahan'], 'Pilih Tugas Tambahan');
    } else {
        console.error("Gagal memuat DROPDOWN_STATIS.");
    }

    // 5. Panggil data DINAMIS dari server (Unit Kerja, Pangkat)
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options; // Simpan data server
            
            // 6. Logika Utama: Event Listener for "Status Sekolah" (Tab 1)
            statusSekolahSelect.addEventListener('change', function() {
                const isNegeri = this.value === 'Negeri';
                
                formNegeri.style.display = isNegeri ? 'block' : 'none';
                formSwasta.style.display = isNegeri ? 'none' : 'block';
                
                formNegeri.querySelectorAll('select, input').forEach(el => el.disabled = !isNegeri);
                formSwasta.querySelectorAll('select, input').forEach(el => el.disabled = isNegeri);

                if (isNegeri) {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja (Negeri)');
                } else {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja (Swasta)');
                }
                unitKerjaSelect.disabled = false;
                
                pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                pangkatNegeriSelect.disabled = true;
            });

            // 7. Logika Dropdown Bertingkat: "Status Negeri" -> "Pangkat" (Tab 3)
            statusNegeriSelect.addEventListener('change', function() {
                const status = this.value;
                const nipInput = form.querySelector('#nip');
                
                const isPNS = (status === 'PNS');
                const isPPPK = (status === 'PPPK');
                const isPPPKPW = (status === 'PPPK PW'); 
                const isASN = isPNS || isPPPK || isPPPKPW;
                const isNonASN = (status === 'Tenaga Non ASN');

                nipInput.disabled = !isASN;
                nipInput.required = isASN;
                if (!isASN) {
                    nipInput.value = ""; 
                }
                
                pangkatNegeriSelect.disabled = !isASN;

                if (isPNS) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
                } else if (isPPPK) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
                } else if (isPPPKPW) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan'); 
                } else if (isNonASN) {
                    pangkatNegeriSelect.innerHTML = '<option value="â€” Tidak Perlu Diisi â€”" selected>â€” Tidak Perlu Diisi â€”</option>';
                } else {
                     pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                }
            });
            
            // --- AKTIFKAN FORM DAN TUTUP SKELETON (PERBAIKAN) ---
            if (skeleton) skeleton.style.display = 'none'; // Sembunyikan skeleton
            form.style.display = 'flex'; // Tampilkan form utama sebagai flex
            // --- AKHIR PERBAIKAN ---
        })
        .withFailureHandler(err => {
            // Sembunyikan skeleton dan tampilkan modal error
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkSdOptions(); 


    // 8. Atur Validasi Kustom untuk setiap Tab
    
    // Validasi Tab 1 (Data Sekolah)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));

    // Validasi Tab 2 (Data Pribadi)
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsNoJurusan = ['SD', 'MI', 'SMP', 'MTs', 'Paket A', 'Paket B'].includes(pendidikan);

        if (needsNoJurusan && jurusan !== '-') {
            App.showAppModal('error', 'Jurusan harus diisi tanda - (strip) untuk jenjang SD/SMP sederajat.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        
        const nuptkInput = form.querySelector('#nuptk');
        const nuptkValue = nuptkInput.value.trim();
        const nuptkRegex = /^\d{16}$/; 

        if (nuptkValue !== "" && !nuptkRegex.test(nuptkValue)) {
            App.showAppModal('error', 'NUPTK tidak valid. Harap isikan 16 digit angka atau kosongkan field tersebut.');
            nuptkInput.classList.add('input-error'); 
            return false; 
        }
        
        nuptkInput.classList.remove('input-error');
        return true; 
    });
    
    // Validasi Tab 3 (Data Kepegawaian)
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 9. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!formLogic.validateTab(0)) {
            App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.');
            formLogic.showTab(0); 
            return;
        }
        if (!formLogic.validateTab(1)) {
            formLogic.showTab(1); 
            return;
        }
        if (!formLogic.validateTab(2)) {
            App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.');
            formLogic.showTab(2); 
            return;
        }

        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.error) {
                    App.showAppModal('error', `Gagal: ${response.error}`);
                    submitButton.disabled = false;
                } else {
                    App.showAppModal('success', response, 'ptk_kelola_sd');
                }
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkSd(formData); 
    });
}

function initPtkEditSdPage(params) {
    const form = document.getElementById('editPtkSdForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    if (!form || !params || !params.rowIndex || !params.source) {
        if(skeleton) skeleton.style.display = 'none';
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit (rowIndex/source) tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;
    if (skeleton) skeleton.style.display = 'block';

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('editPtkSdForm');
    
    // 2. Variabel untuk elemen form
    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    
    // Variabel untuk dropdown di Tab 2 & 3
    const agamaSelect = form.querySelector('#agama');
    const pendidikanSelect = form.querySelector('#pendidikan');
    const statusNegeriSelect = form.querySelector('#statusNegeri');
    const pangkatNegeriSelect = form.querySelector('#pangkatNegeri');
    const statusSwastaSelect = form.querySelector('#statusSwasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {}; // Untuk menyimpan data DARI SERVER

    // 3. Fungsi helper untuk mengisi dropdown
    function populateSelect(selectEl, optionsArr, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    // 4. Isi dropdown STATIS
    if (typeof DROPDOWN_STATIS !== 'undefined') {
        populateSelect(agamaSelect, DROPDOWN_STATIS['Agama'], 'Pilih Agama');
        populateSelect(pendidikanSelect, DROPDOWN_STATIS['Pendidikan'], 'Pilih Pendidikan');
        populateSelect(statusNegeriSelect, DROPDOWN_STATIS['StatusKepegawaian'], 'Pilih Status');
        populateSelect(statusSwastaSelect, DROPDOWN_STATIS['StatusKepegawaianSwasta'], 'Pilih Status');
        populateSelect(jabatanSelect, DROPDOWN_STATIS['TugasJabatan'], 'Pilih Tugas/Jabatan');
        populateSelect(tugasTambahanSelect, DROPDOWN_STATIS['TugasTambahan'], 'Pilih Tugas Tambahan');
    } else {
        console.error("Gagal memuat DROPDOWN_STATIS.");
    }

    // 5. Panggil data DINAMIS dari server
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options; 
            
            // --- INI ADALAH LOGIKA BARU UNTUK MEMBUKA KUNCI ---
            // Kita tambahkan listener cascading (sama seperti form Tambah)
            statusSekolahSelect.addEventListener('change', function() {
                const isNegeri = this.value === 'Negeri';
                
                formNegeri.style.display = isNegeri ? 'block' : 'none';
                formSwasta.style.display = isNegeri ? 'none' : 'block';
                
                formNegeri.querySelectorAll('select, input').forEach(el => el.disabled = !isNegeri);
                formSwasta.querySelectorAll('select, input').forEach(el => el.disabled = isNegeri);

                if (isNegeri) {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja (Negeri)');
                } else {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja (Swasta)');
                }
                unitKerjaSelect.disabled = false;
                
                pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                pangkatNegeriSelect.disabled = true;
                
                // BARU: Perbarui juga hidden input "source"
                form.querySelector('[name="source"]').value = isNegeri ? 'SDN' : 'SDS';
            });
            // --- AKHIR LOGIKA BARU ---
            
            // Logika Dropdown Bertingkat: "Status Negeri" -> "Pangkat" (Tab 3)
            statusNegeriSelect.addEventListener('change', function() {
                const status = this.value;
                const nipInput = form.querySelector('#nip');
                
                const isPNS = (status === 'PNS');
                const isPPPK = (status === 'PPPK');
                const isPPPKPW = (status === 'PPPK PW'); 
                const isASN = isPNS || isPPPK || isPPPKPW;
                const isNonASN = (status === 'Tenaga Non ASN');

                nipInput.disabled = !isASN;
                nipInput.required = isASN;
                if (!isASN) nipInput.value = ""; 
                
                pangkatNegeriSelect.disabled = !isASN;

                if (isPNS) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
                } else if (isPPPK) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
                } else if (isPPPKPW) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan'); 
                } else if (isNonASN) {
                    pangkatNegeriSelect.innerHTML = '<option value="â€” Tidak Perlu Diisi â€”" selected>â€” Tidak Perlu Diisi â€”</option>';
                } else {
                     pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                }
            });

            // 6. Panggil data baris yang mau diedit
            google.script.run
                .withSuccessHandler(rowData => {
                    if (rowData.error) {
                        App.showAppModal('error', `Gagal memuat data baris: ${rowData.error}`);
                        return;
                    }

                    // Isi Semua Field Form
                    for (const key in rowData) {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (key === 'TMT' && rowData[key]) {
                                field.value = rowData[key]; // yyyy-MM-dd
                            } else {
                                // Ganti petik satu (misal: '00123) menjadi 00123
                                field.value = String(rowData[key]).replace(/'/g, ''); 
                            }
                        }
                    }

                    // 7. Taktik Kunci: Isi Dropdown Bertingkat
                    const isNegeri = (params.source === 'SDN');
                    
                    // Triger Tab 1 (Status Sekolah -> Unit Kerja)
                    statusSekolahSelect.value = isNegeri ? 'Negeri' : 'Swasta';
                    statusSekolahSelect.dispatchEvent(new Event('change')); // Picu event 'change'
                    unitKerjaSelect.value = rowData['Unit Kerja']; // Set nilai anak
                    
                    // Triger Tab 3 (Status Kepegawaian -> Pangkat)
                    if (isNegeri) {
                        statusNegeriSelect.value = rowData['Status'];
                        statusNegeriSelect.dispatchEvent(new Event('change'));
                        pangkatNegeriSelect.value = rowData['Pangkat, Gol./Ruang'];
                    } else {
                        statusSwastaSelect.value = rowData['Status'];
                    }

                    // 8. Buka semua tab
                    formLogic.unlockTab(1);
                    formLogic.unlockTab(2);

                    // Sembunyikan Skeleton, Tampilkan Form
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';

                })
                .withFailureHandler(err => { 
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`);
                })
                .getPtkSdDataByRow(params.rowIndex, params.source); 

        })
        .withFailureHandler(err => {
             if (skeleton) skeleton.style.display = 'none';
             form.style.display = 'flex';
             App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkSdOptions(); 

    // 8. Atur Validasi Kustom (Sama seperti Tambah)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsNoJurusan = ['SD', 'MI', 'SMP', 'MTs', 'Paket A', 'Paket B'].includes(pendidikan);
        if (needsNoJurusan && jurusan !== '-') {
            App.showAppModal('error', 'Jurusan harus diisi tanda - (strip) untuk jenjang SD/SMP sederajat.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        const nuptkInput = form.querySelector('#nuptk');
        const nuptkValue = nuptkInput.value.trim();
        const nuptkRegex = /^\d{16}$/; 
        if (nuptkValue !== "" && !nuptkRegex.test(nuptkValue)) {
            App.showAppModal('error', 'NUPTK tidak valid. Harap isikan 16 digit angka atau kosongkan field tersebut.');
            nuptkInput.classList.add('input-error'); 
            return false; 
        }
        nuptkInput.classList.remove('input-error');
        return true; 
    });
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 9. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#editSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        // Ambil data dari field yang AKTIF
        const formData = Object.fromEntries(new FormData(form));
        
        // Ambil data dari field yang DI-NONAKTIFKAN (disabled)
        formData.rowIndex = params.rowIndex;
        formData.source = form.querySelector('[name="source"]').value; // Ambil source yang mungkin baru
        formData['Unit Kerja'] = unitKerjaSelect.value;
        formData['statusSekolah'] = statusSekolahSelect.value;
        
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.error) {
                    App.showAppModal('error', `Gagal: ${response.error}`);
                    submitButton.disabled = false;
                } else {
                    // ===================================
                    // ===== INI ADALAH PERBAIKANNYA =====
                    // ===================================
                    App.showAppModal('success', response, 'ptk_kelola_sd'); // <- 'App.showAppModal'
                }
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkSdData(formData); 
    });
}

function initPtkKebutuhanSdPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('kebutuhanGuruTable'); // Target ID baru
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterKebutuhanStatus'); // Target ID filter baru

    // 2. Variabel Penyimpanan Data
    let allData = { negeri: [], swasta: [] };
    let headerData = { negeri: [], swasta: [] };
    let dataRows = { negeri: [], swasta: [] };

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") {
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    // PERUBAHAN: Menerima headers1 dan headers2
    function buildTableBodyAndFooter(headers1, headers2, data) {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headers1.length + 1}">Tidak ada data.</td></tr>`;
            return;
        }

        const sumStartIndex = 1; // Mulai menjumlahkan dari kolom ke-2 (setelah Nama Sekolah)
        const totals = new Array(headers1.length).fill(0);

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                // Perbaikan: Pastikan angka 0 dibaca sebagai string '-'
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                
                // --- KODE BARU: PEWARNAAN DAN FORMAT KONDISIONAL ---
                let classes = [];
                let fontClass = '';
                const subHeaderName = headers2[cellIndex]; // KUNCI PERBAIKAN: Menggunakan sub-header
                
                // 1. Pewarnaan Latar Belakang Grup (Kolom 5-39 / Index 3-37)
                // Col 5-11 (Index 3-9) <-- Digeser dari 4 ke 3
                if (cellIndex >= 3 && cellIndex <= 9) classes.push('cell-bg-blue');      
                // Col 12-18 (Index 10-16) <-- Digeser dari 11 ke 10
                if (cellIndex >= 10 && cellIndex <= 16) classes.push('cell-bg-green');    
                // Col 19-25 (Index 17-23) <-- Digeser dari 18 ke 17
                if (cellIndex >= 17 && cellIndex <= 23) classes.push('cell-bg-purple');   
                // Col 26-32 (Index 24-30) <-- Digeser dari 25 ke 24
                if (cellIndex >= 24 && cellIndex <= 30) classes.push('cell-bg-yellow');   
                // Col 33-39 (Index 31-37) <-- Digeser dari 32 ke 31
                if (cellIndex >= 31 && cellIndex <= 37) classes.push('cell-bg-red');      

                // 2. Format Kondisional Font (HANYA UNTUK KOLOM "KURANG")
                if (subHeaderName === 'Kurang') {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    
                    if (numericValue < 0) fontClass = 'font-red';      
                    else if (numericValue > 0) fontClass = 'font-green';
                    else if (numericValue === 0) fontClass = 'font-blue';
                }
                
                if (fontClass) classes.push(fontClass);
                const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                // --- AKHIR KODE BARU ---

                cellsHTML += `<td${classString}>${displayValue}</td>`;
                
                // ... (Logika kalkulasi total footer) ...
                if (cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>'; // Kolom Nama Sekolah (Rata Kiri)
        
        for (let i = sumStartIndex; i < totals.length; i++) {
            // Perbaikan: Angka 0 di total juga ditampilkan sebagai '-'
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Fungsi Render Utama
    function renderTable(status) { // status = "negeri" atau "swasta"
        if (!allData[status] || allData[status].length === 0) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = `<tr><td colspan="1">Data untuk ${status} tidak tersedia.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        const headers1 = headerData[status][0];
        const headers2 = headerData[status][1];
        const rows = dataRows[status];
        
        buildTableHeader(headers1, headers2);
        // PERUBAHAN: Memanggil buildTableBodyAndFooter dengan headers1 dan headers2
        buildTableBodyAndFooter(headers1, headers2, rows); 
    }

    // 6. Panggil data dari Server
    google.script.run
        .withSuccessHandler(result => {
            if (result.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${result.error}</p>`;
                return;
            }

            // Pisahkan Header dan Data untuk kedua sumber
            allData.negeri = result.negeri;
            allData.swasta = result.swasta;
            
            // Data Header (Baris 1 dan 2)
            headerData.negeri = [result.negeri[0], result.negeri[1]];
            headerData.swasta = [result.swasta[0], result.swasta[1]];
            
            // Data baris (Baris 3 sampai akhir, dikurangi 1 baris footer statis)
            dataRows.negeri = result.negeri.slice(2, result.negeri.length - 1);
            dataRows.swasta = result.swasta.slice(2, result.swasta.length - 1);

            // 7. Tampilkan tabel default (Negeri)
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex';
            renderTable('negeri'); // Tampilkan data 'negeri' saat pertama kali dimuat

            // 8. Tambahkan Event Listener ke Filter
            filterSelect.addEventListener('change', () => {
                renderTable(filterSelect.value); // Panggil renderTable dengan nilai baru ('negeri' or 'swasta')
            });

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKebutuhanGuruData(); // Panggil fungsi backend baru
}

function initMuridPaudKelasUsiaPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudKelasUsiaTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders = [];
    let jenjangIndex = -1;

    // 3. Fungsi untuk membangun Header (Sederhana)
    function buildTableHeader(headers) {
        tableHead.innerHTML = `<tr><th>No.</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || jenjangIndex === -1) return true; // Tampilkan semua jika filter "Semua"
            return String(row[jenjangIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (sesuai 'init' Anda sebelumnya)
        const labelColumn = 'Nama Lembaga';
        const sumStartColumn = 'Rombel';
        
        const labelColIndex = allHeaders.indexOf(labelColumn);
        const sumStartIndex = allHeaders.indexOf(sumStartColumn);
        
        const totals = new Array(allHeaders.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders = data[0];
            allDataRows = data.slice(1);
            jenjangIndex = allHeaders.indexOf('Jenjang');

            // 6. Buat filter dropdown
            if (jenjangIndex !== -1) {
                const uniqueJenjang = [...new Set(allDataRows.map(row => row[jenjangIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Jenjang</option>';
                uniqueJenjang.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none'; // Sembunyikan filter jika kolom Jenjang tidak ada
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudKelasUsiaData(); // Panggil fungsi backend
}

function initMuridPaudJenisKelaminPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudJkTable'); // ID Tabel yang Benar
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = [];
    let allHeaders2 = [];
    let jenjangIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { // rowspan 2
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { // colspan
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { // sub-header only
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || jenjangIndex === -1) return true;
            return String(row[jenjangIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer
        const labelColIndex = allHeaders1.indexOf('Nama Lembaga'); // Kolom 2 (index 1)
        const sumStartIndex = allHeaders1.indexOf('Rombel');     // Kolom 3 (index 2)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders1.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { // Membutuhkan 2 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0]; // Header 1
            allHeaders2 = data[1]; // Header 2
            allDataRows = data.slice(2); // Data rows
            jenjangIndex = allHeaders1.indexOf('Jenjang'); // Cari 'Jenjang' di header 1

            // 6. Buat filter dropdown
            if (jenjangIndex !== -1) {
                const uniqueJenjang = [...new Set(allDataRows.map(row => row[jenjangIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Jenjang</option>';
                uniqueJenjang.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJenisKelaminData(); // Panggil fungsi backend
}

function initMuridPaudJumlahBulananPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudBulananTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua 3 filter
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterJenjang = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = [];
    let allHeaders2 = [];
    
    // Indeks untuk 3 filter
    let tahunIndex = -1;
    let bulanIndex = -1;
    let jenjangIndex = -1;

    // --- KODE BARU DIMULAI DI SINI (LANGKAH #2) ---
    // Hitung nilai default untuk filter
    const now = new Date();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    // Logika "Bulan Lalu"
    let lastMonthIndex = now.getMonth() - 1; // getMonth() itu 0-11
    let defaultTahun = now.getFullYear().toString();

    // Penanganan jika sekarang bulan Januari (0)
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Bulan lalu adalah Desember (11)
        defaultTahun = (now.getFullYear() - 1).toString(); // Dari tahun lalu
    }
    const defaultBulan = monthNames[lastMonthIndex];
    // --- AKHIR KODE BARU ---


    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { // rowspan 2
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { // colspan
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { // sub-header only
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        
        // Ambil nilai dari 3 filter
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valJenjang = filterJenjang.value;
        
        const filteredRows = allDataRows.filter(row => {
            // Logika filter untuk 3 kolom
            const matchTahun = !valTahun || (tahunIndex !== -1 && String(row[tahunIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanIndex !== -1 && String(row[bulanIndex]).trim() === valBulan);
            const matchJenjang = !valJenjang || (jenjangIndex !== -1 && String(row[jenjangIndex]).trim() === valJenjang);
            return matchTahun && matchBulan && matchJenjang;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (Sama seperti halaman PAUD lainnya)
        const labelColIndex = allHeaders1.indexOf('Nama Lembaga'); // Kolom 2 (index 1)
        const sumStartIndex = allHeaders1.indexOf('Rombel');     // Kolom 3 (index 2)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders1.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { // Membutuhkan 2 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0]; // Header 1
            allHeaders2 = data[1]; // Header 2
            allDataRows = data.slice(2); // Data rows
            
            // Cari indeks untuk 3 filter di header baris PERTAMA
            tahunIndex = allHeaders1.indexOf('Tahun');
            bulanIndex = allHeaders1.indexOf('Bulan');
            jenjangIndex = allHeaders1.indexOf('Jenjang');

            // 6. Buat filter dropdown (Logika baru untuk 3 filter)
            const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            // Fungsi helper untuk mengisi satu dropdown
            function populateFilter(selectEl, columnIndex, sortLogic) {
                if (!selectEl || columnIndex === -1) {
                    if(selectEl) selectEl.parentElement.style.display = 'none';
                    return;
                }
                const unique = [...new Set(allDataRows.map(row => row[columnIndex]))].filter(Boolean);
                
                if (sortLogic === 'bulan') {
                    unique.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                } else if (sortLogic === 'reverse') {
                    unique.sort().reverse();
                } else {
                    unique.sort();
                }
                
                selectEl.innerHTML = '<option value="">Semua</option>'; // Ganti default text
                unique.forEach(val => selectEl.add(new Option(val, val)));
                selectEl.addEventListener('change', buildTableBodyAndFooter);
            }
            
            // Panggil helper untuk setiap filter
            populateFilter(filterTahun, tahunIndex, 'reverse');
            populateFilter(filterBulan, bulanIndex, 'bulan');
            populateFilter(filterJenjang, jenjangIndex, 'sort');

            // --- KODE BARU DIMULAI DI SINI (LANGKAH #6) ---
            
            // Helper untuk mengecek apakah opsi ada sebelum mengaturnya
            const optionExists = (selectEl, value) => {
                return Array.from(selectEl.options).some(opt => opt.value === value);
            };

            // Terapkan default TAHUN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterTahun, defaultTahun)) {
                filterTahun.value = defaultTahun;
            }

            // Terapkan default BULAN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterBulan, defaultBulan)) {
                filterBulan.value = defaultBulan;
            }
            // --- AKHIR KODE BARU ---

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali (SEKARANG AKAN MENGGUNAKAN DEFAULT)

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJumlahBulananData(); // Panggil fungsi backend
}

function initMuridSdKelasPage() {
    // 1. Referensi Elemen (DIUBAH)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdKelasTable'); // <-- DIUBAH
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); // <-- DIUBAH

    // 2. Variabel Penyimpanan Data (DIUBAH)
    let allDataRows = [];
    let allHeaders = [];
    let statusIndex = -1; // <-- DIUBAH (dari jenjangIndex)

    // 3. Fungsi untuk membangun Header (Sederhana)
    //    (Fungsi ini SAMA, tidak perlu diubah)
    function buildTableHeader(headers) {
        tableHead.innerHTML = `<tr><th>No.</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    //    (Fungsi ini DIMODIFIKASI untuk filter 'Status')
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            // --- LOGIKA FILTER DIUBAH ---
            if (!filterValue || statusIndex === -1) return true; // Tampilkan semua jika filter "Semua"
            return String(row[statusIndex]).trim() === filterValue;
            // --- AKHIR PERUBAHAN ---
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (DIUBAH)
        const labelColumn = 'Nama Sekolah'; // <-- DIUBAH (dari 'Nama Lembaga')
        const sumStartColumn = 'Rombel';   // <-- DIUBAH (Sesuai konfirmasi Anda)
        
        const labelColIndex = allHeaders.indexOf(labelColumn);
        const sumStartIndex = allHeaders.indexOf(sumStartColumn);
        
        const totals = new Array(allHeaders.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>'; // Kolom sebelum 'Rombel'
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 2) { // 1 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders = data[0].map(h => String(h).trim()); // <-- DIUBAH: Tambahkan .trim()
            allDataRows = data.slice(1);
            statusIndex = allHeaders.indexOf('Status'); // <-- DIUBAH

            // 6. Buat filter dropdown (DIUBAH)
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none'; 
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex';
            buildTableHeader(allHeaders);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdKelasData(); // <-- DIUBAH: Panggil fungsi backend yang benar
}

function initMuridSdRombelPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdRombelTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 4;   // Mulai menjumlahkan dari kolom ke-5 (indeks 4)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 4
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, atau 3 (NPSN, Status, Rombel)
                footerHTML += '<td>-</td>';
            } else { // Jika index 4 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdRombelData(); // Panggil fungsi backend
}

function initMuridSdJenisKelaminPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdJkTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 4;   // Mulai menjumlahkan dari kolom ke-5 (indeks 4)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 4
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, atau 3
                footerHTML += '<td>-</td>';
            } else { // Jika index 4 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJenisKelaminData(); 
}

function initMuridSdAgamaPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdAgamaTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 5;   // Mulai menjumlahkan dari kolom ke-6 (indeks 5)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 5
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, 3, atau 4
                footerHTML += '<td>-</td>';
            } else { // Jika index 5 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdAgamaData(); 
}

function initMuridSdJumlahBulananPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdBulananTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua 3 filter
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterStatus = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    
    // Indeks untuk 3 filter
    let tahunIndex = -1;
    let bulanIndex = -1;
    let statusIndex = -1;

    // --- KODE BARU DIMULAI DI SINI ---
    // Hitung nilai default untuk filter
    const now = new Date();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    // Logika "Bulan Lalu"
    let lastMonthIndex = now.getMonth() - 1; // getMonth() itu 0-11
    let defaultTahun = now.getFullYear().toString(); // Default tahun adalah TAHUN INI

    // Penanganan jika sekarang bulan Januari (0)
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Bulan lalu adalah Desember (11)
        defaultTahun = (now.getFullYear() - 1).toString(); // Default tahun adalah TAHUN LALU
    }
    const defaultBulan = monthNames[lastMonthIndex];
    // --- AKHIR KODE BARU ---

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        
        // Ambil nilai dari 3 filter
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valStatus = filterStatus.value;
        
        const filteredRows = allDataRows.filter(row => {
            // Logika filter untuk 3 kolom
            const matchTahun = !valTahun || (tahunIndex !== -1 && String(row[tahunIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanIndex !== -1 && String(row[bulanIndex]).trim() === valBulan);
            const matchStatus = !valStatus || (statusIndex !== -1 && String(row[statusIndex]).trim() === valStatus);
            return matchTahun && matchBulan && matchStatus;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (Menggunakan indeks tetap)
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 5;   // Mulai menjumlahkan dari kolom ke-6 (indeks 5)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 5
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, 3, atau 4
                footerHTML += '<td>-</td>';
            } else { // Jika index 5 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            // Cari indeks untuk 3 filter di header baris PERTAMA
            tahunIndex = allHeaders1.indexOf('Tahun');
            bulanIndex = allHeaders1.indexOf('Bulan');
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            // Fungsi helper untuk mengisi satu dropdown
            function populateFilter(selectEl, columnIndex, sortLogic) {
                if (!selectEl || columnIndex === -1) {
                    if(selectEl) selectEl.parentElement.style.display = 'none';
                    return;
                }
                const unique = [...new Set(allDataRows.map(row => row[columnIndex]))].filter(Boolean);
                
                if (sortLogic === 'bulan') {
                    unique.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                } else if (sortLogic === 'reverse') {
                    unique.sort().reverse();
                } else {
                    unique.sort();
                }
                
                selectEl.innerHTML = '<option value="">Semua</option>'; 
                unique.forEach(val => selectEl.add(new Option(val, val)));
                selectEl.addEventListener('change', buildTableBodyAndFooter);
            }
            
            // Panggil helper untuk setiap filter
            populateFilter(filterTahun, tahunIndex, 'reverse');
            populateFilter(filterBulan, bulanIndex, 'bulan');
            populateFilter(filterStatus, statusIndex, 'sort');

            // --- KODE BARU DIMULAI DI SINI ---
            
            // Helper untuk mengecek apakah opsi ada sebelum mengaturnya
            const optionExists = (selectEl, value) => {
                return Array.from(selectEl.options).some(opt => opt.value === value);
            };

            // Terapkan default TAHUN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterTahun, defaultTahun)) {
                filterTahun.value = defaultTahun;
            }

            // Terapkan default BULAN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterBulan, defaultBulan)) {
                filterBulan.value = defaultBulan;
            }
            // --- AKHIR KODE BARU ---

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali (SEKARANG AKAN MENGGUNAKAN DEFAULT)

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJumlahBulananData(); 
}

function initSiabaDaftarPresensiPage() {
    // 1. Referensi Elemen
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    
    // loadingStatus sudah dihapus dari HTML
    const tableWrapper = document.getElementById('tableWrapper');
    const tableOverlay = document.getElementById('tableOverlayLoader'); // Overlay Spinner
    const table = document.getElementById('presensiTable');
    const keteranganSiaba = document.getElementById('keterangan-siaba');

    if (!table || !tableWrapper || !tableOverlay) return;

    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    // Warna & Format
    const backgroundMap = { 'HA': 'cell-bg-cream', 'APL': 'cell-bg-cream', 'TAp': 'cell-bg-cream', 'HU': 'cell-bg-cream', 'U': 'cell-bg-cream', 'TU': 'cell-bg-cream', 'CT': 'cell-bg-green', 'CAP': 'cell-bg-green', 'CS': 'cell-bg-green', 'CM': 'cell-bg-green', 'DD': 'cell-bg-blue', 'DL': 'cell-bg-blue', 'TA': 'cell-bg-yellow', 'Waktu TA': 'cell-bg-yellow', 'PLA': 'cell-bg-yellow', 'Waktu PLA': 'cell-bg-yellow', 'LA': 'cell-bg-purple' };
    const fontColorMap = { 'CT': 'font-green', 'CAP': 'font-green', 'CS': 'font-green', 'CM': 'font-green', 'DD': 'font-blue', 'DL': 'font-blue' };
    const redFontColumns = ['TAp', 'TU', 'TA', 'PLA', 'LA'];

    let displayHeaders = [];
    let currentFilteredRows = [];

    function populateSelect(el, opts, def) {
        el.innerHTML = '';
        if (el.id === 'filterUnitKerja') el.add(new Option("Semua Unit Kerja", "Semua"));
        if(opts) opts.forEach(o => el.add(new Option(o, o)));
        if (def && (opts.includes(def) || def === "Semua")) el.value = def;
    }

    // --- KONTROL LOADER ---
    function toggleLoader(show) {
        // Karena loadingStatus sudah dihapus, kita hanya mainkan Overlay
        if (show) {
            tableOverlay.style.display = 'flex'; // Tampilkan Spinner di atas tabel
            // Pastikan keterangan sembunyi agar tidak aneh
            if (keteranganSiaba) keteranganSiaba.style.display = 'none';
        } else {
            tableOverlay.style.display = 'none'; // Sembunyikan Spinner
        }
    }

    function renderTable() {
        tableBody.innerHTML = '';
        
        // Matikan loader
        toggleLoader(false);

        if (!currentFilteredRows || currentFilteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}" style="text-align:center; padding:30px;">Tidak ada data ditemukan.</td></tr>`;
            if (keteranganSiaba) keteranganSiaba.style.display = 'none';
            return;
        }
        
        if (keteranganSiaba) keteranganSiaba.style.display = 'block';
        const tpIndex = displayHeaders.indexOf('TP');
        const dayStart = displayHeaders.indexOf('1D');
        const dayEnd = displayHeaders.indexOf('31P');

        currentFilteredRows.forEach((row, i) => {
            const tr = document.createElement('tr');
            let html = `<td>${i + 1}</td>`;
            row.forEach((cell, idx) => {
                const header = displayHeaders[idx];
                let cls = [];
                const isPos = parseInt(cell, 10) > 0;
                if (backgroundMap[header]) cls.push(backgroundMap[header]);
                if (dayStart !== -1 && idx >= dayStart && idx <= dayEnd) {
                    if (!cell) cls.push('cell-bg-red');
                    else if (cell === '-') cls.push('cell-bg-gray');
                    else if (fontColorMap[cell]) cls.push(fontColorMap[cell]);
                }
                if (idx === tpIndex && isPos) cls.push('cell-negative');
                if (redFontColumns.includes(header) && isPos) cls.push('font-red');
                html += `<td class="${cls.join(' ')}">${(cell === '' || cell == null || cell === '0') ? '-' : cell}</td>`;
            });
            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const filters = { tahun: filterTahun.value, bulan: filterBulan.value, unitKerja: filterUnitKerja.value };
        
        // Nyalakan Spinner (untuk awal maupun ganti filter)
        toggleLoader(true);

        // Timeout kecil untuk memastikan UI ter-render sebelum network freeze
        setTimeout(() => {
            google.script.run.withSuccessHandler(res => {
                if (res.error) {
                    tableBody.innerHTML = `<tr><td style="text-align:center; color:red; padding:20px;">Error: ${res.error}</td></tr>`;
                    toggleLoader(false);
                    return;
                }
                displayHeaders = res.headers || [];
                if (displayHeaders.length) tableHead.innerHTML = '<tr><th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
                currentFilteredRows = res.rows || [];
                renderTable();
            }).withFailureHandler(err => {
                tableBody.innerHTML = `<tr><td style="text-align:center; color:red; padding:20px;">Server Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            }).getSiabaPresensiData(filters);
        }, 50);
    }

    // --- INIT ---
    // Nyalakan spinner segera saat inisialisasi fungsi
    toggleLoader(true);
    
    google.script.run.withSuccessHandler(opts => {
        const now = new Date();
        const mNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        populateSelect(filterTahun, opts['Tahun'], now.getFullYear().toString());
        populateSelect(filterBulan, opts['Bulan'], mNames[now.getMonth()]);
        populateSelect(filterUnitKerja, opts['Unit Kerja'], "Semua");

        [filterTahun, filterBulan, filterUnitKerja].forEach(el => el.addEventListener('change', fetchData));
        fetchData();
    }).withFailureHandler(err => {
        tableBody.innerHTML = `<tr><td style="text-align:center; color:red;">Gagal Init: ${err.message}</td></tr>`;
        toggleLoader(false);
    }).getSiabaFilterOptions();
}

function initSiabaTidakPresensiPage() {
    // 1. Referensi Elemen
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    
    const tableWrapper = document.getElementById('tableWrapper');
    const tableOverlay = document.getElementById('tableOverlayLoaderTidakPresensi'); 
    const table = document.getElementById('tidakPresensiTable'); 
    
    if (!table || !tableWrapper || !tableOverlay) return;
    
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    
    let displayHeaders = [];
    let currentFilteredRows = []; 

    // Helper: Isi Dropdown & Set Default dengan Robust
    function populateSelect(el, opts, def) {
        el.innerHTML = '';
        
        // Tambah opsi default khusus Unit Kerja
        if (el.id === 'filterUnitKerja') {
            el.add(new Option("Semua Unit Kerja", "Semua"));
        }
        
        if (opts && Array.isArray(opts)) {
            opts.forEach(o => {
                // Pastikan nilai string dan bersih dari spasi
                const val = String(o).trim();
                el.add(new Option(val, val));
            });
        }
        
        // Logika Set Default Value
        if (def) {
            const defString = String(def).trim();
            
            // Coba set value langsung
            el.value = defString;
            
            // Cek apakah berhasil terset? Jika tidak (karena case sensitive atau format beda), cari manual
            if (el.value !== defString) {
                for (let i = 0; i < el.options.length; i++) {
                    if (el.options[i].value.toLowerCase() === defString.toLowerCase()) {
                        el.selectedIndex = i;
                        break;
                    }
                }
            }
        }
        
        // Fallback untuk Unit Kerja: Jika "Semua" tidak terpilih, paksa pilih index 0
        if (el.id === 'filterUnitKerja' && !el.value) {
            el.selectedIndex = 0;
        }
    }
    
    // --- KONTROL LOADER (Overlay Only) ---
    function toggleLoader(show) {
        if (show) {
            tableWrapper.style.display = 'flex';
            tableOverlay.style.display = 'flex';
        } else {
            tableOverlay.style.display = 'none';
        }
    }
    
    function renderTable() { 
        tableBody.innerHTML = '';
        toggleLoader(false); // Matikan spinner

        if (!currentFilteredRows || currentFilteredRows.length === 0) { 
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}" style="text-align:center; padding: 20px;">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
            return;
        }

        currentFilteredRows.forEach((rowData, index) => { 
            const tr = document.createElement('tr');
            const rowNumber = index + 1; 
            let rowHTML = `<td>${rowNumber}</td>`;
            rowData.forEach((cell, cellIndex) => {
                const cellContent = (cell === '' || cell === null || cell === undefined || cell === '0') ? '-' : cell;
                rowHTML += `<td>${cellContent}</td>`;
            });
            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        // Ambil nilai LANGSUNG dari DOM saat fungsi dijalankan (Live Value)
        const valTahun = document.getElementById('filterTahun').value;
        const valBulan = document.getElementById('filterBulan').value;
        const valUnit = document.getElementById('filterUnitKerja').value;

        const filters = { tahun: valTahun, bulan: valBulan, unitKerja: valUnit };

        // Nyalakan overlay
        toggleLoader(true);
        
        // Timeout kecil untuk rendering UI
        setTimeout(() => {
            google.script.run.withSuccessHandler(result => {
                if (result.error) {
                     tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Gagal: ${result.error}</td></tr>`;
                     toggleLoader(false);
                     return;
                }
                
                displayHeaders = result.headers;
                if (displayHeaders.length) tableHead.innerHTML = '<tr><th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
                currentFilteredRows = result.rows; 
                renderTable(); 
            })
            .withFailureHandler(err => {
                tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Server Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            })
            .getSiabaTidakPresensiData(filters);
        }, 50);
    }

    // --- INIT AWAL ---
    toggleLoader(true); // Tampilkan spinner segera

    google.script.run.withSuccessHandler(options => {
        const now = new Date();
        const mNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

        // Hitung Default (Tahun Ini & Bulan Ini)
        const currentYear = now.getFullYear().toString();
        const currentMonth = mNames[now.getMonth()];

        // Isi Dropdown dengan Default Value
        populateSelect(filterTahun, options['Tahun'], currentYear);
        populateSelect(filterBulan, options['Bulan'], currentMonth);
        populateSelect(filterUnitKerja, options['Unit Kerja'], "Semua"); 

        // Pasang Event Listener (Langsung, tanpa cloneNode)
        // Karena App.loadPage sudah mereset DOM, kita tidak perlu khawatir duplikasi listener
        filterTahun.addEventListener('change', fetchData);
        filterBulan.addEventListener('change', fetchData);
        filterUnitKerja.addEventListener('change', fetchData);
        
        // Panggil data pertama kali
        fetchData();

    }).withFailureHandler(err => {
         tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Gagal inisialisasi filter: ${err.message}</td></tr>`;
         toggleLoader(false);
    }).getSiabaFilterOptions(); 
}

function initSiabaApelUpacaraPage() {
    // 1. Referensi Elemen (Perhatikan ID khusus '...Apel')
    const filterTahun = document.getElementById('filterTahunApel');
    const filterBulan = document.getElementById('filterBulanApel');
    const filterUnitKerja = document.getElementById('filterUnitKerjaApel');
    
    const tableWrapper = document.getElementById('tableWrapperApel');
    const tableOverlay = document.getElementById('tableOverlayLoaderApel'); 
    const table = document.getElementById('apelUpacaraTable'); 
    const keterangan = document.getElementById('keterangan-apel');

    if (!table || !tableWrapper || !tableOverlay) return;
    
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    let displayHeaders = [];
    let currentFilteredRows = []; 
    const redFontColumns = ['TA', 'TU'];

    // Helper: Populate & Default
    function populateSelect(el, opts, def) {
        el.innerHTML = '';
        if (el.id === 'filterUnitKerjaApel') el.add(new Option("Semua Unit Kerja", "Semua"));
        if(opts) opts.forEach(o => el.add(new Option(o, o)));
        
        if (def) {
             let exists = false;
             for (let i = 0; i < el.options.length; i++) {
                 if (el.options[i].value == def) {
                     el.selectedIndex = i;
                     exists = true;
                     break;
                 }
             }
        }
    }
    
    // --- KONTROL LOADER (Overlay) ---
    function toggleLoader(show) {
        if (show) {
            tableWrapper.style.display = 'flex';
            tableOverlay.style.display = 'flex';
            if(keterangan) keterangan.style.display = 'none';
        } else {
            tableOverlay.style.display = 'none';
        }
    }
    
    function renderTable() { 
        tableBody.innerHTML = '';
        toggleLoader(false);

        if (currentFilteredRows.length === 0) { 
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}" style="text-align:center; padding: 20px;">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
            return;
        }
        
        if(keterangan) keterangan.style.display = 'block';

        // Indeks Kolom Tanggal (Mulai dari kolom ke-9, index 8)
        // Headers: [Nama, NIP, HA, A, TA, HU, U, TU, 1, 2, ... 31]
        const dayStartIndex = 8; 

        currentFilteredRows.forEach((rowData, index) => { 
            const tr = document.createElement('tr');
            const rowNumber = index + 1; 
            let rowHTML = `<td>${rowNumber}</td>`;
            
            rowData.forEach((cell, cellIndex) => {
                const header = displayHeaders[cellIndex];
                let classes = [];
                const cellStr = String(cell).trim();
                const isPositive = parseInt(cell, 10) > 0;

                // 1. Highlight Angka Merah di Kolom Ringkasan (TA, TU)
                if (redFontColumns.includes(header) && isPositive) {
                    classes.push('font-red');
                }

                // 2. Warna Background di Kolom Tanggal
                if (cellIndex >= dayStartIndex) {
                    if (cellStr === 'TA' || cellStr === 'TU') classes.push('cell-bg-red');
                    else if (cellStr === 'A' || cellStr === 'U') classes.push('cell-bg-green');
                    else if (cellStr === 'HA' || cellStr === 'HU') classes.push('cell-bg-cream');
                }

                const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                const cellContent = (cell === '' || cell === null || cell === undefined || cell === '0') ? '-' : cell;
                
                rowHTML += `<td${classString}>${cellContent}</td>`;
            });
            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        // Ambil Live Value
        const valTahun = document.getElementById('filterTahunApel').value;
        const valBulan = document.getElementById('filterBulanApel').value;
        const valUnit = document.getElementById('filterUnitKerjaApel').value;

        const filters = { tahun: valTahun, bulan: valBulan, unitKerja: valUnit };

        toggleLoader(true);
        
        setTimeout(() => {
            google.script.run.withSuccessHandler(result => {
                if (result.error) {
                     tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Gagal: ${result.error}</td></tr>`;
                     toggleLoader(false);
                     return;
                }
                
                displayHeaders = result.headers;
                if (displayHeaders.length) tableHead.innerHTML = '<tr><th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
                currentFilteredRows = result.rows; 
                renderTable(); 
            })
            .withFailureHandler(err => {
                tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Server Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            })
            .getSiabaApelUpacaraData(filters);
        }, 50);
    }

    // --- INIT AWAL ---
    toggleLoader(true);

    google.script.run.withSuccessHandler(options => {
        const now = new Date();
        const mNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];

        populateSelect(filterTahun, options['Tahun'], now.getFullYear().toString());
        populateSelect(filterBulan, options['Bulan'], mNames[now.getMonth()]);
        populateSelect(filterUnitKerja, options['Unit Kerja'], "Semua"); 

        // Pasang Listener
        const filters = [filterTahun, filterBulan, filterUnitKerja];
        filters.forEach(el => {
             el.addEventListener('change', fetchData);
        });
        
        fetchData();

    }).withFailureHandler(err => {
         tableBody.innerHTML = `<tr><td style="text-align:center; padding:20px; color:red;">Gagal inisialisasi: ${err.message}</td></tr>`;
         toggleLoader(false);
    }).getSiabaFilterOptions(); 
}

function initSiabaLupaUnggahPage() {
    const form = document.getElementById('lupaPresensiForm');
    const skeleton = document.getElementById('skeleton-loader');
    const unitSelect = document.getElementById('unitKerja');
    const namaSelect = document.getElementById('namaAsn');
    const nipInput = document.getElementById('nip');

    if (!form) return;

    // Tampilkan Skeleton
    skeleton.style.display = 'block';
    form.style.display = 'none';

    // Variabel lokal untuk menyimpan data mentah pegawai
    let employeeData = [];

    // 1. Ambil Data Pegawai dari Server
    google.script.run
        .withSuccessHandler(data => {
            employeeData = data;

            // Ambil Unit Kerja Unik & Sortir
            const units = [...new Set(data.map(item => item.unit))].sort();
            
            unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
            units.forEach(u => unitSelect.add(new Option(u, u)));

            // Sembunyikan Skeleton, Tampilkan Form
            skeleton.style.display = 'none';
            form.style.display = 'block';
        })
        .withFailureHandler(err => {
            skeleton.style.display = 'none';
            document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Gagal Memuat Data</h3><p>${err.message}</p></div>`;
        })
        .getSiabaLupaOptions();

    // 2. Logika Dropdown Bertingkat: Unit Kerja -> Nama ASN
    unitSelect.addEventListener('change', function() {
        const selectedUnit = this.value;
        
        // Filter nama berdasarkan unit
        const filteredEmployees = employeeData.filter(item => item.unit === selectedUnit);
        
        // Sortir nama
        filteredEmployees.sort((a, b) => a.nama.localeCompare(b.nama));

        // Isi Dropdown Nama
        namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
        filteredEmployees.forEach(emp => {
            // Simpan NIP di atribut data agar mudah diambil
            const opt = new Option(emp.nama, emp.nama);
            opt.dataset.nip = emp.nip; 
            namaSelect.add(opt);
        });
        
        namaSelect.disabled = false;
        nipInput.value = ""; // Reset NIP
    });

    // 3. Logika Autofill: Nama ASN -> NIP
    namaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const nip = selectedOption.dataset.nip;
        if (nip) {
            nipInput.value = nip;
        }
    });

    // 4. Handle Submit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const fileInput = document.getElementById('fileSurat');
        const file = fileInput.files[0];
        const MAX_SIZE = 200 * 1024; // 200 KB

        // Validasi File
        if (file.size > MAX_SIZE) {
            App.showAppModal('error', 'Ukuran file melebihi batas 200 KB. Mohon kompres file PDF Anda.');
            return;
        }

        submitBtn.disabled = true;
        App.showAppModal('loading', 'Mengirim data surat pernyataan...');

        // Siapkan Payload
        const formData = Object.fromEntries(new FormData(form));
        
        // Baca File & Kirim
        const reader = new FileReader();
        reader.onload = function(event) {
            formData.fileData = {
                fileName: file.name,
                mimeType: file.type,
                data: event.target.result.split(',')[1]
            };

            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                        App.showAppModal('error', res.error);
                        submitBtn.disabled = false;
                    } else {
                        App.showAppModal('success', res, 'siaba_lupa_cek'); // Redirect ke menu utama lupa presensi
                    }
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', `Gagal mengirim: ${err.message}`);
                    submitBtn.disabled = false;
                })
                .processSiabaLupaForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSiabaLupaCekPage() {
    const filterTahun = document.getElementById('filterTahunCek');
    const filterBulan = document.getElementById('filterBulanCek');
    const filterUnitKerja = document.getElementById('filterUnitKerjaCek');
    
    const tableWrapper = document.getElementById('tableWrapperCek');
    const tableOverlay = document.getElementById('tableOverlayLoaderCek');
    const table = document.getElementById('lupaCekTable');

    if (!table || !tableWrapper || !tableOverlay) return;

    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    function populateSelect(el, opts, def) {
        if (!el) return;
        el.innerHTML = '';
        if (el.id === 'filterUnitKerjaCek') el.add(new Option("Semua Unit Kerja", "Semua"));
        
        if (opts && Array.isArray(opts)) {
            opts.forEach(o => el.add(new Option(o, o)));
        }
        
        if (def) {
             el.value = def;
             if (el.value !== def) {
                 for (let i = 0; i < el.options.length; i++) {
                     if (el.options[i].value == def) { el.selectedIndex = i; break; }
                 }
             }
        }
    }

    function toggleLoader(show) {
        if (show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(headers, rows) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        
        if (headers && headers.length > 0) {
             tableHead.innerHTML = '<tr><th>No.</th>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        }

        if (!rows || rows.length === 0) {
             const colSpan = (headers && headers.length > 0) ? headers.length + 1 : 1;
             tableBody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding: 30px;">Tidak ada data untuk filter ini.</td></tr>`;
             return;
        }

        rows.forEach((rowObj, index) => {
            const tr = document.createElement('tr');
            let html = `<td>${index + 1}</td>`;
            
            if (headers) {
                headers.forEach(key => {
                    let val = rowObj[key];
                    
                    // --- LOGIKA STATUS "CEK" (BARU) ---
                    if (key === 'Cek') {
                        const statusStr = String(val).trim();
                        
                        // 1. Disetujui (âœ… atau Diterima)
                        if (statusStr.includes('âœ…') || statusStr.toLowerCase() === 'diterima') {
                            val = '<span class="status-ok"><i class="fas fa-check-circle"></i> Disetujui</span>';
                        } 
                        // 2. Ditolak (âŒ atau Ditolak)
                        else if (statusStr.includes('âŒ') || statusStr.toLowerCase() === 'ditolak') {
                            val = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
                        } 
                        // 3. Kosong / Lainnya -> Diproses
                        else {
                            val = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
                        }
                    }
                    // -----------------------------------

                    // Logika Tombol Lihat Dokumen
                    if (key === 'Dokumen') {
                        if (val && String(val).startsWith('http')) {
                            val = `<button class="view-doc-btn" onclick="App.showFilePreview('${val}')" style="cursor:pointer;"><i class="fas fa-eye"></i> Lihat</button>`;
                        } else {
                            val = '<span style="color:#aaa;">-</span>';
                        }
                    }

                    html += `<td>${val || '-'}</td>`;
                });
            }
            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        if(!filterTahun || !filterBulan || !filterUnitKerja) return;

        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnitKerja.value
        };

        toggleLoader(true);

        google.script.run
            .withSuccessHandler(res => {
                try {
                    if (res.error) {
                        tableBody.innerHTML = `<tr><td colspan="12" style="color:red; text-align:center; padding:20px;">Error: ${res.error}</td></tr>`;
                    } else {
                        renderTable(res.headers, res.rows);
                    }
                } catch (e) {
                    console.error("Render Error:", e);
                } finally {
                    toggleLoader(false);
                }
            })
            .withFailureHandler(err => {
                tableBody.innerHTML = `<tr><td colspan="12" style="color:red; text-align:center; padding:20px;">Server Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            })
            .getSiabaLupaCekData(filters);
    }

    // Init
    toggleLoader(true);

    google.script.run
        .withSuccessHandler(opts => {
            try {
                if (opts.error) throw new Error(opts.error);

                const now = new Date();
                const mNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
                
                const curYear = now.getFullYear().toString();
                const curMonth = mNames[now.getMonth()];

                populateSelect(filterTahun, opts['Tahun'], curYear);
                populateSelect(filterBulan, opts['Bulan'], curMonth);
                populateSelect(filterUnitKerja, opts['Unit Kerja'], "Semua");

                [filterTahun, filterBulan, filterUnitKerja].forEach(el => {
                    if(el) {
                        el.removeEventListener('change', fetchData);
                        el.addEventListener('change', fetchData);
                    }
                });

                fetchData();
            } catch (e) {
                if(App.showAppModal) App.showAppModal('error', 'Gagal init filter: ' + e.message);
                toggleLoader(false);
            }
        })
        .withFailureHandler(err => {
             if(App.showAppModal) App.showAppModal('error', 'Gagal memuat filter: ' + err.message);
             toggleLoader(false);
        })
        .getSiabaFilterOptions();
}

function initSiabaLupaRekapPage() {
    const filterTahun = document.getElementById('filterTahunRekap');
    const filterUnit = document.getElementById('filterUnitKerjaRekap');
    const tableWrapper = document.getElementById('tableWrapperRekap');
    const tableOverlay = document.getElementById('tableOverlayLoaderRekap');
    const table = document.getElementById('lupaRekapTable');

    if (!table) return;
    const tbody = table.querySelector('tbody');
    const tfoot = table.querySelector('tfoot');

    function toggleLoader(show) {
        if (show) {
            tableWrapper.style.display = 'flex';
            tableOverlay.style.display = 'flex';
        } else {
            tableOverlay.style.display = 'none';
        }
    }

    // Render Tabel & Hitung Total di Klien
    function renderTable(rows) {
        tbody.innerHTML = '';
        tfoot.innerHTML = '';

        if (!rows || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="16" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>';
            return;
        }

        // Array untuk menyimpan total per kolom (Jan-Des + Jumlah) -> 13 kolom
        const colTotals = new Array(13).fill(0); 

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`; // No.
            
            // Nama & NIP
            html += `<td>${row[0]}</td><td>${row[1]}</td>`;

            // Bulan Jan-Des (Index 2-13) + Jumlah (Index 14)
            for (let i = 2; i <= 14; i++) {
                const val = parseInt(row[i]) || 0;
                const displayVal = val === 0 ? '-' : val;
                
                // Update Total (untuk footer)
                colTotals[i - 2] += val; 

                let style = "";
                
                // Kolom Jumlah (Index 14) biarkan CSS yang menangani (Font Oranye)
                if (i === 14) {
                    style = ""; 
                } else {
                    // --- LOGIKA PEWARNAAN BULAN (Jan-Des) ---
                    if (val === 5) {
                        // Merah jika nilainya 5 (Peringatan)
                        style = 'style="font-weight:bold; color:#e74c3c;"'; 
                    } else if (val > 0) {
                        // Putih Terang jika ada isinya (selain 5)
                        style = 'style="font-weight:bold; color:#e0e0e0;"'; 
                    } else {
                        // Abu-abu jika kosong/0
                        style = 'style="color:#888;"';
                    }
                }
                
                html += `<td ${style}>${displayVal}</td>`;
            }
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        // Render Footer
        let footerHtml = '<tr>';
        footerHtml += '<td>-</td><td style="text-align:left;">JUMLAH</td><td>-</td>'; // No, Nama, NIP
        
        colTotals.forEach(total => {
            const displayTotal = total === 0 ? '-' : total;
            footerHtml += `<td>${displayTotal}</td>`;
        });
        footerHtml += '</tr>';
        tfoot.innerHTML = footerHtml;
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            unitKerja: filterUnit.value
        };
        toggleLoader(true);
        google.script.run
            .withSuccessHandler(data => {
                renderTable(data);
                toggleLoader(false);
            })
            .withFailureHandler(err => {
                tbody.innerHTML = `<tr><td colspan="16" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            })
            .getSiabaLupaRekapData(filters);
    }

    // Init Awal
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(opts => {
            if (opts.error) {
                App.showAppModal('error', opts.error);
                toggleLoader(false);
                return;
            }

            // Setup Filter Tahun
            filterTahun.innerHTML = '';
            opts.tahun.forEach(t => filterTahun.add(new Option(t, t)));
            const currentYear = new Date().getFullYear().toString();
            if (opts.tahun.includes(currentYear)) {
                filterTahun.value = currentYear;
            }

            // Setup Filter Unit Kerja
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            opts.unit.forEach(u => filterUnit.add(new Option(u, u)));

            // Listener
            filterTahun.addEventListener('change', fetchData);
            filterUnit.addEventListener('change', fetchData);

            // Load Data
            fetchData();
        })
        .withFailureHandler(err => {
            App.showAppModal('error', 'Gagal init: ' + err.message);
            toggleLoader(false);
        })
        .getSiabaLupaRekapOptions();
}

function initSiabaLupaUnduhPage() {
    // 1. Jalankan animasi masuk untuk tombol menu
    initMenuPage(); 

    // 2. Ambil elemen tombol dan konten info
    const btn = document.getElementById('infoBtnSiaba');
    const content = document.getElementById('infoContentSiaba');

    // 3. Pastikan elemen ada sebelum memanipulasinya
    if (btn && content) {
        // Isi teks informasi
        const infoText = [
            "Klik tombol di atas untuk mengunduh format Surat Pernyataan Lupa Presensi dalam format Microsoft Word (.docx).",
            "Isi formulir tersebut, tanda tangani, lalu scan menjadi file PDF (maks. 200 KB) untuk diunggah."
        ];
        
        // Render HTML list
        content.innerHTML = `<ul style="text-align: left; padding: 15px 20px 15px 35px; line-height: 1.6; margin: 0; color: #e0e0e0;">
            ${infoText.map(t => `<li>${t}</li>`).join('')}
        </ul>`;

        // 4. Pasang Event Listener Klik (Manual & Langsung)
        // Kita gunakan arrow function agar 'this' tidak membingungkan, dan akses elemen langsung lewat variabel
        btn.onclick = (e) => {
            e.preventDefault(); // Mencegah perilaku default tombol
            e.stopPropagation(); // Mencegah event bubbling yang tidak perlu
            
            const isActive = btn.classList.toggle('active');
            
            // Atur max-height untuk animasi slide
            if (isActive) {
                content.style.maxHeight = content.scrollHeight + "px";
            } else {
                content.style.maxHeight = "0px";
            }
        };
    } else {
        console.error("[DEBUG] Gagal menemukan elemen infoBtnSiaba atau infoContentSiaba.");
    }
}

function initSiabaSalahPresensiPage() {
    initMenuPage(); // Aktifkan animasi menu

    const btn = document.getElementById('infoBtnSalahPresensi');
    const content = document.getElementById('infoContentSalahPresensi');

    if (btn && content) {
        // Isi konten informasi sesuai permintaan
        const infoHTML = `
            <div style="text-align: left; padding: 15px 25px; line-height: 1.6; color: #e0e0e0; font-size: 0.95em;">
                
                <strong style="color: #00c3ff; display:block; margin-bottom:5px;">A. Petunjuk Penggunaan</strong>
                <ul style="margin: 0 0 15px 0; padding-left: 20px;">
                    <li style="margin-bottom: 8px;">
                        <strong>Kapan Menu Ini Digunakan?</strong><br>
                        Gunakan menu ini hanya jika Anda salah memilih menu saat presensi Siaba, contoh: salah memilih menu Presensi Pulang saat datang atau sebaliknya.
                    </li>
                    <li style="margin-bottom: 8px;">
                        <strong>Apa yang Perlu Disiapkan?</strong><br>
                        Sebelum mengisi formulir, pastikan Anda sudah membuka Histori Presensi di HP Siaba dan catat tanggal serta waktu presensinya yang salah.
                    </li>
                    <li>
                        <strong>Mengapa Ini Penting?</strong><br>
                        Perbaikan ini akan memastikan data pada rekapitulasi kehadiran bulanan Anda akurat dan sesuai.
                    </li>
                </ul>

                <strong style="color: #00c3ff; display:block; margin-bottom:5px;">B. Batas Waktu Pengajuan</strong>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Perbaikan hanya dapat diajukan maksimal <strong style="color: #f1c40f;">30 hari</strong> dari tanggal presensi yang salah. Jika melewati batas waktu, silakan gunakan menu "Lupa Presensi".</li>
                </ul>

            </div>
        `;

        content.innerHTML = infoHTML;

        // Event Listener untuk Buka/Tutup
        btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isActive = btn.classList.toggle('active');
            content.style.maxHeight = isActive ? content.scrollHeight + "px" : "0px";
        };
    }
}

function initSiabaSalahFormPage() {
    const form = document.getElementById('salahPresensiForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    const unitSelect = document.getElementById('unitKerjaSalah');
    const namaSelect = document.getElementById('namaAsnSalah');
    const nipInput = document.getElementById('nipSalah');

    if (!form) return;

    // Tampilkan Skeleton
    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    let employeeData = []; // Store data from server

    // 1. Ambil Data Opsi
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                if(App.showAppModal) App.showAppModal('error', data.error);
                return;
            }
            
            employeeData = data;

            // Extract Unique Units
            const units = [...new Set(data.map(item => item.unit))].sort();
            
            unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
            units.forEach(u => unitSelect.add(new Option(u, u)));

            // Show Form
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block';
        })
        .withFailureHandler(err => {
            if(App.showAppModal) App.showAppModal('error', 'Gagal memuat data pegawai: ' + err.message);
        })
        .getSiabaSalahOptions();

    // 2. Logic Unit -> Nama
    unitSelect.addEventListener('change', function() {
        const selectedUnit = this.value;
        const filtered = employeeData.filter(item => item.unit === selectedUnit);
        
        // Sort Nama
        filtered.sort((a, b) => a.nama.localeCompare(b.nama));

        namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
        filtered.forEach(emp => {
            const opt = new Option(emp.nama, emp.nama);
            opt.dataset.nip = emp.nip; // Simpan NIP di atribut
            namaSelect.add(opt);
        });
        
        namaSelect.disabled = false;
        nipInput.value = ""; // Reset NIP
    });

    // 3. Logic Nama -> NIP
    namaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.nip) {
            nipInput.value = selectedOption.dataset.nip;
        }
    });

    // 4. Handle Submit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submitBtnSalah');
        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim pengajuan...');

        const formData = Object.fromEntries(new FormData(form));

        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    // Redirect ke halaman Cek Perbaikan
                    App.showAppModal('success', res, 'siaba_salah_cek');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', 'Gagal mengirim: ' + err.message);
                btn.disabled = false;
            })
            .processSiabaSalahForm(formData);
    });
}

function initSiabaSalahCekPage() {
    const filterTahun = document.getElementById('filterTahunSalah');
    const filterBulan = document.getElementById('filterBulanSalah');
    const filterUnit = document.getElementById('filterUnitSalah');
    
    const tableWrapper = document.getElementById('tableWrapperSalah');
    const tableOverlay = document.getElementById('tableOverlayLoaderSalah');
    const table = document.getElementById('salahCekTable');

    if (!table) return;
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    function toggleLoader(show) {
        if (show) {
            tableWrapper.style.display = 'flex';
            tableOverlay.style.display = 'flex';
        } else {
            tableOverlay.style.display = 'none';
        }
    }

    function renderTable(headers, rows) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        // Render Header
        if (headers.length > 0) {
            // Tambahkan kolom No. di awal
            const headerHtml = '<tr><th>No.</th>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            tableHead.innerHTML = headerHtml;
        }

        if (!rows || rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" style="text-align:center; padding:30px;">Tidak ada data untuk filter ini.</td></tr>`;
            return;
        }

        rows.forEach((rowObj, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`; // No.

            headers.forEach(key => {
                let val = rowObj[key];
                
                // Format kolom "Cek" (Status)
                if (key === 'Cek') {
                    const statusStr = String(val).trim();
                    
                    // 1. Jika ada simbol âœ… atau kata 'Diterima'
                    if (statusStr.includes('âœ…') || statusStr.toLowerCase() === 'diterima') {
                        val = '<span class="status-ok"><i class="fas fa-check-circle"></i> Disetujui</span>';
                    } 
                    // 2. Jika ada simbol âŒ atau kata 'Ditolak'
                    else if (statusStr.includes('âŒ') || statusStr.toLowerCase() === 'ditolak') {
                        val = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
                    } 
                    // 3. Jika kosong, anggap sedang menunggu
                    else {
                        val = '<span class="status-proses"><i class="fas fa-clock"></i> Diproses</span>';
                    }
                }

                // Format Tanggal Pengajuan (ambil tanggal saja)
                if (key === 'Tanggal Pengajuan') {
                    // Asumsi format timestamp string ISO atau default
                    if (val && val.length > 10) val = val.substring(0, 10);
                }

                html += `<td>${val}</td>`;
            });
            
            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnit.value
        };
        toggleLoader(true);
        google.script.run
            .withSuccessHandler(res => {
                if (res.error) {
                    tableBody.innerHTML = `<tr><td colspan="10" style="color:red; text-align:center; padding:20px;">Error: ${res.error}</td></tr>`;
                } else {
                    renderTable(res.headers, res.rows);
                }
                toggleLoader(false);
            })
            .withFailureHandler(err => {
                tableBody.innerHTML = `<tr><td colspan="10" style="color:red; text-align:center;">Server Error: ${err.message}</td></tr>`;
                toggleLoader(false);
            })
            .getSiabaSalahCekData(filters);
    }

    // Init
    toggleLoader(true);
    google.script.run
        .withSuccessHandler(opts => {
            if (opts.error) {
                App.showAppModal('error', opts.error);
                toggleLoader(false);
                return;
            }

            // Setup Filter Defaults
            const now = new Date();
            const mNames = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
            const curYear = now.getFullYear().toString();
            const curMonth = mNames[now.getMonth()];

            // Populate
            const addOpt = (el, val) => el.add(new Option(val, val));
            
            opts.tahun.forEach(t => addOpt(filterTahun, t));
            opts.bulan.forEach(b => addOpt(filterBulan, b));
            filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
            opts.unit.forEach(u => addOpt(filterUnit, u));

            // Set Defaults (Jika ada)
            if (opts.tahun.includes(curYear)) filterTahun.value = curYear;
            if (opts.bulan.includes(curMonth)) filterBulan.value = curMonth;
            filterUnit.value = "Semua";

            // Listeners
            [filterTahun, filterBulan, filterUnit].forEach(el => el.addEventListener('change', fetchData));

            fetchData();
        })
        .withFailureHandler(err => {
            App.showAppModal('error', 'Gagal init filter: ' + err.message);
            toggleLoader(false);
        })
        .getSiabaSalahFilterOptions();
}

function initSiabaDinasPage() {
    initMenuPage(); // Aktifkan animasi menu

    const btn = document.getElementById('infoBtnDinas');
    const content = document.getElementById('infoContentDinas');

    if (btn && content) {
        const infoHTML = `
            <div style="text-align: left; padding: 15px 25px; line-height: 1.6; color: #e0e0e0; font-size: 0.95em;">
                <strong style="color: #00c3ff; display:block; margin-bottom:10px;">Ketentuan Perjalanan Dinas:</strong>
                <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                    <li style="margin-bottom: 6px;">Diajukan menggunakan Surat Perintah Tugas (SPT);</li>
                    <li style="margin-bottom: 6px;">Bagi ASN yang akan menggunakan Perjalanan Dinas Siaba dapat mengajukan melalui halaman ini;</li>
                    <li style="margin-bottom: 6px;">Batas waktu pengusulan adalah sebelum tanggal pelaksanaan;</li>
                    <li style="margin-bottom: 6px;">Guru yang mengajukan perjalanan dinas menggunakan SPT dari Kepala Sekolah, kecuali jika sudah ada SPT dari Kepala Dinas atau pejabat lain yang berwenang;</li>
                    <li style="margin-bottom: 6px;">SPT Kepala Sekolah dibuat oleh Kepala Dinas, apabila dari dinas belum/tidak ada SPT, untuk sementara dapat menggunakan surat undangan;</li>
                    <li style="margin-bottom: 6px;">Surat Perintah Tugas dapat berasal dari instansi/lembaga lain dan dapat diinputkan di Siaba apabila sudah mendapatkan ijin dari Kepala Sekolah/atasan;</li>
                    <li style="margin-bottom: 6px;">Dalam hal kegiatan lingkup kecamatan, apabila waktu tidak memungkinkan untuk melakukan presensi di sekolah, ASN dapat diberikan SPT untuk perjalanan dinas;</li>
                    <li style="margin-bottom: 6px;">File format SPT bisa diunduh di halaman ini, terdapat 2 jenis SPT yaitu untuk satu orang pelaksana tugas dan SPT Kolektif untuk pelaksana tugas lebih dari satu orang;</li>
                    <li>SPT asli discan format pdf menggunakan mesin scanner dengan ukuran file maksimal 200 KB, atau dapat menggunakan SPT elektronik.</li>
                </ul>
            </div>
        `;

        content.innerHTML = infoHTML;

        btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isActive = btn.classList.toggle('active');
            content.style.maxHeight = isActive ? content.scrollHeight + "px" : "0px";
        };
    }
}

function initSiabaDinasUnggahPage() {
    const form = document.getElementById('dinasUnggahForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    const unitSelect = document.getElementById('unitKerjaDinas');
    const pesertaSelect = document.getElementById('jumlahPeserta');
    const pesertaWrapper = document.getElementById('peserta-wrapper');

    if (!form) return;
    setupDateValidation('tanggalSPT', 'tanggalMulai', 'tanggalSelesai');

    // Tampilkan Skeleton
    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    let employeeData = []; 
    let currentUnitEmployees = [];

    // 1. Ambil Data Opsi dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                if(App.showAppModal) App.showAppModal('error', data.error);
                return;
            }
            employeeData = data;

            // Isi Dropdown Unit Kerja
            const units = [...new Set(data.map(item => item.unit))].sort();
            unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
            units.forEach(u => unitSelect.add(new Option(u, u)));

            // Isi Dropdown Jumlah Peserta (1-20)
            pesertaSelect.innerHTML = '';
            for(let i=1; i<=20; i++) {
                pesertaSelect.add(new Option(i, i));
            }
            // Set default ke 1 tapi disable dulu sampai unit dipilih
            pesertaSelect.value = 1;
            pesertaSelect.disabled = true;

            // Tampilkan Form
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block';
        })
        .withFailureHandler(err => {
            if(App.showAppModal) App.showAppModal('error', 'Gagal memuat data: ' + err.message);
        })
        .getSiabaDinasOptions();

    // 2. Logika Anti-Duplikasi
    function updateAllDropdownOptions() {
        const selects = document.querySelectorAll('.peserta-nama-select');
        const selectedValues = Array.from(selects).map(s => s.value).filter(v => v && v !== "");

        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="" disabled>-- Pilih Nama --</option>';
            if (!currentValue) select.querySelector('option').selected = true;

            currentUnitEmployees.forEach(emp => {
                if (emp.nama === currentValue || !selectedValues.includes(emp.nama)) {
                    const opt = new Option(emp.nama, emp.nama);
                    select.add(opt);
                }
            });
            if (currentValue) select.value = currentValue;
        });
    }

    // 3. Helper: Generate Row Peserta (PERBAIKAN TAMPILAN)
    function generateParticipantRows(count) {
        pesertaWrapper.innerHTML = ''; 
        
        for (let i = 1; i <= count; i++) {
            // PERUBAHAN DI SINI: Menghapus class 'ptk-row' dan menggunakan style display block standar
            const rowHtml = `
            <div style="display: block; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-bottom: 15px;">
                <label style="color: #f1c40f; font-weight:bold; margin-bottom:10px; display:block;">Peserta ${i}</label>
                
                <div class="form-grid-12">
                    <div class="col-span-6">
                        <div class="form-group" style="margin-bottom:0;">
                            <select id="nama_${i}" name="nama_${i}" class="peserta-nama-select" data-index="${i}" required style="width: 100%;">
                                <option value="" disabled selected>-- Pilih Nama --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-span-6">
                        <div class="form-group" style="margin-bottom:0;">
                            <input type="text" id="nip_${i}" name="nip_${i}" readonly style="background-color: rgba(0,0,0,0.3); width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            `;
            pesertaWrapper.insertAdjacentHTML('beforeend', rowHtml);
        }
        
        updateAllDropdownOptions();
        
        // Listener Autofill NIP
        document.querySelectorAll('.peserta-nama-select').forEach(select => {
            select.addEventListener('change', function() {
                const idx = this.dataset.index;
                const selectedEmp = currentUnitEmployees.find(e => e.nama === this.value);
                if (selectedEmp) {
                    document.getElementById(`nip_${idx}`).value = selectedEmp.nip;
                }
                updateAllDropdownOptions();
            });
        });
    }

    // 4. Event Listener Unit Kerja
    unitSelect.addEventListener('change', function() {
        const selectedUnit = this.value;
        currentUnitEmployees = employeeData.filter(item => item.unit === selectedUnit);
        currentUnitEmployees.sort((a, b) => a.nama.localeCompare(b.nama));
        
        pesertaSelect.disabled = false;
        pesertaSelect.value = 1; 
        generateParticipantRows(1);
    });

    // 5. Event Listener Jumlah Peserta
    pesertaSelect.addEventListener('change', function() {
        generateParticipantRows(parseInt(this.value));
    });

    // 6. Handle Submit
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtnDinas');
        const fileInput = document.getElementById('fileSPT');
        
        if (fileInput.files[0].size > 200 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 200 KB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim Data Perjalanan Dinas...');

        const formData = Object.fromEntries(new FormData(form));
        
        const reader = new FileReader();
        reader.onload = function(event) {
            formData.fileData = {
                fileName: fileInput.files[0].name,
                mimeType: fileInput.files[0].type,
                data: event.target.result.split(',')[1]
            };

            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                        App.showAppModal('error', res.error);
                        btn.disabled = false;
                    } else {
                        App.showAppModal('success', res, 'siaba_dinas_cek');
                    }
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', 'Gagal kirim: ' + err.message);
                    btn.disabled = false;
                })
                .processSiabaDinasForm(formData);
        };
        reader.readAsDataURL(fileInput.files[0]);
    });
}

function initSiabaDinasCekPage() {
    const filterTahun = document.getElementById('filterTahunDinas');
    const filterBulan = document.getElementById('filterBulanDinas');
    const filterUnit = document.getElementById('filterUnitDinas');
    
    const tableWrapper = document.getElementById('tableWrapperDinas');
    const tableOverlay = document.getElementById('tableOverlayLoaderDinas');
    const table = document.getElementById('dinasCekTable');

    if (!table) return;
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(headers, rows) {
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';

        if (headers.length > 0) {
            tableHead.innerHTML = '<tr><th>No.</th>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        }

        if (!rows || rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headers.length + 1}" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`;
            
            headers.forEach(key => {
                let val = row[key];
                
                // Format Kolom "Cek"
                if (key === 'Cek') {
                    // Ambil nilai string dan bersihkan spasi
                    const s = String(val).trim(); 
                    const lowerS = s.toLowerCase();
                    
                    // 1. Disetujui (Cek Simbol âœ… ATAU kata kunci)
                    if (s.includes('V') || lowerS.includes('diterima') || lowerS.includes('ok') || lowerS.includes('disetujui') || lowerS.includes('acc')) {
                        val = '<span class="status-ok"><i class="fas fa-check-circle"></i> Disetujui</span>';
                    } 
                    // 2. Ditolak (Cek Simbol âŒ ATAU kata kunci)
                    else if (s.includes('X') || lowerS.includes('ditolak') || lowerS.includes('tolak')) {
                        val = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
                    } 
                    // 3. Diproses (Jika kosong atau lainnya)
                    else {
                        val = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
                    }
                }
                
                // Format Tombol Lihat Dokumen
                if (key === 'Dokumen') {
                    if (val && String(val).startsWith('http')) {
                        val = `<button class="view-doc-btn" onclick="App.showFilePreview('${val}')"><i class="fas fa-eye"></i> Lihat</button>`;
                    } else {
                        val = '-';
                    }
                }

                // Format Kolom Aksi
                if (key === 'Aksi') {
                    const idSpt = row['ID'] || ''; 
                    const jenisDok = row['Jenis Dokumen'];
                    const rowIndex = row._rowIndex;
                    
                    // Tombol Edit
                    let editBtn = '';
                    if (jenisDok === 'Sementara' && idSpt) {
                        editBtn = `<button class="action-btn edit-btn" onclick="App.loadPage(event, 'siaba_dinas_edit', {idSpt: '${idSpt}'})"><i class="fas fa-pencil-alt"></i> Edit</button>`;
                    } else {
                        editBtn = `<button class="action-btn edit-btn" disabled style="opacity:0.5; cursor:not-allowed;"><i class="fas fa-pencil-alt"></i> Edit</button>`;
                    }

                    // --- PERBAIKAN TOMBOL HAPUS ---
                    // Tambahkan 'Nomor SPT' ke dalam objek rowInfo
                    const rowInfoObj = { 
                        _source: 'DINAS', 
                        _rowIndex: rowIndex, 
                        'Nama': row['Nama ASN'] || 'Pegawai',
                        'Nomor SPT': row['Nomor SPT'] || '-' // <-- INI YANG DITAMBAHKAN
                    };
                    
                    // Stringify dan escape tanda petik agar HTML aman
                    const rowInfoStr = JSON.stringify(rowInfoObj).replace(/'/g, "&#39;");
                    
                    // Gunakan App.showDeleteConfirmation (Global)
                    const delBtn = `<button class="action-btn delete-btn" onclick="App.showDeleteConfirmation(this)" data-row-info='${rowInfoStr}'><i class="fas fa-trash"></i> Hapus</button>`;
                    
                    val = `<div style="display:flex; gap:5px;">${editBtn}${delBtn}</div>`;
                }

                html += `<td>${val || '-'}</td>`;
            });
            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnit.value
        };
        toggleLoader(true);
        google.script.run.withSuccessHandler(res => {
            if(res.error) {
                tableBody.innerHTML = `<tr><td colspan="15" style="color:red; text-align:center;">Error: ${res.error}</td></tr>`;
            } else {
                renderTable(res.headers, res.rows);
            }
            toggleLoader(false);
        }).getSiabaDinasCekData(filters);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(opts => {
        if(opts.error) { App.showAppModal('error', opts.error); return; }

        const now = new Date();
        const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const curYear = now.getFullYear().toString();
        const curMonth = mNames[now.getMonth()];

        const addOpt = (el, v) => el.add(new Option(v, v));
        
        filterTahun.innerHTML = '';
        opts.tahun.forEach(t => addOpt(filterTahun, t));
        
        filterBulan.innerHTML = '';
        opts.bulan.forEach(b => addOpt(filterBulan, b));
        
        filterUnit.innerHTML = '';
        filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
        opts.unit.forEach(u => addOpt(filterUnit, u));

        if(opts.tahun.includes(curYear)) filterTahun.value = curYear;
        if(opts.bulan.includes(curMonth)) filterBulan.value = curMonth;
        filterUnit.value = "Semua";

        [filterTahun, filterBulan, filterUnit].forEach(el => el.addEventListener('change', fetchData));
        fetchData();
    }).getSiabaDinasFilterOptions();
}

// Helper Hapus Khusus Dinas (agar tidak merusak logika hapus global yang ada)
App.confirmDeleteDinas = (btn) => {
    const rowInfo = JSON.parse(btn.dataset.rowInfo);
    const modal = document.getElementById('deleteModal');
    const title = document.getElementById('deleteModalTitle');
    const body = document.getElementById('deleteModalBody');
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    
    title.textContent = "Hapus Data Perjalanan Dinas";
    body.innerHTML = `<p>Apakah Anda yakin ingin menghapus data perjalanan dinas atas nama <b>${rowInfo.Nama}</b>?</p>`;
    
    // Clone tombol untuk reset listener
    const newConfirm = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirm, confirmBtn);
    
    newConfirm.onclick = () => {
        App.showAppModal('loading', 'Menghapus data...');
        modal.classList.remove('show');
        google.script.run.withSuccessHandler(res => {
            App.showAppModal('success', res, 'siaba_dinas_cek');
        }).deleteSiabaDinasData(rowInfo._rowIndex);
    };
    
    modal.classList.add('show');
};

function initSiabaDinasEditPage(params) {
    const form = document.getElementById('dinasEditForm');
    const skeleton = document.getElementById('skeleton-loader');

    // Cek parameter
    if (!params || !params.idSpt) {
        console.error("ID SPT tidak ditemukan");
        return;
    }
    setupDateValidation('tanggalSPTEdit', 'tanggalMulaiEdit', 'tanggalSelesaiEdit');

    // Elemen Form (GUNAKAN ID BARU DENGAN SUFFIX 'Edit')
    const unitSelect = document.getElementById('unitKerjaDinasEdit');
    const pesertaSelect = document.getElementById('jumlahPesertaEdit');
    const pesertaWrapper = document.getElementById('peserta-wrapper-edit');
    
    const idInput = document.getElementById('idSpt');
    if(idInput) idInput.value = params.idSpt;
    
    // --- KONTROL SKELETON (Mulai) ---
    if(skeleton) skeleton.style.display = 'flex'; 
    form.style.display = 'none'; 
    // --------------------------------
    
    let employeeData = []; 
    let currentUnitEmployees = [];

    // Helper: Anti-Duplikasi Dropdown (Skop Lokal Edit)
    function updateAllDropdownOptions() {
        // Gunakan selector spesifik di dalam wrapper edit
        const selects = pesertaWrapper.querySelectorAll('.peserta-nama-select');
        const selectedValues = Array.from(selects).map(s => s.value).filter(v => v && v !== "");

        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="" disabled>-- Pilih Nama --</option>';
            if (!currentValue) select.querySelector('option').selected = true;

            currentUnitEmployees.forEach(emp => {
                if (emp.nama === currentValue || !selectedValues.includes(emp.nama)) {
                    const opt = new Option(emp.nama, emp.nama);
                    select.add(opt);
                }
            });
            if (currentValue) select.value = currentValue;
        });
    }

    // Helper: Generate Baris Peserta (Layout 50:50)
    function generateParticipantRows(count) {
        pesertaWrapper.innerHTML = ''; 
        for (let i = 1; i <= count; i++) {
            const rowHtml = `
            <div style="display: block; width: 100%; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-bottom: 15px;">
                <label style="color: #f1c40f; font-weight:bold; margin-bottom:10px; display:block;">Peserta ${i}</label>
                <div class="form-grid-12">
                    <div class="col-span-6">
                        <div class="form-group" style="margin-bottom:0;">
                            <select id="nama_edit_${i}" name="nama_${i}" class="peserta-nama-select" data-index="${i}" required style="width: 100%;">
                                <option value="" disabled selected>-- Pilih Nama --</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-span-6">
                        <div class="form-group" style="margin-bottom:0;">
                            <input type="text" id="nip_edit_${i}" name="nip_${i}" readonly style="background-color: rgba(0,0,0,0.3); width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            `;
            pesertaWrapper.insertAdjacentHTML('beforeend', rowHtml);
        }
        
        // Listener change untuk setiap baris baru
        pesertaWrapper.querySelectorAll('.peserta-nama-select').forEach(select => {
            select.addEventListener('change', function() {
                const idx = this.dataset.index;
                const selectedEmp = currentUnitEmployees.find(e => e.nama === this.value);
                if (selectedEmp) {
                    document.getElementById(`nip_edit_${idx}`).value = selectedEmp.nip;
                }
                updateAllDropdownOptions();
            });
        });
    }

    // EVENT LISTENER UI
    if (unitSelect) {
        unitSelect.addEventListener('change', function() {
            const selectedUnit = this.value;
            currentUnitEmployees = employeeData.filter(item => item.unit === selectedUnit);
            currentUnitEmployees.sort((a, b) => a.nama.localeCompare(b.nama));
            
            pesertaSelect.value = 1; 
            generateParticipantRows(1);
            updateAllDropdownOptions();
        });
    }

    if (pesertaSelect) {
        pesertaSelect.addEventListener('change', function() {
            generateParticipantRows(parseInt(this.value));
            updateAllDropdownOptions();
        });
    }

    // LOAD DATA DARI SERVER
    google.script.run.withSuccessHandler(opts => {
        if (opts.error) { 
             if(skeleton) skeleton.style.display = 'none';
             App.showAppModal('error', opts.error); 
             return; 
        }
        employeeData = opts;
        
        // Isi Unit Kerja
        const units = [...new Set(opts.map(item => item.unit))].sort();
        unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
        units.forEach(u => unitSelect.add(new Option(u, u)));

        // Isi Jumlah Peserta
        pesertaSelect.innerHTML = '';
        for(let i=1; i<=20; i++) pesertaSelect.add(new Option(i, i));

        // PANGGIL DATA EDIT BERDASARKAN ID
        google.script.run.withSuccessHandler(data => {
            
            // --- KONTROL SKELETON (Selesai) ---
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            // ----------------------------------

            // Isi Data Utama (Gunakan ID Elemen 'Edit')
            document.getElementById('idSpt').value = data.id || '';
            document.getElementById('existingFileUrl').value = data.fileUrl || '';
            
            // Helper set value
            const setVal = (id, val) => { 
                const el = document.getElementById(id); 
                if(el) el.value = val || ''; 
            };

            setVal('jenisPDEdit', data.jenisPD);
            setVal('nomorSPTEdit', data.nomorSPT);
            setVal('tanggalSPTEdit', data.tanggalSPT);
            setVal('tanggalMulaiEdit', data.tanggalMulai);
            setVal('tanggalSelesaiEdit', data.tanggalSelesai);
            setVal('lokasiEdit', data.lokasi);
            setVal('kegiatanEdit', data.kegiatan);
            setVal('jenisDokumenEdit', data.jenisDokumen);

            // Link File Lama
            const linkDiv = document.getElementById('currentDocLink');
            if(data.fileUrl && data.fileUrl.startsWith('http')) {
                linkDiv.innerHTML = `<button type="button" class="view-doc-btn" onclick="App.showFilePreview('${data.fileUrl}')"><i class="fas fa-eye"></i> Lihat Dokumen Saat Ini</button>`;
            } else {
                linkDiv.innerHTML = '<span style="color:#aaa;">Belum ada dokumen.</span>';
            }

            // C. Isi Data Peserta
            unitSelect.value = data.unitKerja;
            currentUnitEmployees = employeeData.filter(item => item.unit === data.unitKerja);
            currentUnitEmployees.sort((a, b) => a.nama.localeCompare(b.nama));

            const namaList = data.namaASN ? data.namaASN.split('<br>') : [];
            const nipList = data.nip ? data.nip.split('<br>') : [];
            const count = Math.max(namaList.length, 1);

            pesertaSelect.value = count;
            generateParticipantRows(count);

            for (let i = 0; i < count; i++) {
                const idx = i + 1;
                const namaVal = namaList[i];
                const nipVal = nipList[i];
                
                // Gunakan ID Baru: nama_edit_1, nip_edit_1
                const sel = document.getElementById(`nama_edit_${idx}`);
                if(sel) {
                    // Inject opsi terpilih jika belum ada
                    let exists = Array.from(sel.options).some(o => o.value === namaVal);
                    if (!exists && namaVal) {
                        sel.add(new Option(namaVal, namaVal));
                    }
                    sel.value = namaVal;
                }
                
                const inp = document.getElementById(`nip_edit_${idx}`);
                if(inp) inp.value = nipVal;
            }
            
            updateAllDropdownOptions();

        }).withFailureHandler(err => {
            if(skeleton) skeleton.style.display = 'none';
            App.showAppModal('error', 'Gagal ambil data: ' + err.message);
        }).getSiabaDinasEditData(params.idSpt);

    }).withFailureHandler(err => {
        if(skeleton) skeleton.style.display = 'none';
        App.showAppModal('error', 'Gagal ambil opsi: ' + err.message);
    }).getSiabaDinasOptions();

    // --- HANDLE SUBMIT (VERSI FINAL & AMAN) ---
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnSimpanRevisi');
        const fileInput = document.getElementById('fileRevisi');
        
        // Validasi Ukuran File
        if (fileInput.files.length > 0 && fileInput.files[0].size > 200 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 200 KB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');
        
        // 1. Ambil data form
        const formData = Object.fromEntries(new FormData(form));

        // 2. [PENTING] Hapus objek File mentah agar tidak error "Illegal Value"
        delete formData.fileData; 
        
        // 3. Fungsi kirim data dengan PENGECEKAN ERROR
        const sendData = (payload) => {
             google.script.run.withSuccessHandler(res => {
                // Cek apakah server mengembalikan objek error
                if (res && res.error) {
                    App.showAppModal('error', res.error); // Tampilkan pesan error asli (Merah)
                    btn.disabled = false; // Aktifkan tombol kembali
                } else {
                    // Jika sukses (respon adalah string pesan)
                    App.showAppModal('success', res, 'siaba_dinas_cek'); // Tampilkan pesan sukses (Hijau)
                }
            }).withFailureHandler(err => {
                // Error koneksi/server crash (Jarang terjadi jika logic server benar)
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).updateSiabaDinasFullData(payload);
        };

        // 4. Proses File (Jika ada upload baru)
        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                // Masukkan file sebagai objek bersih (base64)
                formData.fileData = {
                    fileName: fileInput.files[0].name,
                    mimeType: fileInput.files[0].type,
                    data: ev.target.result.split(',')[1]
                };
                sendData(formData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            // 5. Jika tidak ada file, kirim data teks saja
            sendData(formData);
        }
    });
}

function initSiabaDinasUnduhPage() {
    initMenuPage(); // Animasi tombol

    const btn = document.getElementById('infoBtnDinasUnduh');
    const content = document.getElementById('infoContentDinasUnduh');

    if (btn && content) {
        const infoText = [
            "Klik tombol di atas untuk mengunduh format Surat Perintah Tugas (SPT) dalam format Microsoft Word (.docx).",
            "Format ini dapat digunakan untuk SPT Perorangan maupun Kolektif.",
            "Silakan isi data yang diperlukan, cetak, tanda tangani, lalu scan menjadi PDF untuk diunggah di menu 'Unggah SPT'."
        ];

        content.innerHTML = `<ul style="text-align: left; padding: 15px 20px 15px 35px; line-height: 1.6; margin: 0; color: #e0e0e0;">
            ${infoText.map(t => `<li>${t}</li>`).join('')}
        </ul>`;

        btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isActive = btn.classList.toggle('active');
            content.style.maxHeight = isActive ? content.scrollHeight + "px" : "0px";
        };
    }
}

function initSiabaCutiMenuPage() {
    initMenuPage(); // Animasi

    const btn = document.getElementById('infoBtnCuti');
    const content = document.getElementById('infoContentCuti');

    if (btn && content) {
        const infoHTML = `
            <div style="text-align: left; padding: 15px 25px; line-height: 1.6; color: #e0e0e0; font-size: 0.95em;">
                <strong style="color: #00c3ff; display:block; margin-bottom:5px;">Ketentuan Cuti Pegawai:</strong>
                <ul style="margin: 0 0 15px 0; padding-left: 20px; list-style-type: disc;">
                    <li>Pengajuan cuti harus dilakukan secara tertulis/elektronik sebelum tanggal pelaksanaan.</li>
                    <li>Jenis cuti meliputi: Cuti Tahunan, Cuti Sakit, Cuti Alasan Penting, dan Cuti Melahirkan.</li>
                    <li>Pastikan saldo Cuti Tahunan mencukupi sebelum mengajukan.</li>
                    <li>Surat Cuti asli yang telah disetujui wajib diunggah melalui menu "Unggah Surat Cuti".</li>
                </ul>
            </div>
        `;
        content.innerHTML = infoHTML;

        btn.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const isActive = btn.classList.toggle('active');
            content.style.maxHeight = isActive ? content.scrollHeight + "px" : "0px";
        };
    }
}

function initSiabaCutiFormPage() {
    const form = document.getElementById('cutiForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    // Elemen Form
    const unitSelect = document.getElementById('unitKerjaCuti');
    const namaSelect = document.getElementById('namaAsnCuti');
    const nipInput = document.getElementById('nipCuti');
    const alamatInput = document.getElementById('alamatCuti');
    const statusSelect = document.getElementById('statusCuti');
    const golonganSelect = document.getElementById('golonganCuti');
    const jenisCutiSelect = document.getElementById('jenisCuti');
    
    // Tanggal
    const tglMulai = document.getElementById('tglMulai');
    const tglSelesai = document.getElementById('tglSelesai');
    const jmlHari = document.getElementById('jmlHari');

    if (!form) return;

    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    let employeeData = [];

    // 1. Load Options dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) { App.showAppModal('error', data.error); return; }
            employeeData = data;
            
            // Isi Unit Kerja
            const units = [...new Set(data.map(item => item.unit))].sort();
            unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
            units.forEach(u => unitSelect.add(new Option(u, u)));

            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block';
        })
        .withFailureHandler(err => {
            App.showAppModal('error', 'Gagal memuat data: ' + err.message);
        })
        .getSiabaCutiOptions();

    // 2. Listener Unit -> Nama
    unitSelect.addEventListener('change', function() {
        const selectedUnit = this.value;
        const filtered = employeeData.filter(item => item.unit === selectedUnit);
        filtered.sort((a, b) => a.nama.localeCompare(b.nama));

        namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
        filtered.forEach(emp => {
            const opt = new Option(emp.nama, emp.nama);
            opt.dataset.nip = emp.nip;
            opt.dataset.alamat = emp.alamat;
            namaSelect.add(opt);
        });
        namaSelect.disabled = false;
        nipInput.value = "";
        alamatInput.value = "";
    });

    // 3. Listener Nama -> NIP & Alamat
    namaSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.nip) nipInput.value = selectedOption.dataset.nip;
        if (selectedOption.dataset.alamat) alamatInput.value = selectedOption.dataset.alamat;
    });

    // 4. Listener Status -> Golongan & Jenis Cuti
    statusSelect.addEventListener('change', function() {
        const status = this.value;
        golonganSelect.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        jenisCutiSelect.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        
        let golOpts = [];
        let cutiOpts = [];

        if (status === 'PNS') {
            golOpts = ['IV/b', 'IV/a', 'III/d', 'III/c', 'III/b', 'III/a', 'II/d', 'II/c', 'II/b', 'II/a'];
            cutiOpts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Melahirkan', 'Cuti Alasan Penting', 'Cuti Besar', 'Cuti di Luar Tanggungan Negara', 'Cuti Umroh'];
        } else if (status === 'PPPK') {
            golOpts = ['IX', 'VII', 'VI', 'V', 'IV', 'I'];
            cutiOpts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Melahirkan', 'Cuti Umroh'];
        }

        golOpts.forEach(o => golonganSelect.add(new Option(o, o)));
        cutiOpts.forEach(o => jenisCutiSelect.add(new Option(o, o)));
        
        golonganSelect.disabled = false;
        jenisCutiSelect.disabled = false;
    });

    // 5. Kalkulasi Hari Otomatis
    function calculateDays() {
        if (tglMulai.value && tglSelesai.value) {
            // Validasi Tanggal
            if (tglSelesai.value < tglMulai.value) {
                tglSelesai.value = tglMulai.value; // Reset
            }
            
            const start = new Date(tglMulai.value);
            const end = new Date(tglSelesai.value);
            // Hitung selisih waktu (ms) -> hari
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 karena inclusive
            
            jmlHari.value = diffDays;
        }
    }

    tglMulai.addEventListener('change', () => {
        // Set min date untuk Selesai
        tglSelesai.min = tglMulai.value;
        calculateDays();
    });
    
    tglSelesai.addEventListener('change', calculateDays);

    // 6. Submit Form
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnCuti');
        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim Pengajuan Cuti...');

        const formData = Object.fromEntries(new FormData(form));

        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    // PERBAIKAN: Redirect ke halaman 'siaba_cuti_unduh'
                    App.showAppModal('success', res, 'siaba_cuti_unduh'); 
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            })
            .submitSiabaCutiForm(formData);
    });
}

function initSiabaCutiSisaPage() {
    const filterUnit = document.getElementById('filterUnitCutiSisa');
    const searchInput = document.getElementById('searchCutiSisa');
    
    const tableWrapper = document.getElementById('tableWrapperCutiSisa');
    const tableOverlay = document.getElementById('tableOverlayLoaderCutiSisa');
    const tableBody = document.getElementById('cutiSisaTable').querySelector('tbody');
    const tableHead = document.getElementById('cutiSisaTable').querySelector('thead');

    let allRows = []; 
    let tableHeaders = [];

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        
        if (tableHeaders.length > 0) {
            tableHead.innerHTML = '<tr><th>No.</th>' + tableHeaders.map(h => `<th>${h}</th>`).join('') + '</tr>';
        }

        if (rows.length === 0) {
            const colSpan = tableHeaders.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding:30px;">Tidak ada data cuti.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`; // Kolom 1: No.
            
            row.forEach(cell => {
                // PERBAIKAN: Ubah 0, "0", null, undefined, "" menjadi "-"
                let cellContent = cell;
                if (cell === '' || cell == null || cell == 0) {
                    cellContent = '-';
                }
                html += `<td>${cellContent}</td>`;
            });
            
            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const unit = filterUnit ? filterUnit.value : "Semua";
        toggleLoader(true);
        
        google.script.run.withSuccessHandler(data => {
            tableHeaders = data.headers;
            allRows = data.rows; 
            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="10" style="color:red; text-align:center; padding:20px;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaCutiSisaData(unit);
    }

    function filterAndRender() {
        const query = searchInput ? searchInput.value.toLowerCase() : "";
        const filtered = allRows.filter(row => 
            String(row[0]).toLowerCase().includes(query) || 
            String(row[1]).toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(units => {
        filterUnit.innerHTML = '';
        filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
        units.forEach(u => filterUnit.add(new Option(u, u)));

        filterUnit.addEventListener('change', fetchData);
        if(searchInput) searchInput.addEventListener('input', App.debounce(filterAndRender, 300));
        
        fetchData();
    }).getSiabaCutiSisaFilterOptions();
}

function initSiabaCutiUnduhPage() {
    const filterTahun = document.getElementById('filterTahunUnduh');
    const filterUnit = document.getElementById('filterUnitUnduh');
    const searchInput = document.getElementById('searchCuti');
    
    const loadingStatus = document.getElementById('loadingStatusUnduh');
    const tableWrapper = document.getElementById('tableWrapperUnduh');
    const tableOverlay = document.getElementById('tableOverlayLoaderUnduh');
    const tableBody = document.getElementById('cutiUnduhTable').querySelector('tbody');
    
    let allRows = []; 

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`;
            html += `<td>${row.nama}</td>`;
            html += `<td>${row.nip}</td>`;
            html += `<td>${row.jenis}</td>`;
            html += `<td>${row.tglMulai}</td>`;
            html += `<td>${row.tglSelesai}</td>`;
            html += `<td>${row.jmlHari}</td>`;
            html += `<td>${row.usulan}</td>`;
            
            // Status
            let statusHtml = '';
            const s = row.status; 
            if (s === 'Disetujui') statusHtml = '<span class="status-ok"><i class="fas fa-check-circle"></i> Disetujui</span>';
            else if (s === 'Dibatalkan') statusHtml = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Dibatalkan</span>';
            else statusHtml = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
            html += `<td>${statusHtml}</td>`;

            // Formulir
            let fileBtn = '-';
            if (row.fileUrl && row.fileUrl.startsWith('http')) {
                fileBtn = `<button class="action-btn btn-blue" onclick="App.showFilePreview('${row.fileUrl}')"><i class="fas fa-download"></i> Unduh</button>`;
            }
            html += `<td>${fileBtn}</td>`;

            html += `<td>${row.keterangan}</td>`;
            
            // Aksi
            const rowInfo = JSON.stringify({ _source: 'CUTI', _rowIndex: row._rowIndex, Nama: row.nama }).replace(/'/g, "&#39;");
            
            // LOGIKA EDIT: Tidak aktif jika Disetujui
            let editBtn = '';
            if (s === 'Disetujui') {
                editBtn = `<button class="action-btn btn-edit" disabled style="opacity: 0.5; cursor: not-allowed;"><i class="fas fa-pencil-alt" style="margin-right:4px;"></i> Edit</button>`;
            } else {
                // Gunakan row._rowIndex atau ID jika sudah ada. Disini pakai rowIndex (lama) atau ID jika ada.
                editBtn = `<button class="action-btn btn-edit" onclick="App.loadPage(event, 'siaba_cuti_form', {rowIndex: ${row._rowIndex}})"><i class="fas fa-pencil-alt" style="margin-right:4px;"></i> Edit</button>`;
            }

            const delBtn = `<button class="action-btn btn-delete" onclick="App.showDeleteConfirmation(this)" data-row-info='${rowInfo}'><i class="fas fa-trash" style="margin-right:4px;"></i> Hapus</button>`;
            
            html += `<td><div class="action-buttons">${editBtn}${delBtn}</div></td>`;

            html += `<td>${row.tglAjuan}</td>`;

            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            unitKerja: filterUnit.value
        };
        toggleLoader(true);
        google.script.run.withSuccessHandler(data => {
            allRows = data; 
            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="13" style="color:red;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaCutiUnduhData(filters);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(r => 
            String(r.nama).toLowerCase().includes(query) || 
            String(r.nip).toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(opts => {
        if(opts.error) { App.showAppModal('error', opts.error); toggleLoader(false); return; }

        const now = new Date();
        const curYear = now.getFullYear().toString();

        const addOpt = (el, v) => el.add(new Option(v, v));
        
        filterTahun.innerHTML = '';
        opts.tahun.forEach(t => addOpt(filterTahun, t));
        if(opts.tahun.includes(curYear)) filterTahun.value = curYear;

        filterUnit.innerHTML = '';
        filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
        opts.unit.forEach(u => addOpt(filterUnit, u));

        [filterTahun, filterUnit].forEach(el => el.addEventListener('change', fetchData));
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getSiabaCutiUnduhFilterOptions();
}

function initSiabaCutiEditPage(params) {
    // ALERT INI HARUS MUNCUL. JIKA TIDAK, BERARTI CODE BELUM TER-UPDATE.
    alert("MEMUAT HALAMAN EDIT CUTI - VERSI BARU"); 

    const form = document.getElementById('cutiEditForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.idCuti) {
        alert("Error: ID Cuti tidak ditemukan");
        return;
    }

    form.idCuti.value = params.idCuti;
    
    // Elemen Input
    const elStatus = document.getElementById('statusEdit');
    const elJenis = document.getElementById('jenisCutiEdit');
    const elMulai = document.getElementById('tglMulaiEdit');
    const elSelesai = document.getElementById('tglSelesaiEdit');
    const elHari = document.getElementById('jmlHariEdit');

    // 1. Logic Dropdown Jenis Cuti
    function updateJenisCuti(statusRaw) {
        const status = String(statusRaw || "").trim();
        elJenis.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        let opts = [];
        if (status === 'PNS') {
            opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Alasan Penting', 'Cuti Melahirkan', 'Cuti Besar'];
        } else if (status === 'PPPK') {
            opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Melahirkan'];
        }
        opts.forEach(o => elJenis.add(new Option(o, o)));
    }

    elStatus.addEventListener('change', () => {
        updateJenisCuti(elStatus.value);
        elJenis.disabled = false;
    });

    // 2. Logic Tanggal & Hari
    function calculateDays() {
        if (elMulai.value && elSelesai.value) {
            if (elSelesai.value < elMulai.value) elSelesai.value = elMulai.value;
            const diff = Math.ceil(Math.abs(new Date(elSelesai.value) - new Date(elMulai.value)) / (1000 * 60 * 60 * 24)) + 1;
            elHari.value = diff;
        }
    }
    elMulai.addEventListener('change', () => { elSelesai.min = elMulai.value; calculateDays(); });
    elSelesai.addEventListener('change', calculateDays);

    // 3. Load Data
    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    google.script.run.withSuccessHandler(data => {
        if(skeleton) skeleton.style.display = 'none';
        form.style.display = 'block';

        // ALERT DATA DARI SERVER
        // alert("Data Server:\nUnit: " + data.unitKerja + "\nNama: " + data.namaAsn);

        if (!data) {
            App.showAppModal('error', 'Data tidak ditemukan.');
            return;
        }

        // ISI DATA
        document.getElementById('existingFileUrlEdit').value = data.fileUrl || '';
        
        document.getElementById('unitKerjaEdit').value = data.unitKerja || '';
        document.getElementById('namaAsnEdit').value = data.namaAsn || '';
        document.getElementById('nipEdit').value = data.nip || '';

        const safeStatus = String(data.status || "").trim();
        elStatus.value = safeStatus;
        updateJenisCuti(safeStatus); 
        
        if(data.jenisCuti) {
            elJenis.value = data.jenisCuti;
        }
        elJenis.disabled = false;

        elMulai.value = data.tglMulai || '';
        elSelesai.value = data.tglSelesai || '';
        elHari.value = data.jmlHari || '';

        const linkDiv = document.getElementById('currentDocLink');
        if(data.fileUrl && data.fileUrl.startsWith('http')) {
            linkDiv.innerHTML = `<button type="button" class="view-doc-btn" onclick="App.showFilePreview('${data.fileUrl}')"><i class="fas fa-eye"></i> Lihat Dokumen Saat Ini</button>`;
        } else {
            linkDiv.innerHTML = '<span style="color:#aaa;">Belum ada dokumen.</span>';
        }

    }).withFailureHandler(err => {
        if(skeleton) skeleton.style.display = 'none';
        App.showAppModal('error', err.message);
    }).getSiabaCutiEditData(params.idCuti);

    // 4. Submit Update
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnEditCuti');
        const fileInput = document.getElementById('fileCutiEdit');
        
        if (fileInput.files.length > 0 && fileInput.files[0].size > 100 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 100 KB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Menyimpan Perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        delete formData.fileData; 

        const sendData = (payload) => {
             google.script.run.withSuccessHandler(res => {
                if(res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    App.showAppModal('success', res, 'siaba_cuti_cek');
                }
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).updateSiabaCutiData(payload);
        };

        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                formData.fileData = {
                    fileName: fileInput.files[0].name,
                    mimeType: fileInput.files[0].type,
                    data: ev.target.result.split(',')[1]
                };
                sendData(formData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            sendData(formData);
        }
    });
}

function initSiabaDataCutiPage() {
    const filterTahun = document.getElementById('filterTahunData');
    const filterUnit = document.getElementById('filterUnitData');
    const searchInput = document.getElementById('searchDataCuti');
    
    // Elemen Overlay
    const tableWrapper = document.getElementById('tableWrapperDataCuti');
    const tableOverlay = document.getElementById('tableOverlayLoaderDataCuti');
    
    const tableBody = document.getElementById('dataCutiTable').querySelector('tbody');
    const tableHead = document.getElementById('dataCutiTable').querySelector('thead');
    
    let allRows = [];

    // Toggle Overlay
    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderHeader(headers) {
        tableHead.innerHTML = '';
        const row1 = headers[0]; 
        const row2 = headers[1]; 
        
        let tr1 = document.createElement('tr');
        let tr2 = document.createElement('tr');
        
        // Kolom No.
        let thNo = document.createElement('th');
        thNo.textContent = "No.";
        thNo.rowSpan = 2; 
        thNo.style.width = "50px";
        thNo.style.minWidth = "50px";
        thNo.style.maxWidth = "50px";
        tr1.appendChild(thNo);
        
        let skipCol = new Array(row1.length).fill(false);

        for (let i = 0; i < row1.length; i++) {
            if (skipCol[i]) continue;

            const text1 = row1[i];
            const text2 = row2[i];
            let th = document.createElement('th');
            th.textContent = text1;

            if (text1 && !text2) {
                th.rowSpan = 2;
                tr1.appendChild(th);
            }
            else if (text1 && text2) {
                let span = 1;
                for (let j = i + 1; j < row1.length; j++) {
                    if (!row1[j] && row2[j]) { 
                        span++;
                        skipCol[j] = true; 
                    } else {
                        break; 
                    }
                }
                if (span > 1) th.colSpan = span;
                // Background color dihapus agar ikut CSS
                tr1.appendChild(th);

                let subTh = document.createElement('th');
                subTh.textContent = text2;
                tr2.appendChild(subTh);
                
                for (let k = 1; k < span; k++) {
                    let nextSubTh = document.createElement('th');
                    nextSubTh.textContent = row2[i + k];
                    tr2.appendChild(nextSubTh);
                }
            } 
            else {
                th.rowSpan = 1; 
                tr1.appendChild(th);
                if(text2) {
                    let subTh = document.createElement('th');
                    subTh.textContent = text2;
                    tr2.appendChild(subTh);
                }
            }
        }

        tableHead.appendChild(tr1);
        if (tr2.children.length > 0) {
            tableHead.appendChild(tr2);
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="15" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            
            // Kolom No.
            let tdNo = document.createElement('td');
            tdNo.textContent = idx + 1;
            tr.appendChild(tdNo);
            
            row.forEach(cell => {
                // LOGIKA PENGGANTIAN NILAI 0/- MENJADI '-'
                let cellContent = cell;
                if (cell === '' || cell == null || cell == 0 || cell === '0') {
                    cellContent = '-';
                }
                const td = document.createElement('td');
                td.textContent = cellContent;
                tr.appendChild(td);
            });
            
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const year = filterTahun.value;
        const unit = filterUnit.value || "Semua";
        if (!year) return;

        toggleLoader(true);
        
        google.script.run.withSuccessHandler(res => {
            if (res.error) {
                tableBody.innerHTML = `<tr><td colspan="15" style="color:red; text-align:center;">${res.error}</td></tr>`;
                toggleLoader(false);
                return;
            }

            const currentUnit = filterUnit.value;
            filterUnit.innerHTML = '';
            filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
            res.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (res.units.includes(currentUnit)) filterUnit.value = currentUnit;
            else filterUnit.value = "Semua";

            if (res.headers) {
                renderHeader(res.headers);
            }

            allRows = res.rows;
            filterAndRender();
            toggleLoader(false);

        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="15" style="color:red;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaDataCutiTable(year, unit);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(row => 
            String(row[0] || "").toLowerCase().includes(query) || 
            String(row[1] || "").toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(years => {
        filterTahun.innerHTML = '';
        if (!years || years.length === 0) {
            filterTahun.add(new Option("Tidak ada data", ""));
            toggleLoader(false);
            return;
        }
        
        const currentYear = new Date().getFullYear().toString();
        years.forEach(y => filterTahun.add(new Option(y, y)));
        
        if (years.includes(currentYear)) filterTahun.value = currentYear;
        else filterTahun.selectedIndex = 0;

        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';

        filterTahun.addEventListener('change', fetchData);
        filterUnit.addEventListener('change', fetchData);
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getSiabaDataCutiYears();
}

function initSiabaCutiUnggahPage() {
    const form = document.getElementById('cutiUnggahForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    // Element Form
    const unitSelect = document.getElementById('unitKerjaUnggah');
    const namaSelect = document.getElementById('namaAsnUnggah');
    const nipInput = document.getElementById('nipUnggah');
    const statusSelect = document.getElementById('statusUnggah');
    const jenisSelect = document.getElementById('jenisCutiUnggah');
    
    const elMulai = document.getElementById('tglMulaiUnggah');
    const elSelesai = document.getElementById('tglSelesaiUnggah');
    const elHari = document.getElementById('jmlHariUnggah');

    if (!form) return;

    // Reset Form & Tampilkan Loader
    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';
    
    // Reset Dropdown Unit agar bersih
    if(unitSelect) unitSelect.innerHTML = '<option value="" disabled selected>-- Memuat... --</option>';

    let employeeData = [];

    // 1. Load Options (Unit, Nama, NIP)
    google.script.run
        .withSuccessHandler(data => {
            // Sembunyikan Loader & Tampilkan Form
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block';

            // Cek Error Server
            if (data.error) { 
                App.showAppModal('error', data.error); 
                return; 
            }
            
            // Cek Data Kosong
            if (!data || data.length === 0) {
                if(unitSelect) unitSelect.innerHTML = '<option value="" disabled selected>-- Data Kosong --</option>';
                // Optional: App.showAppModal('error', 'Data Database Cuti kosong.');
                return;
            }

            employeeData = data;
            
            // Isi Dropdown Unit Kerja
            const units = [...new Set(data.map(item => item.unit))].sort();
            
            if(unitSelect) {
                unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
                units.forEach(u => unitSelect.add(new Option(u, u)));
            }

        })
        .withFailureHandler(err => {
            // Handler Error Koneksi/Script
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block'; // Tetap tampilkan form meski error (biar user tau)
            if(unitSelect) unitSelect.innerHTML = '<option value="" disabled selected>-- Gagal Memuat --</option>';
            App.showAppModal('error', 'Gagal memuat data: ' + err.message);
        })
        .getSiabaCutiDatabaseOptions();

    // 2. Dropdown Bertingkat (Unit -> Nama -> NIP)
    if(unitSelect) {
        unitSelect.addEventListener('change', function() {
            const unit = this.value;
            const filtered = employeeData.filter(e => e.unit === unit);
            filtered.sort((a, b) => a.nama.localeCompare(b.nama));

            namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
            filtered.forEach(emp => {
                const opt = new Option(emp.nama, emp.nama);
                opt.dataset.nip = emp.nip;
                namaSelect.add(opt);
            });
            namaSelect.disabled = false;
            nipInput.value = "";
        });
    }

    if(namaSelect) {
        namaSelect.addEventListener('change', function() {
            const opt = this.options[this.selectedIndex];
            if (opt.dataset.nip) nipInput.value = opt.dataset.nip;
        });
    }

    // 3. Dropdown Status -> Jenis Cuti
    if(statusSelect) {
        statusSelect.addEventListener('change', function() {
            const status = this.value;
            jenisSelect.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
            
            let opts = [];
            if (status === 'PNS') {
                opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Alasan Penting', 'Cuti Melahirkan', 'Cuti Besar'];
            } else if (status === 'PPPK') {
                opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Melahirkan'];
            }
            
            opts.forEach(o => jenisSelect.add(new Option(o, o)));
            jenisSelect.disabled = false;
        });
    }

    // 4. Kalkulasi Hari & Validasi Tanggal
    function calculateDays() {
        if (elMulai.value && elSelesai.value) {
            if (elSelesai.value < elMulai.value) elSelesai.value = elMulai.value;
            const diff = Math.ceil(Math.abs(new Date(elSelesai.value) - new Date(elMulai.value)) / (1000 * 60 * 60 * 24)) + 1;
            elHari.value = diff;
        }
    }
    
    if(elMulai) {
        elMulai.addEventListener('change', () => {
            elSelesai.min = elMulai.value;
            calculateDays();
        });
    }
    if(elSelesai) elSelesai.addEventListener('change', calculateDays);

    // 5. Submit Form
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnUnggahCuti');
        const fileInput = document.getElementById('fileCuti');
        
        // UBAH BATASAN JADI 100 KB
        if (fileInput.files[0].size > 100 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 100 KB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim data...');

        const formData = Object.fromEntries(new FormData(form));
        
        const reader = new FileReader();
        reader.onload = function(ev) {
            formData.fileData = {
                fileName: fileInput.files[0].name,
                mimeType: fileInput.files[0].type,
                data: ev.target.result.split(',')[1]
            };

            google.script.run.withSuccessHandler(res => {
                if (res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    App.showAppModal('success', res, 'siaba_cuti_cek'); 
                }
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).submitSiabaCutiUnggahForm(formData);
        };
        reader.readAsDataURL(fileInput.files[0]);
    });
}

function initSiabaCutiCekPage() {
    const filterTahun = document.getElementById('filterTahunCekCuti');
    const filterBulan = document.getElementById('filterBulanCekCuti');
    const filterUnit = document.getElementById('filterUnitCekCuti');
    const searchInput = document.getElementById('searchCekCuti');
    
    const tableWrapper = document.getElementById('tableWrapperCekCuti');
    const tableOverlay = document.getElementById('tableOverlayLoaderCekCuti');
    const tableBody = document.getElementById('cekCutiTable').querySelector('tbody');
    
    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`;
            html += `<td>${row.nama}</td>`;
            html += `<td>${row.nip}</td>`;
            html += `<td>${row.jenis}</td>`;
            html += `<td>${row.mulai}</td>`;
            html += `<td>${row.selesai}</td>`;
            html += `<td>${row.jml}</td>`;
            
            // Formulir
            let fileBtn = '-';
            if (row.fileUrl && row.fileUrl.startsWith('http')) {
                // Menggunakan class 'action-btn btn-blue' agar seragam
                fileBtn = `<button class="action-btn btn-blue" onclick="App.showFilePreview('${row.fileUrl}')"><i class="fas fa-eye"></i> Lihat</button>`;
            }
            html += `<td>${fileBtn}</td>`;

            // Status
            let statusHtml = '';
            if (row.status === 'Disetujui') statusHtml = '<span class="status-ok"><i class="fas fa-check-circle"></i> Disetujui</span>';
            else if (row.status === 'Ditolak') statusHtml = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
            else if (row.status === 'Revisi') statusHtml = '<span class="status-revisi"><i class="fas fa-exclamation-triangle"></i> Revisi</span>';
            else statusHtml = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
            html += `<td>${statusHtml}</td>`;

            html += `<td>${row.ket}</td>`;
            
            // Aksi (HANYA DEKLARASI SEKALI)
            const canEdit = (row.status === 'Diproses' || row.status === 'Revisi');
            const rowInfo = JSON.stringify({ _source: 'CEKCUTI', _rowIndex: row._rowIndex, Nama: row.nama }).replace(/'/g, "&#39;");
            
            let editBtn = '';
            if(canEdit && row.id) {
                editBtn = `<button class="action-btn btn-edit" onclick="App.loadPage(event, 'siaba_cuti_edit', {idCuti: '${row.id}'})"><i class="fas fa-pencil-alt" style="margin-right:4px;"></i> Edit</button>`;
            } else {
                editBtn = `<button class="action-btn btn-edit" disabled style="opacity:0.5; cursor:not-allowed;"><i class="fas fa-pencil-alt" style="margin-right:4px;"></i> Edit</button>`;
            }

            const delBtn = `<button class="action-btn btn-delete" onclick="App.showDeleteConfirmation(this)" data-row-info='${rowInfo}'><i class="fas fa-trash" style="margin-right:4px;"></i> Hapus</button>`;
            
            html += `<td><div class="action-buttons">${editBtn}${delBtn}</div></td>`;

            html += `<td>${row.tglAju}</td>`;
            html += `<td>${row.update}</td>`;

            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnit.value
        };
        toggleLoader(true);
        google.script.run.withSuccessHandler(data => {
            allRows = data; 
            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="13" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaCutiCekData(filters);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(r => 
            String(r.nama).toLowerCase().includes(query) || 
            String(r.nip).toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(opts => {
        if(opts.error) { App.showAppModal('error', opts.error); toggleLoader(false); return; }

        const now = new Date();
        const curYear = now.getFullYear().toString();
        const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const curMonth = mNames[now.getMonth()];

        const addOpt = (el, v) => el.add(new Option(v, v));
        
        filterTahun.innerHTML = '';
        opts.tahun.forEach(t => addOpt(filterTahun, t));
        if(opts.tahun.includes(curYear)) filterTahun.value = curYear;

        filterBulan.innerHTML = '';
        filterBulan.add(new Option("Semua Bulan", "Semua"));
        opts.bulan.forEach(b => addOpt(filterBulan, b));
        filterBulan.value = "Semua";

        filterUnit.innerHTML = '';
        filterUnit.add(new Option("Semua Unit Kerja", "Semua"));
        opts.unit.forEach(u => addOpt(filterUnit, u));

        [filterTahun, filterBulan, filterUnit].forEach(el => el.addEventListener('change', fetchData));
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getSiabaCutiCekFilterOptions();
}

// --- FUNGSI BARU V2 ---
function initSiabaCutiEditPage_v2(params) {
    const form = document.getElementById('cutiEditForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.idCuti) {
        App.showAppModal('error', 'Parameter ID Salah.');
        return;
    }

    form.idCuti.value = params.idCuti;
    
    const elUnit = document.getElementById('unitKerjaEdit');
    const elNama = document.getElementById('namaAsnEdit');
    const elNip = document.getElementById('nipEdit');
    const elStatus = document.getElementById('statusEdit');
    const elJenis = document.getElementById('jenisCutiEdit');
    const elMulai = document.getElementById('tglMulaiEdit');
    const elSelesai = document.getElementById('tglSelesaiEdit');
    const elHari = document.getElementById('jmlHariEdit');

    // Helper Parse Date Client Side (dd mmmm yyyy -> yyyy-mm-dd)
    function convertIndoDate(str) {
        if(!str) return "";
        const mNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const parts = str.split(' '); 
        if(parts.length >= 3) {
            const d = parts[0].padStart(2,'0');
            const mIdx = mNames.indexOf(parts[1]) + 1;
            const m = String(mIdx).padStart(2,'0');
            const y = parts[2];
            return `${y}-${m}-${d}`;
        }
        return "";
    }

    // Logic Dropdown
    function updateJenisCuti(status) {
        elJenis.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        let opts = [];
        if (status === 'PNS') opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Alasan Penting', 'Cuti Melahirkan', 'Cuti Besar'];
        else if (status === 'PPPK') opts = ['Cuti Tahunan', 'Cuti Sakit', 'Cuti Melahirkan'];
        opts.forEach(o => elJenis.add(new Option(o, o)));
    }
    elStatus.addEventListener('change', () => { updateJenisCuti(elStatus.value); elJenis.disabled = false; });

    // Logic Hari
    function calculateDays() {
        if (elMulai.value && elSelesai.value) {
            if (elSelesai.value < elMulai.value) elSelesai.value = elMulai.value;
            const diff = Math.ceil(Math.abs(new Date(elSelesai.value) - new Date(elMulai.value)) / (1000 * 60 * 60 * 24)) + 1;
            elHari.value = diff;
        }
    }
    elMulai.addEventListener('change', calculateDays);
    elSelesai.addEventListener('change', calculateDays);

    // Load Data
    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    // PANGGIL FUNGSI V2
    google.script.run.withSuccessHandler(data => {
        if(skeleton) skeleton.style.display = 'none';
        form.style.display = 'block';

        if(!data) { App.showAppModal('error', 'Data kosong.'); return; }

        // Debug Alert (Bisa dihapus jika sudah sukses)
        // alert("Data Masuk:\n" + JSON.stringify(data));

        // Isi Form
        document.getElementById('existingFileUrlEdit').value = data.fileUrl || '';
        elUnit.value = data.unitKerja || '';
        elNama.value = data.namaAsn || '';
        elNip.value = data.nip || '';

        elStatus.value = data.status || '';
        updateJenisCuti(data.status);
        if(data.jenisCuti) elJenis.value = data.jenisCuti;
        elJenis.disabled = false;

        // Parse Tanggal dari Server (String Indo) ke Input Date (HTML)
        elMulai.value = convertIndoDate(data.tglMulai);
        elSelesai.value = convertIndoDate(data.tglSelesai);
        elHari.value = data.jmlHari || '';

        // Dokumen
        const linkDiv = document.getElementById('currentDocLink');
        if(data.fileUrl && data.fileUrl.startsWith('http')) {
            linkDiv.innerHTML = `<button type="button" class="view-doc-btn" onclick="App.showFilePreview('${data.fileUrl}')"><i class="fas fa-eye"></i> Lihat Dokumen</button>`;
        } else {
            linkDiv.innerHTML = '<span style="color:#aaa;">Tidak ada dokumen.</span>';
        }

    }).withFailureHandler(err => {
        if(skeleton) skeleton.style.display = 'none';
        App.showAppModal('error', 'Gagal: ' + err.message);
    }).getSiabaCutiEditData_v2(params.idCuti);

    // Submit
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnEditCuti');
        const fileInput = document.getElementById('fileCutiEdit');
        
        if (fileInput.files.length > 0 && fileInput.files[0].size > 100 * 1024) {
            App.showAppModal('error', 'Ukuran file > 100 KB.'); return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Menyimpan...');
        
        const formData = Object.fromEntries(new FormData(form));
        delete formData.fileData;
        
        // Kirim kembali Nama ASN agar penamaan file di server aman
        formData.namaAsn = elNama.value; 

        const sendData = (payload) => {
             google.script.run.withSuccessHandler(res => {
                App.showAppModal('success', res, 'siaba_cuti_cek');
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).updateSiabaCutiData_v2(payload);
        };

        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                formData.fileData = {
                    fileName: fileInput.files[0].name,
                    mimeType: fileInput.files[0].type,
                    data: ev.target.result.split(',')[1]
                };
                sendData(formData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            sendData(formData);
        }
    });
}

function initSiabaRekapTerlambatPage() {
    const filterTahun = document.getElementById('filterTahunRekapTelat');
    const filterUnit = document.getElementById('filterUnitRekapTelat');
    const searchInput = document.getElementById('searchRekapTelat');
    
    const loader = document.getElementById('loadingRekapTelat');
    const wrapper = document.getElementById('wrapperRekapTelat');
    
    const table = document.getElementById('rekapTelatTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    
    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            loader.style.display = 'flex';
            wrapper.style.display = 'flex'; // Tetap tampilkan wrapper (di bawah overlay)
        } else {
            loader.style.display = 'none';
        }
    }

    // Render Header Dinamis (Copy logic from Cuti Data)
    function renderHeader(headers) {
        thead.innerHTML = '';
        if (!headers || headers.length < 2) return;

        const row1 = headers[0];
        const row2 = headers[1];
        
        let tr1 = document.createElement('tr');
        let tr2 = document.createElement('tr');
        
        // Insert Kolom No.
        let thNo = document.createElement('th');
        thNo.textContent = "No.";
        thNo.rowSpan = 2;
        thNo.style.width = "50px"; thNo.style.minWidth = "50px"; thNo.style.maxWidth = "50px";
        tr1.appendChild(thNo);

        let skipCol = new Array(row1.length).fill(false);

        for (let i = 0; i < row1.length; i++) {
            if (skipCol[i]) continue;
            const t1 = row1[i];
            const t2 = row2[i];
            let th = document.createElement('th');
            th.textContent = t1;

            if (t1 && !t2) { // Rowspan
                th.rowSpan = 2;
                tr1.appendChild(th);
            } else if (t1 && t2) { // Colspan check
                let span = 1;
                for (let j = i + 1; j < row1.length; j++) {
                    if (!row1[j] && row2[j]) { span++; skipCol[j] = true; } 
                    else break;
                }
                if (span > 1) th.colSpan = span;
                tr1.appendChild(th);
                
                let subTh = document.createElement('th');
                subTh.textContent = t2;
                tr2.appendChild(subTh);
                for (let k = 1; k < span; k++) {
                    let nSub = document.createElement('th');
                    nSub.textContent = row2[i + k];
                    tr2.appendChild(nSub);
                }
            } else {
                th.rowSpan = 1; tr1.appendChild(th);
                if (t2) {
                    let subTh = document.createElement('th');
                    subTh.textContent = t2;
                    tr2.appendChild(subTh);
                }
            }
        }
        thead.appendChild(tr1);
        if (tr2.children.length > 0) thead.appendChild(tr2);
    }

    function renderTable(rows) {
        tbody.innerHTML = '';
        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="30" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            // No
            let tdNo = document.createElement('td');
            tdNo.textContent = idx + 1;
            tr.appendChild(tdNo);

            // Data
            row.forEach(cell => {
                const val = (cell === "" || cell == null || cell == 0 || cell === '0') ? "-" : cell;
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function fetchData() {
        const year = filterTahun.value;
        const unit = filterUnit.value || "Semua";
        if (!year) return;

        toggleLoader(true);
        
        google.script.run.withSuccessHandler(res => {
            if (res.error) {
                tbody.innerHTML = `<tr><td colspan="30" style="color:red; padding:20px;">${res.error}</td></tr>`;
                toggleLoader(false);
                return;
            }

            // Isi Filter Unit
            const curUnit = filterUnit.value;
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            res.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (res.units.includes(curUnit)) filterUnit.value = curUnit;

            // Render
            renderHeader(res.headers);
            allRows = res.rows;
            filterAndRender();
            toggleLoader(false);

        }).withFailureHandler(err => {
            tbody.innerHTML = `<tr><td colspan="30" style="color:red;">${err.message}</td></tr>`;
            toggleLoader(false);
        }).getRekapTerlambatData(year, unit);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        // Filter di Client (Cari di semua kolom)
        const filtered = allRows.filter(row => 
            row.some(cell => String(cell).toLowerCase().includes(query))
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(years => {
        filterTahun.innerHTML = '';
        if (!years || years.length === 0) {
            filterTahun.add(new Option("Tidak ada data", ""));
            toggleLoader(false);
            return;
        }
        
        const curYear = new Date().getFullYear().toString();
        years.forEach(y => filterTahun.add(new Option(y, y)));
        
        if (years.includes(curYear)) filterTahun.value = curYear;
        else filterTahun.selectedIndex = 0;

        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';

        filterTahun.addEventListener('change', fetchData);
        filterUnit.addEventListener('change', fetchData);
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getRekapTerlambatOptions();
}

function initSiabaRekapPulangAwalPage() {
    const filterTahun = document.getElementById('filterTahunRekapPulang');
    const filterUnit = document.getElementById('filterUnitRekapPulang');
    const searchInput = document.getElementById('searchRekapPulang');
    
    const loader = document.getElementById('loadingRekapPulang');
    const wrapper = document.getElementById('wrapperRekapPulang');
    
    const table = document.getElementById('rekapPulangTable');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    
    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            loader.style.display = 'flex';
            wrapper.style.display = 'flex';
        } else {
            loader.style.display = 'none';
        }
    }

    // Render Header (Sama dengan Rekap Terlambat)
    function renderHeader(headers) {
        thead.innerHTML = '';
        if (!headers || headers.length < 2) return;

        const row1 = headers[0];
        const row2 = headers[1];
        let tr1 = document.createElement('tr');
        let tr2 = document.createElement('tr');
        
        let thNo = document.createElement('th');
        thNo.textContent = "No."; thNo.rowSpan = 2;
        thNo.style.width = "50px"; thNo.style.minWidth = "50px";
        tr1.appendChild(thNo);

        let skipCol = new Array(row1.length).fill(false);
        for (let i = 0; i < row1.length; i++) {
            if (skipCol[i]) continue;
            const t1 = row1[i];
            const t2 = row2[i];
            let th = document.createElement('th');
            th.textContent = t1;

            if (t1 && !t2) { 
                th.rowSpan = 2; tr1.appendChild(th);
            } else if (t1 && t2) { 
                let span = 1;
                for (let j = i + 1; j < row1.length; j++) {
                    if (!row1[j] && row2[j]) { span++; skipCol[j] = true; } else break;
                }
                if (span > 1) th.colSpan = span;
                tr1.appendChild(th);
                
                let subTh = document.createElement('th');
                subTh.textContent = t2; tr2.appendChild(subTh);
                for (let k = 1; k < span; k++) {
                    let nSub = document.createElement('th');
                    nSub.textContent = row2[i + k]; tr2.appendChild(nSub);
                }
            } else {
                th.rowSpan = 1; tr1.appendChild(th);
                if (t2) {
                    let subTh = document.createElement('th');
                    subTh.textContent = t2; tr2.appendChild(subTh);
                }
            }
        }
        thead.appendChild(tr1);
        if (tr2.children.length > 0) thead.appendChild(tr2);
    }

    function renderTable(rows) {
        tbody.innerHTML = '';
        if (rows.length === 0) {
            tbody.innerHTML = `<tr><td colspan="30" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let tdNo = document.createElement('td');
            tdNo.textContent = idx + 1;
            tr.appendChild(tdNo);

            row.forEach(cell => {
                const val = (cell === "" || cell == null || cell == 0 || cell === '0') ? "-" : cell;
                const td = document.createElement('td');
                td.textContent = val;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    function fetchData() {
        const year = filterTahun.value;
        const unit = filterUnit.value || "Semua";
        if (!year) return;

        toggleLoader(true);
        
        google.script.run.withSuccessHandler(res => {
            if (res.error) {
                tbody.innerHTML = `<tr><td colspan="30" style="color:red; padding:20px;">${res.error}</td></tr>`;
                toggleLoader(false);
                return;
            }

            const curUnit = filterUnit.value;
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            res.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (res.units.includes(curUnit)) filterUnit.value = curUnit;

            renderHeader(res.headers);
            allRows = res.rows;
            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tbody.innerHTML = `<tr><td colspan="30" style="color:red;">${err.message}</td></tr>`;
            toggleLoader(false);
        }).getRekapPulangAwalData(year, unit);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(row => row.some(cell => String(cell).toLowerCase().includes(query)));
        renderTable(filtered);
    }

    toggleLoader(true);
    google.script.run.withSuccessHandler(years => {
        filterTahun.innerHTML = '';
        if (!years || years.length === 0) {
            filterTahun.add(new Option("Tidak ada data", ""));
            toggleLoader(false);
            return;
        }
        
        const curYear = new Date().getFullYear().toString();
        years.forEach(y => filterTahun.add(new Option(y, y)));
        
        if (years.includes(curYear)) filterTahun.value = curYear;
        else filterTahun.selectedIndex = 0;

        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';

        filterTahun.addEventListener('change', fetchData);
        filterUnit.addEventListener('change', fetchData);
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getRekapPulangAwalOptions();
}

function initSiabaUnduhRekapPage() {
    const breadcrumbEl = document.getElementById('rekapBreadcrumb');
    const gridEl = document.getElementById('rekapGrid');
    const loader = document.getElementById('rekapLoader');
    
    // State untuk navigasi (Stack of objects: {id, name})
    let navHistory = []; 

    // Fungsi Utama: Load Folder
    function loadFolder(folderId, folderName, isPush = true) {
        // UI Loading
        gridEl.style.display = 'none';
        loader.style.display = 'flex';
        
        google.script.run.withSuccessHandler(data => {
            // Update History
            if (data.isRoot) {
                navHistory = [{ id: null, name: 'Home' }];
            } else if (isPush) {
                navHistory.push({ id: data.currentId, name: data.currentName });
            }
            
            renderBreadcrumb();
            renderGrid(data.folders, data.files);
            
            loader.style.display = 'none';
            gridEl.style.display = 'grid';
        }).withFailureHandler(err => {
            loader.style.display = 'none';
            gridEl.innerHTML = `<p style="color:red; text-align:center; width:100%;">Error: ${err.message}</p>`;
            gridEl.style.display = 'block';
        }).getSiabaRekapArchiveContent(folderId);
    }

    // Render Breadcrumb
    function renderBreadcrumb() {
        breadcrumbEl.innerHTML = '';
        navHistory.forEach((item, index) => {
            const li = document.createElement('li');
            if (index === navHistory.length - 1) {
                // Item Terakhir (Aktif) - Teks biasa
                li.textContent = item.name;
                li.style.color = '#ecf0f1';
            } else {
                // Item Link - Klik untuk mundur
                const a = document.createElement('a');
                a.textContent = item.name;
                a.onclick = (e) => {
                    e.preventDefault();
                    // Potong history sampai index ini
                    navHistory = navHistory.slice(0, index + 1);
                    // Load (isPush = false karena kita mundur, tidak nambah history baru)
                    loadFolder(item.id, item.name, false); 
                };
                li.appendChild(a);
            }
            breadcrumbEl.appendChild(li);
        });
    }

    // Render Grid (Folder & File)
    function renderGrid(folders, files) {
        gridEl.innerHTML = '';
        
        if (folders.length === 0 && files.length === 0) {
            gridEl.innerHTML = `<p style="color:#bdc3c7; text-align:center; width:100%; grid-column: 1/-1; padding-top:20px;">Folder kosong.</p>`;
            return;
        }

        // 1. Render Folders
        folders.forEach(f => {
            const div = document.createElement('div');
            div.className = 'grid-item';
            div.onclick = () => loadFolder(f.id, f.name);
            div.innerHTML = `
                <div class="item-icon icon-folder"><i class="fas fa-folder"></i></div>
                <div class="item-name">${f.name}</div>
            `;
            gridEl.appendChild(div);
        });

        // 2. Render Files
        files.forEach(f => {
            const div = document.createElement('div');
            div.className = 'grid-item';
            // Klik file -> Preview
            div.onclick = () => App.showFilePreview(f.url);
            div.innerHTML = `
                <div class="item-icon icon-pdf"><i class="fas fa-file-pdf"></i></div>
                <div class="item-name">${f.name}</div>
            `;
            gridEl.appendChild(div);
        });
    }

    // Init Load (Root)
    loadFolder(null, 'Home');
}

function initAsnSkpUnggahPage() {
    const form = document.getElementById('skpUnggahForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    // Elements
    const unitSelect = document.getElementById('unitKerjaSkp');
    const namaSelect = document.getElementById('namaAsnSkp');
    const nipInput = document.getElementById('nipSkp');
    const tahunSelect = document.getElementById('tahunSkp');

    if (!form) return;

    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    let employeeData = [];

    // 1. Load Data Pegawai
    google.script.run.withSuccessHandler(data => {
        if (data.error) { App.showAppModal('error', data.error); return; }
        employeeData = data;
        
        const units = [...new Set(data.map(item => item.unit))].sort();
        unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
        units.forEach(u => unitSelect.add(new Option(u, u)));
        
        // Setup Tahun (2022 - Tahun Depan)
        const currentYear = new Date().getFullYear();
        tahunSelect.innerHTML = '';
        for (let y = 2022; y <= currentYear + 1; y++) {
            const opt = new Option(y, y);
            if (y === currentYear) opt.selected = true;
            tahunSelect.add(opt);
        }

        if(skeleton) skeleton.style.display = 'none';
        form.style.display = 'block';
    }).withFailureHandler(err => {
        App.showAppModal('error', 'Gagal memuat data: ' + err.message);
    }).getSiabaSkpOptions();

    // 2. Listener Unit -> Nama
    unitSelect.addEventListener('change', function() {
        const unit = this.value;
        const filtered = employeeData.filter(e => e.unit === unit);
        filtered.sort((a, b) => a.nama.localeCompare(b.nama));

        namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
        filtered.forEach(emp => {
            const opt = new Option(emp.nama, emp.nama);
            opt.dataset.nip = emp.nip;
            namaSelect.add(opt);
        });
        namaSelect.disabled = false;
        nipInput.value = "";
    });

    // 3. Listener Nama -> NIP
    namaSelect.addEventListener('change', function() {
        const opt = this.options[this.selectedIndex];
        if (opt.dataset.nip) nipInput.value = opt.dataset.nip;
    });

    // 4. Submit
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnSkp');
        const fileInput = document.getElementById('fileSkp');
        
        // Max 1 MB
        if (fileInput.files[0].size > 1 * 1024 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 1 MB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim Data SKP...');

        const formData = Object.fromEntries(new FormData(form));
        
        const reader = new FileReader();
        reader.onload = function(ev) {
            formData.fileData = {
                fileName: fileInput.files[0].name,
                mimeType: fileInput.files[0].type,
                data: ev.target.result.split(',')[1]
            };

            google.script.run.withSuccessHandler(res => {
                if (res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    // PERBAIKAN: Redirect ke halaman 'asn_skp_kelola'
                    App.showAppModal('success', res, 'asn_skp_kelola'); 
                }
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).submitSiabaSkpForm(formData);
        };
        reader.readAsDataURL(fileInput.files[0]);
    });
}

function initAsnSkpKelolaPage() {
    const filterTahun = document.getElementById('filterTahunSkp');
    const filterUnit = document.getElementById('filterUnitSkp');
    const searchInput = document.getElementById('searchSkp');
    
    const tableWrapper = document.getElementById('tableWrapperSkp');
    const tableOverlay = document.getElementById('tableOverlayLoaderSkp');
    const tableBody = document.getElementById('skpTable').querySelector('tbody');
    
    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="12" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`;
            html += `<td>${row.nama}</td>`;
            html += `<td>${row.nip}</td>`;
            html += `<td>${row.statusPeg}</td>`;
            html += `<td>${row.tahun}</td>`;
            
            // Dokumen (Tombol Lihat - Global CSS)
            let fileBtn = '-';
            if (row.fileUrl && row.fileUrl.startsWith('http')) {
                fileBtn = `<button class="action-btn btn-blue" onclick="App.showFilePreview('${row.fileUrl}')"><i class="fas fa-eye"></i> Lihat</button>`;
            }
            html += `<td>${fileBtn}</td>`;

            // Status Cek
            let statusHtml = '';
            const s = row.statusCek;
            if (s === 'Diterima') statusHtml = '<span class="status-ok"><i class="fas fa-check-circle"></i> Diterima</span>';
            else if (s === 'Ditolak') statusHtml = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
            else if (s === 'Revisi') statusHtml = '<span class="status-revisi"><i class="fas fa-exclamation-triangle"></i> Revisi</span>';
            else statusHtml = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
            html += `<td>${statusHtml}</td>`;

            html += `<td>${row.ket}</td>`;
            
            // Aksi
            // Data untuk Hapus
            const rowInfo = JSON.stringify({ 
                _source: 'SKP', 
                _rowIndex: row._rowIndex, 
                _sheetName: row._sheetName, 
                Nama: row.nama 
            }).replace(/'/g, "&#39;");
            
            // LOGIKA EDIT (BARU)
            // Aktif KECUALI jika "Diterima" (sesuai request)
            const canEdit = (s !== 'Diterima'); 
            let editBtn = '';
            
            if(canEdit) {
                // Kirim sheetName dan rowIndex
                editBtn = `<button class="action-btn btn-edit" onclick="App.loadPage(event, 'asn_skp_edit', {sheetName: '${row._sheetName}', rowIndex: ${row._rowIndex}})"><i class="fas fa-pencil-alt"></i> Edit</button>`;
            } else {
                editBtn = `<button class="action-btn btn-edit" disabled style="opacity:0.5; cursor:not-allowed;"><i class="fas fa-pencil-alt"></i> Edit</button>`;
            }

            const delBtn = `<button class="action-btn btn-delete" onclick="App.showDeleteConfirmation(this)" data-row-info='${rowInfo}'><i class="fas fa-trash"></i> Hapus</button>`;
            
            html += `<td><div class="action-buttons">${editBtn}${delBtn}</div></td>`;

            html += `<td>${row.tgl}</td>`;
            html += `<td>${row.update}</td>`;

            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const tahun = filterTahun.value;
        const unit = filterUnit.value;
        if (!tahun) return;

        toggleLoader(true);
        google.script.run.withSuccessHandler(data => {
            allRows = data.rows;
            
            // Isi Filter Unit (Dinamis sesuai tahun terpilih)
            const curUnit = filterUnit.value;
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            data.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (data.units.includes(curUnit)) filterUnit.value = curUnit;

            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="12" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaSkpData(tahun, unit);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(r => 
            String(r.nama).toLowerCase().includes(query) || 
            String(r.nip).toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(years => {
        filterTahun.innerHTML = '';
        if (!years || years.length === 0) {
            filterTahun.add(new Option("Tidak ada data", ""));
            toggleLoader(false);
            return;
        }

        const currentYear = new Date().getFullYear().toString(); // Dapatkan Tahun Ini

        years.forEach(y => filterTahun.add(new Option(y, y)));
        
        // --- LOGIKA BARU: PILIH TAHUN INI SECARA DEFAULT ---
        if (years.includes(currentYear)) {
            filterTahun.value = currentYear;
        } else {
            filterTahun.selectedIndex = 0; // Fallback: Pilih yang paling atas (terbaru)
        }
        // ---------------------------------------------------

        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';

        filterTahun.addEventListener('change', fetchData); 
        filterUnit.addEventListener('change', filterAndRender); 
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        fetchData();
    }).getSiabaSkpYearList();
}

function initAsnSkpEditPage(params) {
    const form = document.getElementById('skpEditForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.sheetName || !params.rowIndex) {
        App.showAppModal('error', 'Parameter Data Salah.');
        return;
    }

    form.rowIndex.value = params.rowIndex;
    form.oldSheetName.value = params.sheetName;
    
    // Elemen
    const tahunSelect = document.getElementById('tahunSkpEdit');
    
    // Setup Tahun (2022 - Tahun Depan)
    const currentYear = new Date().getFullYear();
    tahunSelect.innerHTML = '';
    for (let y = 2022; y <= currentYear + 1; y++) {
        tahunSelect.add(new Option(y, y));
    }

    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    // Load Data
    google.script.run.withSuccessHandler(data => {
        if(skeleton) skeleton.style.display = 'none';
        form.style.display = 'block';

        if (!data) { App.showAppModal('error', 'Data tidak ditemukan.'); return; }

        // Isi Form
        document.getElementById('unitKerjaSkpEdit').value = data.unitKerja || '';
        document.getElementById('namaAsnSkpEdit').value = data.namaAsn || '';
        document.getElementById('nipSkpEdit').value = data.nip || '';
        document.getElementById('statusSkpEdit').value = data.status || 'PNS';
        document.getElementById('existingFileUrlSkp').value = data.fileUrl || '';
        
        // Set Tahun (Trigger change sheet logic jika diubah)
        tahunSelect.value = data.tahun;

        // Dokumen
        const linkDiv = document.getElementById('currentDocLinkSkp');
        if(data.fileUrl && data.fileUrl.startsWith('http')) {
            linkDiv.innerHTML = `<button type="button" class="view-doc-btn" onclick="App.showFilePreview('${data.fileUrl}')"><i class="fas fa-eye"></i> Lihat Dokumen Saat Ini</button>`;
        } else {
            linkDiv.innerHTML = '<span style="color:#aaa;">Belum ada dokumen.</span>';
        }

    }).withFailureHandler(err => {
        if(skeleton) skeleton.style.display = 'none';
        App.showAppModal('error', err.message);
    }).getSiabaSkpEditData(params.sheetName, params.rowIndex);

    // Submit
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnSkpEdit');
        const fileInput = document.getElementById('fileSkpEdit');
        
        if (fileInput.files.length > 0 && fileInput.files[0].size > 1 * 1024 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 1 MB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Menyimpan Perubahan...');
        
        const formData = Object.fromEntries(new FormData(form));
        delete formData.fileData; 

        // Kirim ulang data readonly agar aman
        formData.unitKerja = document.getElementById('unitKerjaSkpEdit').value;
        formData.namaAsn = document.getElementById('namaAsnSkpEdit').value;
        formData.nip = document.getElementById('nipSkpEdit').value;

        const sendData = (payload) => {
             google.script.run.withSuccessHandler(res => {
                App.showAppModal('success', res, 'asn_skp_kelola');
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).updateSiabaSkpData(payload);
        };

        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                formData.fileData = {
                    fileName: fileInput.files[0].name,
                    mimeType: fileInput.files[0].type,
                    data: ev.target.result.split(',')[1]
                };
                sendData(formData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            sendData(formData);
        }
    });
}

function initAsnSkpDaftarKirimPage() {
    const filterUnit = document.getElementById('filterUnitSkpKirim');
    const searchInput = document.getElementById('searchSkpKirim');
    
    const loader = document.getElementById('loaderSkpKirim');
    const tableWrapper = document.getElementById('tableWrapperSkpKirim');
    const tableBody = document.getElementById('skpKirimTable').querySelector('tbody');
    const tableHead = document.getElementById('skpKirimTable').querySelector('thead');

    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(loader) loader.style.display = 'flex';
        } else {
            if(loader) loader.style.display = 'none';
        }
    }

    function renderTable(headers, rows) {
        // 1. Render Header Dinamis
        tableHead.innerHTML = '';
        if (headers.length > 0) {
            let thHtml = '<tr><th>No.</th>'; // Kolom No manual
            headers.forEach(h => thHtml += `<th>${h}</th>`);
            thHtml += '</tr>';
            tableHead.innerHTML = thHtml;
        }

        // 2. Render Body
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            const colCount = headers.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colCount}" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            
            // Kolom No
            tr.innerHTML += `<td>${idx + 1}</td>`;
            
            // Loop Data Kolom (B s/d Terakhir)
            row.forEach((cell, i) => {
                let displayVal = cell;
                
                // LOGIKA IKON (Mulai Kolom D)
                // Di array row ini:
                // Index 0 = Kolom B (Nama)
                // Index 1 = Kolom C (NIP)
                // Index 2+ = Kolom D dst (Data Status)
                if (i >= 2) {
                    const val = String(cell).trim().toUpperCase();
                    if (val === 'V') {
                        displayVal = '<i class="fas fa-check-circle ic-ok" title="Selesai"></i>';
                    } else if (val === 'X') {
                        displayVal = '<i class="fas fa-times-circle ic-no" title="Belum/Salah"></i>';
                    } else if (val === 'R') {
                        displayVal = '<i class="fas fa-exclamation-triangle ic-warn" title="Revisi"></i>';
                    } else if (val === '' || val === null) {
                        displayVal = '<i class="fas fa-clock ic-wait" title="Belum Ada Data"></i>';
                    } else if (val === '#N/A' || val.toLowerCase() === 'error') {
                        displayVal = '-';
                    }
                    // Jika teks lain, tampilkan apa adanya
                }
                
                tr.innerHTML += `<td>${displayVal}</td>`;
            });
            
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const unit = filterUnit.value || "Semua";
        toggleLoader(true);
        
        google.script.run.withSuccessHandler(data => {
            if (data.error) {
                tableBody.innerHTML = `<tr><td colspan="10" style="color:red;">${data.error}</td></tr>`;
                toggleLoader(false);
                return;
            }

            // Populate Filter Unit
            const currentUnit = filterUnit.value;
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            data.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (data.units.includes(currentUnit)) filterUnit.value = currentUnit;

            // Render
            allRows = { headers: data.headers, rows: data.rows }; // Simpan struktur
            filterAndRender();
            toggleLoader(false);

        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="10" style="color:red;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaSkpDaftarKirimData(unit);
    }

    function filterAndRender() {
        if (!allRows.rows) return;
        
        const query = searchInput.value.toLowerCase();
        // Filter hanya pada Nama (Index 0) atau NIP (Index 1)
        const filteredRows = allRows.rows.filter(row => 
            String(row[0]).toLowerCase().includes(query) || 
            String(row[1]).toLowerCase().includes(query)
        );
        renderTable(allRows.headers, filteredRows);
    }

    // Init
    toggleLoader(true);
    // Fetch awal dengan unit 'Semua'
    fetchData();
    
    filterUnit.addEventListener('change', fetchData);
    searchInput.addEventListener('input', App.debounce(filterAndRender, 300));
}

function initAsnPakUnggahPage() {
    const form = document.getElementById('pakUnggahForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    const unitSelect = document.getElementById('unitKerjaPak');
    const namaSelect = document.getElementById('namaAsnPak');
    const nipInput = document.getElementById('nipPak');
    const pangkatSelect = document.getElementById('pangkatPak');
    const jabatanSelect = document.getElementById('jabatanPak');
    const tahunSelect = document.getElementById('tahunPak');
    
    // Elemen Kredit Baru
    const kreditInput = document.getElementById('kreditPak');

    if (!form) return;

    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    let pnsData = [];

    // --- 1. VALIDASI INPUT ANGKA KREDIT (REAL-TIME) ---
    if (kreditInput) {
        kreditInput.addEventListener('input', function(e) {
            let val = this.value;
            
            // A. Ganti titik (.) menjadi koma (,) otomatis
            val = val.replace(/\./g, ',');
            
            // B. Hapus semua karakter KECUALI angka dan koma
            val = val.replace(/[^0-9,]/g, '');
            
            // C. Pastikan hanya ada SATU koma
            const parts = val.split(',');
            if (parts.length > 2) {
                // Gabungkan bagian depan dan belakang koma pertama
                val = parts[0] + ',' + parts.slice(1).join('');
            }
            
            // Update nilai di form
            this.value = val;
        });
    }
    // --------------------------------------------------

    // 2. Load Options
    google.script.run.withSuccessHandler(data => {
        if (data.error) { App.showAppModal('error', data.error); return; }
        
        pnsData = data.pns; 
        
        const units = [...new Set(pnsData.map(item => item.unit))].sort();
        unitSelect.innerHTML = '<option value="" disabled selected>-- Pilih Unit Kerja --</option>';
        units.forEach(u => unitSelect.add(new Option(u, u)));

        pangkatSelect.innerHTML = '<option value="" disabled selected>-- Pilih Pangkat --</option>';
        data.pangkat.forEach(p => pangkatSelect.add(new Option(p, p)));

        jabatanSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jabatan --</option>';
        data.jabatan.forEach(j => jabatanSelect.add(new Option(j, j)));

        tahunSelect.innerHTML = '';
        tahunSelect.add(new Option("-- Pilih Periode PAK --", "", true, true)); 
        tahunSelect.options[0].disabled = true;

        const staticOpts = ['Konvensional', 'Integrasi'];
        staticOpts.forEach(o => tahunSelect.add(new Option(o, o)));
        
        const currentYear = new Date().getFullYear();
        for (let y = 2023; y <= currentYear + 1; y++) {
            tahunSelect.add(new Option(y, y));
        }

        if(skeleton) skeleton.style.display = 'none';
        form.style.display = 'block';

    }).withFailureHandler(err => {
        App.showAppModal('error', 'Gagal memuat data: ' + err.message);
    }).getSiabaPakOptions();

    // 3. Logic Unit -> Nama -> NIP
    unitSelect.addEventListener('change', function() {
        const unit = this.value;
        const filtered = pnsData.filter(e => e.unit === unit);
        filtered.sort((a, b) => a.nama.localeCompare(b.nama));

        namaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Nama --</option>';
        filtered.forEach(emp => {
            const opt = new Option(emp.nama, emp.nama);
            opt.dataset.nip = emp.nip;
            namaSelect.add(opt);
        });
        namaSelect.disabled = false;
        nipInput.value = "";
    });

    namaSelect.addEventListener('change', function() {
        const opt = this.options[this.selectedIndex];
        if (opt.dataset.nip) nipInput.value = opt.dataset.nip;
    });

    // 4. Submit
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnPak');
        const fileInput = document.getElementById('filePak');
        
        if (fileInput.files[0].size > 1 * 1024 * 1024) {
            App.showAppModal('error', 'Ukuran file melebihi 1 MB.');
            return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Mengirim Data PAK...');

        const formData = Object.fromEntries(new FormData(form));
        
        const reader = new FileReader();
        reader.onload = function(ev) {
            formData.fileData = {
                fileName: fileInput.files[0].name,
                mimeType: fileInput.files[0].type,
                data: ev.target.result.split(',')[1]
            };

            google.script.run.withSuccessHandler(res => {
                if (res && res.error) {
                    App.showAppModal('error', res.error);
                    btn.disabled = false;
                } else {
                    App.showAppModal('success', res, 'asn_pak_kelola'); 
                }
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).submitSiabaPakForm(formData);
        };
        reader.readAsDataURL(fileInput.files[0]);
    });
}

function initAsnPakKelolaPage() {
    const filterTahun = document.getElementById('filterTahunPak');
    const filterUnit = document.getElementById('filterUnitPak');
    const searchInput = document.getElementById('searchPak');
    
    const tableWrapper = document.getElementById('tableWrapperPak');
    const tableOverlay = document.getElementById('tableOverlayLoaderPak');
    const tableBody = document.getElementById('pakTable').querySelector('tbody');
    
    let allRows = [];

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(tableOverlay) tableOverlay.style.display = 'flex';
        } else {
            if(tableOverlay) tableOverlay.style.display = 'none';
        }
    }

    function renderTable(rows) {
        tableBody.innerHTML = '';
        if (rows.length === 0) {
            // Colspan 13 (karena unit dihapus)
            tableBody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding:30px;">Tidak ada data.</td></tr>`;
            return;
        }

        rows.forEach((row, idx) => {
            const tr = document.createElement('tr');
            let html = `<td>${idx + 1}</td>`;
            
            // Mapping Kolom:
            html += `<td>${row.nama}</td>`;    // C
            html += `<td>${row.nip}</td>`;     // D
            html += `<td>${row.pangkat}</td>`; // E
            html += `<td>${row.tmt}</td>`;     // F
            html += `<td>${row.jabatan}</td>`; // G
            html += `<td>${row.tahun}</td>`;   // H
            html += `<td>${row.kredit}</td>`;  // I
            
            // Dokumen (J)
            let fileBtn = '-';
            if (row.fileUrl && row.fileUrl.startsWith('http')) {
                fileBtn = `<button class="action-btn btn-blue" onclick="App.showFilePreview('${row.fileUrl}')"><i class="fas fa-eye"></i> Lihat</button>`;
            }
            html += `<td>${fileBtn}</td>`;

            // Status (L)
            let statusHtml = '';
            const s = row.statusCek;
            if (s === 'Diterima') statusHtml = '<span class="status-ok"><i class="fas fa-check-circle"></i> Diterima</span>';
            else if (s === 'Ditolak') statusHtml = '<span class="status-tolak"><i class="fas fa-times-circle"></i> Ditolak</span>';
            else if (s === 'Revisi') statusHtml = '<span class="status-revisi"><i class="fas fa-exclamation-triangle"></i> Revisi</span>';
            else statusHtml = '<span class="status-proses"><i class="fas fa-hourglass-half"></i> Diproses</span>';
            html += `<td>${statusHtml}</td>`;

            // Keterangan (M)
            html += `<td>${row.ket}</td>`;
            
            // Aksi
            const rowInfo = JSON.stringify({ 
                _source: 'PAK', 
                _rowIndex: row._rowIndex, 
                _sheetName: row._sheetName, 
                Nama: row.nama 
            }).replace(/'/g, "&#39;");
            
            const canEdit = (s !== 'Diterima'); 
            let editBtn = '';
            if(canEdit) {
                // Pass sheetName dan ID
                editBtn = `<button class="action-btn btn-edit" onclick="App.loadPage(event, 'asn_pak_edit', {sheetName: '${row._sheetName}', id: '${row.id}', rowIndex: ${row._rowIndex}})"> <i class="fas fa-pencil-alt"></i> Edit</button>`;
            } else {
                editBtn = `<button class="action-btn btn-edit" disabled style="opacity:0.5;"><i class="fas fa-pencil-alt"></i> Edit</button>`;
            }

            const delBtn = `<button class="action-btn btn-delete" onclick="App.showDeleteConfirmation(this)" data-row-info='${rowInfo}'><i class="fas fa-trash"></i> Hapus</button>`;
            
            html += `<td><div class="action-buttons">${editBtn}${delBtn}</div></td>`;

            // PERBAIKAN: Tgl Unggah mengambil row.time (Timestamp)
            html += `<td>${row.time}</td>`;
            
            // Unit Kerja dihapus
            
            // Update (N)
            html += `<td>${row.update}</td>`;

            tr.innerHTML = html;
            tableBody.appendChild(tr);
        });
    }

    function fetchData() {
        const tahun = filterTahun.value;
        const unit = filterUnit.value;
        if (!tahun) return;

        toggleLoader(true);
        google.script.run.withSuccessHandler(data => {
            allRows = data.rows;
            
            const curUnit = filterUnit.value;
            filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
            data.units.forEach(u => filterUnit.add(new Option(u, u)));
            if (data.units.includes(curUnit)) filterUnit.value = curUnit;

            filterAndRender();
            toggleLoader(false);
        }).withFailureHandler(err => {
            tableBody.innerHTML = `<tr><td colspan="14" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
            toggleLoader(false);
        }).getSiabaPakData(tahun, unit);
    }

    function filterAndRender() {
        const query = searchInput.value.toLowerCase();
        const filtered = allRows.filter(r => 
            String(r.nama).toLowerCase().includes(query) || 
            String(r.nip).toLowerCase().includes(query)
        );
        renderTable(filtered);
    }

    // Init
    toggleLoader(true);
    google.script.run.withSuccessHandler(years => {
        filterTahun.innerHTML = '';
        
        // --- LOGIKA DEFAULT TAHUN PAK ---
        const currentYear = new Date().getFullYear().toString();
        let hasCurrentYear = false;

        // Tambahkan Placeholder (Default jika tahun ini tidak ada)
        const placeholder = new Option("-- Pilih --", "");
        filterTahun.add(placeholder);

        if (years && years.length > 0) {
            years.forEach(y => {
                filterTahun.add(new Option(y, y));
                if (String(y) === currentYear) hasCurrentYear = true;
            });
        }

        // Logic Seleksi
        if (hasCurrentYear) {
            filterTahun.value = currentYear;
        } else {
            filterTahun.value = ""; // Pilih "-- Pilih --"
        }
        // --------------------------------

        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';

        filterTahun.addEventListener('change', fetchData); 
        filterUnit.addEventListener('change', filterAndRender); 
        searchInput.addEventListener('input', App.debounce(filterAndRender, 300));

        // Fetch data hanya jika tahun terpilih (valid)
        if (filterTahun.value) {
            fetchData();
        } else {
            // Jika "-- Pilih --", matikan loader, tabel kosong
            toggleLoader(false);
        }
        
    }).getSiabaPakYearList();
}

function initAsnPakEditPage(params) {
    const form = document.getElementById('pakEditForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.sheetName || !params.id) {
        App.showAppModal('error', 'Parameter Data Salah.');
        return;
    }

    form.rowIndex.value = params.rowIndex; // Optional if using ID search in update, but good for consistency
    form.oldSheetName.value = params.sheetName;
    form.idPak.value = params.id;
    
    // Elements
    const pangkatSelect = document.getElementById('pangkatPakEdit');
    const jabatanSelect = document.getElementById('jabatanPakEdit');
    const tahunSelect = document.getElementById('tahunPakEdit');
    const kreditInput = document.getElementById('kreditPakEdit');

    // Logic Kredit (Auto Format)
    if (kreditInput) {
        kreditInput.addEventListener('input', function(e) {
            let val = this.value.replace(/\./g, ',').replace(/[^0-9,]/g, '');
            const parts = val.split(',');
            if (parts.length > 2) val = parts[0] + ',' + parts.slice(1).join('');
            this.value = val;
        });
    }

    if(skeleton) skeleton.style.display = 'block';
    form.style.display = 'none';

    // 1. Load Options
    google.script.run.withSuccessHandler(optData => {
        if (optData.error) { App.showAppModal('error', optData.error); return; }

        pangkatSelect.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        optData.pangkat.forEach(p => pangkatSelect.add(new Option(p, p)));

        jabatanSelect.innerHTML = '<option value="" disabled selected>-- Pilih --</option>';
        optData.jabatan.forEach(j => jabatanSelect.add(new Option(j, j)));

        tahunSelect.innerHTML = '';
        const staticOpts = ['Konvensional', 'Integrasi'];
        staticOpts.forEach(o => tahunSelect.add(new Option(o, o)));
        const currentYear = new Date().getFullYear();
        for (let y = 2023; y <= currentYear + 1; y++) tahunSelect.add(new Option(y, y));

        // 2. Load Data Edit
        google.script.run.withSuccessHandler(data => {
            if(skeleton) skeleton.style.display = 'none';
            form.style.display = 'block';

            if (!data) { App.showAppModal('error', 'Data tidak ditemukan.'); return; }

            // Isi Form
            document.getElementById('unitKerjaPakEdit').value = data.unitKerja || '';
            document.getElementById('namaAsnPakEdit').value = data.namaAsn || '';
            document.getElementById('nipPakEdit').value = data.nip || '';
            document.getElementById('tmtPakEdit').value = data.tmt || '';
            document.getElementById('existingFileUrlPak').value = data.fileUrl || '';
            
            pangkatSelect.value = data.pangkat;
            jabatanSelect.value = data.jabatan;
            tahunSelect.value = data.tahun;
            kreditInput.value = data.kredit;

            // Dokumen
            const linkDiv = document.getElementById('currentDocLinkPak');
            if(data.fileUrl && data.fileUrl.startsWith('http')) {
                linkDiv.innerHTML = `<button type="button" class="view-doc-btn" onclick="App.showFilePreview('${data.fileUrl}')"><i class="fas fa-eye"></i> Lihat Dokumen Saat Ini</button>`;
            } else {
                linkDiv.innerHTML = '<span style="color:#aaa;">Belum ada dokumen.</span>';
            }

        }).withFailureHandler(err => {
            if(skeleton) skeleton.style.display = 'none';
            App.showAppModal('error', err.message);
        }).getSiabaPakEditData(params.sheetName, params.id);

    }).withFailureHandler(err => {
        App.showAppModal('error', 'Gagal opsi: ' + err.message);
    }).getSiabaPakOptions();

    // Submit
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtnPakEdit');
        const fileInput = document.getElementById('filePakEdit');
        
        if (fileInput.files.length > 0 && fileInput.files[0].size > 1 * 1024 * 1024) {
            App.showAppModal('error', 'Ukuran file > 1 MB.'); return;
        }

        btn.disabled = true;
        App.showAppModal('loading', 'Menyimpan Perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        delete formData.fileData; 
        
        // Kirim ulang data readonly
        formData.unitKerja = document.getElementById('unitKerjaPakEdit').value;
        formData.namaAsn = document.getElementById('namaAsnPakEdit').value;
        formData.nip = document.getElementById('nipPakEdit').value;

        const sendData = (payload) => {
             google.script.run.withSuccessHandler(res => {
                App.showAppModal('success', res, 'asn_pak_kelola');
            }).withFailureHandler(err => {
                App.showAppModal('error', err.message);
                btn.disabled = false;
            }).updateSiabaPakData(payload);
        };

        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                formData.fileData = {
                    fileName: fileInput.files[0].name,
                    mimeType: fileInput.files[0].type,
                    data: ev.target.result.split(',')[1]
                };
                sendData(formData);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            sendData(formData);
        }
    });
}

function initAsnPakDaftarKirimPage() {
    const filterUnit = document.getElementById('filterUnitPakKirim');
    const searchInput = document.getElementById('searchPakKirim');
    
    const loader = document.getElementById('loaderPakKirim');
    const tableWrapper = document.getElementById('tableWrapperPakKirim');
    const tableBody = document.getElementById('pakKirimTable').querySelector('tbody');
    const tableHead = document.getElementById('pakKirimTable').querySelector('thead');

    // Simpan data mentah dari server
    let globalData = { headers: [], rows: [] };

    function toggleLoader(show) {
        if(show) {
            if(tableWrapper) tableWrapper.style.display = 'flex';
            if(loader) loader.style.display = 'flex';
        } else {
            if(loader) loader.style.display = 'none';
        }
    }

    function renderTable(headers, rows) {
        // 1. Render Header (Jika belum ada)
        if (tableHead.innerHTML === '' && headers.length > 0) {
            let tr = document.createElement('tr');
            tr.innerHTML = '<th>No.</th>'; 
            headers.forEach(h => tr.innerHTML += `<th>${h}</th>`);
            tableHead.appendChild(tr);
        }

        // 2. Render Body
        tableBody.innerHTML = '';
        
        if (!rows || rows.length === 0) {
            // Hitung jumlah kolom agar pesan rapi
            const colCount = (headers.length > 0 ? headers.length : 10) + 1;
            tableBody.innerHTML = `<tr><td colspan="${colCount}" style="text-align:center; padding:30px;">Tidak ada data untuk ditampilkan.</td></tr>`;
            return;
        }

        const fragment = document.createDocumentFragment();

        rows.forEach((item, idx) => {
            const tr = document.createElement('tr');
            
            // Kolom No
            let tdNo = document.createElement('td');
            tdNo.textContent = idx + 1;
            tr.appendChild(tdNo);
            
            // Data Tampilan (item.d)
            item.d.forEach((cell, i) => {
                let td = document.createElement('td');
                let displayVal = cell;
                
                // LOGIKA IKON (Mulai Kolom D / Index 2)
                if (i >= 2) {
                    const val = String(cell).trim().toUpperCase();
                    if (val === 'V') displayVal = '<i class="fas fa-check-circle ic-ok" title="Selesai"></i>';
                    else if (val === 'X') displayVal = '<i class="fas fa-times-circle ic-no" title="Ditolak"></i>';
                    else if (val === 'R') displayVal = '<i class="fas fa-exclamation-triangle ic-warn" title="Revisi"></i>';
                    else if (!val) displayVal = '<i class="fas fa-clock ic-wait" title="Belum"></i>';
                    else if (val === '#N/A' || val === 'ERROR') displayVal = '-';
                }
                
                td.innerHTML = displayVal;
                tr.appendChild(td);
            });
            
            fragment.appendChild(tr);
        });
        
        tableBody.appendChild(fragment);
    }

    // --- FUNGSI FILTER CLIENT (DIPERBAIKI) ---
    function applyFilter() {
        const unitVal = filterUnit.value;
        const searchVal = searchInput.value.toLowerCase();
        
        // DEBUG (Bisa dihapus nanti)
        // console.log("Filter Unit:", unitVal); 

        if (!globalData.rows) return;

        const filtered = globalData.rows.filter(item => {
            // 1. Filter Unit
            // Loloskan jika: Pilihan "Semua" ATAU Pilihan Kosong ATAU Unit cocok
            const isAll = (unitVal === "Semua" || unitVal === "");
            const matchUnit = isAll || (String(item.u) === String(unitVal));
            
            // 2. Filter Search (Nama/NIP)
            const matchSearch = !searchVal || 
                                String(item.d[0] || "").toLowerCase().includes(searchVal) || 
                                String(item.d[1] || "").toLowerCase().includes(searchVal);

            return matchUnit && matchSearch;
        });

        renderTable(globalData.headers, filtered);
    }

    // --- MAIN INIT ---
    toggleLoader(true);
    
    // Ambil Data dari Server
    google.script.run.withSuccessHandler(res => {
        if (res.error) {
            tableBody.innerHTML = `<tr><td colspan="10" style="color:red;">${res.error}</td></tr>`;
            toggleLoader(false);
            return;
        }

        // 1. Simpan Data
        globalData = res;

        // 2. Isi Dropdown
        const currentUnit = filterUnit.value;
        filterUnit.innerHTML = '<option value="Semua">Semua Unit Kerja</option>';
        res.units.forEach(u => filterUnit.add(new Option(u, u)));
        
        // Restore selection (jika ada dan bukan default)
        // Jika currentUnit kosong/null, otomatis jadi "Semua" karena itu opsi pertama
        if (currentUnit && currentUnit !== "Semua" && res.units.includes(currentUnit)) {
            filterUnit.value = currentUnit;
        } else {
            filterUnit.value = "Semua"; 
        }

        // 3. Render Awal
        applyFilter();
        toggleLoader(false);

    }).withFailureHandler(err => {
        tableBody.innerHTML = `<tr><td colspan="10" style="color:red;">Error: ${err.message}</td></tr>`;
        toggleLoader(false);
    }).getSiabaPakDaftarKirimData(); // Panggil server

    // Event Listeners
    filterUnit.addEventListener('change', applyFilter);
    searchInput.addEventListener('input', App.debounce(applyFilter, 300));
}

/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */

App.processDeletionSkp = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus kosong.'); return; }
    App.showAppModal('loading', 'Menghapus...');
    
    google.script.run.withSuccessHandler(res => {
        document.getElementById('deleteModal').classList.remove('show');
        if(res && res.error) App.showAppModal('error', res.error);
        else App.showAppModal('success', res, reloadPage);
    }).deleteSiabaSkpData(rowInfo._sheetName, rowInfo._rowIndex, deleteCode);
};

// Fungsi Buka Preview (UPDATED)
App.showFilePreview = (url) => {
    const modal = document.getElementById('previewModal');
    const frame = document.getElementById('previewFrame');
    const loading = document.getElementById('previewLoading');
    const downloadBtn = document.getElementById('previewDownloadBtn');
    
    if (!url) {
        App.showAppModal('error', 'URL Dokumen tidak valid.');
        return;
    }

    let previewUrl = url;
    // Convert view -> preview
    if (url.includes('drive.google.com') && url.includes('/view')) {
        previewUrl = url.replace('/view', '/preview');
    }
    
    // Setup Download Button (Gunakan URL asli /view untuk download)
    if (downloadBtn) {
        downloadBtn.href = url;
        downloadBtn.style.display = 'flex';
    }

    modal.classList.add('show');
    loading.style.display = 'flex';
    frame.src = previewUrl;

    frame.onload = () => {
        loading.style.display = 'none';
    };
};

// Fungsi Tutup Preview
App.closePreview = () => {
    const modal = document.getElementById('previewModal');
    const frame = document.getElementById('previewFrame');
    
    modal.classList.remove('show');
    // Reset src agar video/audio/pdf berhenti loading di background
    setTimeout(() => { frame.src = 'about:blank'; }, 300); 
};

App.pageInitializers = {
    'home': initMenuPage,
    'sk_menu': initMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage,
    'lapbul_status': initLapbulStatusPage,
    'lapbul_arsip': initLapbulArsipPage,
    'lapbul_kelola': initLapbulKelolaPage,
    'lapbul_edit_paud': initLapbulEditPaudPage,
    'lapbul_edit_sd': initLapbulEditSdPage,
    'lapbul_unduh_format': initLapbulUnduhFormatPage,
    'ptk_menu': initMenuPage,
    'ptk_paud_menu': initMenuPage,
    'ptk_sd_menu': initMenuPage,
    'ptk_keadaan_paud': initPtkKeadaanPaudPage,
    'ptk_keadaan_sd': initPtkKeadaanSdPage,
    'ptk_jumlah_bulanan_sd': initPtkJumlahBulananSdPage,
    'ptk_jumlah_bulanan_paud': initPtkJumlahBulananPaudPage,
    'ptk_daftar_paud': initPtkDaftarPaudPage,
    'ptk_kelola_paud': initPtkKelolaPaudPage,
    'ptk_tambah_paud': initPtkTambahPaudPage,
    'ptk_edit_paud': initPtkEditPaudPage,
    'ptk_daftar_sd_negeri': initPtkDaftarSdnPage,
    'ptk_daftar_sd_swasta': initPtkDaftarSdsPage,
    'ptk_kelola_sd': initPtkKelolaSdPage,
    'ptk_kebutuhan_sd_negeri': initPtkKebutuhanSdPage,
    'ptk_tambah_sd': initPtkTambahSdPage,
    'ptk_edit_sd': initPtkEditSdPage,
    'ptk_bezetting_sd_negeri': initMenuPage,
    'murid_menu': initMenuPage,
    'murid_paud_kelas_usia': initMuridPaudKelasUsiaPage,
    'murid_paud_jenis_kelamin': initMuridPaudJenisKelaminPage,
    'murid_paud_jumlah_bulanan': initMuridPaudJumlahBulananPage,
    'murid_sd_kelas': initMuridSdKelasPage,
    'murid_sd_rombel': initMuridSdRombelPage,
    'murid_sd_jenis_kelamin': initMuridSdJenisKelaminPage,
    'murid_sd_agama': initMuridSdAgamaPage,
    'murid_sd_jumlah_bulanan': initMuridSdJumlahBulananPage,
    'siaba_menu': initMenuPage,
    'siaba_panduan': initMenuPage,
    'siaba_daftar_presensi': initSiabaDaftarPresensiPage,
    'siaba_tidak_presensi': initSiabaTidakPresensiPage,
    'siaba_apel_upacara': initSiabaApelUpacaraPage,
    'siaba_lupa_presensi': initMenuPage,
    'siaba_lupa_unggah': initSiabaLupaUnggahPage, // Placeholder sementara
    'siaba_lupa_cek': initSiabaLupaCekPage,    // Placeholder sementara
    'siaba_lupa_rekap': initSiabaLupaRekapPage,  // Placeholder sementara
    'siaba_lupa_unduh': initSiabaLupaUnduhPage,  // Placeholder sementara
    'siaba_salah_presensi': initSiabaSalahPresensiPage,
    'siaba_salah_form': initSiabaSalahFormPage,
    'siaba_salah_cek': initSiabaSalahCekPage,
    'siaba_perjalanan_dinas': initSiabaDinasPage,
    'siaba_dinas_unggah': initSiabaDinasUnggahPage, // Placeholder
    'siaba_dinas_cek': initSiabaDinasCekPage,    // Placeholder
    'siaba_dinas_edit': initSiabaDinasEditPage,
    'siaba_dinas_unduh': initSiabaDinasUnduhPage,  // Placeholder
    'siaba_cuti_menu': initSiabaCutiMenuPage,   // Halaman Menu Utama
    'siaba_cuti_sisa': initSiabaCutiSisaPage,   // Halaman Tabel (Fungsi Baru)
    'siaba_cuti_data': initSiabaDataCutiPage,
    'siaba_cuti_form': initSiabaCutiFormPage,            // Placeholder
    'siaba_cuti_unduh': initSiabaCutiUnduhPage,           // Placeholder
    'siaba_cuti_unggah': initSiabaCutiUnggahPage,          // Placeholder
    'siaba_cuti_cek': initSiabaCutiCekPage,
    'siaba_cuti_informasi': initMenuPage,
    'siaba_cuti_edit': initSiabaCutiEditPage_v2,
    'siaba_rekap_terlambat': initSiabaRekapTerlambatPage,
    'siaba_rekap_pulang_awal': initSiabaRekapPulangAwalPage,
    'siaba_unduh_rekap': initSiabaUnduhRekapPage,
    'asn_skp_menu': initMenuPage,   // Halaman Menu Utama SKP
    'asn_skp_unggah': initAsnSkpUnggahPage,
    'asn_skp_kelola': initAsnSkpKelolaPage,
    'asn_skp_edit': initAsnSkpEditPage,
    'asn_skp_kirim': initAsnSkpDaftarKirimPage,
    'asn_pak_menu': initMenuPage,
    'asn_pak_unggah': initAsnPakUnggahPage,
    'asn_pak_kelola': initAsnPakKelolaPage,
    'asn_pak_edit': initAsnPakEditPage,
    'asn_pak_kirim': initAsnPakDaftarKirimPage,
    'asn_kp': initMenuPage,
    'asn_kgb': initMenuPage,
    'asn_kp4': initMenuPage,
    'rapor_pendidikan_menu': initMenuPage,
    'tata_naskah_menu': initMenuPage,
    'mutasi_murid_menu': initMenuPage,
    'tapera_sitara_menu': initMenuPage,
    'administrasi_sekolah_menu': initMenuPage,
    'data_sekolah_menu': initMenuPage,
    'komunitas_belajar_menu': initMenuPage,
    'gelar_karya_menu': initMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    // Load halaman home saat pertama kali dibuka
    setTimeout(() => {
        App.loadPage(null, 'home');
    }, 0);
    
    document.body.addEventListener('click', function(e) {
        // Cari elemen <a> terdekat yang diklik
        const link = e.target.closest('a');
        if (!link) return;

        // Ambil data page
        const pageName = link.dataset.page;
        const parentLi = link.parentElement;
        const isParentToggle = parentLi.classList.contains('has-submenu');

        // LOGIKA 1: Jika yang diklik adalah tombol Toggle (Menu Induk yang punya anak)
        if (isParentToggle) {
            // Jika user mengklik panah chevron ATAU link itu tidak punya halaman tujuan (href="#" dan tidak ada data-page)
            // Maka fungsinya hanya Buka/Tutup (Toggle)
            const isChevronClick = e.target.classList.contains('submenu-icon');
            
            if (isChevronClick || !pageName) {
                e.preventDefault();
                parentLi.classList.toggle('open'); // Buka atau Tutup
                return; // Berhenti di sini, jangan load page
            }
            
            // Jika Menu Induk punya halaman tujuan (misal: SK Pembagian Tugas), biarkan lanjut ke Logika 2
        }

        // LOGIKA 2: Navigasi Halaman
        if (pageName) {
            e.preventDefault();
            
            // Khusus Mobile: Tutup sidebar setelah klik (opsional, jika Anda punya tombol toggle sidebar mobile)
            // document.querySelector('.sidebar').classList.remove('show'); 

            App.loadPage(null, pageName);
        }
    });
});
</script>